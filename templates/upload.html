{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        padding-bottom: 100px;
        -webkit-tap-highlight-color: transparent;
    }
    .page-header { text-align: center; padding: 25px 0 10px 0; width: 100%; position: relative; }
    .page-title-img {
        width: 85%; max-width: 320px; height: auto; display: block; margin: 0 auto;
        filter: drop-shadow(0 8px 15px rgba(93, 64, 55, 0.4));
        animation: float-title 4s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .form-card {
        background: rgba(255, 255, 255, 0.95); width: 92%; max-width: 500px;
        padding: 25px; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
        margin: 10px auto; position: relative; border: 2px solid #fff;
    }
    .gps-pill {
        background: #fff8e1; padding: 8px 15px; border-radius: 50px;
        font-size: 0.9rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex; align-items: center; justify-content: center;
        border: 1px solid #ffe0b2; color: #f57c00;
        margin-bottom: 20px; width: 100%; cursor: pointer;
    }
    .upload-zone {
        border: 2px dashed #d7ccc8; border-radius: 20px; min-height: 250px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: #fafafa; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .upload-zone:active { background: #fff; border-color: #d32f2f; transform: scale(0.98); }
    .god-camera-img {
        width: 150px; height: auto; object-fit: contain; margin-bottom: 10px; 
        filter: drop-shadow(0 0 15px rgba(255, 193, 7, 0.5));
        animation: breathe-god 3s infinite ease-in-out;
    }
    @keyframes breathe-god {
        0%, 100% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(255, 193, 7, 0.5)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 25px rgba(255, 193, 7, 0.8)); }
    }
    .upload-text { font-weight: bold; color: #8d6e63; font-size: 1.1rem; margin-top: 5px; }
    #preview { width: 100%; height: 100%; position: absolute; top:0; left:0; object-fit: cover; display: none; }
    .re-take-hint {
        position: absolute; bottom: 10px; background: rgba(0,0,0,0.6); color: white;
        padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; display: none;
    }
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 5px; font-size: 0.95rem; display: block;}
    .custom-input {
        width: 100%; border-radius: 15px; border: 1px solid #eee; background: #fdfdfd;
        padding: 12px 15px; font-size: 1rem; transition: 0.3s;
    }
    .custom-input:focus { border-color: #d32f2f; outline: none; background: white; }
    
    .btn-submit {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        border: none; border-radius: 50px; padding: 15px; margin-top: 15px;
        font-weight: bold; letter-spacing: 1px; width: 100%; font-size: 1.1rem; color: white;
        box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
        opacity: 0.5; pointer-events: none; transition: 0.3s;
        cursor: pointer; display: block;
    }
    .btn-submit.ready { opacity: 1; pointer-events: auto; }
    .btn-submit:active { transform: scale(0.98); }

    /* è¨ºæ–·æ¡†æ¨£å¼ */
    .console-log {
        background: #333; color: #0f0; font-family: monospace; font-size: 0.75rem;
        padding: 10px; border-radius: 10px; margin-top: 15px;
        height: 80px; overflow-y: scroll; text-align: left;
        border: 2px solid #555;
    }
    .test-btn {
        background: #ff9800; color: white; border: none; padding: 5px 10px;
        border-radius: 5px; font-size: 0.8rem; margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/title_signboard.png" class="page-title-img" alt="å°‹ç¥æƒ…å ±ç«™">
    </div>

    <div class="form-card">
        <!-- å‚™ç”¨éŸ³æ•ˆï¼šçŸ­ä¿ƒçš„å®å’šè² (Base64) -->
        <audio id="backupMp3" preload="auto">
            <source src="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
        </audio>

        <div class="gps-pill" id="gpsStatus" onclick="startGPS()">
            <i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­... (é»æ“Šé‡æŠ“)
        </div>

        <form id="uploadForm">
            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lng" name="lng">

            <div class="form-group text-center">
                <label for="photo" class="upload-zone" id="uploadLabel">
                    <div id="uploadPlaceholder">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768691403/god_camera.png" class="god-camera-img" alt="è«‹ä¸Šå‚³ç…§ç‰‡">
                        <div class="upload-text">ğŸ“¸ é»æ­¤å¥‰ä¸Šç¥è·¡ç…§ç‰‡</div>
                        <small style="color:#aaa;">é–‹å•Ÿç›¸æ©Ÿæ•æ‰é‡‘èº«</small>
                    </div>
                    <img id="preview" alt="é è¦½åœ–">
                    <div class="re-take-hint" id="reTakeHint"><i class="fas fa-redo"></i> é»æ“Šé‡æ‹</div>
                    <input type="file" id="photo" name="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this)">
                </label>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-map-marker-alt" style="color:#d32f2f;"></i> å‡ºæ²’å€åŸŸ (å¿…å¡«)</label>
                <select id="area" name="area" class="custom-input" required onchange="checkReady()">
                    <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                    <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                    <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                    <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                    <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                    <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                    <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                    <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                    <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" style="display:flex; justify-content:space-between;">
                    <span><i class="fas fa-user-tag" style="color:#fbc02d;"></i> æ‚¨çš„ç¨±è™Ÿ</span>
                    <button type="button" class="test-btn" onclick="testSound()">ğŸ” è²éŸ³è¨ºæ–·</button>
                </label>
                <input type="text" class="custom-input" id="nickname" name="nickname" maxlength="8" placeholder="ä¾‹å¦‚ï¼šç†±å¿ƒä¸²å‹ (é è¨­)">
            </div>

            <div class="form-group mb-0">
                <label class="form-label"><i class="fas fa-pen" style="color:#8d6e63;"></i> ç·šç´¢æè¿° (é¸å¡«)</label>
                <textarea class="custom-input" id="description" name="description" rows="2" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..."></textarea>
            </div>

            <!-- è¨ºæ–·è¨Šæ¯æ¡† -->
            <div id="console" class="console-log">ç³»çµ±æº–å‚™å°±ç·’...<br>ç­‰å¾…æ“ä½œ...</div>

            <!-- ä½¿ç”¨ ontouchstart æ¶å…ˆè§¸ç™¼ -->
            <button type="button" class="btn-submit" id="submitBtn" ontouchstart="handleSubmit()" onclick="handleSubmit()">
                <i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- è¨ºæ–·èˆ‡ç™¼è²ç³»çµ± ---
    function log(msg) {
        let c = document.getElementById('console');
        c.innerHTML += "> " + msg + "<br>";
        c.scrollTop = c.scrollHeight;
        console.log(msg);
    }

    let hasVoices = false;
    let submitted = false;

    // 1. åˆå§‹åŒ–æª¢æŸ¥
    function initSystem() {
        if (!('speechSynthesis' in window)) {
            log("âŒ æ‰‹æ©Ÿä¸æ”¯æ´èªéŸ³åˆæˆ (TTS)");
            return;
        }
        
        let voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            hasVoices = true;
            log(`âœ… æª¢æ¸¬åˆ° ${voices.length} å€‹èªéŸ³åŒ…`);
            checkChinese(voices);
        } else {
            // Android å¸¸å¸¸éåŒæ­¥è¼‰å…¥
            log("â³ ç­‰å¾…èªéŸ³åŒ…è¼‰å…¥...");
            window.speechSynthesis.onvoiceschanged = function() {
                voices = window.speechSynthesis.getVoices();
                hasVoices = true;
                log(`âœ… èªéŸ³åŒ…å·²æ›´æ–°: ${voices.length} å€‹`);
                checkChinese(voices);
            };
        }
    }

    function checkChinese(voices) {
        let zh = voices.find(v => v.lang.includes('zh'));
        if (zh) log(`âœ… ç™¼ç¾ä¸­æ–‡å¼•æ“: ${zh.name}`);
        else log(`âš ï¸ è­¦å‘Š: ç„¡ä¸­æ–‡èªéŸ³ï¼Œå°‡ä½¿ç”¨é è¨­`);
    }

    // 2. æ¸¬è©¦æŒ‰éˆ•é‚è¼¯
    function testSound() {
        log("--- é–‹å§‹æ¸¬è©¦ ---");
        // å˜—è©¦ TTS
        if (hasVoices) {
            speakText("æ¸¬è©¦è²éŸ³");
        } else {
            log("âŒ ç„¡ TTS è³‡æºï¼Œåˆ‡æ› MP3");
            playMp3();
        }
    }

    // 3. æ ¸å¿ƒç™¼è² (åŒ…å«é™ç´š)
    function speakText(text) {
        if (!hasVoices) {
            playMp3(); // æ²’èªéŸ³åŒ…ç›´æ¥æ’­ MP3
            return;
        }

        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        
        // éŒ¯èª¤ç›£è½
        u.onerror = function(e) {
            log(`âŒ TTS éŒ¯èª¤: ${e.error}`);
            log("ğŸ”„ è‡ªå‹•åˆ‡æ›è‡³ MP3 å‚™æ´");
            playMp3(); // å¤±æ•—å°±æ’­ MP3
        };

        u.onstart = function() { log("ğŸ”Š TTS æ­£åœ¨æ’­æ”¾..."); };

        try {
            window.speechSynthesis.speak(u);
        } catch(e) {
            log("âŒ TTS å‘¼å«å¤±æ•—");
            playMp3();
        }
    }

    // 4. çµ•å°å‚™æ´ï¼šæ’­æ”¾ MP3
    function playMp3() {
        let audio = document.getElementById('backupMp3');
        if(!audio) return;
        
        audio.currentTime = 0;
        let p = audio.play();
        if (p !== undefined) {
            p.then(() => {
                log("ğŸµ MP3 æ’­æ”¾æˆåŠŸ");
            }).catch(e => {
                log(`âŒ MP3 å¤±æ•—: ${e.message}`);
                log("ğŸ’¡ è«‹æª¢æŸ¥æ‰‹æ©Ÿæ˜¯å¦éœéŸ³ï¼");
            });
        }
    }

    // 5. æäº¤é‚è¼¯
    function handleSubmit() {
        if (submitted) return;
        let btn = $('#submitBtn');
        if (!btn.hasClass('ready')) return;

        submitted = true; // é–å®šé˜²æ­¢é‡è¤‡

        // --- é€™è£¡åŒæ­¥è§¸ç™¼è²éŸ³ ---
        let area = $('#area').val();
        let nickname = $('#nickname').val().trim() || 'ä¸²å‹';
        let text = `æ”¶åˆ°ï¼Œè³‡æ–™å‚³é€ä¸­ã€‚æ„Ÿè¬${area}çš„${nickname}`;
        
        speakText(text); // å˜—è©¦èªªè©±ï¼Œå¤±æ•—æœƒè‡ªå‹•è½‰ MP3

        // --- è³‡æ–™ä¸Šå‚³ ---
        btn.removeClass('ready').html('è™•ç†ä¸­...').css('opacity', 0.8);
        
        let form = document.getElementById('uploadForm');
        let formData = new FormData(form);
        formData.set('nickname', nickname);
        let desc = $('#description').val();
        formData.set('description', '[' + area + '] ' + desc);

        $.ajax({
            url: '/upload', type: 'POST', data: formData, contentType: false, processData: false,
            success: function(response) {
                submitted = false;
                if(response.status === 'duplicate') {
                    Swal.fire({title: 'å·²é‡è¤‡', text: 'æ­¤åœ°é»å·²æœ‰ç´€éŒ„', icon: 'info'})
                        .then(() => window.location.href='/map');
                } else {
                    Swal.fire({title: 'æˆåŠŸï¼', text: 'æ„Ÿè¬é€šå ±', icon: 'success'})
                        .then(() => window.location.href='/map');
                }
            },
            error: function() {
                submitted = false;
                log("âŒ ä¸Šå‚³å¤±æ•—");
                Swal.fire({title: 'ä¸Šå‚³å¤±æ•—', icon: 'error'});
                btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> é‡è©¦');
            }
        });
    }

    // GPS èˆ‡åˆå§‹åŒ–
    function startGPS() {
        $('#gpsStatus').html('å®šä½ä¸­...');
        navigator.geolocation.getCurrentPosition(
            p => {
                $('#lat').val(p.coords.latitude);
                $('#lng').val(p.coords.longitude);
                $('#gpsStatus').html('âœ… å®šä½å®Œæˆ').css('color', 'green');
                checkReady();
            },
            e => { $('#gpsStatus').html('âŒ å®šä½å¤±æ•—').css('color', 'red'); }
        );
    }
    
    // é è¦½åœ–ç‰‡
    function previewImage(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                $('#preview').attr('src', e.target.result).show();
                $('#reTakeHint').show();
                $('#uploadPlaceholder').hide();
                checkReady();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function checkReady() {
        let area = $('#area').val();
        if ($('#lat').val() && area && $('#preview').attr('src')) {
            $('#submitBtn').addClass('ready').html('<i class="fas fa-paper-plane"></i> ç™¼é€æƒ…å ±');
        }
    }

    $(document).ready(function() {
        startGPS();
        initSystem();
        // é å…ˆè§£é–éŸ³è¨Šç’°å¢ƒ
        document.body.addEventListener('touchstart', function() {
            if(window.speechSynthesis) window.speechSynthesis.resume();
            document.getElementById('backupMp3').load();
        }, {once:true});
    });
</script>
{% endblock %}


