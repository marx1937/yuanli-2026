{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    /* å…¨å±€èƒŒæ™¯ (ä¿ç•™æ‚¨æä¾›çš„æ¨£å¼) */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        padding-bottom: 100px;
    }

    /* é ‚éƒ¨æ¨™é¡Œ */
    .page-header { text-align: center; padding: 25px 0 15px 0; width: 100%; position: relative; }
    .header-capsule {
        background: white; padding: 8px 25px; border-radius: 50px;
        font-weight: bold; color: #5d4037; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: inline-flex; align-items: center; border: 1px solid rgba(255,255,255,0.8);
        font-size: 1.1rem;
    }

    /* ä¸»è¡¨å–®å¡ç‰‡ */
    .form-card {
        background: rgba(255, 255, 255, 0.95); width: 92%; max-width: 500px;
        padding: 25px; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
        margin: 0 auto; border: 1px solid #efebe9;
        position: relative; overflow: hidden;
    }
    
    /* è£é£¾ç·šæ¢ */
    .form-card::before {
        content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
        background: linear-gradient(90deg, #8d6e63, #d7ccc8);
    }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 8px; display: block; font-size: 0.95rem; }
    .custom-input {
        width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
        border-radius: 15px; background: #fff; font-size: 1rem; color: #333;
        transition: 0.3s; outline: none;
    }
    .custom-input:focus { border-color: #8d6e63; box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1); }

    /* ç…§ç‰‡é è¦½å€ (æ‹ç«‹å¾—é¢¨æ ¼) */
    .upload-preview-container {
        width: 100%; height: 220px; background: #f5f5f5; border: 2px dashed #ccc;
        border-radius: 20px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; cursor: pointer;
        transition: 0.3s; margin-bottom: 25px; position: relative; overflow: hidden;
    }
    .upload-preview-container:hover { background: #eee; border-color: #8d6e63; }
    .upload-preview-container.has-image { border: none; background: #fff; padding: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    
    #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 15px; }
    .upload-placeholder { text-align: center; color: #888; transition: 0.3s; }
    .upload-placeholder i { font-size: 2.5rem; color: #bdbdbd; margin-bottom: 10px; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-submit {
        width: 100%; padding: 14px; background: linear-gradient(135deg, #d32f2f, #b71c1c);
        color: white; border: none; border-radius: 50px;
        font-size: 1.1rem; font-weight: bold; letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
    }
    .btn-submit:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(211, 47, 47, 0.2); }
    .btn-submit:disabled { background: #bdbdbd; box-shadow: none; cursor: not-allowed; }

    /* Loading å‹•ç•« */
    .spinner { display: none; width: 20px; height: 20px; border: 3px solid #fff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* å°è£é£¾ */
    .decoration-icon { position: absolute; font-size: 5rem; color: rgba(141, 110, 99, 0.03); z-index: 0; pointer-events: none; }
    .deco-1 { top: 10%; left: -20px; transform: rotate(-15deg); }
    .deco-2 { bottom: 15%; right: -20px; transform: rotate(15deg); }

</style>
{% endblock %}

{% block content %}

<i class="fas fa-torii-gate decoration-icon deco-1"></i>
<i class="fas fa-cloud decoration-icon deco-2"></i>

<div class="page-header">
    <div class="header-capsule">
        <i class="fas fa-camera" style="color: #d32f2f; margin-right: 8px;"></i> å›å ±ç¥éšŠå‹
    </div>
    <div style="font-size: 0.85rem; color: #888; margin-top: 5px;">ä¸€èµ·å®Œå–„è‹‘è£¡çš„ç¥æ˜åœ°åœ–</div>
</div>

<div class="form-card">
    <form id="uploadForm" enctype="multipart/form-data">
        
        <div class="upload-preview-container" id="upload-box" onclick="document.getElementById('photo').click()">
            <div class="upload-placeholder" id="upload-placeholder">
                <i class="fas fa-camera-retro"></i>
                <div>é»æ“Šæ‹æ”æˆ–ä¸Šå‚³ç…§ç‰‡</div>
                <div style="font-size: 0.8rem; margin-top: 5px; color: #aaa;">(ç›´å¼æ©«å¼çš†å¯)</div>
            </div>
            <img id="preview-img" />
            <input type="file" id="photo" name="photo" accept="image/*" style="display: none;" onchange="previewImage(this)">
        </div>

        <div class="form-group">
            <label class="form-label"><i class="fas fa-user" style="color:#8d6e63;"></i> æ‚¨çš„æš±ç¨± (é¸å¡«)</label>
            <input type="text" class="custom-input" id="nickname" name="nickname" placeholder="ä¾‹å¦‚ï¼šè‹‘è£¡å°ç•¶å®¶">
        </div>

        <div class="form-group mb-0">
            <label class="form-label"><i class="fas fa-pen" style="color:#8d6e63;"></i> ç·šç´¢æè¿° (é¸å¡«)</label>
            <textarea class="custom-input" id="description" name="note" rows="2" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..."></textarea>
        </div>

        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lng" name="lng">

        <div style="height: 25px;"></div>

        <button type="submit" class="btn-submit" id="submitBtn">
            <span id="btnText">ç¢ºèªä¸Šå‚³</span> <div class="spinner" id="loadingSpinner"></div>
        </button>

    </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    // é è¦½åœ–ç‰‡åŠŸèƒ½
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#preview-img').attr('src', e.target.result).show();
                $('#upload-placeholder').hide();
                $('.upload-preview-container').addClass('has-image');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // è‡ªå‹•æŠ“å–åº§æ¨™
    $(document).ready(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                $('#lat').val(position.coords.latitude);
                $('#lng').val(position.coords.longitude);
            }, function(error) {
                Swal.fire({
                    icon: 'warning',
                    title: 'éœ€è¦å®šä½æ¬Šé™',
                    text: 'è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ä½ç½®ï¼Œæ‰èƒ½æ¨™è¨˜ç¥æ˜çš„ä½ç½®å–”ï¼',
                    confirmButtonColor: '#d32f2f'
                });
            });
        } else {
            alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        }
    });

    // è¡¨å–®é€å‡ºè™•ç†
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();

        // æª¢æŸ¥æ˜¯å¦æœ‰ç…§ç‰‡
        if (!$('#photo').val()) {
            Swal.fire({
                icon: 'warning',
                title: 'å¿˜è¨˜æ‹ç…§äº†å—ï¼Ÿ',
                text: 'è«‹å…ˆæ‹æ”æˆ–é¸æ“‡ä¸€å¼µç¥æ˜/å»Ÿå®‡çš„ç…§ç‰‡',
                confirmButtonColor: '#d32f2f'
            });
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰åº§æ¨™
        if (!$('#lat').val() || !$('#lng').val()) {
             Swal.fire({
                icon: 'error',
                title: 'ç„¡æ³•å–å¾—ä½ç½®',
                text: 'è«‹ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿï¼Œä¸¦å…è¨±ç¶²é ä½¿ç”¨å®šä½åŠŸèƒ½ã€‚',
                confirmButtonColor: '#d32f2f'
            });
            return;
        }

        // æŒ‰éˆ• loading ç‹€æ…‹
        let btn = $('#submitBtn');
        let originalText = $('#btnText').text();
        btn.prop('disabled', true);
        $('#btnText').text('è³‡æ–™å‚³é€ä¸­...');
        $('#loadingSpinner').show();

        // æº–å‚™è³‡æ–™
        var formData = new FormData(this);

        // ç™¼é€ AJAX
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                // æ¢å¾©æŒ‰éˆ•
                btn.prop('disabled', false);
                $('#btnText').text(originalText);
                $('#loadingSpinner').hide();

                // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºçµæœ
                let area = response.area || "è‹‘è£¡";
                let nickname = $('#nickname').val() || "ç†±å¿ƒä¸²å‹";

                if (response.status === 'success') {
                    Swal.fire({
                        title: 'âœ… ä¸Šå‚³æˆåŠŸï¼', 
                        html: `æ„Ÿè¬ <b>${area}</b> çš„ <b>${nickname}</b>ï¼ŒåœŸåœ°å…¬æ”¶åˆ°å›‰ï¼`, 
                        imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1/happy.jpg', 
                        imageWidth: '100%',
                        confirmButtonText: 'å¤ªæ£’äº†ï¼', confirmButtonColor: '#d32f2f',
                        background: '#fffbf0', backdrop: `rgba(0,0,0,0.5)`
                    }).then(() => { window.location.href = '/map'; });

                } else if (response.status === 'pending') {
                    Swal.fire({
                        title: 'ğŸ“ åœ°é»é‡è¤‡å›‰', 
                        html: `æ„Ÿè¬ <span style="color:#d32f2f;">${nickname}</span>ï¼<br>ä¸é ${area} é™„è¿‘ä¼¼ä¹å·²æœ‰ç´€éŒ„å›‰ã€‚<br>è³‡æ–™å·²é€äº¤å¯©æ ¸ï¼`,
                        imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1/pada.jpg', 
                        imageWidth: '100%', 
                        confirmButtonText: 'æ”¶åˆ°ï¼Œä¾†å»æ‰¾ä¸‹ä¸€åº§ï¼', confirmButtonColor: '#ff9800',
                        background: '#fffbf0', backdrop: `rgba(0,0,0,0.5)`
                    }).then(() => { window.location.href = '/map'; });

                } else {
                    Swal.fire({
                        icon: 'error', title: 'ä¸Šå‚³å¤±æ•—', text: response.message,
                        confirmButtonColor: '#d32f2f'
                    });
                }
            },
            error: function() {
                // æ¢å¾©æŒ‰éˆ•
                btn.prop('disabled', false);
                $('#btnText').text(originalText);
                $('#loadingSpinner').hide();
                
                Swal.fire({ 
                    title: 'âŒ ä¸Šå‚³å¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦', icon: 'error', confirmButtonColor: '#d32f2f'
                });
            }
        });
    });
</script>

{% endblock %}
