{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    /* --- ç‰ˆé¢å„ªåŒ– --- */
    .upload-container {
        padding: 20px; max-width: 500px; margin: 0 auto;
        padding-bottom: 100px;
    }

    /* é ‚éƒ¨æç¤ºå¡ç‰‡ */
    .status-card {
        background: #fff; border-radius: 15px; padding: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        display: flex; align-items: center; justify-content: space-between;
        border: 1px solid #ffe0b2;
    }
    .gps-status { font-weight: bold; font-size: 0.9rem; color: #f57c00; display: flex; align-items: center; }
    .btn-retry-gps {
        background: white; border: 1px solid #ddd; padding: 5px 12px;
        border-radius: 20px; font-size: 0.8rem; color: #666;
    }

    /* ç…§ç‰‡é è¦½å€ */
    .preview-box {
        width: 100%; height: 250px; background: #eee;
        border-radius: 15px; overflow: hidden; margin-bottom: 20px;
        display: none; position: relative; border: 2px solid #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .preview-img { width: 100%; height: 100%; object-fit: cover; }
    .re-take-btn {
        position: absolute; bottom: 10px; right: 10px;
        background: rgba(0,0,0,0.6); color: white;
        padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;
        pointer-events: none;
    }

    /* é–‹å•Ÿç›¸æ©Ÿå¤§æŒ‰éˆ• */
    .btn-camera-trigger {
        width: 100%; padding: 25px;
        background: white; border: 2px dashed #d7ccc8;
        border-radius: 20px; text-align: center;
        margin-bottom: 25px; cursor: pointer;
        transition: all 0.2s;
    }
    .btn-camera-trigger:active { background: #f5f5f5; transform: scale(0.98); }
    .camera-icon-big { width: 60px; opacity: 0.6; margin-bottom: 10px; }
    .camera-text { color: #8d6e63; font-weight: bold; font-size: 1.1rem; }

    /* è¡¨å–®å„ªåŒ– */
    .form-group { margin-bottom: 20px; }
    .form-label {
        font-weight: bold; color: #5d4037; margin-bottom: 8px; display: block; font-size: 1rem;
    }
    .custom-input {
        width: 100%; padding: 15px; border-radius: 12px;
        border: 1px solid #ddd; font-size: 1rem; background: #fafafa;
    }
    .custom-input:focus { background: white; border-color: #d32f2f; outline: none; }
    
    /* è®“ placeholder è®Šæˆç°è‰² */
    .custom-input::placeholder { color: #ccc; }

    /* åº•éƒ¨æäº¤æŒ‰éˆ• */
    .btn-submit {
        width: 100%; padding: 18px; border-radius: 50px; border: none;
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        color: white; font-weight: bold; font-size: 1.2rem;
        box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        opacity: 0.5; pointer-events: none; transition: 0.3s;
    }
    .btn-submit.ready { opacity: 1; pointer-events: auto; }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    
    <div class="status-card">
        <div class="gps-status" id="gps-msg">
            <i class="fas fa-satellite-dish fa-spin" style="margin-right:8px;"></i> å®šä½ä¸­...
        </div>
        <button class="btn-retry-gps" onclick="startGPS()">é‡æŠ“</button>
    </div>

    <form id="uploadForm">
        <input type="hidden" name="lat" id="lat">
        <input type="hidden" name="lng" id="lng">

        <div class="preview-box" id="previewBox" onclick="document.getElementById('photo').click()">
            <img id="previewImg" class="preview-img">
            <div class="re-take-btn"><i class="fas fa-camera"></i> é»æ“Šé‡æ‹</div>
        </div>

        <div class="btn-camera-trigger" id="cameraTrigger" onclick="document.getElementById('photo').click()">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/yuanli_ui/icon_camera.png" class="camera-icon-big">
            <div class="camera-text">ğŸ“¸ é»æˆ‘é–‹å•Ÿç›¸æ©Ÿ</div>
        </div>
        
        <input type="file" id="photo" name="photo" accept="image/*" capture="environment" style="display:none;" onchange="handleFileSelect(this)">

        <div class="form-group">
            <label class="form-label">ğŸ“ å‡ºæ²’å€åŸŸ (å¿…å¡«)</label>
            <select name="area" id="area" class="custom-input" required onchange="checkForm()">
                <option value="" disabled selected>è«‹é¸æ“‡é‡Œåˆ¥...</option>
                <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">ğŸ‘¤ æ‚¨çš„ç¨±è™Ÿ</label>
            <input type="text" name="nickname" id="nickname" class="custom-input" placeholder="ä¾‹å¦‚ï¼šç†±å¿ƒä¸²å‹ (é è¨­)">
        </div>

        <div class="form-group">
            <label class="form-label">ğŸ“ ç·šç´¢æè¿° (é¸å¡«)</label>
            <textarea name="description" id="description" class="custom-input" rows="3" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..."></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn-submit">
            è«‹å…ˆæ‹ç…§èˆ‡å®šä½
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let isGpsReady = false;
    let isPhotoReady = false;

    // 1. èªéŸ³æ’­å ±åŠŸèƒ½ (åœŸåœ°å…¬ä¿åº‡)
    function speakHappy(text) {
        if ('speechSynthesis' in window) {
            var msg = new SpeechSynthesisUtterance();
            msg.text = text; 
            msg.lang = 'zh-TW'; 
            msg.rate = 1.0; 
            window.speechSynthesis.speak(msg);
        }
    }

    // 2. å•Ÿå‹• GPS
    function startGPS() {
        $('#gps-msg').html('<i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­...');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                $('#lat').val(pos.coords.latitude);
                $('#lng').val(pos.coords.longitude);
                $('#gps-msg').html('<i class="fas fa-check-circle text-success mr-2"></i> å®šä½æˆåŠŸ').css('color', '#2ecc71');
                isGpsReady = true;
                checkForm();
            }, function(err) {
                $('#gps-msg').html('<i class="fas fa-times-circle text-danger mr-2"></i> å®šä½å¤±æ•— (è«‹é–‹GPS)').css('color', '#e74c3c');
                isGpsReady = false; 
            });
        } else {
            $('#gps-msg').text('æ‰‹æ©Ÿä¸æ”¯æ´ GPS');
        }
    }

    // 3. è™•ç†ç…§ç‰‡
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#previewImg').attr('src', e.target.result);
                $('#previewBox').show(); $('#cameraTrigger').hide();
                isPhotoReady = true;
                checkForm();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 4. æª¢æŸ¥è¡¨å–®
    function checkForm() {
        let area = $('#area').val();
        let btn = $('#submitBtn');
        if (isGpsReady && isPhotoReady && area) {
            btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> ç¢ºèªä¸Šå‚³');
        } else {
            btn.removeClass('ready');
            if (!isPhotoReady) btn.text('è«‹å…ˆæ‹ç…§');
            else if (!area) btn.text('è«‹é¸æ“‡å€åŸŸ');
            else if (!isGpsReady) btn.text('ç­‰å¾…å®šä½...');
        }
    }

    // 5. æäº¤è¡¨å–® (å«ä¸é›…å­—éæ¿¾ + èªéŸ³)
    $('#uploadForm').submit(function(e) {
        e.preventDefault();
        
        // æš±ç¨±æª¢æŸ¥
        let nickname = $('#nickname').val().trim();
        if(!nickname) nickname = "ç†±å¿ƒä¸²å‹"; // å¦‚æœæ²’å¡«å°±çµ¦é è¨­å€¼
        
        let area = $('#area').val();
        
        // ğŸ”¥ ä¸é›…å­—éæ¿¾æ¸…å–®
        var badWords = ['ç¬¨è›‹', 'å£è›‹', 'ç‹å…«', 'ç™½ç—´', 'ç™½ç™¡', 'æ™ºéšœ', 'å¹¹', 'é ', 'æ­»', 'çˆ›', 'å±Œ', 'é›æ°', 'fuck', 'shit'];
        for (var word of badWords) {
            if (nickname.toLowerCase().includes(word)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'æš±ç¨±ä¸å¤ªå¥½è½å–”...',
                    text: 'è«‹æ›´æ›ä¸€å€‹å„ªé›…çš„åå­—ï¼ŒåœŸåœ°å…¬åœ¨çœ‹å–”ï¼',
                    confirmButtonColor: '#d33'
                });
                return; 
            }
        }

        let btn = $('#submitBtn');
        if (!btn.hasClass('ready')) return;

        btn.removeClass('ready').html('<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...').css('opacity', '0.8');

        var formData = new FormData(this);
        var desc = $('#description').val();
        // å¦‚æœæš±ç¨±æ˜¯ç©ºçš„ï¼Œé€™è£¡æ‰‹å‹•è£œé€²å»çµ¦å¾Œç«¯
        if($('#nickname').val().trim() === "") formData.set('nickname', "ç†±å¿ƒä¸²å‹");
        
        formData.set('description', `[${area}] ${desc}`);

        $.ajax({
            url: '/upload', type: 'POST', data: formData, contentType: false, processData: false,
            success: function(res) {
                // ğŸ”¥ æˆåŠŸå¾Œçš„èªéŸ³æ’­å ±
                var sayText = 'æ„Ÿè¬ ' + area + ' çš„ ' + nickname + 'ï¼ŒåœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼';
                speakHappy(sayText);

                Swal.fire({
                    title: 'âœ… ä¸Šå‚³æˆåŠŸï¼',
                    html: `æ„Ÿè¬ <b>${area}</b> çš„ <b>${nickname}</b><br>åœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼`,
                    icon: 'success',
                    confirmButtonText: 'å¤ªæ£’äº†',
                    confirmButtonColor: '#d32f2f'
                }).then(() => { window.location.href = '/map'; });
            },
            error: function(xhr) {
                let errMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'è«‹ç¨å¾Œå†è©¦';
                Swal.fire({ title: 'ä¸Šå‚³å¤±æ•—', text: errMsg, icon: 'error' });
                btn.addClass('ready').html('é‡è©¦ä¸Šå‚³');
            }
        });
    });

    $(document).ready(function() { startGPS(); });
</script>
{% endblock %}
