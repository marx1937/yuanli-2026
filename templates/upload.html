{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    /* å…¨å±€èƒŒæ™¯ä¿®æ­£ */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        margin: 0; 
    }

    .page-header { text-align: center; padding: 20px 0 10px 0; width: 100%; position: relative; }
    .title-signboard { width: 70%; max-width: 280px; height: auto; display: block; margin: 0 auto; filter: drop-shadow(0 5px 5px rgba(93, 64, 55, 0.15)); }

    /* è¡¨å–®å¡ç‰‡ç½®ä¸­ */
    .form-card {
        background: rgba(255, 255, 255, 0.95); width: 92%; max-width: 500px;
        padding: 25px; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
        margin: 10px auto; /* é—œéµç½®ä¸­ */
        border: 2px solid #fff;
    }

    .gps-pill { background: #fff8e1; padding: 8px 15px; border-radius: 50px; font-size: 0.9rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; border: 1px solid #ffe0b2; color: #f57c00; margin-bottom: 20px; width: 100%; cursor: pointer; }
    .upload-zone { border: 2px dashed #d7ccc8; border-radius: 20px; min-height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .upload-zone:active { background: #fff; border-color: #d32f2f; transform: scale(0.98); }
    .upload-icon-img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; opacity: 0.9; }
    .upload-text { font-weight: bold; color: #8d6e63; font-size: 1.1rem; }
    #preview { width: 100%; height: 100%; position: absolute; top:0; left:0; object-fit: cover; display: none; }
    .re-take-hint { position: absolute; bottom: 10px; background: rgba(0,0,0,0.6); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; display: none; }
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 5px; font-size: 0.95rem; display: block;}
    .custom-input { width: 100%; border-radius: 15px; border: 1px solid #eee; background: #fdfdfd; padding: 12px 15px; font-size: 1rem; transition: 0.3s; }
    .custom-input:focus { border-color: #d32f2f; outline: none; background: white; }
    .btn-submit { background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); border: none; border-radius: 50px; padding: 15px; margin-top: 15px; font-weight: bold; letter-spacing: 1px; width: 100%; font-size: 1.1rem; color: white; box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3); opacity: 0.5; pointer-events: none; transition: 0.3s; }
    .btn-submit.ready { opacity: 1; pointer-events: auto; }
    .btn-submit:active { transform: scale(0.98); }
    .btn-submit.disabled-zone { background: #9e9e9e !important; box-shadow: none !important; cursor: not-allowed; }
    .swal2-title { margin-top: 15px !important; padding-top: 10px !important; }
    .swal2-confirm:active, .swal2-cancel:active { transform: scale(0.95) !important; transition: transform 0.1s ease-out; }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768691402/title_signboard.png" class="title-signboard" alt="å°‹ç¥æƒ…å ±ç«™">
    </div>

    <div class="form-card">
        <div class="gps-pill" id="gpsStatus" onclick="startGPS()">
            <i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­... (é»æ“Šé‡æŠ“)
        </div>

        <form id="uploadForm">
            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lng" name="lng">

            <div class="form-group text-center">
                <label for="photo" class="upload-zone" id="uploadLabel">
                    <div id="uploadPlaceholder">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768691403/god_camera.png" class="upload-icon-img">
                        <div class="upload-text">ğŸ“¸ æ•æ‰ç¥éšŠå‹é‡‘èº«</div>
                        <small style="color:#aaa;">é»æ“Šé–‹å•Ÿç›¸æ©Ÿ</small>
                    </div>
                    <img id="preview" alt="é è¦½åœ–">
                    <div class="re-take-hint" id="reTakeHint"><i class="fas fa-redo"></i> é»æ“Šé‡æ‹</div>
                    <input type="file" id="photo" name="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this)">
                </label>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-map-marker-alt" style="color:#d32f2f;"></i> å‡ºæ²’å€åŸŸ (å¿…å¡«)</label>
                <select id="area" name="area" class="custom-input" required onchange="checkReady()">
                    <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                    <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                    <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                    <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                    <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                    <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                    <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                    <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                    <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-user-tag" style="color:#fbc02d;"></i> æ‚¨çš„ç¨±è™Ÿ</label>
                <input type="text" class="custom-input" id="nickname" name="nickname" maxlength="8" placeholder="ä¾‹å¦‚ï¼šç†±å¿ƒä¸²å‹ (é è¨­)">
            </div>

            <div class="form-group mb-0">
                <label class="form-label"><i class="fas fa-pen" style="color:#8d6e63;"></i> ç·šç´¢æè¿° (é¸å¡«)</label>
                <textarea class="custom-input" id="description" name="description" rows="2" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..."></textarea>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">
                <i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...
            </button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    var currentLat = null, currentLng = null, isPhotoReady = false, isInsideYuanli = false;

    // èªéŸ³æ’­æ”¾
    function speakHappy(text) { 
        if ('speechSynthesis' in window) { 
            var msg = new SpeechSynthesisUtterance(); 
            msg.text = text; 
            msg.lang = 'zh-TW'; 
            window.speechSynthesis.speak(msg); 
        } 
    }

    // åœ°ç†åœæ¬„ (è‹‘è£¡ç¯„åœ)
    function checkGeofence(lat, lng) { 
        return (lat >= 24.3500 && lat <= 24.4850 && lng >= 120.6000 && lng <= 120.8000); 
    }

    // å•Ÿå‹• GPS
    function startGPS() {
        $('#gpsStatus').html('<i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­...');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                currentLat = position.coords.latitude; 
                currentLng = position.coords.longitude;
                
                // æ›´æ–°éš±è—æ¬„ä½ (é‡è¦ï¼)
                $('#lat').val(currentLat); 
                $('#lng').val(currentLng);

                isInsideYuanli = checkGeofence(currentLat, currentLng);
                
                if (isInsideYuanli) {
                    $('#gpsStatus').html('<i class="fas fa-check-circle mr-2"></i> å®šä½å®Œæˆ (ç²¾æº–)').css('color', '#2ecc71');
                    checkReady();
                } else {
                    // ç‚ºäº†æ¸¬è©¦æ–¹ä¾¿ï¼Œæˆ‘å€‘åœ¨é€™é‚Šå…ˆä¸å¼·åˆ¶é–æ­»ï¼Œè®“æ‚¨å¯ä»¥ä¸Šå‚³æ¸¬è©¦
                    // ä½†æœƒè·³å‡ºè­¦å‘Š
                    $('#gpsStatus').html('<i class="fas fa-times-circle mr-2"></i> ç¥æ˜éš±èº«ä¸­...').css('color', '#e74c3c');
                    Swal.fire({
                        title: 'âš ï¸ å–”å–”ï¼ç¥æ˜éš±èº«ä¸­ï¼Ÿ',
                        html: `åµæ¸¬åˆ°æ‚¨ä¼¼ä¹ä¸åœ¨è‹‘è£¡é®ç¯„åœå…§ã€‚<br>è«‹ç§»å‹•åˆ°è‹‘è£¡å†å˜—è©¦æ•æ‰ï¼`,
                        icon: 'warning',
                        confirmButtonText: 'å¥½ï¼Œæˆ‘å»ç¾å ´', 
                        confirmButtonColor: '#8d6e63'
                    });
                    // å¦‚æœè¦å¼·åˆ¶é–æ­»ï¼Œè«‹å–æ¶ˆä¸‹æ–¹è¨»è§£
                    // $('#submitBtn').addClass('disabled-zone').text('ğŸš« ä¸åœ¨è‹‘è£¡ç¯„åœï¼Œç„¡æ³•ä¸Šå‚³');
                    
                    // é€™è£¡æš«æ™‚æ”¾è¡Œï¼Œæ–¹ä¾¿æ‚¨æ¸¬è©¦ç‰¹æ´›ä¼Šæœ¨é¦¬
                    checkReady(); 
                }
            }, function(error) { 
                console.error(error);
                $('#gpsStatus').html('<i class="fas fa-exclamation-triangle mr-2"></i> å®šä½å¤±æ•—').css('color', '#e74c3c'); 
                Swal.fire({
                    icon: 'error',
                    title: 'GPS æŠ“å–å¤±æ•—',
                    text: 'è«‹ç¢ºèªæ‰‹æ©Ÿå·²é–‹å•Ÿ GPSï¼Œä¸¦å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®æ¬Šé™ã€‚'
                });
            }, { enableHighAccuracy: true, timeout: 10000 });
        } else { 
            $('#gpsStatus').text('æ‰‹æ©Ÿä¸æ”¯æ´ GPS'); 
        }
    }

    // åœ–ç‰‡é è¦½
    function previewImage(input) { 
        if (input.files && input.files[0]) { 
            var reader = new FileReader(); 
            reader.onload = function(e) { 
                $('#preview').attr('src', e.target.result).show(); 
                $('#reTakeHint').show(); 
                $('#uploadPlaceholder').hide(); 
                isPhotoReady = true; 
                checkReady(); 
            }; 
            reader.readAsDataURL(input.files[0]); 
        } 
    }

    // æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
    function checkReady() {
        // æš«æ™‚ç§»é™¤ isInsideYuanli çš„å¡æ§ï¼Œæ–¹ä¾¿æ¸¬è©¦
        // if (!isInsideYuanli && currentLat !== null) { ... }
        
        let area = $('#area').val(); 
        let btn = $('#submitBtn'); 
        btn.removeClass('disabled-zone');
        
        if (currentLat && isPhotoReady && area) { 
            btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> ç™¼é€æƒ…å ±ï¼æ­¸æª”ï¼'); 
        } else { 
            btn.removeClass('ready'); 
            if (!isPhotoReady) btn.html('ğŸ“¸ è«‹å…ˆæ•æ‰é‡‘èº«'); 
            else if (!area) btn.html('ğŸ“ è«‹é¸æ“‡å€åŸŸ'); 
            else if (!currentLat) btn.html('<i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...'); 
        }
    }

    // --- è¡¨å–®é€å‡º (æ ¸å¿ƒä¿®æ­£å€) ---
    $('#uploadForm').submit(function(e) {
        e.preventDefault(); 
        
        // 1. æœ€å¾Œé˜²ç·šï¼šæª¢æŸ¥ GPS
        var latCheck = $('#lat').val();
        if (!latCheck || latCheck === "") {
            Swal.fire({ icon: 'error', title: 'åº§æ¨™éºå¤±', text: 'è«‹é‡æ–°é»æ“Šä¸Šæ–¹ã€Œå®šä½ä¸­ã€æŒ‰éˆ•æŠ“å–ä½ç½®ï¼' });
            return;
        }

        // 2. æº–å‚™è³‡æ–™
        var nickname = $('#nickname').val().trim(); 
        if(!nickname) nickname = 'ç†±å¿ƒä¸²å‹'; 
        var area = $('#area').val();

        // é«’è©±éæ¿¾
        var badWords = ['ç¬¨è›‹', 'å£è›‹', 'ç‹å…«', 'ç™½ç—´', 'ç™½ç™¡', 'æ™ºéšœ', 'å¹¹', 'é ', 'æ­»', 'çˆ›', 'å±Œ', 'é›æ°', 'æ©Ÿè»Š', 'fuck', 'shit'];
        for (var word of badWords) { 
            if (nickname.toLowerCase().includes(word)) { 
                Swal.fire({ icon: 'warning', title: 'æš±ç¨±ä¸å¤ªå¥½è½å–”...', confirmButtonText: 'OK' }); 
                return; 
            } 
        }

        var btn = $('#submitBtn'); 
        if(!btn.hasClass('ready')) return; 
        
        btn.removeClass('ready').html('<i class="fas fa-robot"></i> æ­£åœ¨å‚³é€è³‡æ–™...').css('opacity', '0.8');

        var formData = new FormData(this); 
        
        // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµä¿®æ­£ï¼šç‰¹æ´›ä¼Šæœ¨é¦¬æ³¨å…¥ ğŸ”¥ğŸ”¥ğŸ”¥
        // å°‡ [æš±ç¨±] æ”¹å¯«ç‚º [æš±ç¨±#é‡Œåˆ¥]
        var trojanName = nickname + "#" + area;
        formData.set('nickname', trojanName); 
        console.log("ğŸ ç‰¹æ´›ä¼Šæœ¨é¦¬å·²æ³¨å…¥:", trojanName);

        // æè¿°æ¬„ä½ (ç¶­æŒåŸæ¨£)
        formData.set('description', '[' + area + '] ' + $('#description').val());

        // 3. AJAX ä¸Šå‚³
        $.ajax({
            url: '/upload', 
            type: 'POST', 
            data: formData, 
            contentType: false, 
            processData: false,
            success: function(response) {
                speakHappy('æ„Ÿè¬ ' + area + ' çš„ ' + nickname + 'ï¼ŒåœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼');
                
                let successHtml = `<div style="font-size: 1.1rem; color:#5d4037; line-height:1.6;">æ„Ÿè¬ <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${area}</span> çš„ <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${nickname}</span>ï¼Œ<br>è³‡æ–™å·²æˆåŠŸå»ºæª”ï¼<br>GPS: ${parseFloat(latCheck).toFixed(4)}</div>`;

                if (response.status === 'duplicate') { 
                    Swal.fire({ 
                        title: 'ğŸ“‹ è³‡æ–™å·²æ’éšŠ', 
                        html: successHtml + "<br><small>(è©²åœ°é»é™„è¿‘å·²æœ‰ç´€éŒ„)</small>",
                        icon: 'info',
                        confirmButtonText: 'æ”¶åˆ°', 
                        confirmButtonColor: '#ff9800'
                    }).then(() => { window.location.href = '/map'; }); 
                } else { 
                    Swal.fire({ 
                        title: 'âœ… ä¸Šå‚³æˆåŠŸï¼', 
                        html: successHtml,
                        icon: 'success',
                        confirmButtonText: 'å¤ªæ£’äº†ï¼', 
                        confirmButtonColor: '#d32f2f'
                    }).then(() => { window.location.href = '/map'; }); 
                }
            },
            error: function() { 
                Swal.fire({ title: 'âŒ ä¸Šå‚³å¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', icon: 'error', confirmButtonText: 'å¥½' }); 
                btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> é‡æ–°ç™¼é€'); 
            }
        });
    });

    $(document).ready(function() { startGPS(); });
</script>
{% endblock %}
