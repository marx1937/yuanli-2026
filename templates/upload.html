<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›å ±åœŸåœ°å…¬ä½ç½®</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            background-color: #fff8e1;
            padding-bottom: 90px;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .app-header {
            background: linear-gradient(135deg, #d32f2f, #8e0000);
            color: #ffeb3b;
            padding: 15px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid #ffc107;
        }

        /* âš ï¸ FB/LINE è­¦å‘Šæ¢ */
        #browser-warning {
            display: none;
            background-color: #ffc107;
            color: #856404;
            padding: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        /* ç›¸æ©Ÿå€å¡Š */
        .camera-zone {
            background-color: #ffffff;
            border-radius: 15px;
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            border: 2px dashed #d32f2f;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .camera-zone:active { background-color: #fff3cd; }
        .camera-icon { font-size: 3rem; color: #d32f2f; }
        #previewImg { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* ç‹€æ…‹æ–‡å­—å°è—¥ä¸¸ */
        .status-pill {
            background: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: inline-block;
            border: 1px solid #dee2e6;
        }

        /* åº•éƒ¨å›ºå®šæŒ‰éˆ•å€ */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .btn-main {
            width: 100%;
            height: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 25px;
        }
    </style>
</head>
<body>

    <img src="/static/up.png" alt="å°å¹«æ‰‹" 
         style="position: fixed; bottom: 75px; right: 0px; width: 130px; height: auto; z-index: 9999; pointer-events: none; opacity: 0.9;">

    <div class="app-header">
        <div style="float:left;"><a href="/" style="color:white;"><i class="fas fa-chevron-left"></i> å›é¦–é </a></div>
        <i class="fas fa-camera"></i> åœŸåœ°å…¬æŸ¥å ±
    </div>

    <div id="browser-warning">
        <i class="fas fa-exclamation-triangle"></i> <strong>å»ºè­°ä½¿ç”¨ Chrome/Safari</strong><br>
        è‡‰æ›¸/LINE å¯èƒ½ç„¡æ³•å®šä½ï¼Œè«‹é»å³ä¸Šè§’é¸ã€Œä»¥ç€è¦½å™¨é–‹å•Ÿã€
    </div>

    <div class="container mt-3">
        
        <div class="text-center">
            <div class="status-pill" id="statusText">
                <i class="fas fa-satellite-dish"></i> è¡›æ˜Ÿå®šä½ä¸­...
            </div>
        </div>

        <div class="camera-zone" onclick="$('#fileInput').click()">
            <div id="cameraPlaceholder" class="text-center">
                <i class="fas fa-camera camera-icon"></i>
                <p class="mt-2" style="color: #d32f2f; font-weight: bold;">æ‹æ”åœŸåœ°å…¬å»Ÿ</p>
                <small class="text-muted">é»æ“Šé–‹å•Ÿç›¸æ©Ÿ</small>
            </div>
            <img id="previewImg" alt="é è¦½åœ–">
        </div>

        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;" onchange="previewFile()">

        <div class="card border-0 shadow-sm mb-3" style="background-color: rgba(255,255,255,0.9);">
            <div class="card-body">
                
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt text-danger"></i> é€™ä½åœŸåœ°å…¬ä½å“ªè£¡ï¼Ÿ</label>
                    <select class="form-control" id="area" style="font-size: 1.1rem; border-radius: 20px; height: 50px;">
                        <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                        <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option>
                        <option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option>
                        <option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                        <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option>
                        <option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option>
                        <option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                        <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option>
                        <option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option>
                        <option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                        <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option>
                        <option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option>
                        <option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                        <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option>
                        <option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option>
                        <option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                        <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option>
                        <option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option>
                        <option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                        <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option>
                        <option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option>
                        <option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                        <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option>
                        <option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option>
                        <option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                        <option value="å…¶ä»–">å…¶ä»– / ä¸ç¢ºå®š</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-user text-info"></i> ä½ æ˜¯å“ªä½ç¥éšŠå‹ï¼Ÿ(é¸å¡«)</label>
                    <input type="text" class="form-control" id="nickname" placeholder="ç†±å¿ƒä¸²å‹">
                    <small class="text-muted">ä¸­è‹±æ–‡çš†å¯ï¼Œè«‹å‹¿ä½¿ç”¨ä¸é›…å­—çœ¼</small>
                </div>

                <div class="form-group mb-0">
                    <label><i class="fas fa-book-open text-warning"></i> é—œæ–¼ç¥‚çš„å°æ•…äº‹</label>
                    <textarea class="form-control" id="note" rows="3" placeholder="ã€Œä¾‹å¦‚ï¼šè½èªªé€™è£¡æ±‚è²¡å¾ˆéˆé©—ï¼Œæˆ–æ˜¯æ—é‚Šæœ‰æ£µå¤§æ¦•æ¨¹...(é¸å¡«)"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed-footer">
        <button id="submitBtn" class="btn btn-secondary btn-main" onclick="uploadData()" disabled>
            <i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    var currentLat = null;
    var currentLng = null;
    var fileBlob = null; 

    $(document).ready(function() {
        // 1. FB/LINE åµæ¸¬
        var ua = navigator.userAgent || navigator.vendor || window.opera;
        if ((ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1)) {
            $('#browser-warning').show();
        }

        // 2. GPS å®šä½
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    
                    var dist = getDistanceFromLatLonInKm(currentLat, currentLng, 24.4432, 120.6547);
                    
                    if (dist > 15) {
                        $('#statusText').html('<i class="fas fa-times-circle text-danger"></i> è¶…å‡ºæœå‹™ç¯„åœ (' + dist.toFixed(1) + 'km)');
                        $('#submitBtn').text('ğŸš« è·é›¢å¤ªé ï¼Œç„¡æ³•ä¸Šå‚³');
                        currentLat = null; 
                    } else {
                        $('#statusText').html('<i class="fas fa-map-marker-alt text-success"></i> å®šä½å®Œæˆ');
                        checkReady(); 
                    }
                },
                function(error) {
                    $('#statusText').html('<i class="fas fa-exclamation-triangle text-warning"></i> ç„¡æ³•å–å¾—å®šä½');
                    Swal.fire({
                        icon: 'warning',
                        title: 'ç„¡æ³•å®šä½',
                        text: 'è«‹å…è¨±æ‰‹æ©Ÿé–‹å•Ÿä½ç½®æ¬Šé™ï¼Œæ‰èƒ½ç´€éŒ„åœ°é»å–”ï¼'
                    });
                },
                { enableHighAccuracy: true } 
            );
        } else {
            Swal.fire('æ‚¨çš„æ‰‹æ©Ÿä¸æ”¯æ´ GPS');
        }
    });

    // ç…§ç‰‡è™•ç†
    function previewFile() {
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        if (!file) return; 

        fileBlob = null;
        $('#cameraPlaceholder').hide();
        var previewImg = document.getElementById('previewImg');
        previewImg.style.display = 'block';
        previewImg.src = URL.createObjectURL(file);

        $('#statusText').html('<i class="fas fa-spinner fa-spin"></i> ç…§ç‰‡è™•ç†ä¸­...');

        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            var img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var maxWidth = 800;
                var scale = maxWidth / img.width;
                var width = (img.width > maxWidth) ? maxWidth : img.width;
                var height = (img.width > maxWidth) ? (img.height * scale) : img.height;

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(function(blob) {
                    fileBlob = blob;
                    $('#statusText').html('<i class="fas fa-image text-success"></i> ç…§ç‰‡å·²æº–å‚™å¥½');
                    checkReady();
                }, 'image/jpeg', 0.8);
            };
        };
    }

    function checkReady() {
        if (currentLat && fileBlob) {
            $('#submitBtn').prop('disabled', false)
                          .removeClass('btn-secondary')
                          .addClass('btn-danger') 
                          .html('ç¢ºèªä¸Šå‚³');
        } else if (currentLat) {
            $('#submitBtn').html('è«‹å…ˆä¸Šæ–¹æ‹ç…§');
        }
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1);  
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
    }
    function deg2rad(deg) { return deg * (Math.PI/180) }

    // --- ä¸Šå‚³åŠŸèƒ½ ---
    function uploadData() {
        if(!fileBlob || !currentLat) return;
        var area = $('#area').val();
        var rawName = $('#nickname').val() || ''; 
        
        // 1. æª¢æŸ¥åœ°é»
        if(!area) {
            Swal.fire({
                icon: 'warning',
                title: 'å¿˜äº†é¸åœ°é»ï¼Ÿ',
                text: 'è«‹è¨˜å¾—é¸æ“‡ã€Œé‡Œåˆ¥ã€ï¼ŒåœŸåœ°å…¬æ‰çŸ¥é“ä»–åœ¨å“ªå–”ï¼',
                confirmButtonText: 'å¥½ï¼Œæˆ‘é¸ä¸€ä¸‹',
                confirmButtonColor: '#ff9800'
            });
            return;
        }

        // ğŸ‘®â€â™‚ï¸ é«’è©±éæ¿¾å™¨
        var lowerName = rawName.toLowerCase();
        var badWords = [
            'ç¬¨è›‹', 'å£è›‹', 'ç‹å…«', 'ç™½ç—´', 'å¹¹', 'æ­»', 'çˆ›', 'å±Œ', 'é›æ°', 
            'fuck', 'shit', 'bitch', 'asshole', 'cunt', 'dick', 'sex'
        ]; 
        
        for (var i = 0; i < badWords.length; i++) {
            if (lowerName.includes(badWords[i])) {
                Swal.fire({
                    imageUrl: '/static/377.jpg',
                    imageWidth: '100%', 
                    imageHeight: 'auto',
                    title: 'æš±ç¨±ä¸å¤ªå¥½è½å–”...',
                    html: 'è«‹ä½¿ç”¨å„ªé›…ä¸€é»çš„åå­—ï¼Œ<br>åœŸåœ°å…¬æ‰è½å¾—æ‡‚ï¼',
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'OK'
                });
                return; 
            }
        }

        $('#submitBtn').html('<i class="fas fa-robot"></i> å‚³é€ä¸­...')
                      .prop('disabled', true);

        var formData = new FormData();
        formData.append('photo', fileBlob);
        formData.append('lat', currentLat);
        formData.append('lng', currentLng);
        formData.append('note', $('#note').val());
        formData.append('nickname', rawName);
        formData.append('area', area);

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                var displayName = rawName ? rawName : 'ç†±å¿ƒä¸²å‹';

                // ğŸ”´ 2. é•è¦ (å¾Œç«¯)ï¼š377.jpg
                if (response.status === 'block') {
                    Swal.fire({
                        imageUrl: '/static/377.jpg',
                        imageWidth: '100%', 
                        imageHeight: 'auto',
                        title: 'âš ï¸ æš±ç¨±é•è¦',
                        text: response.message, 
                        confirmButtonText: 'å¥½ï¼Œæˆ‘æ”¹ä¸€ä¸‹',
                        confirmButtonColor: '#d33'
                    });
                    $('#submitBtn').html('ç¢ºèªä¸Šå‚³').prop('disabled', false);
                    return; 
                }

                // ğŸŸ¡ 3. é‡è¤‡æŠ•ç¨¿ (å¾…å¯©)ï¼špada.jpg
                if (response.status === 'pending') {
                    Swal.fire({
                        imageUrl: '/static/pada.jpg',  
                        imageWidth: '100%', 
                        imageHeight: 'auto',
                        title: 'ğŸ“‹ è³‡æ–™å·²é€äº¤å¯©æ ¸',
                        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é€™è£¡æ”¹äº†æ’ç‰ˆ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                        html: `æ„Ÿè¬æ‚¨ï¼ä¸éæ­¤åœ°é» (<b>${area}</b>)<br>é™„è¿‘ä¼¼ä¹å·²æœ‰ç™»å…¥ç´€éŒ„ã€‚<br><br>
                               æ‚¨çš„ç…§ç‰‡å·²å­˜å…¥<br><b>ã€Œå¾…å¯©æ ¸æ¸…å–®ã€</b><br>
                               ç®¡ç†å“¡ç¢ºèªå“è³ªå¾Œå°±æœƒæ›´æ–°ï¼`,
                        
                        confirmButtonText: 'æ”¶åˆ°ï¼Œä¾†å»æ‰¾ä¸‹ä¸€åº§ï¼',
                        confirmButtonColor: '#ff9800'
                    }).then(() => {
                        window.location.href = '/map';
                    });
                } 
                // ğŸŸ¢ 4. æˆåŠŸï¼šhappy.jpg
                else {
                    var sayText = 'æ„Ÿè¬ ' + area + ' çš„ ' + displayName + 'ï¼ŒåœŸåœ°å…¬æ”¶åˆ°å›‰ï¼';
                    
                    Swal.fire({
                        title: 'âœ… ä¸Šå‚³æˆåŠŸï¼',
                        text: sayText,
                        imageUrl: '/static/happy.jpg',
                        imageWidth: '100%', 
                        imageHeight: 'auto',
                        imageAlt: 'åœŸåœ°å…¬',
                        confirmButtonText: 'å¤ªæ£’äº†ï¼',
                        confirmButtonColor: '#d32f2f'
                    }).then(() => {
                        window.location.href = '/map';
                    });
                }
            },
            error: function() {
                Swal.fire({
                    title: 'âŒ ä¸Šå‚³å¤±æ•—',
                    text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚',
                    icon: 'error',
                    confirmButtonText: 'å¥½'
                });
                $('#submitBtn').html('ç¢ºèªä¸Šå‚³').prop('disabled', false);
            }
        });
    }
    </script>
</body>
</html>
