{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    /* å…¨å±€èƒŒæ™¯ */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        padding-bottom: 100px;
        /* é˜²æ­¢ iOS é»æ“Šé–ƒçˆ */
        -webkit-tap-highlight-color: transparent;
    }

    .page-header { text-align: center; padding: 25px 0 10px 0; width: 100%; position: relative; }
    
    .page-title-img {
        width: 85%; max-width: 320px; 
        height: auto; display: block; margin: 0 auto;
        filter: drop-shadow(0 8px 15px rgba(93, 64, 55, 0.4));
        animation: float-title 4s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    .form-card {
        background: rgba(255, 255, 255, 0.95); width: 92%; max-width: 500px;
        padding: 25px; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
        margin: 10px auto; position: relative;
        border: 2px solid #fff;
    }

    .gps-pill {
        background: #fff8e1; padding: 8px 15px; border-radius: 50px;
        font-size: 0.9rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex; align-items: center; justify-content: center;
        border: 1px solid #ffe0b2; color: #f57c00;
        margin-bottom: 20px; width: 100%; cursor: pointer;
    }
    
    .upload-zone {
        border: 2px dashed #d7ccc8; border-radius: 20px;
        min-height: 250px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: #fafafa;
        cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .upload-zone:active { background: #fff; border-color: #d32f2f; transform: scale(0.98); }
    
    /* é‡‘èº«åœŸåœ°å…¬ (çµ•å°è·¯å¾‘) */
    .god-camera-img {
        width: 150px; height: auto; object-fit: contain; margin-bottom: 10px; 
        filter: drop-shadow(0 0 15px rgba(255, 193, 7, 0.5));
        animation: breathe-god 3s infinite ease-in-out;
    }
    @keyframes breathe-god {
        0%, 100% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(255, 193, 7, 0.5)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 25px rgba(255, 193, 7, 0.8)); }
    }
    
    .upload-text { font-weight: bold; color: #8d6e63; font-size: 1.1rem; margin-top: 5px; }
    
    #preview { 
        width: 100%; height: 100%; position: absolute; top:0; left:0;
        object-fit: cover; display: none; 
    }
    .re-take-hint {
        position: absolute; bottom: 10px; background: rgba(0,0,0,0.6); color: white;
        padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; pointer-events: none;
        display: none;
    }

    .form-group { margin-bottom: 15px; text-align: left; }
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 5px; font-size: 0.95rem; display: block;}
    .custom-input {
        width: 100%; border-radius: 15px; border: 1px solid #eee; background: #fdfdfd;
        padding: 12px 15px; font-size: 1rem; transition: 0.3s;
    }
    .custom-input:focus { border-color: #d32f2f; outline: none; background: white; }
    .custom-input::placeholder { color: #ccc; }

    .btn-submit {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        border: none; border-radius: 50px; padding: 15px; margin-top: 15px;
        font-weight: bold; letter-spacing: 1px; width: 100%; font-size: 1.1rem; color: white;
        box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
        opacity: 0.5; pointer-events: none; transition: 0.3s;
    }
    .btn-submit.ready { opacity: 1; pointer-events: auto; }
    .btn-submit:active { transform: scale(0.98); }

    /* éœéŸ³æç¤º */
    .mute-hint {
        text-align: center; font-size: 0.8rem; color: #999; margin-top: 10px;
        opacity: 0; transition: opacity 2s;
    }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/title_signboard.png" class="page-title-img" alt="å°‹ç¥æƒ…å ±ç«™">
    </div>

    <div class="form-card">
        
        <div class="gps-pill" id="gpsStatus" onclick="startGPS()">
            <i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­... (é»æ“Šé‡æŠ“)
        </div>

        <form id="uploadForm">
            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lng" name="lng">

            <div class="form-group text-center">
                <label for="photo" class="upload-zone" id="uploadLabel">
                    <div id="uploadPlaceholder">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768691403/god_camera.png" 
                             class="god-camera-img" 
                             alt="è«‹ä¸Šå‚³ç…§ç‰‡">
                        
                        <div class="upload-text">ğŸ“¸ é»æ­¤å¥‰ä¸Šç¥è·¡ç…§ç‰‡</div>
                        <small style="color:#aaa;">é–‹å•Ÿç›¸æ©Ÿæ•æ‰é‡‘èº«</small>
                    </div>
                    
                    <img id="preview" alt="é è¦½åœ–">
                    <div class="re-take-hint" id="reTakeHint"><i class="fas fa-redo"></i> é»æ“Šé‡æ‹</div>

                    <input type="file" id="photo" name="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this)">
                </label>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-map-marker-alt" style="color:#d32f2f;"></i> å‡ºæ²’å€åŸŸ (å¿…å¡«)</label>
                <select id="area" name="area" class="custom-input" required onchange="checkReady()" onfocus="GodVoice.unlock()">
                    <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                    <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                    <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                    <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                    <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                    <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                    <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                    <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                    <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-user-tag" style="color:#fbc02d;"></i> æ‚¨çš„ç¨±è™Ÿ</label>
                <input type="text" class="custom-input" id="nickname" name="nickname" maxlength="8" placeholder="ä¾‹å¦‚ï¼šç†±å¿ƒä¸²å‹ (é è¨­)" onfocus="GodVoice.unlock()">
            </div>

            <div class="form-group mb-0">
                <label class="form-label"><i class="fas fa-pen" style="color:#8d6e63;"></i> ç·šç´¢æè¿° (é¸å¡«)</label>
                <textarea class="custom-input" id="description" name="description" rows="2" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..." onfocus="GodVoice.unlock()"></textarea>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">
                <i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...
            </button>
            <div class="mute-hint" id="muteHint">ğŸ’¡ è«‹é–‹å•ŸéŸ³é‡ï¼Œè†è½åœŸåœ°å…¬çš„ç¥ç¦</div>
        </form>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- ğŸ”¥ çµ‚æ¥µèªéŸ³å¼•æ“ GodVoice (æŠ— iOS éœéŸ³ç‰ˆ) ---
    const GodVoice = {
        hasUnlocked: false,
        keepAlive: [], // é˜²æ­¢ GC å›æ”¶

        // 1. éœé»˜è§£é–ï¼šåœ¨ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡è§¸æ‘¸è¢å¹•æ™‚åŸ·è¡Œ
        unlock: function() {
            if (this.hasUnlocked || !('speechSynthesis' in window)) return;
            
            // æ’­æ”¾ä¸€å€‹æ¥µçŸ­çš„ç©ºç™½éŸ³è¨Šï¼Œè®“ç€è¦½å™¨èªç‚º "AudioContext å·²å•Ÿç”¨"
            const u = new SpeechSynthesisUtterance('');
            u.volume = 0; // éœéŸ³
            window.speechSynthesis.speak(u);
            this.hasUnlocked = true;
            // console.log("GodVoice Unlocked ğŸ”“");
        },

        // 2. çµ„åˆæ‹³æ’­æ”¾ï¼šä¸€æ¬¡æŠŠæ‰€æœ‰è©±è¬›å®Œï¼Œä¸ä¾è³´ AJAX Callback
        speakCombo: function(text1, text2) {
            if (!('speechSynthesis' in window)) return;

            // å¼·åˆ¶é‡ç½®ï¼Œé˜²æ­¢å¡ä½
            window.speechSynthesis.cancel();
            this.keepAlive = []; // æ¸…ç©ºèˆŠçš„

            // å»ºç«‹ç¬¬ä¸€å¥ (æ”¶åˆ°)
            const u1 = new SpeechSynthesisUtterance(text1);
            u1.lang = 'zh-TW'; u1.rate = 1.0; u1.pitch = 1.0;
            
            // å»ºç«‹ç¬¬äºŒå¥ (æ„Ÿè¬è©)
            const u2 = new SpeechSynthesisUtterance(text2);
            u2.lang = 'zh-TW'; u2.rate = 1.0; u2.pitch = 1.0;
            
            // *** é—œéµæŠ€å·§ ***
            // å°‡ç‰©ä»¶æ”¾å…¥å…¨åŸŸé™£åˆ—ï¼Œé˜²æ­¢ç€è¦½å™¨åœ¨æ’­æ”¾ä¸­é€”å›æ”¶è¨˜æ†¶é«”
            this.keepAlive.push(u1, u2);

            // ä¾åºæ’­æ”¾ (Queue æ©Ÿåˆ¶)
            window.speechSynthesis.speak(u1);
            window.speechSynthesis.speak(u2);
            
            // é¡¯ç¤ºæç¤º
            $('#muteHint').css('opacity', 1);
        }
    };

    // å…¨å±€ç›£è½é»æ“Šï¼Œç¢ºä¿è‡³å°‘è§£é–ä¸€æ¬¡ (é‡å°é‚£äº›æ²’é»è¼¸å…¥æ¡†ç›´æ¥é€å‡ºçš„äºº)
    document.body.addEventListener('touchstart', function() { GodVoice.unlock(); }, {once:true, passive:true});
    document.body.addEventListener('click', function() { GodVoice.unlock(); }, {once:true});


    // --- åŸæœ‰é‚è¼¯ ---
    var currentLat = null, currentLng = null;
    var isPhotoReady = false;

    function startGPS() {
        $('#gpsStatus').html('<i class="fas fa-satellite-dish fa-spin mr-2"></i> å®šä½ä¸­...');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLat = position.coords.latitude; 
                    currentLng = position.coords.longitude;
                    $('#lat').val(currentLat); $('#lng').val(currentLng);
                    $('#gpsStatus').html('<i class="fas fa-check-circle mr-2"></i> å®šä½å®Œæˆ (ç²¾æº–)').css('color', '#2ecc71');
                    checkReady();
                }, 
                function(error) { 
                    $('#gpsStatus').html('<i class="fas fa-exclamation-triangle mr-2"></i> å®šä½å¤±æ•— (é»æ“Šé‡è©¦)').css('color', '#e74c3c');
                },
                { timeout: 10000 }
            );
        } else {
            $('#gpsStatus').text('æ‰‹æ©Ÿä¸æ”¯æ´ GPS');
        }
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#preview').attr('src', e.target.result).show();
                $('#reTakeHint').show();
                $('#uploadPlaceholder').hide();
                isPhotoReady = true;
                checkReady();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function checkReady() {
        let area = $('#area').val();
        let btn = $('#submitBtn');
        if (currentLat && isPhotoReady && area) {
            btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> ç™¼é€æƒ…å ±ï¼æ­¸æª”ï¼');
        } else {
            btn.removeClass('ready');
            if (!isPhotoReady) btn.html('ğŸ“¸ è«‹å…ˆæ•æ‰é‡‘èº«');
            else if (!area) btn.html('ğŸ“ è«‹é¸æ“‡å€åŸŸ');
            else if (!currentLat) btn.html('<i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS å®šä½...');
        }
    }

    $('#uploadForm').submit(function(e) {
        e.preventDefault();
        
        var nickname = $('#nickname').val().trim();
        if(!nickname) nickname = 'ç†±å¿ƒä¸²å‹'; 
        var area = $('#area').val();

        // 1. ä¸é›…å­—éæ¿¾
        var badWords = ['ç¬¨è›‹', 'å£è›‹', 'ç‹å…«', 'ç™½ç—´', 'ç™½ç™¡', 'æ™ºéšœ', 'å¹¹', 'é ', 'æ­»', 'çˆ›', 'å±Œ', 'é›æ°', 'æ©Ÿè»Š', 'fuck', 'shit']; 
        for (var word of badWords) {
            if (nickname.toLowerCase().includes(word)) {
                Swal.fire({
                    imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/377.jpg',
                    imageWidth: '100%', imageHeight: 'auto',
                    title: 'æš±ç¨±ä¸å¤ªå¥½è½å–”...', 
                    text: 'è«‹ä½¿ç”¨å„ªé›…ä¸€é»çš„åå­—ï¼ŒåœŸåœ°å…¬æ‰è½å¾—æ‡‚ï¼',
                    confirmButtonColor: '#d33', confirmButtonText: 'OK'
                });
                return; 
            }
        }

        var btn = $('#submitBtn');
        if(!btn.hasClass('ready')) return;

        // ğŸ”¥ğŸ”¥ğŸ”¥ çµ‚æ¥µå¥§ç¾©ï¼šç›´æ¥åœ¨ Click Event è£¡æŠŠæ‰€æœ‰è©±è¬›å®Œ (Optimistic UI) ğŸ”¥ğŸ”¥ğŸ”¥
        // é€™æ¨£å°±ä¸æœƒè¢«ç€è¦½å™¨åˆ¤å®šç‚º "AJAX å¾Œçš„è‡ªå‹•æ’­æ”¾" è€Œé˜»æ“‹
        GodVoice.speakCombo(
            "æ”¶åˆ°ï¼Œè³‡æ–™å‚³é€ä¸­ã€‚", 
            "æ„Ÿè¬ " + area + " çš„ " + nickname + "ï¼ŒåœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼"
        );

        // UI è®Šæ›´
        btn.removeClass('ready').html('<i class="fas fa-robot"></i> æ­£åœ¨å‚³é€è³‡æ–™...').css('opacity', '0.8');

        var formData = new FormData(this);
        formData.set('nickname', nickname);
        var desc = $('#description').val();
        formData.set('description', '[' + area + '] ' + desc);

        $.ajax({
            url: '/upload', type: 'POST', data: formData, contentType: false, processData: false,
            success: function(response) {
                // AJAX æˆåŠŸé€™è£¡åªè¦è² è²¬è·³è¦–çª—å°±å¥½ï¼Œè²éŸ³å‰›å‰›å·²ç¶“è¬›äº†
                if (response.status === 'duplicate') {
                    Swal.fire({
                        imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/guide_couple.png', 
                        imageWidth: '100%', 
                        title: 'ğŸ“‹ è³‡æ–™å·²é€äº¤å¯©æ ¸',
                        html: `æ„Ÿè¬æ‚¨ï¼ä¸éæ­¤åœ°é» (${area}) é™„è¿‘ä¼¼ä¹å·²æœ‰æŸ¥å ±ç´€éŒ„ã€‚<br>ç®¡ç†å“¡ç¢ºèªå“è³ªå¾Œå°±æœƒæ›´æ–°ï¼`,
                        confirmButtonText: 'æ”¶åˆ°ï¼Œä¾†å»æ‰¾ä¸‹ä¸€åº§ï¼', confirmButtonColor: '#ff9800'
                    }).then(() => { window.location.href = '/map'; });
                } else {
                    Swal.fire({
                        title: 'âœ… ä¸Šå‚³æˆåŠŸï¼', 
                        html: `æ„Ÿè¬ <b>${area}</b> çš„ <b>${nickname}</b><br><br><span style="font-size: 1.2rem; color: #d32f2f; font-weight: bold;">åœŸåœ°å…¬æ”¶åˆ°å›‰ï¼</span>`, 
                        imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/happy.jpg', 
                        imageWidth: '100%',
                        confirmButtonText: 'å¤ªæ£’äº†ï¼', confirmButtonColor: '#d32f2f'
                    }).then(() => { window.location.href = '/map'; });
                }
            },
            error: function() {
                Swal.fire({ title: 'âŒ ä¸Šå‚³å¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', icon: 'error', confirmButtonText: 'å¥½' });
                btn.addClass('ready').html('<i class="fas fa-paper-plane"></i> é‡æ–°ç™¼é€');
            }
        });
    });

    $(document).ready(function() { startGPS(); });
</script>
{% endblock %}
