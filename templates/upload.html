{% extends "base.html" %}
{% set active_page = "upload" %}

{% block title %}å°‹ç¥æƒ…å ±ç«™ - æ•æ‰é‡‘èº«{% endblock %}

{% block styles %}
<style>
    /* ğŸŒ é¦™è•‰å»ºè­° 1ï¼šå»¶çºŒæº«æš–æ„Ÿ - æš–ç±³è‰²é»ç‹€èƒŒæ™¯ */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        font-family: "Microsoft JhengHei", sans-serif;
    }

    /* é ‚éƒ¨æ¨™é¡Œ - å»Ÿå®‡åŒ¾é¡é¢¨æ ¼ */
    .temple-header {
        text-align: center;
        padding: 30px 0 10px 0;
    }
    .temple-badge {
        background: #d32f2f;
        color: #fff;
        display: inline-block;
        padding: 10px 30px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 1.3rem;
        box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        border: 2px solid #fff8e1;
        position: relative;
    }

    /* å°å¹«æ‰‹æ¢é ­ (Mascot) */
    .helper-peek {
        position: absolute;
        top: 20px;
        right: 15px;
        width: 100px;
        z-index: 10;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        animation: peek-float 3s ease-in-out infinite;
    }
    @keyframes peek-float { 0%, 100% { transform: translateY(0) rotate(15deg); } 50% { transform: translateY(-5px) rotate(10deg); } }

    /* è¡¨å–®å¡ç‰‡ */
    .form-card {
        background: rgba(255, 255, 255, 0.98);
        width: 92%;
        max-width: 450px;
        margin: 0 auto;
        padding: 25px;
        border-radius: 30px;
        box-shadow: 0 15px 40px rgba(93, 64, 55, 0.1);
        border: 1px solid #efebe9;
        margin-top: 10px;
    }

    /* ğŸŒ é¦™è•‰å»ºè­° 2ï¼šæ ¸å¿ƒè¡Œå‹•å€ - é‡‘è‰²è™›ç·šæ¡† */
    .upload-zone {
        border: 3px dashed #fbc531; /* é‡‘è‰²è™›ç·š */
        border-radius: 20px;
        min-height: 240px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #fffdf5; /* æ¥µæ·¡æš–é»ƒ */
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    .upload-zone:active { transform: scale(0.98); background: #fffde7; }
    
    .upload-icon { 
        font-size: 3.5rem; 
        color: #d32f2f; /* ğŸŒ æ­£ç´…è‰²ç›¸æ©Ÿ */
        margin-bottom: 15px; 
        filter: drop-shadow(0 2px 4px rgba(211, 47, 47, 0.2));
        z-index: 5;
    }
    
    /* æ ¸å¿ƒå€æµ®æ°´å° */
    .watermark {
        position: absolute;
        font-size: 9rem;
        color: rgba(251, 197, 49, 0.08); /* è¶…æ·¡é‡‘è‰²æµ®æ°´å° */
        z-index: 1;
        pointer-events: none;
    }

    /* GPS ç‹€æ…‹ Pill (ğŸŒ é¦™è•‰å»ºè­° 3ï¼šæ”¶æ–‚è‰²å½©) */
    .gps-pill {
        background: #fff3e0;
        padding: 8px 15px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        border: 1px solid #ffcc80;
        color: #e65100; /* å¤§åœ°æ©˜è‰² */
    }

    .btn-refresh-gps {
        background: #fff;
        border: 1px solid #d7ccc8;
        padding: 8px 15px;
        border-radius: 50px;
        color: #8d6e63;
        font-size: 0.85rem;
        font-weight: bold;
        margin-left: 8px;
    }

    /* ğŸŒ é¦™è•‰å»ºè­° 4ï¼šUI ç´°ç¯€ç£¨åœ“ */
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 8px; font-size: 0.95rem; }
    .custom-input {
        border-radius: 15px; /* åœ“è§’ */
        border: 2px solid #efebe9;
        background: #fafafa;
        padding: 12px 18px;
        height: auto;
        font-size: 1rem;
        transition: 0.3s;
        color: #5d4037;
    }
    .custom-input:focus { border-color: #fbc531; background: white; outline: none; }

    /* æäº¤æŒ‰éˆ• */
    .btn-submit {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        border: none;
        border-radius: 50px;
        padding: 16px;
        margin-top: 20px;
        font-weight: bold;
        width: 100%;
        font-size: 1.2rem;
        color: white;
        box-shadow: 0 8px 20px rgba(183, 28, 28, 0.3);
    }
    /* ğŸŒ æš–ç°è‰²ç¦ç”¨ */
    .btn-submit:disabled {
        background: #d7ccc8;
        color: #fff;
        box-shadow: none;
    }

    #preview { width: 100%; height: auto; object-fit: contain; border-radius: 15px; display: none; z-index: 10; }
</style>
{% endblock %}

{% block content %}
    <div class="temple-header">
        <div class="temple-badge">å°‹ç¥æƒ…å ±ç«™</div>
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/mascot_couple.png" class="helper-peek" alt="å°å¹«æ‰‹">
    </div>

    <div class="form-card">
        <form id="uploadForm">
            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lng" name="lng">

            <div class="d-flex justify-content-center align-items-center mb-3">
                <div id="gpsStatus" class="gps-pill">
                    <i class="fas fa-satellite-dish fa-spin mr-2"></i> æ–¹ä½æ„Ÿæ‡‰ä¸­...
                </div>
                <button type="button" class="btn-refresh-gps" onclick="startGPS()">
                    <i class="fas fa-sync-alt"></i> é‡æ–°åµæ¸¬
                </button>
            </div>

            <div class="form-group text-center">
                <label for="photo" class="upload-zone">
                    <i class="fas fa-crosshairs watermark"></i> <div id="uploadPlaceholder">
                        <i class="fas fa-camera upload-icon"></i><br>
                        <span style="font-weight:bold; color:#5d4037; font-size:1.1rem;">ğŸ“¸ æ•æ‰ç¥éšŠå‹é‡‘èº«</span><br>
                        <small style="color:#a1887f;">é»æ“Šé–‹å•Ÿç›¸æ©Ÿ</small>
                    </div>
                    <img id="preview" alt="é è¦½åœ–">
                    <input type="file" id="photo" name="photo" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this)">
                </label>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-map-marker-alt text-danger mr-1"></i> å‡ºæ²’å€åŸŸ (å¿…å¡«)</label>
                <select id="area" name="area" class="form-control custom-input" required>
                    <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                    <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                    <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                    <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                    <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                    <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                    <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                    <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                    <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-user-tag text-info mr-1"></i> å°‹ç¥äººå“¡ç°½åˆ° (é™8å­—)</label>
                <input type="text" class="form-control custom-input" id="nickname" name="nickname" maxlength="8" placeholder="ç†±å¿ƒä¸²å‹">
            </div>

            <div class="form-group mb-0">
                <label class="form-label"><i class="fas fa-pen-fancy text-warning mr-1"></i> ç·šç´¢æè¿° (é¸å¡«)</label>
                <textarea class="form-control custom-input" id="description" name="description" rows="2" placeholder="ä¾‹å¦‚ï¼šåœ¨æ¦•æ¨¹ä¸‹å¾ˆéˆé©—..."></textarea>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn" disabled>
                <i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS é–å®š...
            </button>
        </form>
    </div>

    <div style="height: 100px;"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    var currentLat = null, currentLng = null;

    // èªéŸ³ç¥è³€
    function speakHappy(text) {
        if ('speechSynthesis' in window) {
            var msg = new SpeechSynthesisUtterance();
            msg.text = text; msg.lang = 'zh-TW'; msg.rate = 1.0; 
            window.speechSynthesis.speak(msg);
        }
    }

    // å•Ÿå‹• GPS
    function startGPS() {
        $('#gpsStatus').html('<i class="fas fa-satellite-dish fa-spin mr-2"></i> æ„Ÿæ‡‰æ–¹ä½ä¸­...');
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-sync fa-spin"></i> ç­‰å¾… GPS é–å®š...');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLat = position.coords.latitude; 
                    currentLng = position.coords.longitude;
                    $('#lat').val(currentLat); $('#lng').val(currentLng);
                    
                    $('#gpsStatus').addClass('success').html('<i class="fas fa-check-circle mr-1"></i> æ–¹ä½é–å®šæˆåŠŸ');
                    checkReady();
                }, 
                function(error) { 
                    $('#gpsStatus').html('<i class="fas fa-exclamation-triangle mr-1"></i> å®šä½ä¸ç©© (è«‹é–‹å•ŸGPS)');
                    checkReady(); // å…è¨±å˜—è©¦æäº¤
                },
                { timeout: 10000 }
            );
        }
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#preview').attr('src', e.target.result).show();
                $('#uploadPlaceholder').hide();
                $('.upload-zone').css('border-style', 'solid');
                checkReady();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function checkReady() {
        if ($('#photo').val()) {
            $('#submitBtn').prop('disabled', false).html('<i class="fas fa-paper-plane"></i> ç™¼é€æƒ…å ±ï¼æ­¸æª”ï¼');
        } else {
            $('#submitBtn').html('ğŸ“¸ è«‹å…ˆæ•æ‰é‡‘èº«');
        }
    }

    $('#uploadForm').submit(function(e) {
        e.preventDefault();
        var nickname = $('#nickname').val() || 'ç†±å¿ƒä¸²å‹';
        var area = $('#area').val();
        
        // é¡¯ç¤ºä¸Šå‚³ä¸­
        Swal.fire({
            title: 'ğŸ™ èª å¿ƒå‚³é€ä¸­...',
            text: 'æ­£åœ¨å°‡æƒ…å ±é€å¾€ç¸½éƒ¨',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        var formData = new FormData(this);
        var desc = $('#description').val();
        formData.set('description', '[' + area + '] ' + desc);

        $.ajax({
            url: '/upload', type: 'POST', data: formData, contentType: false, processData: false,
            success: function(response) {
                var sayText = 'æ„Ÿè¬ ' + area + ' çš„ ' + nickname + 'ï¼ŒåœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼';
                speakHappy(sayText); 
                Swal.fire({
                    title: 'âœ… ä¸Šå‚³æˆåŠŸï¼',
                    html: `æ„Ÿè¬ ${area} çš„ ${nickname}ï¼Œ<br><b style="color:#d32f2f;">åœŸåœ°å…¬æœƒä¿åº‡ä½ å–”ï¼</b>`,
                    imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1/happy_landlord.png', 
                    imageWidth: 200,
                    confirmButtonText: 'å¤ªæ£’äº†ï¼', confirmButtonColor: '#d32f2f'
                }).then(() => { window.location.href = '/map'; });
            },
            error: function() {
                Swal.fire({ title: 'âŒ ä¸Šå‚³å¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯', icon: 'error' });
            }
        });
    });

    $(document).ready(function() {
        startGPS();
    });
</script>
{% endblock %}
