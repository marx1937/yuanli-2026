{% extends "base.html" %}
{% set active_page = "upload" %}

{% block styles %}
<style>
    /* 1. å…¨å±€èƒŒæ™¯ (é‚„åŸä½ åŸæœ¬çš„é»é™£èƒŒæ™¯) */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        margin: 0; 
        padding-bottom: 110px; /* é¿é–‹åº•éƒ¨å°èˆª */
    }

    /* 2. æ¨™é¡Œå€ (é‚„åŸä½ çš„ç´…è‰²åŒ¾é¡è¨­è¨ˆ) */
    .page-header { text-align: center; padding: 20px 0 10px 0; width: 100%; position: relative; }
    .title-signboard { width: 70%; max-width: 280px; height: auto; display: block; margin: 0 auto; filter: drop-shadow(0 5px 5px rgba(93, 64, 55, 0.15)); }

    /* 3. è¡¨å–®å¡ç‰‡ (é‚„åŸç½®ä¸­èˆ‡æ¨£å¼) */
    .form-card {
        background: rgba(255, 255, 255, 0.95); width: 92%; max-width: 500px;
        padding: 25px; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1);
        margin: 10px auto; /* é—œéµç½®ä¸­ */
        border: 2px solid #fff;
    }

    /* 4. GPS ç‹€æ…‹æ¢ */
    .gps-pill { background: #fff8e1; padding: 8px 15px; border-radius: 50px; font-size: 0.9rem; color: #f57f17; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; border: 1px solid #ffe082; }

    /* 5. è¼¸å…¥æ¡†æ¨£å¼ */
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-label { font-weight: bold; color: #5d4037; margin-bottom: 8px; display: block; font-size: 1rem; }
    .custom-input { width: 100%; padding: 12px 15px; border-radius: 15px; border: 2px solid #efebe9; background: #fff; font-size: 1rem; color: #4e342e; transition: 0.2s; outline: none; }
    .custom-input:focus { border-color: #d32f2f; background: #fff; box-shadow: 0 0 0 4px rgba(211, 47, 47, 0.1); }
    
    /* ä¸Šå‚³æŒ‰éˆ• */
    .file-upload-wrapper { position: relative; width: 100%; height: 150px; border: 2px dashed #d7ccc8; border-radius: 20px; background: #fffbf0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; transition: 0.2s; cursor: pointer; }
    .file-upload-wrapper:hover { border-color: #d32f2f; background: #ffebee; }
    .upload-icon { font-size: 3rem; color: #d32f2f; margin-bottom: 10px; }
    .upload-text { color: #8d6e63; font-weight: bold; }
    .file-input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    #preview-img { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 18px; }

    /* 6. é€å‡ºæŒ‰éˆ• */
    .submit-btn-container { text-align: center; margin-top: 30px; }
    .btn-submit {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        color: white; border: none; padding: 15px 50px;
        font-size: 1.2rem; font-weight: bold; border-radius: 50px;
        box-shadow: 0 10px 20px rgba(211, 47, 47, 0.3);
        transition: 0.2s; width: 100%; position: relative; overflow: hidden;
    }
    .btn-submit:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(211, 47, 47, 0.2); }

    /* 7. åº•éƒ¨å°èˆª (æ‰‹å‹•ç‰ˆ - è®“ä¸­é–“å¤§æŒ‰éˆ•äº®ç´…ç‡ˆ) */
    .fake-navbar { 
        position: fixed; bottom: 0; width: 100%; 
        background: #fff; border-top: 1px solid #efebe9; 
        padding: 0 5px; height: 90px; 
        display: flex; justify-content: space-around; align-items: center; 
        z-index: 2000; box-shadow: 0 -5px 20px rgba(93, 64, 55, 0.05);
    }
    .nav-item { text-align: center; color: #a1887f; text-decoration: none !important; font-size: 0.75rem; flex: 1; display: flex; flex-direction: column; align-items: center; }
    .nav-icon { height: 42px; width: auto; margin-bottom: 3px; filter: grayscale(100%) sepia(20%) opacity(0.8); transition: 0.3s; }
    .nav-item.active .nav-icon { transform: scale(1.1); filter: none; filter: drop-shadow(0 2px 2px rgba(211, 47, 47, 0.2)); }
    .nav-item.active span { color: #d32f2f; font-weight: bold; }
    
    /* ä¸­é–“å¤§æŒ‰éˆ• - ç™¼å…‰ç‰¹æ•ˆ */
    .nav-center-btn {
        width: 80px; height: 80px; background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
        border-radius: 50%; border: 6px solid #fdfcf0; display: flex; align-items: center; justify-content: center;
        transform: translateY(-35px); box-shadow: 0 8px 15px rgba(198, 40, 40, 0.3);
        animation: pulse-red 2s infinite; /* å‘¼å¸ç‡ˆ */
    }
    @keyframes pulse-red { 0% {box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.4);} 70% {box-shadow: 0 0 0 15px rgba(229, 57, 53, 0);} 100% {box-shadow: 0 0 0 0 rgba(229, 57, 53, 0);} }
    .nav-center-icon { height: 55px; width: auto; display: block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="title-signboard">
    </div>

    <div class="form-card">
        <form id="uploadForm" enctype="multipart/form-data">
            
            <div style="text-align:center;">
                <div class="gps-pill" id="gps-status">
                    <i class="fas fa-satellite-dish fa-spin"></i> æ­£åœ¨æŠ“å–ä½ç½®...
                </div>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-camera"></i> æ‹æ”ç¥åƒ</label>
                <div class="file-upload-wrapper">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">é»æ“Šæ‹ç…§æˆ–é¸å–ç…§ç‰‡</div>
                    <input type="file" name="file" class="file-input" accept="image/*" required onchange="previewImage(this)">
                    <img id="preview-img">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-user-ninja"></i> æ‚¨çš„æš±ç¨± (é¸å¡«)</label>
                <input type="text" name="nickname" class="custom-input" placeholder="ä¾‹å¦‚ï¼šå°‹ç¥å°éšŠé•·">
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-map-marked-alt"></i> æ‰€åœ¨å€åŸŸ</label>
                <select name="area" class="custom-input" required>
                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                    <option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                    <option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option>
                    <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option>
                    <option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option>
                    <option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                    <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option>
                    <option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option>
                    <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option>
                    <option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                    <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option>
                    <option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option>
                    <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option>
                    <option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option>
                    <option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
                    <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option>
                    <option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option>
                    <option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                    <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option>
                    <option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option>
                    <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option>
                    <option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option>
                    <option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                    <option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                    <option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                    <option value="è‹‘å‘é‡Œ">è‹‘å‘é‡Œ</option>
                    <option value="å‡ºæ°´é‡Œ">å‡ºæ°´é‡Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label"><i class="fas fa-pen-fancy"></i> å‚™è¨» (ä½ç½®æè¿°)</label>
                <textarea name="note" class="custom-input" rows="2" placeholder="ä¾‹å¦‚ï¼šå¤§æ¨¹ä¸‹ã€æ´»å‹•ä¸­å¿ƒæ—"></textarea>
            </div>

            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">

            <div class="submit-btn-container">
                <button type="submit" class="btn-submit">
                    ç¢ºèªä¸Šå‚³ <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>

    <div class="fake-navbar">
        <a href="/" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png" class="nav-icon"><span>é¦–é </span></a>
        <a href="/map" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_map.png" class="nav-icon"><span>åœ°åœ–</span></a>
        <a href="/upload" class="nav-center-btn"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="nav-center-icon"></a>
        <a href="/gallery" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" class="nav-icon"><span>åœ–åº«</span></a>
        <a href="/leaderboard" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_leaderboard.png" class="nav-icon"><span>æ¦œå–®</span></a>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // 1. ç…§ç‰‡é è¦½
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#preview-img').attr('src', e.target.result).show();
                $('.upload-icon, .upload-text').hide();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 2. è‡ªå‹•æŠ“å– GPS
    $(document).ready(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    $('#lat').val(position.coords.latitude);
                    $('#lng').val(position.coords.longitude);
                    $('#gps-status').html('<i class="fas fa-check-circle"></i> å®šä½æˆåŠŸï¼').css('color', '#2e7d32').css('background', '#e8f5e9').css('border-color','#a5d6a7');
                },
                function(error) {
                    $('#gps-status').html('<i class="fas fa-exclamation-triangle"></i> å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿ GPS').css('color', '#c62828');
                },
                { enableHighAccuracy: true }
            );
        } else {
            $('#gps-status').text('ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
        }
    });

    // 3. é€å‡ºè¡¨å–® (é˜²å‘† + è½‰åœˆåœˆ)
    $('#uploadForm').submit(function(e) {
        e.preventDefault();

        // ğŸ”¥ é˜²å‘†æ©Ÿåˆ¶ï¼šé¡¯ç¤ºä¸Šå‚³ä¸­
        Swal.fire({
            title: 'æ­£åœ¨å°‡è³‡æ–™å‚³é€çµ¦åœŸåœ°å…¬...',
            html: 'è«‹ç¨å€™ï¼Œä¸è¦é—œé–‰è¦–çª—å–”ï¼',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        var formData = new FormData(this);
        var nickname = $('input[name="nickname"]').val() || "ç†±å¿ƒé„‰è¦ª";
        var area = $('select[name="area"]').val();

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                // å¦‚æœæ˜¯é‡è¤‡ (duplicate) æˆ– æˆåŠŸ (success)
                if (response.status === 'success' || response.status === 'duplicate') {
                    
                    let title = (response.status === 'duplicate') ? 'ğŸ“‹ è³‡æ–™å·²æ’éšŠä¸­' : 'âœ… ä¸Šå‚³æˆåŠŸï¼';
                    let htmlText = (response.status === 'duplicate') 
                        ? `<div style="font-size: 1.1rem; color:#5d4037; line-height:1.6;">æ„Ÿè¬ <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${nickname}</span> çš„ç†±å¿ƒï¼<br>ä¸é <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${area}</span> é™„è¿‘ä¼¼ä¹å·²æœ‰ç´€éŒ„å›‰ã€‚<br>è³‡æ–™å·²é€äº¤å¯©æ ¸ï¼Œ<br>ç¢ºèªç„¡èª¤å°±æœƒæ›´æ–°ï¼</div>`
                        : `<div style="font-size: 1.1rem; color:#5d4037; line-height:1.6;">æ„Ÿè¬ <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${area}</span> çš„ <span style="color:#d32f2f; font-weight:bold; font-size:1.2rem;">${nickname}</span>ï¼Œ<br>åœŸåœ°å…¬æ”¶åˆ°å›‰ï¼<br><span style="color:#d32f2f; font-size:0.9rem;">(åœ°åœ–è³‡æ–™æ›´æ–°ç´„éœ€ 3-5 åˆ†é˜)</span></div>`;

                    Swal.fire({
                        title: title,
                        html: htmlText,
                        // é€™è£¡å¯ä»¥æ›æˆä½ åŸæœ¬çš„ pada.jpg
                        imageUrl: '/static/pada.jpg', 
                        imageWidth: '100%',
                        confirmButtonText: 'æ”¶åˆ°ï¼Œä¾†å»æ‰¾ä¸‹ä¸€åº§ï¼',
                        confirmButtonColor: '#ff9800',
                        background: '#fffbf0',
                        backdrop: `rgba(0,0,0,0.5)`
                    }).then(() => {
                        window.location.href = '/map';
                    });
                } else {
                    Swal.fire('ä¸Šå‚³å¤±æ•—', response.message || 'è«‹ç¨å¾Œå†è©¦', 'error');
                }
            },
            error: function() {
                Swal.fire('ä¼ºæœå™¨éŒ¯èª¤', 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
            }
        });
    });
</script>
{% endblock %}
