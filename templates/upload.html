<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹‘è£¡åœŸåœ°å…¬æŸ¥å ±ç³»çµ±</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <style>
        body { background-color: #fff8e1; padding-bottom: 90px; font-family: "Microsoft JhengHei", sans-serif; }
        .app-header { background: linear-gradient(135deg, #d32f2f, #8e0000); color: #ffeb3b; padding: 15px; text-align: center; font-size: 1.3rem; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .camera-zone { background-color: #ffffff; border-radius: 15px; width: 100%; height: 250px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; border: 2px dashed #d32f2f; overflow: hidden; position: relative; }
        #previewImg { width: 100%; height: 100%; object-fit: cover; display: none; }
        .camera-icon { font-size: 3rem; color: #d32f2f; }
        .fixed-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 999; }
        .btn-main { width: 100%; height: 50px; font-size: 1.2rem; font-weight: bold; border-radius: 25px; }
        .status-pill { background: white; padding: 8px 15px; border-radius: 50px; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="app-header">
        <div style="float:left;"><a href="/" style="color:white;"><i class="fas fa-chevron-left"></i> å›é¦–é </a></div>
        <i class="fas fa-camera"></i> åœŸåœ°å…¬æŸ¥å ±
    </div>

    <div class="container mt-3 text-center">
        <div class="status-pill" id="statusText"><i class="fas fa-satellite-dish"></i> è¡›æ˜Ÿå®šä½ä¸­...</div>
        
        <div class="camera-zone" onclick="$('#fileInput').click()">
            <div id="cameraPlaceholder">
                <i class="fas fa-camera camera-icon"></i>
                <p class="mt-2 text-danger font-weight-bold">æ‹æ”åœŸåœ°å…¬å»Ÿ</p>
            </div>
            <img id="previewImg">
        </div>
        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;" onchange="previewFile()">

        <div class="card border-0 shadow-sm text-left">
            <div class="card-body">
                <div class="form-group">
                    <label>åœŸåœ°å…¬åœ¨å“ªå€‹é‡Œï¼Ÿ</label>
                    <select class="form-control" id="area" style="height:50px; font-size:1.1rem;">
                        <option value="" disabled selected>-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                        <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option><option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option><option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option><option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option><option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option><option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option><option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option><option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option><option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option><option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option><option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option><option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option><option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option><option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option><option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option><option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option><option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option><option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option><option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option><option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option><option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option><option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option><option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option><option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option><option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‚¨çš„ç¨±å‘¼</label>
                    <input type="text" class="form-control" id="nickname" placeholder="ç†±å¿ƒä¸²å‹">
                </div>
                <div class="form-group">
                    <label>å‚™è¨» / æ•…äº‹</label>
                    <textarea class="form-control" id="note" rows="3"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed-footer">
        <button id="submitBtn" class="btn btn-secondary btn-main" onclick="uploadData()" disabled>
            <i class="fas fa-sync fa-spin"></i> ç­‰å¾…å®šä½...
        </button>
    </div>

    <script>
    var currentLat = null;
    var currentLng = null;
    var fileBlob = null; 

    // 1. å•Ÿå‹• GPS
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(pos) {
                currentLat = pos.coords.latitude;
                currentLng = pos.coords.longitude;
                $('#statusText').html('<i class="fas fa-map-marker-alt text-success"></i> å®šä½å®Œæˆ');
                checkReady();
            }, 
            function(err) { $('#statusText').html('ç„¡æ³•å®šä½ï¼Œè«‹é–‹å•Ÿæ¬Šé™'); },
            { enableHighAccuracy: true }
        );
    }

    // 2. ç…§ç‰‡é è¦½
    function previewFile() {
        var file = document.getElementById('fileInput').files[0];
        if (!file) return;
        
        // é¡¯ç¤ºé è¦½
        $('#cameraPlaceholder').hide();
        var preview = document.getElementById('previewImg');
        preview.style.display = 'block';
        preview.src = URL.createObjectURL(file);

        // å£“ç¸®åœ–ç‰‡
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            var img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var maxW = 800;
                var scale = maxW / img.width;
                var w = (img.width > maxW) ? maxW : img.width;
                var h = (img.width > maxW) ? (img.height * scale) : img.height;
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob(function(blob) {
                    fileBlob = blob;
                    checkReady();
                }, 'image/jpeg', 0.8);
            }
        }
    }

    function checkReady() {
        if (currentLat && fileBlob) {
            $('#submitBtn').prop('disabled', false).removeClass('btn-secondary').addClass('btn-danger').html('ç¢ºèªä¸Šå‚³');
        }
    }

    // 3. ä¸Šå‚³åŠŸèƒ½
            // --- ä¸Šå‚³åŠŸèƒ½ (å«èªéŸ³è§£é– + å®Œæ•´é‚è¼¯) ---
    function uploadData() {
        // 1. åŸºæœ¬æª¢æŸ¥
        if(!fileBlob || !currentLat) return;
        var area = $('#area').val();
        var rawName = $('#nickname').val();
        
        // 2. æª¢æŸ¥æœ‰æ²’æœ‰é¸åœ°é»
        if(!area) {
            Swal.fire({
                icon: 'warning',
                title: 'å¿˜äº†é¸åœ°é»ï¼Ÿ',
                text: 'è«‹è¨˜å¾—é¸æ“‡ã€Œé‡Œåˆ¥ã€ï¼ŒåœŸåœ°å…¬æ‰çŸ¥é“ä»–åœ¨å“ªå–”ï¼',
                confirmButtonText: 'å¥½ï¼Œæˆ‘é¸ä¸€ä¸‹',
                confirmButtonColor: '#ff9800'
            });
            return;
        }

        // ğŸ¤ ã€é—œéµä¸€æ­¥ã€‘æŒ‰éˆ•æŒ‰ä¸‹çš„ç¬é–“ï¼Œå¼·åˆ¶ç€è¦½å™¨è§£é–èªéŸ³ï¼
        // é€™ä¸€è¡Œæœƒè®“æ‰‹æ©Ÿèªç‚ºã€Œä½¿ç”¨è€…åŒæ„æ’­æ”¾è²éŸ³ã€
        var startMsg = new SpeechSynthesisUtterance("è³‡æ–™å‚³é€ä¸­ï¼Œè«‹ç¨å€™");
        startMsg.lang = 'zh-TW';
        window.speechSynthesis.speak(startMsg);

        // 3. é–å®šæŒ‰éˆ•
        $('#submitBtn').html('<i class="fas fa-robot"></i> å‚³é€ä¸­...')
                      .prop('disabled', true);

        // 4. æ‰“åŒ…è³‡æ–™
        var formData = new FormData();
        formData.append('photo', fileBlob);
        formData.append('lat', currentLat);
        formData.append('lng', currentLng);
        formData.append('note', $('#note').val());
        formData.append('nickname', rawName);
        formData.append('area', area);

        // 5. ç™¼é€è³‡æ–™
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                var displayName = rawName ? rawName : 'ç†±å¿ƒä¸²å‹';

                // ğŸ”´ ç‹€æ³ Aï¼šæš±ç¨±é•è¦
                if (response.status === 'block') {
                    Swal.fire({
                        title: 'âš ï¸ æš±ç¨±é•è¦',
                        text: response.message,
                        icon: 'warning',
                        confirmButtonText: 'å¥½ï¼Œæˆ‘æ”¹ä¸€ä¸‹',
                        confirmButtonColor: '#d33'
                    });
                    $('#submitBtn').html('ç¢ºèªä¸Šå‚³').prop('disabled', false);
                    return; 
                }

                // ğŸŸ¡ ç‹€æ³ Bï¼šé‡è¤‡åœ°é» (é€²å…¥å¯©æ ¸)
                if (response.status === 'pending') {
                    Swal.fire({
                        title: 'ğŸ“‹ è³‡æ–™å·²é€äº¤å¯©æ ¸',
                        html: `æ„Ÿè¬æ‚¨ï¼ä¸éæ­¤åœ°é» (<b>${area}</b>) é™„è¿‘ä¼¼ä¹å·²æœ‰æŸ¥å ±ç´€éŒ„ã€‚<br><br>æ‚¨çš„ç…§ç‰‡å·²å®‰å…¨å­˜å…¥<b>ã€Œå¾…å¯©æ ¸æ¸…å–®ã€</b>ï¼Œç®¡ç†å“¡ç¢ºèªå“è³ªå¾Œå°±æœƒæ›´æ–°ä¸Šå»å–”ï¼`,
                        icon: 'info',
                        confirmButtonText: 'æ”¶åˆ°ï¼Œæˆ‘å»æŠ“ä¸‹ä¸€éš»ï¼',
                        confirmButtonColor: '#ff9800'
                    }).then(() => {
                        window.location.href = '/map';
                    });
                } 
                // ğŸŸ¢ ç‹€æ³ Cï¼šæˆåŠŸä¸Šå‚³
                else {
                    var sayText = 'æ„Ÿè¬ ' + area + ' çš„ ' + displayName + 'ï¼ŒåœŸåœ°å…¬æ”¶åˆ°å›‰ï¼';
                    
                    // ğŸ¤ æˆåŠŸå¾Œè¬›ç¬¬äºŒå¥è©±
                    // å…ˆå–æ¶ˆå‰é¢çš„ï¼Œå†è¬›é€™ä¸€å¥
                    window.speechSynthesis.cancel(); 
                    var successMsg = new SpeechSynthesisUtterance(sayText);
                    successMsg.lang = 'zh-TW';
                    window.speechSynthesis.speak(successMsg);

                    Swal.fire({
                        title: 'âœ… ä¸Šå‚³æˆåŠŸï¼',
                        text: sayText,
                        icon: 'success',
                        confirmButtonText: 'å¤ªæ£’äº†ï¼',
                        confirmButtonColor: '#d32f2f'
                    }).then(() => {
                        window.location.href = '/map';
                    });
                }
            },
            error: function() {
                Swal.fire({
                    title: 'âŒ ä¸Šå‚³å¤±æ•—',
                    text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚',
                    icon: 'error',
                    confirmButtonText: 'å¥½'
                });
                $('#submitBtn').html('ç¢ºèªä¸Šå‚³').prop('disabled', false);
            }
        });
    }

    </script>
</body>
</html>
