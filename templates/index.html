<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>苑裡土地公查報系統</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <style>
        /* --- APP 風格樣式表 --- */
        body {
            background-color: #f8f9fa; /* 淺灰背景 */
            padding-bottom: 80px; /* 留位置給底部按鈕 */
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* 頂部標題列 */
        .app-header {
            background: linear-gradient(135deg, #d32f2f, #b71c1c); /* 廟宇紅 */
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* 相機區塊 (模仿 IG 限動) */
        .camera-zone {
            background-color: #e9ecef;
            border-radius: 15px;
            width: 100%;
            height: 250px; /* 高度固定 */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            border: 2px dashed #ced4da;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .camera-zone:active {
            background-color: #dee2e6; /* 按下去的特效 */
        }

        .camera-icon {
            font-size: 3rem;
            color: #6c757d;
        }

        #previewImg {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 讓照片填滿不變形 */
            display: none;
        }

        /* 狀態文字小藥丸 */
        .status-pill {
            background: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            display: inline-block;
        }

        /* 底部固定按鈕區 */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .btn-main {
            width: 100%;
            height: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 25px; /* 圓角按鈕 */
        }
    </style>
</head>
<body>

    <div class="app-header">
        <i class="fas fa-temple"></i> 苑裡土地公查報
    </div>

    <div class="container mt-3">
        
        <div class="text-center">
            <div class="status-pill" id="statusText">
                <i class="fas fa-satellite-dish"></i> 定位中...
            </div>
        </div>

        <div class="camera-zone" onclick="$('#fileInput').click()">
            <div id="cameraPlaceholder" class="text-center">
                <i class="fas fa-camera camera-icon"></i>
                <p class="mt-2 text-muted">點擊拍照 / 選擇照片</p>
            </div>
            <img id="previewImg" alt="預覽圖">
        </div>

        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;" onchange="previewFile()">

        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt text-danger"></i> 里別 (必填)</label>
                    <select class="form-control" id="area">
                        <option value="" disabled selected>-- 請選擇位置 --</option>
                        <option value="苑東里">苑東里</option>
                        <option value="苑南里">苑南里</option>
                        <option value="苑北里">苑北里</option>
                        <option value="西勢里">西勢里</option>
                        <option value="中正里">中正里</option>
                        <option value="客庄里">客庄里</option>
                        <option value="苑港里">苑港里</option>
                        <option value="西平里">西平里</option>
                        <option value="海岸里">海岸里</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-comment-alt text-primary"></i> 備註事項</label>
                    <textarea class="form-control" id="note" rows="2" placeholder="例如：路燈不亮、路面坑洞..."></textarea>
                </div>

                <div class="form-group mb-0">
                    <label><i class="fas fa-user text-info"></i> 您的稱呼 (選填)</label>
                    <input type="text" class="form-control" id="nickname" placeholder="熱心民眾">
                </div>
            </div>
        </div>
    </div>

    <div class="fixed-footer">
        <button id="submitBtn" class="btn btn-secondary btn-main" onclick="uploadData()" disabled>
            請先拍照並定位
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
    // --- 1. 全域變數設定 (作弊模式：強制鎖定苑裡) ---
    var currentLat = 24.4432;  
    var currentLng = 120.6547; 
    var fileBlob = null; 

    // --- 2. 初始化 (一開機就喊成功) ---
    $(document).ready(function() {
        // 直接更新畫面，不等待衛星
        $('#statusText').html('<i class="fas fa-check-circle text-success"></i> 測試定位成功 (苑裡車站)');
        
        // 嘗試讓按鈕亮起來
        checkReady();
    });

    // --- 3. 照片預覽與壓縮 ---
    function previewFile() {
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        if (!file) return; 

        fileBlob = null;
        $('#cameraPlaceholder').hide();
        var previewImg = document.getElementById('previewImg');
        previewImg.style.display = 'block';
        previewImg.src = URL.createObjectURL(file);

        $('#statusText').html('<i class="fas fa-spinner fa-spin"></i> 照片處理中...');

        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            var img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var maxWidth = 800;
                var scale = maxWidth / img.width;
                var width = (img.width > maxWidth) ? maxWidth : img.width;
                var height = (img.width > maxWidth) ? (img.height * scale) : img.height;

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(function(blob) {
                    fileBlob = blob;
                    $('#statusText').html('<i class="fas fa-image text-success"></i> 照片已準備好');
                    checkReady();
                }, 'image/jpeg', 0.8);
            };
        };
    }

    // --- 4. 檢查是否可以上傳 ---
    function checkReady() {
        if (currentLat && fileBlob) {
            $('#submitBtn').prop('disabled', false)
                          .removeClass('btn-secondary')
                          .addClass('btn-danger') // 改成顯眼的紅色按鈕
                          .html('確認上傳');
        }
    }

    // --- 5. 上傳資料 ---
    function uploadData() {
        if(!fileBlob || !currentLat) return;

        var area = $('#area').val();
        var rawName = $('#nickname').val();
        
        if(!area) {
            alert('請選擇「里別」喔！');
            return;
        }

        $('#submitBtn').html('<i class="fas fa-robot"></i> 傳送中...')
                      .prop('disabled', true);

        var formData = new FormData();
        formData.append('photo', fileBlob);
        formData.append('lat', currentLat);
        formData.append('lng', currentLng);
        formData.append('note', $('#note').val());
        formData.append('nickname', rawName);
        formData.append('area', area);

        $.ajax({
            url: '/upload', // ✅ 這裡已經幫你改成正確的 /upload 了
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                var sayText = '感謝 ' + area + ' 的善心人士，土地公收到囉！';
                var msg = new SpeechSynthesisUtterance(sayText);
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);

                alert('✅ 上傳成功！\n\n' + sayText);
                location.reload();
            },
            error: function() {
                alert('❌ 上傳失敗，請檢查網路連線。');
                $('#submitBtn').html('確認上傳').prop('disabled', false);
            }
        });
    }
    </script>
</body>
</html>
