<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹‘è£¡åœŸåœ°å…¬åœ°åœ– (2026ç‰ˆ)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
  body{margin:0;font-family:"Microsoft JhengHei",sans-serif;background:#f0f2f5}
  #map{height:60vh;width:100%}
  .controls{padding:20px;background:#fff;border-radius:20px 20px 0 0;margin-top:-20px;position:relative;z-index:999;text-align:center;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}
  input[type="text"]{padding:12px;width:80%;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{background:#007bff;color:white;padding:15px 40px;border:none;border-radius:50px;font-size:18px;font-weight:bold;box-shadow:0 4px 6px rgba(0,123,255,0.3);cursor:pointer}
  .btn:active{transform:scale(0.98)}
  #status{margin-top:10px;color:#666}
</style>
</head>
<body>

<div id="map"></div>
<div class="controls">
    <h3>ğŸ“ åœŸåœ°å…¬åœ¨å“ªè£¡ï¼Ÿ</h3>
    <input type="text" id="note" placeholder="è«‹è¼¸å…¥å‚™è¨» (ä¾‹: æŸæŸé‡Œå¤§æ¨¹ä¸‹)">
    
    <input type="hidden" id="lat"><input type="hidden" id="lng">
    <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none">
    
    <button class="btn" onclick="startProcess()">ğŸ“· æ‹ç…§ä¸Šå‚³</button>
    <p id="status">è«‹ç«™åœ¨å»Ÿå‰å†æŒ‰ä¸Šå‚³</p>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­è‹‘è£¡)
    var map = L.map('map').setView([24.4429, 120.6493], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. æŠ“å–æ‰€æœ‰åœŸåœ°å…¬è³‡æ–™
    $.getJSON('/api/temples', function(data) {
        data.forEach(function(item) {
            L.marker([item.lat, item.lng])
             .addTo(map)
             .bindPopup(`<b>${item.note}</b><br><img src="${item.image}" width="150" style="border-radius:8px;margin-top:5px">`);
        });
    });

    // 3. é»æ“ŠæŒ‰éˆ•æµç¨‹
    function startProcess() {
        var note = document.getElementById('note').value;
        if(!note){ alert("è«‹å…ˆè¼¸å…¥å‚™è¨»(ä¾‹å¦‚åœ°é»åç¨±)ï¼"); return; }

        document.getElementById('status').innerText = "ğŸ“¡ æ­£åœ¨æŠ“å– GPS...";
        
        if (!navigator.geolocation) { alert("æ‰‹æ©Ÿä¸æ”¯æ´å®šä½"); return; }
        
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            document.getElementById('status').innerText = `âœ… å®šä½æˆåŠŸï¼è«‹æ‹å¼µç…§...`;
            
            // è§¸ç™¼ç›¸æ©Ÿ
            document.getElementById('photoInput').click();
            
        }, function(err) {
            alert("å®šä½å¤±æ•—ï¼šè«‹ç¢ºèªå·²é–‹å•Ÿ GPS");
            document.getElementById('status').innerText = "å®šä½å¤±æ•—";
        }, { enableHighAccuracy: true });
    }

    // 4. é¸å¥½ç…§ç‰‡å¾Œè‡ªå‹•ä¸Šå‚³
    document.getElementById('photoInput').onchange = function() {
        var file = this.files[0];
        if (!file) return;

        var formData = new FormData();
        formData.append('photo', file);
        formData.append('lat', document.getElementById('lat').value);
        formData.append('lng', document.getElementById('lng').value);
        formData.append('note', document.getElementById('note').value);

        document.getElementById('status').innerText = "ğŸš€ ä¸Šå‚³ä¸­...è«‹å‹¿é—œé–‰";
        document.querySelector('.btn').disabled = true;
        document.querySelector('.btn').style.background = "#ccc";

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false, contentType: false,
            success: function(res) {
                alert(res.message);
                location.reload(); // é‡æ–°æ•´ç†
            },
            error: function(err) {
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                document.querySelector('.btn').disabled = false;
                document.querySelector('.btn').style.background = "#007bff";
                document.getElementById('status').innerText = "ä¸Šå‚³å¤±æ•—";
            }
        });
    };
</script>
</body>
</html>
