<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹‘è£¡åœŸåœ°å…¬åœ°åœ– (By è‹‘è£¡äºº)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body{margin:0;font-family:"Microsoft JhengHei",sans-serif;background:#f0f2f5}
        #map{height:60vh;width:100%}
        .controls{padding:20px;background:#fff;border-radius:20px 20px 0 0;margin-top:-20px;position:relative;z-index:999;text-align:center;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}
        input[type="text"]{padding:12px;width:80%;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;font-size:16px}
        .btn{background:#007bff;color:white;padding:15px 40px;border:none;border-radius:50px;font-size:18px;font-weight:bold;box-shadow:0 4px 6px rgba(0,123,255,0.3);transition:transform 0.1s}
        .btn:active{transform: scale(0.98)}
        #status{margin-top:10px;color:#666}
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="controls">
        <h3>è‹‘è£¡ä¸²èµ·ä¾† ğŸš©<br>åœŸåœ°å…¬åœ¨å“ªè£¡ï¼Ÿ</h3>
        <input type="text" id="note" placeholder="è¼¸å…¥å‚™è¨» (ä¾‹: æŸæŸé‡Œ)">
        
        <input type="hidden" id="lat"><input type="hidden" id="lng">
        <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none">
        
        <button class="btn" onclick="startProcess()">ğŸ“· æ‹ç…§ä¸Šå‚³</button>
        <p id="status">è«‹ç«™åœ¨å»Ÿå‰å†æŒ‰ä¸Šå‚³</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­è‹‘è£¡)
        var map = L.map('map').setView([24.4429, 120.6493], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 2. æŠ“å–æ‰€æœ‰åœŸåœ°å…¬è³‡æ–™
        $.getJSON('/api/temples', function(data) {
            data.forEach(function(item) {
                L.marker([item.lat, item.lng])
                    .addTo(map)
                    .bindPopup(
                        '<b>' + item.note + '</b><br>' +
                        '<img src="' + item.image + '" width="150" style="border-radius:8px;margin-top:5px;"><br>' +
                        '<button onclick="deleteTemple(' + item.id + ')" style="background:#ff4d4d;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:5px;cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤</button>'
                    );
            });
        });

        // 3. æ‹ç…§æµç¨‹ (å–å¾—å®šä½ -> å£“ç¸® -> ä¸Šå‚³)
        function startProcess() {
            var note = $('#note').val();
            if(!note) { alert('è«‹å…ˆè¼¸å…¥å‚™è¨» (ä¾‹å¦‚: å®¢åº„é‡Œ)'); return; }

            $('#status').text('ğŸš€ æ­£åœ¨å®šä½ä¸­...');
            
            navigator.geolocation.getCurrentPosition(function(position) {
                $('#lat').val(position.coords.latitude);
                $('#lng').val(position.coords.longitude);
                $('#status').text('ğŸ“¸ è«‹é¸æ“‡ç…§ç‰‡...');
                $('#photoInput').click(); // è§¸ç™¼ç›¸æ©Ÿ
            }, function() {
                alert('å®šä½å¤±æ•—ï¼Œè«‹å…è¨± GPS æ¬Šé™');
                $('#status').text('å®šä½å¤±æ•—');
            });
        }

        // ç•¶é¸å¥½ç…§ç‰‡å¾Œ
        $('#photoInput').change(function() {
            if(this.files.length === 0) return;
            var file = this.files[0];
            $('#status').text('â³ å£“ç¸®ç…§ç‰‡ä¸­...');
            
            compressImage(file, function(blob) {
                uploadFile(blob);
            });
        });

        // 4. ä¸Šå‚³åŠŸèƒ½
        function uploadFile(fileBlob) {
            $('#status').text('ğŸš€ ä¸Šå‚³ä¸­...è«‹å‹¿é—œé–‰');
            
            var formData = new FormData();
            formData.append('photo', fileBlob);
            formData.append('lat', $('#lat').val());
            formData.append('lng', $('#lng').val());
            formData.append('note', $('#note').val());

            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if(res.status === 'error') {
                        alert(res.message);
                        $('#status').text('âŒ ä¸Šå‚³å¤±æ•—: ' + res.message);
                    } else {
                        alert(res.message);
                        location.reload();
                    }
                },
                error: function() {
                    alert('ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                    $('#status').text('âŒ ä¼ºæœå™¨éŒ¯èª¤');
                }
            });
        }

        // 5. åœ–ç‰‡å£“ç¸®å·¥å…·
        function compressImage(file, callback) {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                var img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    
                    var width = 800; // ç¸®å°åˆ°å¯¬åº¦ 800
                    var scale = width / img.width;
                    var height = img.height * scale;

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(function(blob) {
                        callback(blob);
                    }, 'image/jpeg', 0.7); // 70% å“è³ª
                }
            }
        }
  // --- ğŸ”´ æ–°å¢ï¼šåˆªé™¤åŠŸèƒ½çš„å‡½å¼ ---
        function deleteTemple(id) {
            var password = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ (é è¨­ 8888)ï¼š");
            if (password) {
                $.post('/delete/' + id, { password: password }, function(res) {
                    alert(res.message);
                    if (res.status === 'success') {
                        location.reload(); // åˆªé™¤æˆåŠŸå¾Œé‡æ–°æ•´ç†
                    }
                });
            }
        }

    </script>
</body>
</html>
