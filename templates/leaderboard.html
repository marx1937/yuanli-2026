<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°‹ç¥é¢¨é›²æ¦œ - è‹‘è£¡é®</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* 1. åŸºç¤è¨­å®š */
        body {
            background-color: #fdfcf0;
            background-image: 
                linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            padding-bottom: 110px;
            margin: 0;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* 2. çœ‹æ¿å€ */
        .rank-header {
            text-align: center; padding: 25px 0 10px 0;
            position: relative; margin-bottom: 15px;
        }
        .rank-banner-img {
            width: 90%; max-width: 320px; height: auto;
            filter: drop-shadow(0 8px 10px rgba(93, 64, 55, 0.15));
            animation: float-title 3s ease-in-out infinite;
        }
        @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* 3. åˆ‡æ›æŒ‰éˆ• */
        .tab-container {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;
        }
        .rank-tab {
            padding: 8px 25px; border-radius: 50px; font-weight: bold; border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; display: flex; align-items: center; gap: 6px;
        }
        .rank-tab.active {
            background: linear-gradient(135deg, #d32f2f, #b71c1c); color: white; transform: scale(1.05);
        }
        .rank-tab.inactive {
            background: #fff; color: #8d6e63; border: 1px solid #efebe9;
        }

        /* 4. èªªæ˜æŒ‰éˆ• (å·è»¸é¢¨) */
        .info-bar { text-align: center; margin-bottom: 25px; }
        .info-scroll-btn {
            background: #fff8e1; color: #d84315;
            border: 2px solid #ffe082;
            padding: 6px 18px; border-radius: 8px;
            font-size: 0.9rem; font-weight: bold; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
            box-shadow: 0 3px 0 #ffca28;
            transition: 0.1s;
        }
        .info-scroll-btn:active { transform: translateY(3px); box-shadow: none; }

        /* 5. çå°å€ */
        .podium-section {
            display: flex; align-items: flex-end; justify-content: center;
            height: 230px; margin-bottom: 20px; gap: 8px; padding: 0 10px;
        }
        .podium-col {
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        
        .p-avatar {
            width: 70px; height: 70px; border-radius: 50%; 
            border: 4px solid #fff; z-index: 5; background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: -15px;
            object-fit: cover;
        }
        .p-crown {
            position: absolute; top: -35px; width: 40px; 
            animation: bounce 2s infinite; z-index: 6;
        }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

        .p-base {
            width: 90px; text-align: center; color: white;
            border-radius: 15px 15px 0 0; padding-top: 20px;
            display: flex; flex-direction: column; justify-content: flex-start;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .p-1 .p-avatar { width: 90px; height: 90px; border-color: #ffd700; margin-bottom: -20px;}
        .p-1 .p-base { height: 130px; background: linear-gradient(to bottom, #ffca28, #ff6f00); width: 110px; z-index: 3;}
        .p-2 .p-base { height: 100px; background: linear-gradient(to bottom, #cfd8dc, #90a4ae); z-index: 2;}
        .p-3 .p-base { height: 80px;  background: linear-gradient(to bottom, #d7ccc8, #8d6e63); z-index: 2;}

        .p-name { font-weight: bold; font-size: 1rem; margin-bottom: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .p-score { font-size: 0.8rem; opacity: 0.9; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; display: inline-block;}

        /* 6. åˆ—è¡¨å€ */
        .list-container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .list-item {
            background: white; border-radius: 15px; padding: 12px 15px;
            display: flex; align-items: center; margin-bottom: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05); border: 1px solid #fff;
        }
        .list-rank { width: 30px; font-size: 1.1rem; font-weight: 900; color: #a1887f; text-align: center; }
        .list-avatar {
            width: 50px; height: 50px; border-radius: 50%; margin: 0 15px;
            background: #f5f5f5; border: 2px solid #eee; object-fit: cover;
        }
        .list-info { flex: 1; overflow: hidden; }
        .list-name { font-weight: bold; color: #4e342e; font-size: 1.05rem; display: flex; align-items: center; gap: 5px;}
        .list-sub { font-size: 0.85rem; color: #9e9e9e; margin-top: 2px; }
        
        .list-bar-bg { height: 6px; width: 100%; background: #efebe9; border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .list-bar-fill { height: 100%; background: linear-gradient(90deg, #ffca28, #ff6f00); border-radius: 3px; }
        .list-count { font-size: 1.2rem; font-weight: 900; color: #d32f2f; margin-left: 10px; min-width: 40px; text-align: right; }

        /* ç­‰ç´šæ¨™ç±¤ (æœ¨ç‰Œè³ªæ„Ÿ) */
        .lvl-tag {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 4px;
            font-weight: normal; color: #5d4037; border: 1px solid #8d6e63;
            background-color: #efebe9; display: inline-block; transform: scale(0.9);
        }
        .lvl-max { background: #d32f2f; color: #fff; border-color: #b71c1c; }
        .lvl-3 { background: #ffca28; color: #5d4037; border-color: #ff8f00; }

        /* åº•éƒ¨å°èˆª */
        .fake-navbar { 
            position: fixed; bottom: 0; width: 100%; 
            background: #fff; border-top: 1px solid #efebe9; 
            padding: 0 5px; height: 90px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 2000; box-shadow: 0 -5px 20px rgba(93, 64, 55, 0.05);
        }
        .nav-item { text-align: center; color: #a1887f; text-decoration: none !important; font-size: 0.75rem; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .nav-icon { height: 42px; width: auto; margin-bottom: 3px; filter: grayscale(100%) sepia(20%) opacity(0.8); transition: 0.3s; }
        .nav-item.active .nav-icon { transform: scale(1.1); filter: none; filter: drop-shadow(0 2px 2px rgba(211, 47, 47, 0.2)); }
        .nav-item.active span { color: #d32f2f; font-weight: bold; }
        .nav-center-btn {
            width: 80px; height: 80px; background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            border-radius: 50%; border: 6px solid #fdfcf0; display: flex; align-items: center; justify-content: center;
            transform: translateY(-35px); box-shadow: 0 8px 15px rgba(198, 40, 40, 0.3);
        }
        .nav-center-icon { height: 55px; width: auto; display: block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
    </style>
</head>
<body>

    <div class="rank-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/rank_header.png" class="rank-banner-img">
    </div>

    <div class="tab-container">
        <button class="rank-tab active" onclick="switchTab('village')"><i class="fas fa-map-marked-alt"></i> å…¨é‡Œçˆ­éœ¸</button>
        <button class="rank-tab inactive" onclick="switchTab('user')"><i class="fas fa-user-ninja"></i> å€‹äººè‹±é›„</button>
    </div>

    <div class="info-bar">
        <a href="#" class="info-scroll-btn" onclick="showLevelInfo()">
            <i class="fas fa-scroll"></i> åƒé–±è‹±é›„æ¦œæ–‡ (ç­‰ç´šèªªæ˜)
        </a>
    </div>

    <div class="podium-section" id="podium-area">
        <div style="color:#a1887f;">æ­£åœ¨è¨ˆç®—åŠŸå¾·å€¼...</div>
    </div>

    <div class="list-container" id="list-area"></div>

    <div class="fake-navbar">
        <a href="/" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png" class="nav-icon"><span>é¦–é </span></a>
        <a href="/map" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_map.png" class="nav-icon"><span>åœ°åœ–</span></a>
        <a href="/upload" class="nav-center-btn"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="nav-center-icon"></a>
        <a href="/gallery" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" class="nav-icon"><span>åœ–åº«</span></a>
        <a href="/leaderboard" class="nav-item active"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_leaderboard.png" class="nav-icon"><span>æ¦œå–®</span></a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        const ALL_VILLAGES = [
            "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "è‹‘æ¸¯é‡Œ", "è¥¿å¹³é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "æˆ¿è£¡é‡Œ", "å®¢åº„é‡Œ", "ä¸­æ­£é‡Œ", 
            "æ–°å¾©é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "èˆŠç¤¾é‡Œ", "å±±è…³é‡Œ", "ç¦ç”°é‡Œ", "æ³°ç”°é‡Œ", "ç‰ç”°é‡Œ", "å—å‹¢é‡Œ", 
            "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "ä¸Šé¤¨é‡Œ", "æ°´å¡é‡Œ", "è‹‘å‘é‡Œ", "å‡ºæ°´é‡Œ"
        ];

        let currentTab = 'village';
        let rawData = [];

        // é è¨­é ­åƒ (å¦‚æœçœŸçš„ç”Ÿä¸å‡ºä¾†ï¼Œå°±æœƒé¡¯ç¤ºé€™å€‹)
        const DEFAULT_AVATAR = "https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png";

        fetch('/api/locations').then(r => r.json()).then(data => {
            rawData = data;
            renderVillageRank();
        });

        function switchTab(tab) {
            currentTab = tab;
            $('.rank-tab').removeClass('active').addClass('inactive');
            if(tab === 'village') {
                $('.rank-tab:first').addClass('active').removeClass('inactive');
                renderVillageRank();
            } else {
                $('.rank-tab:last').addClass('active').removeClass('inactive');
                renderUserRank();
            }
        }

        // ğŸ”¥ è¶…èƒ½åŠ›é ­åƒç”¢ç”Ÿå™¨ï¼šå·²ä¿®å¾©ä¸­æ–‡ç ´åœ–å•é¡Œ ğŸ”¥
        function getAvatar(seed, isUser) {
            // å°ä¸­æ–‡åå­—é€²è¡Œç·¨ç¢¼ï¼Œé˜²æ­¢ç ´åœ–
            let encodedSeed = encodeURIComponent(seed);

            if(!isUser) {
                // é‡Œåˆ¥ä½¿ç”¨æ–‡å­—ç¸®å¯«
                return `https://ui-avatars.com/api/?name=${encodedSeed}&background=random&color=fff&size=128`;
            }
            // ä½¿ç”¨ v9 adventurer-neutral (ä¸­æ€§å†’éšªå®¶)
            // é€™è£¡ä½¿ç”¨äº† encodedSeedï¼Œæ‰€ä»¥ä¸­æ–‡åå­—ä¸æœƒå†è®“ç¶²å€çˆ†ç‚¸äº†
            return `https://api.dicebear.com/9.x/adventurer-neutral/svg?seed=${encodedSeed}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        }

        function renderVillageRank() {
            let counts = {};
            ALL_VILLAGES.forEach(v => counts[v] = 0);
            rawData.forEach(i => {
                let v = "å…¶ä»–";
                if (i['é‡Œåˆ¥'] && i['é‡Œåˆ¥'] !== "nan") v = i['é‡Œåˆ¥'];
                else if (i.nickname && i.nickname.includes("#")) v = i.nickname.split("#")[1];
                else if (i.area) v = i.area;
                if(counts[v] !== undefined) counts[v]++;
            });

            let sorted = Object.keys(counts).map(k => ({name: k, count: counts[k]}))
                                          .sort((a,b) => b.count - a.count);
            renderPodium(sorted);
            renderList(sorted.slice(3, 53)); // Top 50
        }

        function renderUserRank() {
            let counts = {};
            rawData.forEach(i => {
                let name = i.nickname ? i.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                if(!counts[name]) counts[name] = 0;
                counts[name]++;
            });

            let sorted = Object.keys(counts).map(k => ({name: k, count: counts[k]}))
                                          .sort((a,b) => b.count - a.count);
            
            renderPodium(sorted, true);
            renderList(sorted.slice(3, 53), true); // Top 50
        }

        function renderPodium(data, isUser=false) {
            let p1 = data[0] || {name:'è™›ä½ä»¥å¾…', count:0};
            let p2 = data[1] || {name:'è™›ä½ä»¥å¾…', count:0};
            let p3 = data[2] || {name:'è™›ä½ä»¥å¾…', count:0};

            // ä½¿ç”¨ä¿®å¾©å¾Œçš„ getAvatar
            let img1 = isUser ? getAvatar(p1.name, true) : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_gold.png`;
            let img2 = isUser ? getAvatar(p2.name, true) : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_silver.png`;
            let img3 = isUser ? getAvatar(p3.name, true) : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_bronze.png`;

            // å®‰å…¨æ°£å›Š (onerror)
            let err = `onerror="this.src='${DEFAULT_AVATAR}'"`;

            let html = `
                <div class="podium-col p-2">
                    <img src="${img2}" class="p-avatar" ${err}>
                    <div class="p-base">
                        <div class="p-name">${p2.name}</div>
                        <div class="p-score">${p2.count} å°Š</div>
                    </div>
                </div>
                <div class="podium-col p-1">
                    <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/crown.png" class="p-crown">
                    <img src="${img1}" class="p-avatar" ${err}>
                    <div class="p-base">
                        <div class="p-name">${p1.name}</div>
                        <div class="p-score">${p1.count} å°Š</div>
                    </div>
                </div>
                <div class="podium-col p-3">
                    <img src="${img3}" class="p-avatar" ${err}>
                    <div class="p-base">
                        <div class="p-name">${p3.name}</div>
                        <div class="p-score">${p3.count} å°Š</div>
                    </div>
                </div>
            `;
            $('#podium-area').html(html);
        }

        function renderList(data, isUser=false) {
            let html = '';
            
            data.forEach((item, idx) => {
                if (item.count === 0) return;
                
                // ä½¿ç”¨ä¿®å¾©å¾Œçš„ getAvatar
                let img = getAvatar(item.name, isUser);
                let percent = Math.min((item.count / 20) * 100, 100);
                
                // å®‰å…¨æ°£å›Š
                let err = `onerror="this.src='${DEFAULT_AVATAR}'"`;

                let levelTag = '';
                if (isUser) {
                    if (item.count >= 20) levelTag = '<span class="lvl-tag lvl-max">åœ¨ä¸–åœŸåœ°å…¬</span>';
                    else if (item.count >= 10) levelTag = '<span class="lvl-tag lvl-3">è™”èª çˆä¸»</span>';
                    else levelTag = ''; 
                }

                html += `
                    <div class="list-item">
                        <div class="list-rank">${idx+4}</div>
                        <img src="${img}" class="list-avatar" ${err}>
                        <div class="list-info">
                            <div class="list-name">${item.name} ${levelTag}</div>
                            ${isUser ? '<div class="list-sub">æŒçºŒç´¯ç©åŠŸå¾·ä¸­...</div>' : ''}
                            <div class="list-bar-bg">
                                <div class="list-bar-fill" style="width: ${percent}%;"></div>
                            </div>
                        </div>
                        <div class="list-count">${item.count}</div>
                    </div>
                `;
            });
            
            if(html === '') html = '<div style="text-align:center; color:#999; padding:30px;">æœŸå¾…æ›´å¤šè‹±é›„ä¸Šæ¦œï¼</div>';
            $('#list-area').html(html);
        }

        function showLevelInfo() {
            Swal.fire({
                title: 'ğŸ“œ è‹±é›„æ¦œæ–‡',
                html: `
                    <div style="text-align:left; font-size:0.9rem; line-height:1.8;">
                        <p>ç´¯ç©ä¸Šå‚³æ•¸é‡ï¼Œå¯ç²å¾—é„‰æ°‘å°è™Ÿï¼š</p>
                        <span class="lvl-tag">å°‹ç¥å°èŒæ–°</span>ï¼š1~4 å°Š<br>
                        <span class="lvl-tag">ç†±è¡€è­·è¡›éšŠ</span>ï¼š5~9 å°Š<br>
                        <span class="lvl-tag lvl-3">è™”èª çˆä¸»</span>ï¼š10~19 å°Š<br>
                        <span class="lvl-tag lvl-max">åœ¨ä¸–åœŸåœ°å…¬</span>ï¼š20 å°Šä»¥ä¸Š<br>
                        <br>
                        <small style="color:#888;">* ç³»çµ±æ¯ 10 åˆ†é˜æ›´æ–°ä¸€æ¬¡æ¦œå–®</small>
                    </div>
                `,
                confirmButtonText: 'æ”¶åˆ°ï¼Œç¹¼çºŒå°‹ç¥ï¼',
                confirmButtonColor: '#d32f2f'
            });
        }
    </script>
</body>
</html>
