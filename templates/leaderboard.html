{% extends "base.html" %}
{% set active_page = "leaderboard" %}

{% block title %}å°‹ç¥é¢¨é›²æ¦œ - è·¯å¾‘åµæ¸¬æ¨¡å¼{% endblock %}

{% block styles %}
<style>
    body { background-color: #fdfcf0; padding-bottom: 80px; }
    
    /* åµæ¸¬å€æ¨£å¼ */
    .debug-zone {
        background: #333; color: white; padding: 20px; text-align: center;
        border-bottom: 5px solid #d32f2f;
    }
    .debug-img-container { margin-bottom: 20px; border-bottom: 1px dashed #555; padding-bottom: 10px; }
    .debug-label { color: #ffeb3b; font-weight: bold; margin-bottom: 5px; display: block; }
    .debug-img { 
        width: 80%; max-width: 300px; height: auto; 
        border: 2px solid red; background: white; min-height: 50px;
    }

    /* åŸæœ¬çš„æ¨£å¼ */
    .rank-header { text-align: center; padding: 10px 0; display: none; /* æš«æ™‚éš±è—åŸæœ¬æ¨™é¡Œï¼Œå°ˆå¿ƒæ¸¬è©¦ */ }
    
    /* é›™æ¦œåˆ‡æ›æŒ‰éˆ• */
    .tab-container { display: flex; justify-content: center; gap: 10px; margin: 15px auto; width: 90%; max-width: 400px; background: #fff; padding: 5px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .tab-btn { flex: 1; padding: 10px 0; border-radius: 40px; text-align: center; font-weight: bold; color: #888; cursor: pointer; transition: 0.3s; }
    .tab-btn.active { background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; }
    
    .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 8px; margin-bottom: 30px; height: 230px; }
    .podium-item { display: flex; flex-direction: column; align-items: center; }
    .rank-1 { width: 110px; } .rank-2 { width: 90px; } .rank-3 { width: 90px; }
    
    .rank-avatar { width: 60px; height: 60px; background: white; border-radius: 50%; border: 4px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; margin-bottom: -15px; z-index: 5; position: relative; }
    .rank-1 .rank-avatar { width: 80px; height: 80px; border-color: #ffd700; font-size: 2rem; }
    .crown-icon { position: absolute; top: -45px; font-size: 40px; animation: spin 3s infinite linear; }
    @keyframes spin { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
    
    .podium-block { width: 100%; border-radius: 15px 15px 0 0; display: flex; flex-direction: column; align-items: center; padding-top: 25px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .rank-1 .podium-block { height: 130px; background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); }
    .rank-2 .podium-block { height: 100px; background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%); }
    .rank-3 .podium-block { height: 80px; background: linear-gradient(135deg, #ffab91 0%, #d84315 100%); }
    
    .list-container { width: 92%; margin: 0 auto; background: white; border-radius: 25px; padding: 10px; min-height: 200px; }
    .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
    .list-rank { width: 28px; height: 28px; background: #8d6e63; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 12px; }
    .list-info { flex: 1; }
    .list-count { font-weight: bold; color: #d32f2f; }
    .tab-content { display: none; } .tab-content.active { display: block; }
    #loading-box { text-align: center; padding: 50px; color: #aaa; }
</style>
{% endblock %}

{% block content %}

    <div class="debug-zone">
        <h3>ğŸ•µï¸â€â™‚ï¸ åœ–ç‰‡è·¯å¾‘åµæ¸¬ä¸­</h3>
        <p>è«‹å‘Šè¨´æˆ‘å“ªä¸€å¼µåœ–é¡¯ç¤ºå‡ºä¾†äº†ï¼Ÿ</p>

        <div class="debug-img-container">
            <span class="debug-label">æ¸¬è©¦ 1: åŠ ä¸Š yuanli_ui è³‡æ–™å¤¾ (ç„¡ç‰ˆæœ¬è™Ÿ)</span>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/yuanli_ui/leaderboard_top.png" class="debug-img">
        </div>

        <div class="debug-img-container">
            <span class="debug-label">æ¸¬è©¦ 2: åŠ ä¸Š yuanli_ui è³‡æ–™å¤¾ (æœ‰ç‰ˆæœ¬è™Ÿ)</span>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768742671/yuanli_ui/leaderboard_top.png" class="debug-img">
        </div>

        <div class="debug-img-container">
            <span class="debug-label">æ¸¬è©¦ 3: åªæœ‰æª”å (ç„¡è³‡æ–™å¤¾/ç„¡ç‰ˆæœ¬è™Ÿ)</span>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/leaderboard_top.png" class="debug-img">
        </div>
        
        <div class="debug-img-container">
            <span class="debug-label">æ¸¬è©¦ 4: ä½ çš„åŸå§‹é€£çµ (æª¢æŸ¥ç”¨)</span>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768742671/leaderboard_top.png" class="debug-img">
        </div>
    </div>

    <div class="tab-container">
        <div class="tab-btn active" onclick="switchTab('village')">å…¨é‡Œçˆ­éœ¸</div>
        <div class="tab-btn" onclick="switchTab('personal')">å€‹äººè‹±é›„</div>
    </div>

    <div id="loading-box"><i class="fas fa-spinner fa-spin"></i> è®€å–ä¸­...</div>
    <div id="tab-village" class="tab-content active"><div class="podium-container" id="podium-village"></div><div class="list-container" id="list-village"></div></div>
    <div id="tab-personal" class="tab-content"><div class="podium-container" id="podium-personal"></div><div class="list-container" id="list-personal"></div></div>
    <div style="height:30px;"></div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = ["è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"];
    let villageData = [], personalData = [];

    window.switchTab = function(type) {
        $('.tab-btn').removeClass('active'); $('.tab-content').removeClass('active');
        if (type === 'village') { $('.tab-btn:first-child').addClass('active'); $('#tab-village').addClass('active'); } 
        else { $('.tab-btn:last-child').addClass('active'); $('#tab-personal').addClass('active'); }
    };

    fetch('/api/locations?t=' + new Date().getTime()).then(r => r.json()).then(data => {
        let vCounts = {}, pCounts = {};
        ALL_VILLAGES.forEach(v => vCounts[v] = 0);

        data.forEach(item => {
            let rawName = item.nickname || item.name || '';
            let displayName = rawName, assignedVillage = null;
            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#'); displayName = parts[0]; let vName = parts[1];
                if (ALL_VILLAGES.includes(vName)) assignedVillage = vName;
            } else {
                let soup = (item.area || "") + (item.address || "") + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) assignedVillage = matches.find(term => ALL_VILLAGES.includes(term));
            }
            if (assignedVillage) vCounts[assignedVillage]++;
            if (displayName && displayName !== 'ç†±å¿ƒé„‰è¦ª' && displayName !== 'å–„å¿ƒäººå£«') {
                let key = rawName; 
                if (!pCounts[key]) pCounts[key] = { name: displayName, village: assignedVillage || 'æœªçŸ¥', count: 0 };
                pCounts[key].count++;
            }
        });

        villageData = Object.keys(vCounts).map(key => ({ name: key, count: vCounts[key] })).sort((a, b) => b.count - a.count);
        personalData = Object.values(pCounts).sort((a, b) => b.count - a.count);
        renderPodium('village', villageData); renderList('village', villageData);
        renderPodium('personal', personalData); renderList('personal', personalData);
        $('#loading-box').hide();
    });

    function renderPodium(type, data) {
        let d1=data[0]||{name:'å¾ç¼º',count:'-'}, d2=data[1]||{name:'å¾ç¼º',count:'-'}, d3=data[2]||{name:'å¾ç¼º',count:'-'};
        $(`#podium-${type}`).html(`
            <div class="podium-item rank-2"><div class="rank-avatar">ğŸ¥ˆ</div><div class="podium-block"><div class="rank-name">${d2.name}</div><div class="count-badge">${d2.count}</div></div></div>
            <div class="podium-item rank-1"><div class="crown-icon">ğŸ‘‘</div><div class="rank-avatar">ğŸ¥‡</div><div class="podium-block"><div class="rank-name">${d1.name}</div><div class="count-badge">${d1.count}</div></div></div>
            <div class="podium-item rank-3"><div class="rank-avatar">ğŸ¥‰</div><div class="podium-block"><div class="rank-name">${d3.name}</div><div class="count-badge">${d3.count}</div></div></div>
        `);
    }

    function renderList(type, data) {
        let html = '', maxCount = data[0] ? data[0].count : 1;
        for (let i = 3; i < data.length; i++) {
            let item = data[i]; if (item.count === 0 && type === 'personal') continue;
            let percent = (item.count / maxCount) * 100;
            html += `<div class="list-item"><div class="list-rank">${i+1}</div><div class="list-info"><div class="list-name">${item.name}</div><div class="list-bar-bg"><div class="list-bar-fill" style="width:${percent}%"></div></div></div><div class="list-count">${item.count}</div></div>`;
        }
        $(`#list-${type}`).html(html);
    }
</script>
{% endblock %}
