<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°‹ç¥è‹±é›„æ¦œ - è‹‘è£¡é®</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #fdfcf0;
            background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 110px; /* é¿é–‹åº•éƒ¨å°èˆª */
            margin: 0;
        }

        /* --- é ‚éƒ¨ Banner --- */
        .rank-header {
            text-align: center;
            padding: 20px 0 10px 0;
            background: linear-gradient(to bottom, #fff3e0, #fdfcf0);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .rank-title-img { width: 200px; max-width: 80%; }

        /* --- åˆ‡æ›æŒ‰éˆ• (å…¨é‡Œ/å€‹äºº) --- */
        .toggle-container {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;
        }
        .toggle-btn {
            padding: 8px 20px; border-radius: 50px; font-weight: bold; border: none;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: 0.2s;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .toggle-btn.active { background: #c62828; color: white; transform: scale(1.05); }
        .toggle-btn.inactive { background: #fff; color: #8d6e63; border: 1px solid #efebe9; }

        /* --- èªªæ˜æŒ‰éˆ• --- */
        .info-badge {
            text-align: center; margin-bottom: 25px;
        }
        .info-btn {
            background: #ffebee; color: #c62828; 
            padding: 5px 15px; border-radius: 20px; 
            font-size: 0.85rem; font-weight: bold; text-decoration: none;
            display: inline-flex; align-items: center; gap: 5px;
        }

        /* --- å‰ä¸‰åçå° (Podium) --- */
        .podium-container {
            display: flex; align-items: flex-end; justify-content: center;
            height: 220px; margin-bottom: 30px; gap: 10px;
        }
        
        .podium-place {
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }

        /* å† è» (ä¸­) */
        .place-1 { z-index: 3; margin-bottom: 20px; }
        .place-1 .crown { width: 40px; position: absolute; top: -45px; animation: float 2s infinite ease-in-out; }
        .place-1 .avatar { width: 80px; height: 80px; border: 4px solid #ffca28; border-radius: 50%; background: #fff; z-index: 2; object-fit: cover;}
        .place-1 .base { 
            width: 100px; height: 110px; 
            background: linear-gradient(180deg, #ffca28 0%, #ff6f00 100%);
            border-radius: 10px 10px 0 0; color: white; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 5px 15px rgba(255, 111, 0, 0.3);
        }

        /* äºè» (å·¦) */
        .place-2 { z-index: 2; }
        .place-2 .avatar { width: 65px; height: 65px; border: 3px solid #cfd8dc; border-radius: 50%; background: #fff; margin-bottom: -10px; z-index: 2; object-fit: cover;}
        .place-2 .base { 
            width: 90px; height: 80px; 
            background: linear-gradient(180deg, #cfd8dc 0%, #90a4ae 100%);
            border-radius: 10px 10px 0 0; color: white; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 5px 15px rgba(144, 164, 174, 0.3);
        }

        /* å­£è» (å³) */
        .place-3 { z-index: 2; }
        .place-3 .avatar { width: 65px; height: 65px; border: 3px solid #d7ccc8; border-radius: 50%; background: #fff; margin-bottom: -10px; z-index: 2; object-fit: cover;}
        .place-3 .base { 
            width: 90px; height: 60px; 
            background: linear-gradient(180deg, #d7ccc8 0%, #8d6e63 100%);
            border-radius: 10px 10px 0 0; color: white; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 5px 15px rgba(141, 110, 99, 0.3);
        }

        .rank-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        .rank-score { font-size: 0.85rem; opacity: 0.9; }
        .medal-icon { width: 25px; margin-bottom: 5px; }

        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .rank-list { padding: 0 15px; max-width: 600px; margin: 0 auto; }
        .rank-item {
            background: white; border-radius: 15px; padding: 15px;
            display: flex; align-items: center; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #fff;
        }
        .rank-num { width: 30px; font-weight: bold; color: #8d6e63; font-size: 1.1rem; text-align: center;}
        .rank-user-img { width: 45px; height: 45px; border-radius: 50%; margin: 0 15px; background: #eee; object-fit: cover;}
        .rank-info { flex: 1; }
        .rank-user-name { font-weight: bold; color: #333; }
        .rank-user-desc { font-size: 0.8rem; color: #888; }
        .rank-val { color: #c62828; font-weight: bold; font-size: 1.1rem; }

        /* --- åº•éƒ¨å°èˆªåˆ— (æ‰‹å‹•ä¿®æ­£ç‰ˆ) --- */
        .fake-navbar { 
            position: fixed; bottom: 0; width: 100%; 
            background: #fff; border-top: 1px solid #efebe9; 
            padding: 0 5px; height: 90px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 2000; box-shadow: 0 -5px 20px rgba(93, 64, 55, 0.05);
        }
        
        .nav-item { 
            text-align: center; color: #a1887f; text-decoration: none !important; 
            font-size: 0.75rem; flex: 1; display: flex; flex-direction: column; align-items: center; 
        }
        
        .nav-icon { 
            height: 42px; width: auto; margin-bottom: 3px; 
            filter: grayscale(100%) sepia(20%) opacity(0.8); 
            transition: 0.3s; 
        }
        
        /* ğŸ”¥ æ‰‹å‹•æŒ‡å®šï¼šå•Ÿå‹•ç‹€æ…‹ (ç´…è‰²) */
        .nav-item.active .nav-icon { 
            transform: scale(1.1); filter: none; 
            filter: drop-shadow(0 2px 2px rgba(211, 47, 47, 0.2)); 
        }
        .nav-item.active span { color: #d32f2f; font-weight: bold; }

        .nav-center-btn {
            width: 80px; height: 80px; 
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            border-radius: 50%; border: 6px solid #fdfcf0;
            display: flex; align-items: center; justify-content: center;
            transform: translateY(-35px); 
            box-shadow: 0 8px 15px rgba(198, 40, 40, 0.3);
            text-decoration: none !important;
        }
        .nav-center-icon { height: 55px; width: auto; display: block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
    </style>
</head>
<body>

    <div class="rank-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/rank_header.png" class="rank-title-img" alt="å°‹ç¥è‹±é›„æ¦œ">
    </div>

    <div class="toggle-container">
        <button class="toggle-btn active" onclick="switchTab('village')"><i class="fas fa-flag"></i> å…¨é‡Œçˆ­éœ¸</button>
        <button class="toggle-btn inactive" onclick="switchTab('user')"><i class="fas fa-user"></i> å€‹äººè‹±é›„</button>
    </div>

    <div class="info-badge">
        <a href="#" class="info-btn" onclick="Swal.fire('ç­‰ç´šèªªæ˜','ä¸Šå‚³è¶Šå¤šï¼Œå®˜ä½è¶Šå¤§ï¼<br>ç´¯ç©åŠŸå¾·ï¼Œé€ ç¦é„‰é‡Œã€‚','info')">
            <i class="fas fa-info-circle"></i> æŸ¥çœ‹ç­‰ç´šèªªæ˜
        </a>
    </div>

    <div class="podium-container" id="podium-area">
        <div style="color:#888;">æ­£åœ¨çµç®—é¦™ç«...</div>
    </div>

    <div class="rank-list" id="list-area"></div>

    <div class="fake-navbar">
        <a href="/" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png" class="nav-icon"><span>é¦–é </span>
        </a>
        <a href="/map" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_map.png" class="nav-icon"><span>åœ°åœ–</span>
        </a>
        <a href="/upload" class="nav-center-btn">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="nav-center-icon">
        </a>
        <a href="/gallery" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" class="nav-icon"><span>åœ–åº«</span>
        </a>
        <a href="/leaderboard" class="nav-item active">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_leaderboard.png" class="nav-icon"><span>æ¦œå–®</span>
        </a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        // è³‡æ–™è¼‰å…¥é‚è¼¯
        const ALL_VILLAGES = [
            "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "è‹‘æ¸¯é‡Œ", "è¥¿å¹³é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "æˆ¿è£¡é‡Œ", "å®¢åº„é‡Œ", "ä¸­æ­£é‡Œ", 
            "æ–°å¾©é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "èˆŠç¤¾é‡Œ", "å±±è…³é‡Œ", "ç¦ç”°é‡Œ", "æ³°ç”°é‡Œ", "ç‰ç”°é‡Œ", "å—å‹¢é‡Œ", 
            "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "ä¸Šé¤¨é‡Œ", "æ°´å¡é‡Œ", "è‹‘å‘é‡Œ", "å‡ºæ°´é‡Œ"
        ];

        let currentTab = 'village';
        let rawData = [];

        // å•Ÿå‹•æ™‚æŠ“è³‡æ–™
        fetch('/api/locations')
            .then(r => r.json())
            .then(data => {
                rawData = data;
                renderVillageRank(); // é è¨­é¡¯ç¤ºå…¨é‡Œ
            });

        function switchTab(tab) {
            currentTab = tab;
            $('.toggle-btn').removeClass('active').addClass('inactive');
            if(tab === 'village') {
                $('.toggle-btn:first').addClass('active').removeClass('inactive');
                renderVillageRank();
            } else {
                $('.toggle-btn:last').addClass('active').removeClass('inactive');
                renderUserRank();
            }
        }

        function renderVillageRank() {
            // çµ±è¨ˆå„é‡Œæ•¸é‡
            let counts = {};
            ALL_VILLAGES.forEach(v => counts[v] = 0);
            rawData.forEach(i => {
                // å„ªå…ˆå¾ CSV æ¬„ä½è®€å–ï¼Œè‹¥ç„¡å‰‡å˜—è©¦è§£ææš±ç¨±
                let v = "å…¶ä»–";
                if (i['é‡Œåˆ¥'] && i['é‡Œåˆ¥'] !== "nan") {
                    v = i['é‡Œåˆ¥'];
                } else if (i.nickname && i.nickname.includes("#")) {
                    v = i.nickname.split("#")[1];
                } else if (i.area) {
                    v = i.area;
                }
                
                if(counts[v] !== undefined) counts[v]++;
            });

            // æ’åº
            let sorted = Object.keys(counts).map(k => ({name: k, count: counts[k]}))
                                          .sort((a,b) => b.count - a.count);

            renderPodium(sorted);
            
            // ğŸ”¥ è¨­å®šé™åˆ¶ï¼šåªé¡¯ç¤ºå‰ 50 å (3 æ˜¯èµ·å§‹ç´¢å¼•, 53 æ˜¯çµæŸç´¢å¼•)
            renderList(sorted.slice(3, 53)); 
        }

        function renderUserRank() {
            // ç°¡å–®æ¨¡æ“¬ï¼šä¾ä¸Šå‚³è€…çµ±è¨ˆ
            let counts = {};
            rawData.forEach(i => {
                let name = i.nickname ? i.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                if(!counts[name]) counts[name] = 0;
                counts[name]++;
            });

            let sorted = Object.keys(counts).map(k => ({name: k, count: counts[k]}))
                                          .sort((a,b) => b.count - a.count);
            
            renderPodium(sorted, true);
            
            // ğŸ”¥ è¨­å®šé™åˆ¶ï¼šå€‹äººæ¦œä¹Ÿåªé¡¯ç¤ºå‰ 50 å
            renderList(sorted.slice(3, 53), true);
        }

        // æ¸²æŸ“çå°
        function renderPodium(data, isUser=false) {
            let p1 = data[0] || {name:'è™›ä½ä»¥å¾…', count:0};
            let p2 = data[1] || {name:'è™›ä½ä»¥å¾…', count:0};
            let p3 = data[2] || {name:'è™›ä½ä»¥å¾…', count:0};

            let img1 = isUser ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${p1.name}` : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_gold.png`;
            let img2 = isUser ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${p2.name}` : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_silver.png`;
            let img3 = isUser ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${p3.name}` : `https://res.cloudinary.com/diuoghid2/image/upload/v1/badge_bronze.png`;

            let html = `
                <div class="podium-place place-2">
                    <img src="${img2}" class="avatar">
                    <div class="base">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/medal_2.png" class="medal-icon">
                        <div class="rank-name">${p2.name}</div>
                        <div class="rank-score">${p2.count} å°Š</div>
                    </div>
                </div>
                <div class="podium-place place-1">
                    <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/crown.png" class="crown">
                    <img src="${img1}" class="avatar">
                    <div class="base">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/medal_1.png" class="medal-icon">
                        <div class="rank-name">${p1.name}</div>
                        <div class="rank-score">${p1.count} å°Š</div>
                    </div>
                </div>
                <div class="podium-place place-3">
                    <img src="${img3}" class="avatar">
                    <div class="base">
                        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/medal_3.png" class="medal-icon">
                        <div class="rank-name">${p3.name}</div>
                        <div class="rank-score">${p3.count} å°Š</div>
                    </div>
                </div>
            `;
            $('#podium-area').html(html);
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderList(data, isUser=false) {
            let html = '';
            data.forEach((item, idx) => {
                // å¦‚æœæ•¸é‡æ˜¯ 0ï¼Œå°±ä¸é¡¯ç¤ºåœ¨æ¦œå–®ä¸Š (é¿å…ä¸€å † 0 çš„äººä½”ç‰ˆé¢)
                if (item.count === 0) return;

                let img = isUser ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.name}` : `https://ui-avatars.com/api/?name=${item.name}&background=random&color=fff`;
                html += `
                    <div class="rank-item">
                        <div class="rank-num">${idx+4}</div>
                        <img src="${img}" class="rank-user-img">
                        <div class="rank-info">
                            <div class="rank-user-name">${item.name}</div>
                            <div class="rank-user-desc">æ„Ÿè¬ä»˜å‡ºè²¢ç»ï¼</div>
                        </div>
                        <div class="rank-val">${item.count}</div>
                    </div>
                `;
            });
            
            // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ (ä¾‹å¦‚æ²’æœ‰ç¬¬ 4 åä»¥å¾Œçš„äºº)
            if (html === '') {
                html = '<div style="text-align:center; color:#999; padding:20px;">æœŸå¾…æ›´å¤šè‹±é›„ä¸Šæ¦œï¼</div>';
            }
            
            $('#list-area').html(html);
        }
    </script>
</body>
</html>
