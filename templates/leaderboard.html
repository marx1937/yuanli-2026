{% block scripts %}
<script>
    // --- ğŸ† è‹±é›„æ¦œæ ¸å¿ƒæ¼”ç®—æ³• ---

    fetch('/api/locations')
    .then(r => r.json())
    .then(data => {
        // 1. è³‡æ–™æ­¸æˆ¶ (Aggregation) - è§£æ±ºã€Œç‰¹æ´›ä¼Šæœ¨é¦¬ã€å°è‡´çš„åå­—åˆ†èº«å•é¡Œ
        let userCounts = {};
        
        data.forEach(item => {
            // (A) å–å¾—åŸå§‹æš±ç¨± (ç›¸å®¹èˆŠè³‡æ–™ nan/null)
            let rawName = item.nickname || item.name || "ç†±å¿ƒé„‰è¦ª";
            
            // (B) æ¸…æ´—åå­—ï¼šç§»é™¤ # å¾Œé¢çš„é‡Œåˆ¥è³‡è¨Š
            // èˆŠè³‡æ–™ "ç‹å°æ˜" -> "ç‹å°æ˜"
            // æ–°è³‡æ–™ "ç‹å°æ˜#å®¢åº„é‡Œ" -> "ç‹å°æ˜" (é€™æ¨£ç©åˆ†æ‰æœƒåŠ åœ¨ä¸€èµ·ï¼)
            let cleanName = rawName.split('#')[0].trim();
            
            // (C) æ’é™¤ç„¡æ•ˆåå­— (å¦‚ nan)
            if(cleanName.toLowerCase() === 'nan' || cleanName === "") {
                cleanName = "ç†±å¿ƒé„‰è¦ª";
            }

            // (D) ç´¯åŠ ç©åˆ†
            if (userCounts[cleanName]) {
                userCounts[cleanName]++;
            } else {
                userCounts[cleanName] = 1;
            }
        });

        // 2. è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº (Sorting)
        let sortedUsers = Object.keys(userCounts).map(key => {
            return { name: key, count: userCounts[key] };
        }).sort((a, b) => b.count - a.count); // ç”±é«˜åˆ°ä½æ’åº

        // 3. æ¸²æŸ“å‰ä¸‰å (Top 3 Heroes)
        // ç¢ºä¿ HTML ä¸­æœ‰å°æ‡‰çš„ ID: #top1-name, #top1-count, #top1-avatar ...
        if (sortedUsers.length > 0) renderTopHero(1, sortedUsers[0]);
        if (sortedUsers.length > 1) renderTopHero(2, sortedUsers[1]);
        if (sortedUsers.length > 2) renderTopHero(3, sortedUsers[2]);

        // 4. æ¸²æŸ“åˆ—è¡¨ (Rank 4 ~ 50) - ä¾ç…§ v7.0 éµå¾‹é™åˆ¶æ•¸é‡
        let listContainer = document.getElementById('leaderboard-list');
        listContainer.innerHTML = ""; // æ¸…ç©º

        // å–ç¬¬ 4 ååˆ°ç¬¬ 53 å (index 3 ~ 52)
        sortedUsers.slice(3, 53).forEach((user, index) => {
            let rank = index + 4; // å¯¦éš›æ’å
            
            // ç”Ÿæˆ DiceBear é ­åƒ (ä½¿ç”¨æ¸…æ´—å¾Œçš„ç´”åï¼Œé¿å…ç ´åœ–)
            let avatarUrl = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${encodeURIComponent(user.name)}`;

            let html = `
                <div class="rank-item" style="display: flex; align-items: center; background: white; margin-bottom: 10px; padding: 10px 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <div style="font-weight: bold; color: #8d6e63; width: 30px; font-size: 1.1rem;">${rank}</div>
                    <img src="${avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; border: 2px solid #ffe082;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #5d4037;">${user.name}</div>
                        <div style="font-size: 0.8rem; color: #a1887f;">å°‹ç¥çµäºº</div>
                    </div>
                    <div style="font-weight: bold; color: #d32f2f; font-size: 1.2rem;">
                        ${user.count} <span style="font-size:0.8rem; color:#8d6e63;">å°Š</span>
                    </div>
                </div>
            `;
            listContainer.innerHTML += html;
        });
    })
    .catch(err => console.error("Leaderboard Error:", err));

    // æ¸²æŸ“å‰ä¸‰åçš„è¼”åŠ©å‡½å¼
    function renderTopHero(rank, user) {
        try {
            // é€™è£¡å‡è¨­æ‚¨çš„ HTML æœ‰é€™äº› IDï¼Œå¦‚æœæ²’æœ‰è«‹å‘ŠçŸ¥ï¼Œæˆ‘å¹«æ‚¨è£œ HTML çµæ§‹
            document.getElementById(`top${rank}-name`).innerText = user.name;
            document.getElementById(`top${rank}-count`).innerText = user.count;
            
            // é ­åƒè™•ç†
            let imgEl = document.getElementById(`top${rank}-avatar`);
            if(imgEl) {
                imgEl.src = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${encodeURIComponent(user.name)}`;
            }
        } catch(e) {
            console.log(`Rank ${rank} render skipped (elements not found).`);
        }
    }
</script>
{% endblock %}
