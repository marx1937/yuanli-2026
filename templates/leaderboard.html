{% extends "base.html" %}
{% set active_page = "leaderboard" %}

{% block styles %}
<style>
    /* èƒŒæ™¯è¨­å®šï¼šç±³è‰²å®£ç´™è³ªæ„Ÿ */
    body {
        background-color: #fdfcf0;
        background-image: radial-gradient(#d7ccc8 1.5px, transparent 1.5px);
        background-size: 24px 24px;
        min-height: 100vh;
    }

    .page-header {
        text-align: center; margin-top: 25px; margin-bottom: 20px;
    }
    
    .header-title {
        background: #d32f2f; color: #fff; 
        display: inline-block; padding: 8px 25px; 
        border-radius: 50px; font-weight: bold; font-size: 1.2rem;
        box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        border: 2px solid #b71c1c;
    }

    /* --- å‰ä¸‰åè‹±é›„å° --- */
    .top-heroes-container {
        display: flex; justify-content: center; align-items: flex-end;
        margin-bottom: 30px; gap: 10px; padding: 0 10px;
    }

    .hero-card {
        background: white; border-radius: 15px;
        text-align: center; padding: 10px 5px;
        box-shadow: 0 5px 15px rgba(93, 64, 55, 0.1);
        display: flex; flex-direction: column; align-items: center;
        position: relative; border: 2px solid #fff;
    }

    /* å† è»ç‰¹åˆ¥å¤§ */
    .hero-card.rank-1 { width: 38%; z-index: 10; padding-top: 25px; border-color: #ffd700; transform: translateY(-10px); }
    .hero-card.rank-2 { width: 30%; border-color: #c0c0c0; }
    .hero-card.rank-3 { width: 30%; border-color: #cd7f32; }

    .crown-icon {
        position: absolute; top: -20px; font-size: 2rem; 
        color: #ffd700; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        animation: float 3s ease-in-out infinite;
    }

    .hero-avatar {
        border-radius: 50%; border: 3px solid #eee; margin-bottom: 5px; background: #eee;
    }
    .rank-1 .hero-avatar { width: 70px; height: 70px; border-color: #ffd700; }
    .rank-2 .hero-avatar { width: 55px; height: 55px; border-color: #c0c0c0; }
    .rank-3 .hero-avatar { width: 55px; height: 55px; border-color: #cd7f32; }

    .hero-name { font-weight: bold; color: #5d4037; font-size: 0.95rem; margin-bottom: 2px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .hero-count { font-weight: 900; color: #d32f2f; font-size: 1.1rem; }
    .hero-count small { font-size: 0.7rem; color: #8d6e63; font-weight: normal; }

    /* --- åˆ—è¡¨å€ (4-50å) --- */
    .leaderboard-list {
        width: 92%; max-width: 500px; margin: 0 auto; padding-bottom: 40px;
    }

    .rank-item {
        display: flex; align-items: center;
        background: rgba(255,255,255,0.9);
        margin-bottom: 10px; padding: 12px 15px;
        border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.5);
        box-shadow: 0 2px 5px rgba(93, 64, 55, 0.05);
        transition: transform 0.1s;
    }
    .rank-item:active { transform: scale(0.98); background: #fff; }

    .rank-num { font-weight: bold; color: #8d6e63; width: 35px; font-size: 1.1rem; text-align: center;}
    .list-avatar { width: 42px; height: 42px; border-radius: 50%; margin-right: 15px; border: 2px solid #ffe082; background: #eee; }
    .list-info { flex: 1; }
    .list-name { font-weight: bold; color: #5d4037; font-size: 1rem; }
    .list-title { font-size: 0.75rem; color: #a1887f; }
    .list-score { font-weight: bold; color: #d32f2f; font-size: 1.2rem; }

    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    
    /* è¼‰å…¥ä¸­å‹•ç•« */
    .loading-spinner { text-align: center; color: #8d6e63; margin-top: 50px; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="header-title">
            <i class="fas fa-trophy" style="color:#ffca28; margin-right:5px;"></i> å°‹ç¥è‹±é›„æ¦œ
        </div>
        <div style="color: #8d6e63; font-size: 0.9rem; margin-top: 5px;">ç´¯ç©å°‹ç²æ•¸ Top 50</div>
    </div>

    <div id="loading" class="loading-spinner">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>æ­£åœ¨çµç®—æˆ°ç¸¾...
    </div>

    <div id="top-heroes" class="top-heroes-container" style="display: none;">
        <div class="hero-card rank-2">
            <img id="top2-img" class="hero-avatar" src="">
            <div id="top2-name" class="hero-name">--</div>
            <div class="hero-count"><span id="top2-score">0</span><small>å°Š</small></div>
            <div style="font-size:1.5rem; margin-top:-5px;">ğŸ¥ˆ</div>
        </div>

        <div class="hero-card rank-1">
            <i class="fas fa-crown crown-icon"></i>
            <img id="top1-img" class="hero-avatar" src="">
            <div id="top1-name" class="hero-name">--</div>
            <div class="hero-count"><span id="top1-score">0</span><small>å°Š</small></div>
            <div style="font-size:1.5rem; margin-top:-5px;">ğŸ¥‡</div>
        </div>

        <div class="hero-card rank-3">
            <img id="top3-img" class="hero-avatar" src="">
            <div id="top3-name" class="hero-name">--</div>
            <div class="hero-count"><span id="top3-score">0</span><small>å°Š</small></div>
            <div style="font-size:1.5rem; margin-top:-5px;">ğŸ¥‰</div>
        </div>
    </div>

    <div id="leaderboard-list" class="leaderboard-list">
        </div>
{% endblock %}

{% block scripts %}
<script>
    // ğŸ”¥ è‹±é›„æ¦œæ ¸å¿ƒé‚è¼¯ï¼šæ”¯æ´ç‰¹æ´›ä¼Šæœ¨é¦¬æ ¼å¼ (æš±ç¨±#é‡Œåˆ¥)
    fetch('/api/locations')
    .then(r => r.json())
    .then(data => {
        // 1. è³‡æ–™æ¸…æ´—èˆ‡æ­¸æˆ¶ (Normalization)
        let userCounts = {};
        
        data.forEach(item => {
            // æŠ“å–åå­—ï¼Œç›¸å®¹èˆŠè³‡æ–™
            let rawName = item.nickname || item.name || "ç†±å¿ƒé„‰è¦ª";
            
            // âœ‚ï¸ é—œéµï¼šåˆ‡é™¤ # å¾Œé¢çš„é‡Œåˆ¥
            let cleanName = rawName.split('#')[0].trim();
            
            // æ’é™¤ç„¡æ•ˆåå­—
            if (cleanName === "nan" || cleanName === "") cleanName = "ç†±å¿ƒé„‰è¦ª";

            // ç´¯åŠ ç©åˆ†
            if (userCounts[cleanName]) {
                userCounts[cleanName]++;
            } else {
                userCounts[cleanName] = 1;
            }
        });

        // 2. è½‰é™£åˆ—ä¸¦æ’åº (Sort)
        let sortedUsers = Object.keys(userCounts).map(key => {
            return { name: key, count: userCounts[key] };
        }).sort((a, b) => b.count - a.count);

        // 3. ç§»é™¤ Loadingï¼Œé¡¯ç¤ºä»‹é¢
        document.getElementById('loading').style.display = 'none';
        document.getElementById('top-heroes').style.display = 'flex';

        // 4. æ¸²æŸ“å‰ä¸‰å (Top 3)
        // ç‚ºäº†é¿å…è³‡æ–™å°‘æ–¼ 3 äººå ±éŒ¯ï¼ŒåŠ å€‹ç°¡æ˜“é˜²å‘†
        if (sortedUsers[0]) updateHero(1, sortedUsers[0]);
        if (sortedUsers[1]) updateHero(2, sortedUsers[1]);
        if (sortedUsers[2]) updateHero(3, sortedUsers[2]);

        // 5. æ¸²æŸ“åˆ—è¡¨ (Rank 4 ~ 50)
        let listContainer = document.getElementById('leaderboard-list');
        listContainer.innerHTML = ""; // æ¸…ç©º

        // åªå–ç¬¬ 4 ååˆ°ç¬¬ 53 å (index 3 ~ 52)
        sortedUsers.slice(3, 53).forEach((user, index) => {
            let rank = index + 4;
            // DiceBear é ­åƒç¨®å­ç¢¼éœ€ encodeï¼Œæ”¯æ´ä¸­æ–‡
            let avatarUrl = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${encodeURIComponent(user.name)}`;

            let html = `
                <div class="rank-item">
                    <div class="rank-num">${rank}</div>
                    <img src="${avatarUrl}" class="list-avatar" alt="avatar">
                    <div class="list-info">
                        <div class="list-name">${user.name}</div>
                        <div class="list-title">å°‹ç¥çµäºº</div>
                    </div>
                    <div class="list-score">${user.count} <small style="font-size:0.8rem; font-weight:normal;">å°Š</small></div>
                </div>
            `;
            listContainer.innerHTML += html;
        });
    })
    .catch(err => {
        console.error("Leaderboard Error:", err);
        document.getElementById('loading').innerHTML = "âš ï¸ è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
    });

    // è¼”åŠ©å‡½å¼ï¼šæ›´æ–°å‰ä¸‰å DOM
    function updateHero(rank, user) {
        let avatarUrl = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${encodeURIComponent(user.name)}`;
        
        let imgEl = document.getElementById(`top${rank}-img`);
        let nameEl = document.getElementById(`top${rank}-name`);
        let scoreEl = document.getElementById(`top${rank}-score`);

        if (imgEl) imgEl.src = avatarUrl;
        if (nameEl) nameEl.innerText = user.name;
        if (scoreEl) scoreEl.innerText = user.count;
    }
</script>
{% endblock %}
