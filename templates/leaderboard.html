{% extends "base.html" %}
{% set active_page = "leaderboard" %}

{% block title %}å°‹ç¥è‹±é›„æ¦œ - è‹‘è£¡ 25 é‡Œçˆ­éœ¸æˆ°{% endblock %}

{% block styles %}
<style>
    /* 1. èƒŒæ™¯èˆ‡åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. é ‚éƒ¨çœ‹æ¿å€ (æ–°åœ–æ¨£å¼) */
    .rank-header {
        text-align: center; padding: 25px 0 10px 0;
        position: relative; margin-bottom: 15px;
    }
    
    .rank-banner-img {
        width: 90%; max-width: 360px; height: auto;
        filter: drop-shadow(0 8px 10px rgba(93, 64, 55, 0.3));
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* 3. æˆ°åŠ›åˆ†æå®¤ (ç­‰ç´šèªªæ˜) */
    .rules-toggle-btn {
        background: #fff; color: #d32f2f; border: 1px solid #ffcdd2;
        padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        display: inline-flex; align-items: center; cursor: pointer;
        box-shadow: 0 4px 10px rgba(211, 47, 47, 0.1); margin-bottom: 10px;
        transition: 0.2s;
    }
    .rules-toggle-btn:active { transform: scale(0.95); background: #ffebee; }

    .rules-card {
        background: white; width: 90%; max-width: 450px; margin: 0 auto 30px auto;
        border-radius: 20px; padding: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        border: 2px solid #fff3e0; 
        display: none; /* é è¨­éš±è— */
    }
    
    .rule-row { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
    .rule-row:last-child { border-bottom: none; margin-bottom: 0; }
    .rule-icon { font-size: 1.8rem; width: 50px; text-align: center; margin-right: 10px; }
    .rule-content { flex: 1; text-align: left; }
    .rule-title { font-weight: bold; color: #5d4037; font-size: 1rem; }
    .rule-desc { font-size: 0.85rem; color: #888; }
    .rule-badge { 
        background: #ffe0b2; padding: 4px 12px; border-radius: 10px; 
        font-size: 0.85rem; color: #e65100; font-weight: bold; white-space: nowrap;
    }

    /* 4. å‰ä¸‰åé ’çå° */
    .podium-container {
        display: flex; justify-content: center; align-items: flex-end;
        gap: 8px; margin-bottom: 30px; padding: 0 10px; height: 210px;
    }
    .podium-item {
        display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        position: relative; transition: transform 0.3s;
    }
    .rank-1 { width: 110px; z-index: 3; }
    .rank-2 { width: 90px; z-index: 2; }
    .rank-3 { width: 90px; z-index: 1; }

    .rank-avatar {
        width: 60px; height: 60px; background: white; border-radius: 50%;
        border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        margin-bottom: -15px; z-index: 5; position: relative;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.5rem; overflow: hidden;
    }
    .rank-1 .rank-avatar { width: 80px; height: 80px; border-color: #ffd700; font-size: 2rem; }
    .rank-2 .rank-avatar { border-color: #c0c0c0; }
    .rank-3 .rank-avatar { border-color: #cd7f32; }

    .crown {
        position: absolute; top: -35px; width: 40px; 
        animation: spin-crown 3s infinite linear;
        filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.8));
    }
    @keyframes spin-crown { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }

    .podium-block {
        width: 100%; border-radius: 15px 15px 0 0;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        padding-top: 25px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .rank-1 .podium-block { height: 130px; background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); border-top: 4px solid #fff9c4; }
    .rank-2 .podium-block { height: 100px; background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%); border-top: 4px solid #f5f5f5; }
    .rank-3 .podium-block { height: 80px; background: linear-gradient(135deg, #ffab91 0%, #d84315 100%); border-top: 4px solid #ffccbc; }

    .village-name { font-weight: bold; font-size: 1.05rem; margin-bottom: 2px; }
    .count-badge { background: rgba(0,0,0,0.2); padding: 2px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }

    /* 5. åˆ—è¡¨æ¨£å¼ */
    .list-container {
        width: 92%; max-width: 500px; margin: 0 auto;
        background: white; border-radius: 25px;
        padding: 10px; box-shadow: 0 5px 20px rgba(93, 64, 55, 0.08);
    }
    .list-item {
        display: flex; align-items: center; padding: 15px;
        border-bottom: 1px solid #eee; transition: background 0.2s;
        border-radius: 15px; position: relative;
    }
    .list-rank {
        width: 28px; height: 28px; background: #8d6e63; color: white;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-weight: bold; font-size: 0.8rem; margin-right: 12px; flex-shrink: 0;
    }
    .list-info { flex: 1; text-align: left; }
    .list-name { font-weight: bold; color: #5d4037; font-size: 1.1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 5px; }
    .list-sub { font-size: 0.85rem; color: #999; margin-top: 2px; }
    
    /* ç­‰ç´šæ¨™ç±¤æ¨£å¼ */
    .list-village { font-weight: bold; color: #5d4037; font-size: 1.1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 5px; }
    .lvl-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; font-weight: normal; border: 1px solid #ddd; }
    .lvl-1 { background: #f1f8e9; color: #558b2f; border-color: #c5e1a5; } /* å°èŒæ–° */
    .lvl-2 { background: #e3f2fd; color: #1565c0; border-color: #90caf9; } /* è­·è¡›éšŠ */
    .lvl-3 { background: #fff3e0; color: #ef6c00; border-color: #ffcc80; } /* çˆä¸» */
    .lvl-max { background: #ffebee; color: #c62828; border-color: #ef9a9a; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); } /* åœŸåœ°å…¬ */

    .list-bar-bg { width: 100%; height: 6px; background: #f0f0f0; border-radius: 10px; margin-top: 5px; overflow: hidden; }
    .list-bar-fill { height: 100%; background: #d32f2f; border-radius: 10px; }
    .list-count { font-weight: bold; color: #d32f2f; font-size: 1.2rem; margin-left: 10px; min-width: 30px; text-align: right; }

    #loading-box { text-align: center; padding: 50px; color: #aaa; }
    
    /* åˆ‡æ›ç‰¹æ•ˆ */
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}

    <div class="rank-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768742671/yuanli_ui/leaderboard_top.png" class="rank-banner-img" alt="å°‹ç¥è‹±é›„æ¦œ">
    </div>

    <div class="tab-container">
        <div class="tab-btn active" onclick="switchTab('village')">
            <i class="fas fa-flag"></i> å…¨é‡Œçˆ­éœ¸
        </div>
        <div class="tab-btn" onclick="switchTab('personal')">
            <i class="fas fa-user-ninja"></i> å€‹äººè‹±é›„
        </div>
    </div>

    <div style="text-align:center; margin-bottom:20px;">
        <div class="rules-toggle-btn" onclick="$('.rules-card').slideToggle();">
            <i class="fas fa-info-circle" style="margin-right:5px;"></i> æŸ¥çœ‹ç­‰ç´šèªªæ˜
        </div>
    </div>

    <div class="rules-card">
        <h4 style="margin-top:0; color:#d32f2f; text-align:center; border-bottom:1px solid #ffe0b2; padding-bottom:10px; margin-bottom:15px;">ğŸ“Š å°‹ç¥ç­‰ç´šèªªæ˜</h4>
        <div class="rule-row"><div class="rule-icon">ğŸŒ±</div><div class="rule-content"><div class="rule-title">å°‹ç¥å°èŒæ–°</div><div class="rule-desc">ç´¯ç© 1~4 å°Š | åˆå…¥æ±Ÿæ¹–</div></div><div class="rule-badge">Lv.1</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ›¡ï¸</div><div class="rule-content"><div class="rule-title">ç†±è¡€è­·è¡›éšŠ</div><div class="rule-desc">ç´¯ç© 5~9 å°Š | ç†Ÿé–€ç†Ÿè·¯</div></div><div class="rule-badge">Lv.2</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ®</div><div class="rule-content"><div class="rule-title">è™”èª çˆä¸»</div><div class="rule-desc">ç´¯ç© 10~19 å°Š | ç¥æ˜é»è®š</div></div><div class="rule-badge">Lv.3</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ˜‡</div><div class="rule-content"><div class="rule-title">åœ¨ä¸–åœŸåœ°å…¬</div><div class="rule-desc">ç´¯ç© 20 å°Šä»¥ä¸Š | è‹‘è£¡è¬äº‹é€š</div></div><div class="rule-badge">MAX</div></div>
    </div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¨ˆç®—é›™æ¦œæˆ°ç¸¾...
    </div>

    <div id="tab-village" class="tab-content active">
        <div class="podium-container" id="podium-village"></div>
        <div class="list-container" id="list-village"></div>
    </div>

    <div id="tab-personal" class="tab-content">
        <div class="podium-container" id="podium-personal"></div>
        <div class="list-container" id="list-personal"></div>
    </div>

    <div style="height:30px;"></div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    let villageData = [];
    let personalData = [];

    window.switchTab = function(type) {
        $('.tab-btn').removeClass('active');
        $('.tab-content').removeClass('active');
        
        if (type === 'village') {
            $('.tab-btn:first-child').addClass('active');
            $('#tab-village').addClass('active');
        } else {
            $('.tab-btn:last-child').addClass('active');
            $('#tab-personal').addClass('active');
        }
    };

    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        let vCounts = {};
        ALL_VILLAGES.forEach(v => vCounts[v] = 0);
        let pCounts = {}; 

        data.forEach(item => {
            let rawName = item.nickname || item.name || '';
            let displayName = rawName;
            let assignedVillage = null;

            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                displayName = parts[0];
                let vName = parts[1];
                if (ALL_VILLAGES.includes(vName)) assignedVillage = vName;
            } else {
                let soup = (item.area || "") + " " + (item.address || "") + " " + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let validLi = matches.find(term => ALL_VILLAGES.includes(term));
                    if (validLi) assignedVillage = validLi;
                }
            }

            if (assignedVillage) vCounts[assignedVillage]++;

            if (displayName && displayName !== 'ç†±å¿ƒé„‰è¦ª' && displayName !== 'å–„å¿ƒäººå£«') {
                let key = rawName; 
                if (!pCounts[key]) pCounts[key] = { name: displayName, village: assignedVillage || 'æœªçŸ¥', count: 0 };
                pCounts[key].count++;
            }
        });

        villageData = Object.keys(vCounts).map(key => ({ name: key, count: vCounts[key] })).sort((a, b) => b.count - a.count);
        personalData = Object.values(pCounts).sort((a, b) => b.count - a.count);

        renderPodium('village', villageData);
        renderList('village', villageData);
        renderPodium('personal', personalData);
        renderList('personal', personalData);

        $('#loading-box').hide();
    })
    .catch(e => { $('#loading-box').html('âŒ è³‡æ–™è®€å–å¤±æ•—'); console.error(e); });

    function renderPodium(type, data) {
        let container = $(`#podium-${type}`);
        let html = '';
        
        let d2 = data[1] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-2">
                <div class="rank-avatar">ğŸ¥ˆ</div>
                <div class="podium-block">
                    <div class="rank-name">${d2.name}</div>
                    ${type==='personal' && d2.count!=='-' ? `<div class="rank-sub">${d2.village}</div>` : ''}
                    <div class="count-badge">${d2.count} ${d2.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;
            
        let d1 = data[0] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-1">
                <img src="https://res.cloudinary.com/diuoghid2/image/upload/crown.png" class="crown" alt="ğŸ‘‘" onerror="this.style.display='none'">
                <div class="rank-avatar">ğŸ¥‡</div>
                <div class="podium-block">
                    <div class="rank-name">${d1.name}</div>
                    ${type==='personal' && d1.count!=='-' ? `<div class="rank-sub">${d1.village}</div>` : ''}
                    <div class="count-badge">${d1.count} ${d1.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;

        let d3 = data[2] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-3">
                <div class="rank-avatar">ğŸ¥‰</div>
                <div class="podium-block">
                    <div class="rank-name">${d3.name}</div>
                    ${type==='personal' && d3.count!=='-' ? `<div class="rank-sub">${d3.village}</div>` : ''}
                    <div class="count-badge">${d3.count} ${d3.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;
            
        container.html(html);
    }

    function renderList(type, data) {
        let container = $(`#list-${type}`);
        let html = '';
        let maxCount = data[0] ? data[0].count : 1;

        for (let i = 3; i < data.length; i++) {
            let item = data[i];
            if (item.count === 0 && type === 'personal') continue; 

            let percent = (item.count / maxCount) * 100;
            
            let levelTag = '';
            if (type === 'personal') {
                if (item.count >= 20) levelTag = '<span class="lvl-tag lvl-max">åœ¨ä¸–åœŸåœ°å…¬</span>';
                else if (item.count >= 10) levelTag = '<span class="lvl-tag lvl-3">è™”èª çˆä¸»</span>';
                else if (item.count >= 5) levelTag = '<span class="lvl-tag lvl-2">ç†±è¡€è­·è¡›éšŠ</span>';
                else levelTag = '<span class="lvl-tag lvl-1">å°‹ç¥å°èŒæ–°</span>';
            } else {
                if (item.count >= 10) levelTag = '<span class="lvl-tag lvl-max">ğŸ”¥ ç†±å€</span>';
            }

            html += `
                <div class="list-item">
                    <div class="list-rank">${i + 1}</div>
                    <div class="list-info">
                        <div class="list-name">
                            ${item.name} ${levelTag}
                        </div>
                        ${type==='personal' ? `<div class="list-sub">${item.village}</div>` : ''}
                        <div class="list-bar-bg">
                            <div class="list-bar-fill" style="width: ${percent}%;"></div>
                        </div>
                    </div>
                    <div class="list-count">${item.count}</div>
                </div>
            `;
        }
        
        if(html === '') html = '<div style="text-align:center;color:#ccc;padding:20px;">ç­‰å¾…è‹±é›„å‡ºç¾...</div>';
        container.html(html);
    }
</script>
{% endblock %}
