{% extends "base.html" %}
{% set active_page = "leaderboard" %}

{% block title %}å°‹ç¥é¢¨é›²æ¦œ - ç¾å­¸è¦ºé†’ç‰ˆ{% endblock %}

{% block styles %}
<style>
    /* 1. åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. çœ‹æ¿å€ */
    .rank-header {
        text-align: center; padding: 25px 0 15px 0;
        position: relative; margin-bottom: 10px;
    }
    
    .rank-banner-img {
        width: 90%; max-width: 360px; height: auto;
        min-height: 120px;
        filter: drop-shadow(0 10px 15px rgba(93, 64, 55, 0.2));
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* ğŸ”¥ é¦™è•‰ç¾å­¸ 1: æµ®å‹•åˆ‡æ›æŒ‰éˆ• (Glassmorphism) */
    .tab-container {
        display: flex; justify-content: center; gap: 8px;
        margin: 10px auto 25px auto; width: 88%; max-width: 380px;
        background: rgba(255, 255, 255, 0.6); /* åŠé€æ˜ */
        backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒç‰¹æ•ˆ */
        padding: 6px; border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    .tab-btn {
        flex: 1; padding: 10px 0; border-radius: 40px;
        text-align: center; font-weight: bold; color: #8d6e63;
        cursor: pointer; transition: all 0.3s; font-size: 0.95rem;
        display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    /* é¸ä¸­ç‹€æ…‹ï¼šç´…è‰²æŸ”å…‰æ°£å ´ */
    .tab-btn.active {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        color: white; 
        box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
        transform: scale(1.02);
    }
    
    /* èªªæ˜æŒ‰éˆ•ï¼šæµ®å‹•è† å›Š */
    .rules-toggle-btn {
        background: white; color: #d32f2f; border: none;
        padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        display: inline-flex; align-items: center; cursor: pointer;
        box-shadow: 0 4px 12px rgba(211, 47, 47, 0.15);
        margin-bottom: 10px; transition: 0.2s;
    }
    .rules-toggle-btn:active { transform: scale(0.95); }

    .rules-card {
        background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 450px; 
        margin: 0 auto 30px auto; border-radius: 25px; padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
        display: none;
    }
    .rule-row { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
    .rule-row:last-child { border-bottom: none; margin-bottom: 0; }
    .rule-icon { font-size: 1.8rem; width: 50px; text-align: center; margin-right: 10px; }
    .rule-content { flex: 1; text-align: left; }
    .rule-title { font-weight: bold; color: #5d4037; font-size: 1rem; }
    .rule-desc { font-size: 0.85rem; color: #888; }
    .rule-badge { background: #fff3e0; padding: 4px 12px; border-radius: 10px; font-size: 0.85rem; color: #e65100; font-weight: bold; }

    /* 3. é ’çå° */
    .podium-container {
        display: flex; justify-content: center; align-items: flex-end;
        gap: 8px; margin-bottom: 30px; padding: 0 10px; height: 240px;
    }
    .podium-item {
        display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        position: relative; transition: transform 0.3s;
    }
    .rank-1 { width: 110px; z-index: 3; }
    .rank-2 { width: 90px; z-index: 2; }
    .rank-3 { width: 90px; z-index: 1; }

    /* ğŸ”¥ é¦™è•‰ç¾å­¸ 2: é ­åƒå…‰æšˆ (Breathing Avatar) */
    .rank-avatar {
        width: 60px; height: 60px; background: white; border-radius: 50%;
        border: 4px solid #fff; 
        margin-bottom: -15px; z-index: 5; position: relative;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.5rem; overflow: hidden; color: #5d4037;
        transition: transform 0.3s;
    }
    /* é‡‘éŠ€éŠ…å…‰æšˆç‰¹æ•ˆ */
    .rank-1 .rank-avatar { 
        width: 80px; height: 80px; border-color: #fff; font-size: 2rem; 
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); /* é‡‘è‰²å…‰æšˆ */
    }
    .rank-2 .rank-avatar { 
        border-color: #fff; 
        box-shadow: 0 0 15px rgba(189, 189, 189, 0.5); /* éŠ€è‰²å…‰æšˆ */
    }
    .rank-3 .rank-avatar { 
        border-color: #fff; 
        box-shadow: 0 0 15px rgba(255, 112, 67, 0.4); /* éŠ…è‰²å…‰æšˆ */
    }

    .crown-icon {
        position: absolute; top: -45px; font-size: 40px;
        animation: spin-crown 3s infinite linear;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
    }
    @keyframes spin-crown { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }

    .podium-block {
        width: 100%; border-radius: 20px 20px 0 0;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        padding-top: 25px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .rank-1 .podium-block { height: 130px; background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); }
    .rank-2 .podium-block { height: 100px; background: linear-gradient(135deg, #bdbdbd 0%, #9e9e9e 100%); }
    .rank-3 .podium-block { height: 80px; background: linear-gradient(135deg, #ff8a65 0%, #d84315 100%); }

    .rank-name { font-weight: bold; font-size: 1rem; margin-bottom: 2px; text-align: center; padding: 0 5px; line-height: 1.1; }
    .rank-sub { font-size: 0.75rem; opacity: 0.95; margin-bottom: 3px; font-weight: normal; }
    .count-badge { background: rgba(0,0,0,0.15); padding: 2px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; backdrop-filter: blur(2px); }

    /* 4. åˆ—è¡¨æ¨£å¼ (æµ®å‹•å¡ç‰‡) */
    .list-container {
        width: 90%; max-width: 500px; margin: 0 auto;
        background: white; border-radius: 25px;
        padding: 10px; 
        box-shadow: 0 15px 40px rgba(93, 64, 55, 0.08);
        min-height: 200px; border: none;
    }
    .list-item {
        display: flex; align-items: center; padding: 15px;
        border-bottom: 1px solid #f5f5f5;
        transition: background 0.2s; border-radius: 15px;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:active { background: #fafafa; }
    
    .list-rank {
        width: 28px; height: 28px; background: #8d6e63; color: white;
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-weight: bold; font-size: 0.8rem; margin-right: 12px; flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(141, 110, 99, 0.3);
    }
    .list-info { flex: 1; text-align: left; }
    .list-name { font-weight: bold; color: #5d4037; font-size: 1.1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 5px; }
    .list-sub { font-size: 0.85rem; color: #999; margin-top: 2px; }
    
    .lvl-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 8px; font-weight: normal; border: 1px solid #eee; }
    .lvl-1 { background: #f1f8e9; color: #558b2f; }
    .lvl-2 { background: #e3f2fd; color: #1565c0; }
    .lvl-3 { background: #fff3e0; color: #ef6c00; }
    .lvl-max { background: #ffebee; color: #c62828; font-weight: bold; box-shadow: 0 2px 5px rgba(198, 40, 40, 0.15); border: none; }

    .list-bar-bg { width: 100%; height: 6px; background: #f5f5f5; border-radius: 10px; margin-top: 6px; overflow: hidden; }
    .list-bar-fill { height: 100%; background: linear-gradient(90deg, #ef5350, #d32f2f); border-radius: 10px; }
    .list-count { font-weight: bold; color: #d32f2f; font-size: 1.2rem; margin-left: 10px; min-width: 30px; text-align: right; }

    #loading-box { text-align: center; padding: 50px; color: #aaa; }
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}

    <div class="rank-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/leaderboard_top.png" 
             class="rank-banner-img" 
             alt="å°‹ç¥è‹±é›„æ¦œ">
    </div>

    <div class="tab-container">
        <div class="tab-btn active" onclick="switchTab('village')">
            <i class="fas fa-flag"></i> å…¨é‡Œçˆ­éœ¸
        </div>
        <div class="tab-btn" onclick="switchTab('personal')">
            <i class="fas fa-user-ninja"></i> å€‹äººè‹±é›„
        </div>
    </div>

    <div style="text-align:center; margin-bottom:20px;">
        <div class="rules-toggle-btn" onclick="$('.rules-card').slideToggle();">
            <i class="fas fa-info-circle" style="margin-right:5px;"></i> æŸ¥çœ‹ç­‰ç´šèªªæ˜
        </div>
    </div>

    <div class="rules-card">
        <h4 style="margin-top:0; color:#d32f2f; text-align:center; border-bottom:1px solid #ffe0b2; padding-bottom:10px; margin-bottom:15px;">ğŸ“Š å°‹ç¥ç­‰ç´šèªªæ˜</h4>
        <div class="rule-row"><div class="rule-icon">ğŸŒ±</div><div class="rule-content"><div class="rule-title">å°‹ç¥å°èŒæ–°</div><div class="rule-desc">ç´¯ç© 1~4 å°Š | åˆå…¥æ±Ÿæ¹–</div></div><div class="rule-badge">Lv.1</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ›¡ï¸</div><div class="rule-content"><div class="rule-title">ç†±è¡€è­·è¡›éšŠ</div><div class="rule-desc">ç´¯ç© 5~9 å°Š | ç†Ÿé–€ç†Ÿè·¯</div></div><div class="rule-badge">Lv.2</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ®</div><div class="rule-content"><div class="rule-title">è™”èª çˆä¸»</div><div class="rule-desc">ç´¯ç© 10~19 å°Š | ç¥æ˜é»è®š</div></div><div class="rule-badge">Lv.3</div></div>
        <div class="rule-row"><div class="rule-icon">ğŸ˜‡</div><div class="rule-content"><div class="rule-title">åœ¨ä¸–åœŸåœ°å…¬</div><div class="rule-desc">ç´¯ç© 20 å°Šä»¥ä¸Š | è‹‘è£¡è¬äº‹é€š</div></div><div class="rule-badge">MAX</div></div>
    </div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¨ˆç®—é›™æ¦œæˆ°ç¸¾...
    </div>

    <div id="tab-village" class="tab-content active">
        <div class="podium-container" id="podium-village"></div>
        <div class="list-container" id="list-village"></div>
    </div>

    <div id="tab-personal" class="tab-content">
        <div class="podium-container" id="podium-personal"></div>
        <div class="list-container" id="list-personal"></div>
    </div>

    <div style="height:30px;"></div>

{% endblock %}

{% block scripts %}
<script>
    // é å…ˆå®šç¾©è‹‘è£¡ 25 é‡Œï¼Œæ–¹ä¾¿æ’åº
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    let villageData = [];
    let personalData = [];

    // åˆ‡æ›é ç±¤ (Tab Switch)
    window.switchTab = function(type) {
        $('.tab-btn').removeClass('active');
        $('.tab-content').removeClass('active');
        
        if (type === 'village') {
            $('.tab-btn:first-child').addClass('active');
            $('#tab-village').addClass('active');
        } else {
            $('.tab-btn:last-child').addClass('active');
            $('#tab-personal').addClass('active');
        }
    };

    // å–å¾—è³‡æ–™ (API)
    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        let vCounts = {};
        ALL_VILLAGES.forEach(v => vCounts[v] = 0);
        let pCounts = {}; 

        data.forEach(item => {
            let rawName = item.nickname || item.name || '';
            let displayName = rawName;
            let assignedVillage = null;

            // ğŸ”¥ ç‰¹æ´›ä¼Šæœ¨é¦¬è§£ç¢¼ (Trojan Decoder)
            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                displayName = parts[0]; // æš±ç¨±
                let vName = parts[1];   // é‡Œåˆ¥
                if (ALL_VILLAGES.includes(vName)) assignedVillage = vName;
            } else {
                // èˆŠè³‡æ–™ç›¸å®¹ï¼šå¾æ¬„ä½å˜—è©¦æŠ“å–é‡Œåˆ¥
                let soup = (item.area || "") + " " + (item.address || "") + " " + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let validLi = matches.find(term => ALL_VILLAGES.includes(term));
                    if (validLi) assignedVillage = validLi;
                }
            }

            // 1. æ­¸æˆ¶åˆ° [é‡Œ]
            if (assignedVillage) vCounts[assignedVillage]++;

            // 2. æ­¸æˆ¶åˆ° [äºº]
            if (displayName && displayName !== 'ç†±å¿ƒé„‰è¦ª' && displayName !== 'å–„å¿ƒäººå£«') {
                let key = rawName; // é€™è£¡æˆ‘å€‘ç”¨åŸå§‹å (å«#) åš key ä¹Ÿå¯ä»¥ï¼Œæˆ–æ˜¯ç”¨ cleanName
                // ç‚ºäº†æ­£ç¢ºåˆä½µç©åˆ†ï¼Œé€™è£¡å»ºè­°ç”¨ cleanName (displayName)
                // ä½†å¦‚æœæ€•é‡åï¼Œå¯ä»¥è€ƒæ…®çµåˆé‡Œåˆ¥ã€‚é€™è£¡æš«æ™‚ç”¨ displayName åˆä½µï¼š
                let mergeKey = displayName; 
                
                if (!pCounts[mergeKey]) pCounts[mergeKey] = { name: displayName, village: assignedVillage || 'æœªçŸ¥', count: 0 };
                pCounts[mergeKey].count++;
            }
        });

        // æ’åº
        villageData = Object.keys(vCounts).map(key => ({ name: key, count: vCounts[key] })).sort((a, b) => b.count - a.count);
        personalData = Object.values(pCounts).sort((a, b) => b.count - a.count);

        // æ¸²æŸ“
        renderPodium('village', villageData);
        renderList('village', villageData);
        renderPodium('personal', personalData);
        renderList('personal', personalData);

        $('#loading-box').hide();
    })
    .catch(e => { $('#loading-box').html('âŒ è³‡æ–™è®€å–å¤±æ•—'); console.error(e); });

    // æ¸²æŸ“é ’çå° (å‰ä¸‰å)
    function renderPodium(type, data) {
        let container = $(`#podium-${type}`);
        let html = '';
        
        let d2 = data[1] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-2">
                <div class="rank-avatar">ğŸ¥ˆ</div>
                <div class="podium-block">
                    <div class="rank-name">${d2.name}</div>
                    ${type==='personal' && d2.count!=='-' ? `<div class="rank-sub">${d2.village}</div>` : ''}
                    <div class="count-badge">${d2.count} ${d2.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;
            
        let d1 = data[0] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-1">
                <div class="crown-icon">ğŸ‘‘</div>
                <div class="rank-avatar">ğŸ¥‡</div>
                <div class="podium-block">
                    <div class="rank-name">${d1.name}</div>
                    ${type==='personal' && d1.count!=='-' ? `<div class="rank-sub">${d1.village}</div>` : ''}
                    <div class="count-badge">${d1.count} ${d1.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;

        let d3 = data[2] || { name: 'å¾ç¼º', count: '-' };
        html += `
            <div class="podium-item rank-3">
                <div class="rank-avatar">ğŸ¥‰</div>
                <div class="podium-block">
                    <div class="rank-name">${d3.name}</div>
                    ${type==='personal' && d3.count!=='-' ? `<div class="rank-sub">${d3.village}</div>` : ''}
                    <div class="count-badge">${d3.count} ${d3.count!=='-'?'å°Š':''}</div>
                </div>
            </div>`;
            
        container.html(html);
    }

    // æ¸²æŸ“åˆ—è¡¨ (4åä»¥å¾Œ)
    function renderList(type, data) {
        let container = $(`#list-${type}`);
        let html = '';
        let maxCount = data[0] ? data[0].count : 1;

        for (let i = 3; i < data.length; i++) {
            let item = data[i];
            if (item.count === 0 && type === 'personal') continue; // æ’é™¤0åˆ†çš„äºº

            let percent = (item.count / maxCount) * 100;
            
            // éŠæˆ²åŒ–ç­‰ç´šæ¨™ç±¤
            let levelTag = '';
            if (type === 'personal') {
                if (item.count >= 20) levelTag = '<span class="lvl-tag lvl-max">åœ¨ä¸–åœŸåœ°å…¬</span>';
                else if (item.count >= 10) levelTag = '<span class="lvl-tag lvl-3">è™”èª çˆä¸»</span>';
                else if (item.count >= 5) levelTag = '<span class="lvl-tag lvl-2">ç†±è¡€è­·è¡›éšŠ</span>';
                else levelTag = '<span class="lvl-tag lvl-1">å°‹ç¥å°èŒæ–°</span>';
            } else {
                if (item.count >= 10) levelTag = '<span class="lvl-tag lvl-max">ğŸ”¥ ç†±å€</span>';
            }

            html += `
                <div class="list-item">
                    <div class="list-rank">${i + 1}</div>
                    <div class="list-info">
                        <div class="list-name">
                            ${item.name} ${levelTag}
                        </div>
                        ${type==='personal' ? `<div class="list-sub">${item.village}</div>` : ''}
                        <div class="list-bar-bg">
                            <div class="list-bar-fill" style="width: ${percent}%;"></div>
                        </div>
                    </div>
                    <div class="list-count">${item.count}</div>
                </div>
            `;
        }
        
        if(html === '') html = '<div style="text-align:center;color:#ccc;padding:20px;">ç­‰å¾…è‹±é›„å‡ºç¾...</div>';
        container.html(html);
    }
</script>
{% endblock %}
