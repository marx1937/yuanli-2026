<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°‹ç¥æƒ…å ±æŒ‡æ®ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { background-color: #fdfcf0; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
        .top-bar { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #d32f2f; display: flex; justify-content: space-between; align-items: center; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; transition: 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .photo-area { position: relative; height: 220px; background: #eee; }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; }
        .id-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-family: monospace; }
        .status-badge { padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; display: inline-block; margin-top: 5px; }
        .status-ok { background: #e6fffa; color: #00b894; }
        .status-danger { background: #ffe6e6; color: #d63031; }
        .btn-delete { width: 100%; border-radius: 0; font-weight: bold; padding: 12px; letter-spacing: 1px; }
        .info-row { font-size: 0.95rem; color: #555; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 6px; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #999; margin-right: 5px; font-size: 0.9rem; }
        
        /* éæ¿¾æŒ‰éˆ•æ¨£å¼ */
        .btn-toggle-dup { border: 1px solid #ff7675; color: #d63031; background: #fff; }
        .btn-toggle-dup.active { background: #d63031; color: white; }
    </style>
</head>
<body>
    
    <div class="top-bar">
        <h5 class="m-0" style="font-weight:800; color:#d32f2f;">ğŸ‘®â€â™‚ï¸ æŒ‡æ®ä¸­å¿ƒ</h5>
        <div>
            <button class="btn btn-success btn-sm mr-2" onclick="exportData()">
                â˜ï¸ ä¸‹è¼‰ CSV
            </button>
            <a href="/admin/logout" class="btn btn-outline-secondary btn-sm">ç™»å‡º</a>
        </div>
    </div>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="alert alert-info mb-0 py-2 px-3">
                ğŸ“Š ç¸½è¨ˆ: <strong id="total-count">0</strong> ç­†
            </div>
            <button class="btn btn-toggle-dup btn-sm" id="btn-filter" onclick="toggleDuplicates()">
                âš ï¸ åªé¡¯ç¤ºé‡è¤‡é …ç›®
            </button>
        </div>

        <div id="loading" class="text-center py-5 text-muted">
            <div class="spinner-border text-danger" role="status"></div>
            <p class="mt-2">æ­£åœ¨åˆ†æ GPS åº§æ¨™...</p>
        </div>

        <div class="row" id="data-list"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        let allDataCache = []; 
        let isFilterActive = false;

        $(document).ready(function() {
            loadData();
        });

        function loadData() {
            $.getJSON('/api/admin/all_data', function(data) {
                $('#loading').hide();
                $('#total-count').text(data.length);
                allDataCache = data; 
                renderCards(data);
            });
        }

        function renderCards(data) {
            var container = $('#data-list');
            container.empty();

            data.sort((a, b) => b.id - a.id);

            // é è™•ç†è³‡æ–™ï¼šæ¨™è¨˜é‡è¤‡
            for(let i = 0; i < data.length; i++) {
                data[i].isDuplicate = false;
                data[i].nearbyInfo = ""; 
                
                // è§£ç¢¼åå­—
                let raw = data[i].nickname || "";
                if(raw.includes("#")) {
                    let parts = raw.split("#");
                    data[i].realName = parts[0];
                    data[i].realVillage = parts[1];
                } else {
                    data[i].realName = raw;
                    data[i].realVillage = data[i].area || "æœªçŸ¥";
                }

                // GPS è·é›¢æ¯”å°
                for(let j = 0; j < data.length; j++) {
                    if(i === j) continue; 
                    if (data[i].lat && data[j].lat) {
                        let dist = getDist(data[i].lat, data[i].lng, data[j].lat, data[j].lng);
                        if(dist < 0.02) { // 20å…¬å°ºå…§
                            data[i].isDuplicate = true;
                            data[i].nearbyInfo = `èˆ‡ ID:${data[j].id} å¤ªè¿‘ (${(dist*1000).toFixed(0)}m)`;
                        }
                    }
                }
            }

            // éæ¿¾æ¨¡å¼
            let displayData = data;
            if (isFilterActive) {
                displayData = data.filter(item => item.isDuplicate);
            }

            if (displayData.length === 0 && isFilterActive) {
                container.html('<div class="col-12 text-center text-muted py-5">ğŸ‰ å¤ªæ£’äº†ï¼æ²’æœ‰ç™¼ç¾é‡è¤‡è³‡æ–™ã€‚</div>');
                return;
            }

            displayData.forEach(function(item) {
                let statusHtml = item.isDuplicate 
                    ? `<div class="status-badge status-danger">âš ï¸ ç–‘ä¼¼é‡è¤‡<br><small>${item.nearbyInfo}</small></div>`
                    : `<div class="status-badge status-ok">âœ… ä½ç½®æ­£å¸¸</div>`;
                
                let borderStyle = item.isDuplicate ? 'border: 2px solid #ff7675;' : '';

                let html = `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card" style="${borderStyle}">
                            <div class="photo-area">
                                <span class="id-badge">ID: ${item.id}</span>
                                <a href="${item.image_url}" target="_blank">
                                    <img src="${item.image_url}" loading="lazy">
                                </div>
                            </a>
                            <div class="card-body pb-0">
                                <h5 class="card-title mb-3 font-weight-bold text-center">
                                    ${item.realVillage} <span style="font-size:0.8rem; color:#999;">(${item.realName})</span>
                                </h5>
                                <div class="info-row"><span class="info-label">å‚™è¨»:</span> ${item.note || item.description || 'ç„¡'}</div>
                                <div class="info-row"><span class="info-label">æ™‚é–“:</span> ${item.created_at || 'æœªçŸ¥'}</div>
                                <div class="mt-2 mb-3 text-center">${statusHtml}</div>
                            </div>
                            <button class="btn btn-danger btn-delete" onclick="deleteItem(${item.id})">
                                ğŸ—‘ï¸ åˆªé™¤æ­¤è³‡æ–™
                            </button>
                        </div>
                    </div>
                `;
                container.append(html);
            });
        }

        function toggleDuplicates() {
            isFilterActive = !isFilterActive;
            let btn = $('#btn-filter');
            if(isFilterActive) {
                btn.addClass('active');
                btn.html('âŒ é¡¯ç¤ºå…¨éƒ¨è³‡æ–™');
            } else {
                btn.removeClass('active');
                btn.html('âš ï¸ åªé¡¯ç¤ºé‡è¤‡é …ç›®');
            }
            renderCards(allDataCache);
        }

        function exportData() {
            if (!allDataCache || allDataCache.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            let csvContent = "\uFEFFåå­—,é‡Œåˆ¥,æè¿°,åœ–ç‰‡,ç·¯åº¦,ç¶“åº¦,æ™‚é–“\n";
            allDataCache.forEach(item => {
                let desc = (item.note || item.description || "").replace(/,/g, "ï¼Œ").replace(/\n/g, " ");
                csvContent += `${item.realName},${item.realVillage},${desc},${item.image_url},${item.lat},${item.lng},${item.created_at}\n`;
            });
            let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `å°‹ç¥å‚™ä»½_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = (lat2-lat1) * (Math.PI/180);
            var dLon = (lon2-lon1) * (Math.PI/180); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function deleteItem(id) {
            if(confirm('ğŸš¨ è­¦å‘Šï¼šåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼\nç¢ºå®šè¦åˆªé™¤ ID: ' + id + ' å—ï¼Ÿ')) {
                $.post('/api/delete', { id: id }, function(res) {
                    if(res.success) { loadData(); } else { alert('å¤±æ•—: ' + res.message); }
                });
            }
        }
    </script>
</body>
</html>
