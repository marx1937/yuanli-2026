{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - è‹‘è£¡é®{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. å…¨è¢å¹•è¨­å®š */
    #map-wrapper {
        position: fixed; top: 0; left: 0; bottom: 0; right: 0;
        width: 100%; height: 100%; z-index: 0;
        background: #e3f2fd; /* é è¨­æµ·è—è‰²èƒŒæ™¯ï¼Œé¿å…ç™½å± */
    }

    #map { width: 100%; height: 100%; z-index: 1; opacity: 0; transition: opacity 0.5s; }
    
    /* 2. ğŸ”¥ éœæ…‹å½è£å±¤ (æ¬ºé¨™çœ¼ç›ç”¨) */
    #static-cover {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #fdfcf0;
        /* é€™è£¡æ”¾ä¸€å¼µè‹‘è£¡çš„åœ°åœ–æˆªåœ–ç•¶èƒŒæ™¯ï¼Œæ²’è¼‰å…¥å‰å…ˆçœ‹é€™å¼µ */
        background-image: url('https://res.cloudinary.com/diuoghid2/image/upload/v1/yuanli_static_map.png'); 
        background-size: cover; background-position: center;
        z-index: 10; /* è“‹åœ¨çœŸåœ°åœ–ä¸Šé¢ */
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s, transform 0.5s;
    }
    
    .cover-msg {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px 25px; border-radius: 50px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        text-align: center;
        animation: pulse 2s infinite;
    }
    .cover-msg h2 { margin: 0; color: #d32f2f; font-weight: 800; font-size: 1.5rem; }
    .cover-msg p { margin: 5px 0 0 0; color: #555; font-size: 0.9rem; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* 3. æ‡¸æµ®ç¯©é¸åˆ— (æœ€ä¸Šå±¤) */
    .map-filter-container {
        position: fixed; top: 15px; left: 0; right: 0; z-index: 1000;
        padding: 10px 15px; white-space: nowrap; overflow-x: auto;
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
        display: flex; gap: 8px;
    }
    .map-filter-container::-webkit-scrollbar { display: none; }

    .filter-chip {
        display: inline-flex; align-items: center; gap: 5px;
        background: rgba(255, 255, 255, 0.95); color: #5d4037; 
        padding: 8px 16px; border-radius: 50px; 
        font-size: 0.9rem; font-weight: bold;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
        border: 1px solid #fff; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip span {
        background: #eee; color: #888; font-size: 0.75rem; 
        padding: 2px 6px; border-radius: 10px; min-width: 15px; text-align: center;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; border-color: #d32f2f;
        transform: scale(1.05); box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
    }
    .filter-chip.active span { background: #fff; color: #d32f2f; }

    /* 4. å®šä½æŒ‰éˆ• */
    .btn-locate {
        position: fixed; bottom: 100px; right: 20px; z-index: 900;
        background: white; width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        color: #444; font-size: 1.3rem; transition: 0.2s;
        display: none; /* éœæ…‹æ¨¡å¼ä¸‹å…ˆéš±è— */
    }

    /* 5. å½ˆçª—å„ªåŒ– */
    .leaflet-popup-content-wrapper { border-radius: 15px; padding: 0; overflow: hidden; }
    .leaflet-popup-content { margin: 0; width: 240px !important; }
    .popup-cover { width: 100%; height: 140px; object-fit: cover; display: block; background: #eee; cursor: pointer;}
    .popup-info { padding: 15px; text-align: left; }
    .popup-btn {
        display: block; width: 100%; margin-top: 10px;
        background: linear-gradient(135deg, #4285f4, #1976d2); 
        color: white; text-align: center; padding: 10px 0; border-radius: 50px;
        text-decoration: none !important; font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
    
    <div class="map-filter-container" id="filter-scroll">
        </div>

    <div id="map-wrapper">
        <div id="static-cover" onclick="activateMap('å…¨éƒ¨')">
            <div class="cover-msg">
                <h2>ğŸ—ºï¸ å°‹ç¥åœ°åœ–</h2>
                <p>é»æ“Šä»»ä¸€æŒ‰éˆ•é–‹å§‹æ¢ç´¢</p>
                <i class="fas fa-hand-pointer fa-2x" style="color:#ffa000; margin-top:10px;"></i>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div class="btn-locate" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map;
    var markersCluster;
    var allMarkers = [];
    var villageCounts = {};
    var isMapInitialized = false;

    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    // 1. é é¢è¼‰å…¥æ™‚ï¼šåªè¼‰å…¥æ•¸æ“šï¼Œä¸è¼‰å…¥åœ°åœ– (æ¥µé€Ÿ)
    $(document).ready(function() {
        loadDataOnly();
    });

    function loadDataOnly() {
        fetch('/api/locations')
        .then(r => r.json())
        .then(data => {
            allMarkers = data;
            calculateCounts(data);
            renderFilterChips(); 
            // é€™è£¡ä¸ initMapï¼Œåªé¡¯ç¤ºæŒ‰éˆ•
        });
    }

    // 2. ç•¶ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•ï¼šå•Ÿå‹•çœŸåœ°åœ– (Activate)
    window.activateMap = function(filterTarget, btn) {
        // è¦–è¦ºåˆ‡æ›
        $('#static-cover').css('opacity', '0').css('pointer-events', 'none'); // æ·¡å‡ºéœæ…‹åœ–
        setTimeout(() => $('#static-cover').hide(), 500);
        $('#map').css('opacity', '1'); // é¡¯ç¤ºçœŸåœ°åœ–
        $('.btn-locate').fadeIn();

        // å¦‚æœåœ°åœ–é‚„æ²’åˆå§‹åŒ–ï¼Œç¾åœ¨æ‰åˆå§‹åŒ– (çœè³‡æº)
        if (!isMapInitialized) {
            initMapAndRender(filterTarget);
            isMapInitialized = true;
        } else {
            // å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œç›´æ¥ç¯©é¸
            filterMap(filterTarget, btn);
        }

        // æŒ‰éˆ•æ¨£å¼è™•ç†
        if(btn) {
            $('.filter-chip').removeClass('active');
            $(btn).addClass('active');
        }
    }

    function initMapAndRender(initialFilter) {
        // å»ºç«‹åœ°åœ–
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap', maxZoom: 19
        }).addTo(map);

        markersCluster = L.markerClusterGroup({ showCoverageOnHover: false });
        map.addLayer(markersCluster);

        // åŸ·è¡Œç¬¬ä¸€æ¬¡ç¯©é¸
        filterMap(initialFilter);
    }

    // è¨ˆç®—æ•¸é‡
    function calculateCounts(data) {
        ALL_VILLAGES.forEach(v => villageCounts[v] = 0);
        data.forEach(item => {
            let v = getVillageName(item);
            if (villageCounts[v] !== undefined) villageCounts[v]++;
        });
    }

    function getVillageName(item) {
        if(item.nickname && item.nickname.includes("#")) return item.nickname.split("#")[1];
        if (item.area) return item.area;
        return "å…¶ä»–";
    }

    // æ¸²æŸ“æŒ‰éˆ•
    function renderFilterChips() {
        let container = document.getElementById('filter-scroll');
        let html = `<div class="filter-chip" id="btn-all" onclick="activateMap('å…¨éƒ¨', this)">
                        å…¨è¦½ <span>${allMarkers.length}</span>
                    </div>`;
        ALL_VILLAGES.forEach(v => {
            let count = villageCounts[v] || 0;
            html += `<div class="filter-chip" onclick="activateMap('${v}', this)">
                        ${v} <span>${count}</span>
                    </div>`;
        });
        container.innerHTML = html;
    }

    // çœŸæ­£çš„åœ°åœ–ç¯©é¸èˆ‡é£›è¡Œé‚è¼¯
    function filterMap(village) {
        if (!isMapInitialized) return;

        markersCluster.clearLayers();
        let filteredData = (village === 'å…¨éƒ¨') ? allMarkers : allMarkers.filter(i => getVillageName(i) === village);

        let tempGroup = L.featureGroup();
        
        // Qç‰ˆåœ–ç¤º
        var godIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3710/3710266.png', 
            iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -35],
        });
        var defaultIcon = new L.Icon.Default();

        filteredData.forEach(item => {
            if (item.lat && item.lng) {
                let v = getVillageName(item);
                let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                let marker = L.marker([item.lat, item.lng], { icon: item.image_url ? godIcon : defaultIcon });
                let thumbUrl = item.image_url ? item.image_url.replace('/upload/', '/upload/w_300,h_200,c_fill,q_auto/') : '';

                let popupContent = `
                    <div style="cursor:pointer;" onclick="window.location.href='/gallery'">
                        <img src="${thumbUrl}" class="popup-cover" onerror="this.src='https://placehold.co/300x200?text=No+Image'">
                        <div class="popup-info">
                            <div style="color:#d32f2f; font-weight:bold;">${v}</div>
                            <div style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;">${name}</div>
                            <div style="font-size:0.9rem; color:#666;">${item.note || 'ç„¡å‚™è¨»'}</div>
                            <a href="http://googleusercontent.com/maps.google.com/maps?daddr=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                <i class="fas fa-location-arrow"></i> å°èˆª
                            </a>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markersCluster.addLayer(marker);
                tempGroup.addLayer(L.marker([item.lat, item.lng]));
            }
        });

        // è‡ªå‹•é£›è¡Œ (FlyTo)
        if (filteredData.length > 0) {
            if (village === 'å…¨éƒ¨') {
                map.flyTo([24.4429, 120.6558], 13);
            } else {
                map.fitBounds(tempGroup.getBounds().pad(0.2));
            }
        } else {
            if(village !== 'å…¨éƒ¨') alert(`${village} é‚„æ²’æœ‰è³‡æ–™å–”ï¼`);
        }
    }

    function locateUser() {
        if (navigator.geolocation && isMapInitialized) {
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([lat, lng], { radius: 8, fillColor: "#2196f3", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                map.flyTo([lat, lng], 16);
            });
        }
    }
</script>
{% endblock %}
