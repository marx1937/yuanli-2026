{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ–{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* åœ°åœ–åº•è‰²è¨­å®šç‚ºæš–ç±³è‰²ï¼Œèˆ‡ CartoDB åœ–å±¤ä¸€è‡´ï¼Œé¿å…è¼‰å…¥ç¬é–“é–ƒçˆ */
        #map { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh; 
            z-index: 1; 
            background-color: #fdfcf0; 
        }
        
        .map-header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 900; width: 90%; max-width: 400px; text-align: center;
        }
        
        .header-capsule {
            background: rgba(255, 255, 255, 0.95); padding: 10px 25px; 
            border-radius: 50px; font-weight: bold; color: #5d4037; 
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.15); 
            display: inline-flex; align-items: center; 
            border: 1px solid rgba(141, 110, 99, 0.2);
            cursor: pointer; transition: transform 0.2s; backdrop-filter: blur(5px);
        }
        .header-capsule:active { transform: scale(0.95); background: #fff8e1; }

        .custom-div-icon { background: transparent; border: none; }
        .simple-pin {
            font-size: 36px; line-height: 36px; text-align: center;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
            cursor: pointer; transition: transform 0.2s;
        }
        .simple-pin:active { transform: scale(1.2); }

        .leaflet-popup-content-wrapper { 
            border-radius: 20px; overflow: hidden; padding: 0; 
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.2);
        }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        .popup-img-box { width: 100%; height: 160px; overflow: hidden; background: #f9f7f2; position: relative; }
        .popup-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .popup-info { padding: 15px 20px; text-align: left; background: #fff; }
        .popup-title { font-weight: bold; font-size: 1.15rem; color: #5d4037; margin-bottom: 5px; }
        .popup-desc { font-size: 0.9rem; color: #8d6e63; margin-bottom: 15px; }
        
        .popup-btn {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); 
            color: white !important; border-radius: 50px; padding: 10px 0; 
            font-size: 0.95rem; font-weight: bold; display: block; text-align: center;
            text-decoration: none !important; box-shadow: 0 4px 10px rgba(183, 28, 28, 0.3);
        }

        .btn-locate {
            position: absolute; bottom: 110px; right: 20px; z-index: 900;
            width: 55px; height: 55px; border-radius: 50%;
            background: white; color: #5d4037; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(141, 110, 99, 0.1);
            box-shadow: 0 5px 15px rgba(93, 64, 55, 0.2); cursor: pointer;
        }

        #guideOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 64, 55, 0.6); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .guide-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 25px; padding: 30px 25px 25px 25px; 
            text-align: center; border: 4px solid #fff8e1;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .guide-mascot {
            display: block; margin: 10px auto 15px auto; 
            width: 140px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
            z-index: 10;
        }

        .guide-title { font-weight: bold; color: #d32f2f; font-size: 1.4rem; margin-bottom: 20px; }
        .guide-list { text-align: left; margin-bottom: 10px; font-size: 0.95rem; color: #5d4037; padding-left: 10px; width: 100%; }
        .guide-list li { margin-bottom: 12px; list-style: none; display: flex; align-items: center; }
        .guide-list i { 
            color: #d32f2f; width: 30px; text-align: center; margin-right: 10px; font-size: 1.2rem; 
            background: #fff8e1; border-radius: 50%; padding: 5px; height: 30px; width: 30px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .btn-guide-ok {
            background: linear-gradient(135deg, #f0932b 0%, #e67e22 100%); 
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; width: 100%;
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <div id="guideOverlay">
        <div class="guide-card">
            <h3 class="guide-title">æ­¡è¿ä¾†åˆ°å°‹ç¥åœ°åœ–</h3>
            <ul class="guide-list">
                <li><i class="fas fa-map-pin"></i> <div><b>é»æ“Šåœ–é‡˜</b>ï¼šæŸ¥çœ‹ç…§ç‰‡èˆ‡å°èˆª</div></li>
                <li><i class="fas fa-undo-alt"></i> <div><b>é»æ“Šæ¨™é¡Œ</b>ï¼šåœ°åœ–ä¸€éµæ­¸ä½</div></li>
                <li><i class="fas fa-crosshairs"></i> <div><b>ç„æº–æŒ‰éˆ•</b>ï¼šå°‹æ‰¾ä½ çš„ä½ç½®</div></li>
                <li><i class="fas fa-camera"></i> <div><b>ä¸­é–“ç›¸æ©Ÿ</b>ï¼šå»ä¸Šå‚³æ–°æƒ…å ±</div></li>
            </ul>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/guide_couple.png" class="guide-mascot" alt="å°‹ç¥å°å¹«æ‰‹">
            <button class="btn btn-guide-ok" onclick="closeGuide()">æ”¶åˆ°ï¼Œå‡ºç™¼å°‹ç¥ï¼</button>
        </div>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-capsule">
            <i class="fas fa-map-marked-alt" style="color:#d32f2f; margin-right:8px;"></i> å°‹ç¥é›·é”åœ°åœ–
            <i class="fas fa-undo-alt" style="font-size: 0.8rem; color: #a1887f; margin-left: 8px;"></i>
        </div>
    </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        function closeGuide() { $('#guideOverlay').fadeOut(); }

        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 13;

        var map = L.map('map', { zoomControl: false }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        // ğŸ”¥ çµ‚æ¥µç©©å®šæ–¹æ¡ˆï¼šCartoDB Voyager + 4æ ¸å¿ƒåŠ é€Ÿ (abcd)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap & CartoDB',
            subdomains: 'abcd', // é–‹å•Ÿå¤šåŸ·è¡Œç·’ä¸‹è¼‰ï¼Œé€Ÿåº¦å¿« 4 å€
            maxZoom: 20
        }).addTo(map);

        var markers = L.markerClusterGroup({
            showCoverageOnHover: false, zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true, spiderfyDistanceMultiplier: 1.5, maxClusterRadius: 60
        });

        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='simple-pin'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
        });

        // åŠ ä¸ŠéŒ¯èª¤è™•ç†ï¼Œå¦‚æœ API è®€ä¸åˆ°æœƒè‡ªå‹•é‡è©¦
        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(data && data.length > 0) {
                    markers.clearLayers(); // æ¸…é™¤èˆŠçš„é¿å…é‡è¤‡
                    data.forEach(function(item) {
                        var desc = item.description || "åœ¨è‹‘è£¡ç™¼ç¾çš„ç¥è¹Ÿï¼";
                        var nickname = item.nickname || 'ç†±å¿ƒé„‰è¦ª';
                        var popupContent = `
                            <div class="popup-img-box"><img src="${item.image_url}" loading="lazy"></div>
                            <div class="popup-info">
                                <div class="popup-title">ğŸ‘¤ ${nickname}</div>
                                <div class="popup-desc">${desc}</div>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                    <i class="fas fa-location-arrow"></i> å°èˆªå»æ‹œæ‹œ
                                </a>
                            </div>`;
                        markers.addLayer(L.marker([item.lat, item.lng], { icon: simpleIcon }).bindPopup(popupContent));
                    });
                    map.addLayer(markers);
                }
            }).fail(function() {
                console.log("é€£ç·šä¸ç©©ï¼Œ3ç§’å¾Œé‡è©¦...");
                setTimeout(loadLocations, 3000); // å¦‚æœå¤±æ•—ï¼Œ3ç§’å¾Œè‡ªå‹•é‡è©¦
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); map.closePopup(); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude; var lng = position.coords.longitude;
                    map.flyTo([lat, lng], 16);
                    L.circleMarker([lat, lng], { radius: 8, fillColor: "#0984e3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map).bindPopup("ğŸ“ ä½ åœ¨é€™è£¡").openPopup();
                }, function() { alert("ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªå·²æˆæ¬Šã€‚"); });
            } else { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"); }
        }

        $(document).ready(function() {
            $('#guideOverlay').css('display', 'flex');
            loadLocations(); // å•Ÿå‹•è³‡æ–™è¼‰å…¥
            setTimeout(function(){ map.invalidateSize(); }, 500); // ç¢ºä¿åœ°åœ–æ»¿ç‰ˆ
        });
    </script>
{% endblock %}
