{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– (ç©©å®šç‰ˆ){% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* åœ°åœ–åº•è‰² */
        #map { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh; 
            z-index: 1; 
            background-color: #fdfcf0; 
        }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .map-header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 900; width: 90%; max-width: 400px; text-align: center;
        }
        .header-capsule {
            background: rgba(255, 255, 255, 0.95); padding: 10px 25px; 
            border-radius: 50px; font-weight: bold; color: #5d4037; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            display: inline-flex; align-items: center; 
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer; backdrop-filter: blur(5px);
        }

        /* ğŸ”¥ å°å¹«æ‰‹é®ç½©æ¨£å¼ (åŠ å›ä¾†äº†ï¼) */
        #guideOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .guide-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 25px; padding: 25px; 
            text-align: center; border: 4px solid #fff8e1;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: popUp 0.5s ease-out;
        }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .guide-mascot {
            display: block; margin: 10px auto 15px auto; 
            width: 140px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
        }
        .guide-list { text-align: left; margin-bottom: 20px; padding-left: 10px; font-size: 0.95rem; }
        .guide-list li { margin-bottom: 10px; list-style: none; display: flex; align-items: center; }
        .guide-list i { 
            color: #d32f2f; width: 30px; margin-right: 10px; font-size: 1.2rem; text-align: center;
        }
        .btn-guide-ok {
            background: linear-gradient(135deg, #f0932b 0%, #e67e22 100%); 
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; width: 100%;
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.3);
        }

        /* å½ˆå‡ºè¦–çª—èˆ‡æŒ‰éˆ• */
        .leaflet-popup-content-wrapper { border-radius: 15px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        .popup-img-box { width: 100%; height: 160px; overflow: hidden; }
        .popup-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .popup-info { padding: 15px; }
        .popup-btn {
            background: #d32f2f; color: white !important; border-radius: 50px; 
            padding: 8px 0; display: block; text-align: center; text-decoration: none; margin-top: 10px;
        }
        .btn-locate {
            position: absolute; bottom: 110px; right: 20px; z-index: 900;
            width: 50px; height: 50px; border-radius: 50%;
            background: white; color: #333; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
        }
        .custom-div-icon { background: transparent; border: none; }
        .simple-pin { font-size: 36px; text-align: center; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); }
    </style>
{% endblock %}

{% block content %}
    <div id="guideOverlay">
        <div class="guide-card">
            <h3 style="color:#d32f2f; font-weight:bold; margin-bottom:15px;">å°‹ç¥åœ°åœ–æŒ‡å—</h3>
            <ul class="guide-list">
                <li><i class="fas fa-map-pin"></i> é»æ“Šåœ–é‡˜çœ‹ç…§ç‰‡</li>
                <li><i class="fas fa-crosshairs"></i> æŒ‰ç„æº–éˆ•æ‰¾è‡ªå·±</li>
                <li><i class="fas fa-camera"></i> æŒ‰ç›¸æ©Ÿå»ä¸Šå‚³</li>
            </ul>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/guide_couple.png" class="guide-mascot" alt="å°å¹«æ‰‹">
            <button class="btn btn-guide-ok" onclick="closeGuide()">å¥½ï¼Œå‡ºç™¼ï¼</button>
        </div>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-capsule">
            <i class="fas fa-map-marked-alt" style="color:#d32f2f; margin-right:8px;"></i> å°‹ç¥é›·é”åœ°åœ–
        </div>
    </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // é—œé–‰å°å¹«æ‰‹çš„åŠŸèƒ½
        function closeGuide() { $('#guideOverlay').fadeOut(); }

        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 14;

        var map = L.map('map', { zoomControl: false }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        // ğŸ”¥ æ”¹å›æœ€ç©©å®šçš„ OSM æ¨™æº–åœ°åœ– (é¿å…ç ´åœ–)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='simple-pin'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
        });

        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(data && data.length > 0) {
                    markers.clearLayers();
                    data.forEach(function(item) {
                        var popupContent = `
                            <div class="popup-img-box"><img src="${item.image_url}"></div>
                            <div class="popup-info">
                                <b>${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                                <p>${item.description || 'ç™¼ç¾ç¥è¹Ÿï¼'}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=$?q=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                    å°èˆªå»æ‹œæ‹œ
                                </a>
                            </div>`;
                        markers.addLayer(L.marker([item.lat, item.lng], { icon: simpleIcon }).bindPopup(popupContent));
                    });
                    map.addLayer(markers);
                }
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    map.flyTo([position.coords.latitude, position.coords.longitude], 16);
                });
            } else { alert("ç„¡æ³•å®šä½"); }
        }

        $(document).ready(function() {
            // ç¢ºä¿ä¸€é€²ä¾†å°±é¡¯ç¤ºå°å¹«æ‰‹
            $('#guideOverlay').show();
            loadLocations();
        });
    </script>
{% endblock %}
