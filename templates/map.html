<script>
/* =====================
   åŸºæœ¬è¨­å®š
===================== */
const DEFAULT_LAT = 24.4418;
const DEFAULT_LNG = 120.6543;
const DEFAULT_ZOOM = 14;
const DETAIL_CACHE = {};

function closeGuide() {
    $('#guideOverlay').fadeOut();
}

/* =====================
   åˆå§‹åŒ–åœ°åœ–ï¼ˆæ‰‹æ©Ÿæ¥µé™ï¼‰
===================== */
var map = L.map('map', {
    zoomControl: false,
    preferCanvas: true,
    inertia: true,
    tap: false
}).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

/* =====================
   åº•åœ–
===================== */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* =====================
   Canvas Marker Cluster
===================== */
var markers = L.markerClusterGroup({
    chunkedLoading: true,
    chunkInterval: 80,
    chunkDelay: 20,
    removeOutsideVisibleBounds: true,
    maxClusterRadius: 60
});
map.addLayer(markers);

/* =====================
   Iconï¼ˆæ¥µç°¡ï¼‰
===================== */
var simpleIcon = L.divIcon({
    className: 'custom-div-icon',
    html: "<div class='simple-pin'>ğŸ“</div>",
    iconSize: [28, 28],
    iconAnchor: [14, 28]
});

/* =====================
   åŠ å…¥ Markerï¼ˆä¸å»º popupï¼‰
===================== */
function addLiteMarker(item) {
    var marker = L.marker([item.lat, item.lng], { icon: simpleIcon });

    marker.on('click', function() {
        openDetailPopup(item.id, marker);
    });

    markers.addLayer(marker);
}

/* =====================
   é»æ“Šæ‰è¼‰è©³ç´°è³‡æ–™
===================== */
function openDetailPopup(id, marker) {
    if (DETAIL_CACHE[id]) {
        marker.bindPopup(DETAIL_CACHE[id]).openPopup();
        return;
    }

    marker.bindPopup('è¼‰å…¥ä¸­...').openPopup();

    $.getJSON(`/api/location/${id}`, function(item) {
        var html = `
            <div class="popup-img-box" data-img="${item.image_url}"></div>
            <div class="popup-info">
                <b>${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                <p>${item.description || ''}</p>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}"
                   target="_blank" class="popup-btn">å°èˆªå»æ‹œæ‹œ</a>
            </div>
        `;

        DETAIL_CACHE[id] = html;
        marker.setPopupContent(html);

        setTimeout(() => {
            const box = document.querySelector('.popup-img-box');
            if (box && !box.innerHTML) {
                box.innerHTML = `<img src="${box.dataset.img}">`;
            }
        }, 50);
    });
}

/* =====================
   è¼‰å…¥ã€Œè¼•é‡ã€è³‡æ–™ï¼ˆè¦–çª—å…§ï¼‰
===================== */
function loadLiteLocations() {
    if (map.getZoom() < 13) {
        markers.clearLayers();
        return;
    }

    const b = map.getBounds();

    $.getJSON('/api/locations-lite', {
        north: b.getNorth(),
        south: b.getSouth(),
        east: b.getEast(),
        west: b.getWest()
    }, function(data) {
        markers.clearLayers();
        if (!data) return;
        data.forEach(addLiteMarker);
    });
}

/* =====================
   åŸºæœ¬äº’å‹•
===================== */
function resetMapView() {
    map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
}

function locateUser() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
    });
}

/* =====================
   åˆå§‹åŒ–æµç¨‹
===================== */
$(document).ready(function() {
    $('#guideOverlay').show();

    setTimeout(loadLiteLocations, 300);
    map.on('moveend zoomend', loadLiteLocations);

    setTimeout(() => map.invalidateSize(), 600);
});
</script>
