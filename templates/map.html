{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥é›·é” - çµ‚æ¥µåŠ é€Ÿç‰ˆ{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* é è¨­ç±³é»ƒè‰²èƒŒæ™¯ï¼Œé˜²æ­¢æ ¼å­ç ´åœ–æ™‚å¤ªé›£çœ‹ */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; background-color: #fdfcf0; }
        
        /* åŒ¾é¡æ¨™é¡Œ */
        .map-header { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 900; width: 90%; max-width: 400px; text-align: center; }
        .header-badge { background: #d32f2f; color: #fff; padding: 10px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3); border: 2px solid #fff8e1; }

        /* ğŸš€ æ•™å­¸æŒ‡å—é®ç½© (ä¿®å¾©å›æ­¸ï¼) */
        #guideOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 64, 55, 0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .guide-card {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 30px; padding: 30px 25px; 
            text-align: center; border: 4px solid #fff8e1;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .guide-mascot { display: block; margin: 0 auto 20px auto; width: 140px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .guide-btn {
            background: linear-gradient(135deg, #f0932b 0%, #e67e22 100%); 
            color: white; border: none; padding: 12px 0; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; width: 100%;
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.3);
        }

        /* å½ˆå‡ºè¦–çª— */
        .leaflet-popup-content-wrapper { border-radius: 20px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 250px !important; }
        .popup-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .popup-info { padding: 15px; }
        .popup-btn { background: #d32f2f; color: white !important; border-radius: 50px; padding: 10px 0; display: block; text-align: center; text-decoration: none !important; margin-top: 10px; }

        /* å®šä½æŒ‰éˆ• */
        .btn-locate { position: absolute; bottom: 110px; right: 20px; z-index: 900; width: 55px; height: 55px; border-radius: 50%; background: white; color: #d32f2f; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    </style>
{% endblock %}

{% block content %}
    <div id="guideOverlay">
        <div class="guide-card">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/guide_couple.png" class="guide-mascot" alt="å°å¹«æ‰‹">
            <h3 style="color:#d32f2f; font-weight:bold; margin-bottom:10px;">å°‹ç¥åœ°åœ–æŒ‡å—</h3>
            <p style="color:#8d6e63; margin-bottom:20px; font-size:0.95rem;">é»æ“Šåœ°åœ–ä¸Šçš„åœ–é‡˜<br>çœ‹çœ‹ç¥éšŠå‹èº²åœ¨å“ªè£¡ï¼</p>
            <button class="guide-btn" onclick="closeGuide()">æ”¶åˆ°ï¼Œå‡ºç™¼ï¼</button>
        </div>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-badge"><i class="fas fa-map-marked-alt mr-2"></i> å°‹ç¥é›·é”åœ°åœ–</div>
    </div>

    <div id="map"></div>
    <div class="btn-locate" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 14;

        function closeGuide() { $('#guideOverlay').fadeOut(); }

        /* ğŸš€ æ•ˆèƒ½æ ¸å¿ƒï¼šCanvas æ¸²æŸ“ + å»¶é²å•Ÿå‹• */
        var map = L.map('map', {
            zoomControl: false,
            preferCanvas: true, // æ•ˆèƒ½é—œéµ
            tap: false,
            updateWhenIdle: true, // åªåœ¨åœæ­¢ç§»å‹•æ™‚æ›´æ–°
            updateWhenZooming: false
        }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        /* ğŸ”¥ ä½¿ç”¨ CartoDB å…¨çƒåŠ é€Ÿç¯€é»ï¼Œé€Ÿåº¦æœ€å¿« */
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© CartoDB',
            subdomains: 'abcd', // ä½¿ç”¨å¤šç·šç¨‹åŠ é€Ÿä¸‹è¼‰
            maxZoom: 20
        }).addTo(map);

        var markers = L.markerClusterGroup({ 
            chunkedLoading: true, // åˆ†æ‰¹è¼‰å…¥é¿å…ç•¶æ©Ÿ
            maxClusterRadius: 60 
        });

        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(!data) return;
                markers.clearLayers();
                data.forEach(function(item) {
                    var marker = L.marker([item.lat, item.lng], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='font-size:32px; filter:drop-shadow(0 2px 3px rgba(0,0,0,0.3));'>ğŸ“</div>",
                            iconSize: [30, 30], iconAnchor: [15, 30]
                        })
                    });
                    
                    marker.on('click', function() {
                        var html = `
                            <img src="${item.image_url}" class="popup-img" loading="lazy">
                            <div class="popup-info">
                                <b style="color:#5d4037;">ğŸ‘¤ ${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                                <p style="margin:5px 0; font-size:0.9rem; color:#8d6e63;">${item.description || ''}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                    <i class="fas fa-location-arrow"></i> å°èˆªå»æ‹œæ‹œ
                                </a>
                            </div>`;
                        marker.bindPopup(html).openPopup();
                    });
                    markers.addLayer(marker);
                });
                map.addLayer(markers);
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
                });
            }
        }

        $(document).ready(function() {
            // 1. å¼·åˆ¶é¡¯ç¤ºæŒ‡å—
            $('#guideOverlay').css('display', 'flex').hide().fadeIn();
            
            // 2. ç•°æ­¥è¼‰å…¥è³‡æ–™
            setTimeout(loadLocations, 300);
            
            // 3. è§£æ±ºæ‰‹æ©Ÿç•«é¢è·‘æ‰çš„å•é¡Œ
            setTimeout(() => { map.invalidateSize(); }, 600);
        });
    </script>
{% endblock %}
