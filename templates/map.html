<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map My God - æœå°‹é›·é”</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        body { 
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 70px;
            overflow-x: hidden;
        }
        
        #map { 
            height: 78vh; 
            width: 95%; margin: 0 auto; 
            border-radius: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border: 4px solid white;
            z-index: 1;
        }
        
        /* ğŸ”¦ èšç„¦ç‡ˆæ§åˆ¶å€ */
        .spotlight-control {
            position: relative;
            width: 90%; max-width: 450px; 
            margin: 50px auto 15px auto; /* ä¸Šæ–¹é‚Šè·å†åŠ å¤§ä¸€é»ï¼Œçµ¦æ°£æ³¡æ¡†ç©ºé–“ */
            background: white; padding: 10px 15px; border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 20;
        }
        
        /* ğŸ§ å°å¹«æ‰‹å…¬ä»” */
        .helper-mascot {
            position: absolute;
            top: -40px;
            right: 15px;
            height: 75px; width: auto; /* ç¨å¾®å†å¤§ä¸€é»é» */
            cursor: pointer;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2));
            transition: transform 0.2s;
            animation: float-mascot 3s ease-in-out infinite;
            z-index: 22;
        }
        .helper-mascot:active { transform: scale(0.9) rotate(-5deg); }

        @keyframes float-mascot {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        /* ğŸ’¬ å°å¹«æ‰‹æ°£æ³¡æ¡† (æ–°å¢ï¼) */
        .helper-bubble {
            position: absolute;
            top: -70px; /* åœ¨å…¬ä»”é ­ä¸Š */
            right: 0px;
            background: #2d3436;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 21;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°å…¬ä»” */
            opacity: 0.9;
            animation: bounce-bubble 2s infinite;
        }
        /* æ°£æ³¡çš„å°ä¸‰è§’å½¢ */
        .helper-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            right: 25px;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #2d3436 transparent;
        }

        @keyframes bounce-bubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* ğŸ”´ æ‡¸æµ®ç´…è‰²æŒ‰éˆ• (ä¿®æ­£ï¼šå¼·åˆ¶ä¸æ›è¡Œ) */
        .btn-floating-add {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(214, 48, 49, 0.4);
            z-index: 900;
            display: flex; align-items: center; justify-content: center;
            white-space: nowrap; /* âœ¨ é—œéµä¿®æ­£ï¼šå¼·åˆ¶æ–‡å­—ä¸æ›è¡Œï¼ */
            min-width: 220px; /* çµ¦å®ƒä¸€å€‹æœ€å°å¯¬åº¦ï¼Œç¢ºä¿ä¸æœƒè¢«æ“ å£“ */
        }
        .btn-floating-add:hover { color: white; text-decoration: none; transform: translateX(-50%) scale(1.05); }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 0; display: flex; justify-content: space-around; z-index: 999; }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 0.8rem; flex: 1; }
        .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

    <div class="spotlight-control">
        <div style="flex-grow: 1; display:flex; align-items:center;">
            <i class="fas fa-search-location" style="color:#d32f2f; margin-right:8px; font-size:1.2rem;"></i>
            <select id="district-select" class="form-control form-control-sm" style="border-radius:20px; border:1px solid #eee; background:#f9f9f9; height: 35px;">
                <option value="all">é¡¯ç¤ºå…¨è‹‘è£¡ (é è¨­)</option>
                <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option>
                <option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option>
                <option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                <option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option>
                <option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option>
                <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option>
                <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option>
                <option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option>
                <option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                <option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option>
                <option value="è‹‘å‘é‡Œ">è‹‘å‘é‡Œ</option>
                <option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                <option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option>
                <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option>
                <option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                <option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option>
                <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option>
                <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option>
                <option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                <option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option>
                <option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option>
                <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option>
                <option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                <option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
            </select>
        </div>

        <div class="helper-bubble">æˆ‘æ˜¯å°å¹«æ‰‹ ğŸ‘‹</div>
        
        <img src="/static/maps.png" class="helper-mascot" alt="å°å¹«æ‰‹" data-toggle="modal" data-target="#mapHelperModal">
    </div>

    <div id="map"></div>
    
    <a href="/upload" class="btn-floating-add">
        <i class="fas fa-camera" style="margin-right:8px;"></i> é€™è£¡ä¹Ÿæœ‰ä¸€å°Šï¼
    </a>

    <div class="modal fade" id="mapHelperModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px;">
                <div class="modal-header" style="border-bottom:none;">
                    <h5 class="modal-title" style="font-weight:bold; color:#2d3436;">ğŸ—ºï¸ åœ°åœ–æ€éº¼çœ‹ï¼Ÿ</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" style="padding:0 20px 20px 20px;">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center">
                            <div style="width:30px; height:30px; background-color:#6ecc39; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; margin-right:15px; font-weight:bold;">10</div>
                            <span><b>å½©è‰²åœ“åœˆ (èšåˆ)</b><br><small class="text-muted">é€™å€æœ‰ 10 å°Šï¼Œé»æ“Šçœ‹ç´°ç¯€ï¼</small></span>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="fas fa-map-marker-alt" style="color:#2980b9; font-size:1.5rem; margin-right:18px; margin-left:5px;"></i>
                            <span><b>è—è‰²åœ–é‡˜</b><br><small class="text-muted">é€™è£¡æœ‰ä¸€å°ŠåœŸåœ°å…¬ï¼</small></span>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <img src="/static/maps.png" style="width:40px; margin-right:10px;">
                            <span><b>å°å¹«æ‰‹</b><br><small class="text-muted">é»æˆ‘æœ‰ä½¿ç”¨èªªæ˜å–”ï¼</small></span>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer" style="border-top:none;">
                    <button type="button" class="btn btn-primary btn-block" data-dismiss="modal" style="border-radius:30px;">æ‡‚äº†ï¼Œé–‹å§‹å°‹å¯¶ï¼</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/" class="nav-item"><i class="fas fa-home"></i>é¦–é </a>
        <a href="/map" class="nav-item active"><i class="fas fa-map-marked-alt"></i>åœ°åœ–</a>
        <a href="/gallery" class="nav-item"><i class="fas fa-images"></i>åœ–åº«</a>
        <a href="/leaderboard" class="nav-item"><i class="fas fa-list-ol"></i>æ¦œå–®</a>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const districts = {
            "è‹‘æ±é‡Œ": [24.443, 120.655], "è‹‘å—é‡Œ": [24.441, 120.652], "å±±è…³é‡Œ": [24.415, 120.685],
        };

        var map = L.map('map').setView([24.44, 120.65], 13); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        var markers = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
        var allLocations = [];

        $.getJSON('/api/locations', function(data) {
            allLocations = data;
            renderMarkers(allLocations);
        });

        function renderMarkers(data) {
            markers.clearLayers();
            if (data.length > 0) {
                var groupBounds = L.latLngBounds();
                data.forEach(function(item) {
                    // ğŸ‘‡ ä¿®æ­£ï¼šé€™è£¡æ”¹æˆ 'ç†±å¿ƒä¸²å‹'
                    var hunterName = item.nickname || 'ç†±å¿ƒä¸²å‹'; 
                    
                    var popupContent = `
                        <div style="text-align:center;">
                            <b style="color:#d32f2f; font-size:1.1rem;">ğŸ‰ ç™¼ç¾ç¥éšŠå‹ï¼</b><br>
                            <span style="color:#d35400; font-weight:bold; font-size:1rem;">ğŸ† çµäººï¼š${hunterName}</span><br>
                            <span style="color:#666; font-size:0.9rem;">ğŸ“ ä½ç½®ï¼š${item.description || 'æœªçŸ¥'}</span><br>
                            <img src="${item.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:10px; margin-top:5px; border:2px solid #eee;">
                        </div>
                    `;
                    var marker = L.marker([item.lat, item.lng]).bindPopup(popupContent);
                    markers.addLayer(marker);
                    groupBounds.extend([item.lat, item.lng]);
                });
                map.addLayer(markers);
                if (!currentDistrictFilter || currentDistrictFilter === 'all') { map.fitBounds(groupBounds); }
            }
        }

        var currentDistrictFilter = 'all';
        $('#district-select').change(function() {
            var selectedDistrict = $(this).val();
            currentDistrictFilter = selectedDistrict;
            if (selectedDistrict === 'all') {
                renderMarkers(allLocations);
                if (allLocations.length > 0) { map.fitBounds(markers.getBounds()); }
            } else {
                if (districts[selectedDistrict]) { map.flyTo(districts[selectedDistrict], 16); }
            }
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                L.circleMarker([lat, lng], { color: '#2980b9', fillColor: '#3498db', fillOpacity: 0.8, radius: 8 }).addTo(map).bindPopup("ä½ ç›®å‰çš„ä½ç½®");
            });
        }
    </script>
</body>
</html>
