{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥é›·é” - æ¥µé€Ÿç‰ˆ{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* ğŸŒ é¦™è•‰å»ºè­°ï¼šå»¶çºŒæš–ç±³è‰²åº•è‰²ï¼Œé¿å…ç™½å±é–ƒçˆ */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; background-color: #fdfcf0; }
        
        /* åŒ¾é¡æ¨™é¡Œ */
        .map-header { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 900; width: 90%; max-width: 400px; text-align: center; }
        .header-badge { background: #d32f2f; color: #fff; padding: 10px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3); border: 2px solid #fff8e1; }

        /* ğŸš€ æ–°å¢ï¼šè¼‰å…¥ä¸­é®ç½©ï¼Œè§£æ±ºã€Œå®¢äººè·‘å…‰ã€çš„å•é¡Œ */
        #mapLoading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdfcf0; z-index: 1500; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top: 5px solid #d32f2f; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å½ˆå‡ºè¦–çª—åœ“æ½¤åŒ– */
        .leaflet-popup-content-wrapper { border-radius: 20px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 250px !important; }
        .popup-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .popup-info { padding: 15px; }
        .popup-btn { background: #d32f2f; color: white !important; border-radius: 50px; padding: 10px 0; display: block; text-align: center; text-decoration: none !important; margin-top: 10px; }

        /* å®šä½æŒ‰éˆ• */
        .btn-locate { position: absolute; bottom: 110px; right: 20px; z-index: 900; width: 55px; height: 55px; border-radius: 50%; background: white; color: #d32f2f; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    </style>
{% endblock %}

{% block content %}
    <div id="mapLoading">
        <div class="loading-spinner"></div>
        <p style="margin-top:15px; color:#5d4037; font-weight:bold;">ğŸ™ æ­£åœ¨é–‹å•Ÿéˆæ„Ÿé›·é”...</p>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-badge"><i class="fas fa-map-marked-alt mr-2"></i> å°‹ç¥é›·é”åœ°åœ–</div>
    </div>

    <div id="map"></div>
    <div class="btn-locate" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 14;

        /* ğŸš€ æ•ˆèƒ½å„ªåŒ–æ ¸å¿ƒï¼šé–‹å•Ÿ Canvas æ¸²æŸ“æ¨¡å¼ */
        var map = L.map('map', {
            zoomControl: false,
            preferCanvas: true, // é€™è¡Œæ˜¯è§£æ±º 500 å€‹é»å¡é “çš„é—œéµ
            tap: false
        }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        /* ğŸ”¥ ä½¿ç”¨ CartoDB ç©©å®šåœ–å±¤ï¼Œé¿å…å°ç£æ”¿åºœä¼ºæœå™¨å¡è»Šå•é¡Œ */
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© CartoDB'
        }).addTo(map);

        // åœ°åœ–è¼‰å…¥å®Œæˆå¾Œé—œé–‰å‹•ç•«
        map.on('tileload', function() { $('#mapLoading').fadeOut(1000); });

        var markers = L.markerClusterGroup({ chunkedLoading: true });
        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='font-size:32px; filter:drop-shadow(0 2px 3px rgba(0,0,0,0.3));'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30]
        });

        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(!data) return;
                markers.clearLayers();
                data.forEach(function(item) {
                    var marker = L.marker([item.lat, item.lng], { icon: simpleIcon });
                    
                    // ğŸš€ é»æ“Šæ‰ç”Ÿæˆè©³æƒ…ï¼Œå¹« Cloudinary ç¯€çœé »å¯¬
                    marker.on('click', function() {
                        var html = `
                            <img src="${item.image_url}" class="popup-img" loading="lazy">
                            <div class="popup-info">
                                <b style="color:#5d4037;">ğŸ‘¤ ${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                                <p style="margin:5px 0; font-size:0.9rem; color:#8d6e63;">${item.description || ''}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                    <i class="fas fa-location-arrow"></i> å°èˆªå»æ‹œæ‹œ
                                </a>
                            </div>`;
                        marker.bindPopup(html).openPopup();
                    });
                    markers.addLayer(marker);
                });
                map.addLayer(markers);
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
                });
            }
        }

        $(document).ready(function() {
            loadLocations();
            setTimeout(() => { map.invalidateSize(); $('#mapLoading').fadeOut(1500); }, 1000);
        });
    </script>
{% endblock %}
