{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– (å°ç£ç‰ˆ){% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* åœ°åœ–åº•è‰²æ”¹ç‚ºæ·ºç°ï¼Œé¿å…è¼‰å…¥æ™‚å¤ªåˆºçœ¼ */
        #map { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh; 
            z-index: 1; 
            background-color: #eeeeee; 
        }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .map-header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 900; width: 90%; max-width: 400px; text-align: center;
        }
        .header-capsule {
            background: rgba(255, 255, 255, 0.95); padding: 10px 25px; 
            border-radius: 50px; font-weight: bold; color: #5d4037; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            display: inline-flex; align-items: center; 
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer; backdrop-filter: blur(5px);
        }

        /* å½ˆå‡ºè¦–çª— */
        .leaflet-popup-content-wrapper { border-radius: 15px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        .popup-img-box { width: 100%; height: 160px; overflow: hidden; position: relative; }
        .popup-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .popup-info { padding: 15px; background: #fff; }
        .popup-btn {
            background: #d32f2f; color: white !important; border-radius: 50px; 
            padding: 8px 0; display: block; text-align: center; text-decoration: none; margin-top: 10px;
        }

        /* å®šä½æŒ‰éˆ• */
        .btn-locate {
            position: absolute; bottom: 110px; right: 20px; z-index: 900;
            width: 50px; height: 50px; border-radius: 50%;
            background: white; color: #333; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
        }
        
        /* è‡ªå®šç¾©åœ–é‡˜ */
        .custom-div-icon { background: transparent; border: none; }
        .simple-pin { font-size: 36px; text-align: center; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); }
    </style>
{% endblock %}

{% block content %}
    <div class="map-header" onclick="resetMapView()">
        <div class="header-capsule">
            <i class="fas fa-map-marked-alt" style="color:#d32f2f; margin-right:8px;"></i> å°ç£é€šç”¨é›»å­åœ°åœ–
        </div>
    </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // é è¨­é–å®šè‹‘è£¡
        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 14;

        var map = L.map('map', { zoomControl: false }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        // ğŸ”¥ é€™è£¡æ”¹æˆäº†ï¼šå°ç£é€šç”¨é›»å­åœ°åœ– (NLSC)
        L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
            attribution: 'Â© å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ',
            maxZoom: 20
        }).addTo(map);

        var markers = L.markerClusterGroup();

        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='simple-pin'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
        });

        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(data && data.length > 0) {
                    markers.clearLayers();
                    data.forEach(function(item) {
                        var popupContent = `
                            <div class="popup-img-box"><img src="${item.image_url}"></div>
                            <div class="popup-info">
                                <b>${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                                <p>${item.description || 'ç™¼ç¾ç¥è¹Ÿï¼'}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=$?q=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                    å°èˆªå»æ‹œæ‹œ
                                </a>
                            </div>`;
                        markers.addLayer(L.marker([item.lat, item.lng], { icon: simpleIcon }).bindPopup(popupContent));
                    });
                    map.addLayer(markers);
                }
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    map.flyTo([position.coords.latitude, position.coords.longitude], 16);
                });
            } else { alert("ç„¡æ³•å®šä½"); }
        }

        $(document).ready(function() {
            loadLocations();
        });
    </script>
{% endblock %}
