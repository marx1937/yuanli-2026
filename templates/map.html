{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - æ¸¬è©¦ç‰ˆ{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
    /* ğŸ”¥ æš´åŠ›æ¸…é™¤ï¼šå¼·åˆ¶æŠŠæ‰€æœ‰èƒŒæ™¯æ”¹æˆç™½è‰²ï¼Œæ‹¿æ‰é»é»åœ–æ¡ˆ */
    body, html {
        background: #ffffff !important;
        background-image: none !important;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* ç¦æ­¢æ»‘å‹• */
    }

    /* ğŸ”¥ åœ°åœ–æœ¬é«”ï¼šè¨­ç‚ºçµ•å°ç½®åº• */
    #map { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100vw; 
        height: 100vh; 
        z-index: 1; /* å±¤ç´š 1ï¼Œç¢ºä¿åœ¨åœ°æ¿ä¸Š */
    }

    /* å®šä½æŒ‰éˆ• (ç°¡å–®çš„å°åœ“éˆ•) */
    .btn-gps {
        position: fixed;
        bottom: 120px; /* é¿é–‹åº•éƒ¨é¸å–® */
        right: 20px;
        width: 50px; height: 50px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: #555;
        z-index: 1000; /* å±¤ç´šé«˜ä¸€é»ï¼Œæµ®åœ¨åœ°åœ–ä¸Š */
        cursor: pointer;
    }
    .btn-gps:active { background: #eee; }
</style>
{% endblock %}

{% block content %}
    
    <div id="map"></div>

    <div class="btn-gps" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    var map;
    var userMarker = null;

    // åˆå§‹åŒ–ï¼šå–®ç´”è¼‰å…¥åœ°åœ–
    document.addEventListener("DOMContentLoaded", function() {
        initMap();
    });

    function initMap() {
        // 1. å»ºç«‹åœ°åœ–ï¼Œä¸­å¿ƒé»è¨­åœ¨è‹‘è£¡
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 14);
        
        // 2. è¼‰å…¥åœ–å±¤ (ä½¿ç”¨æœ€ç©©å®šçš„ OSM)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // 3. å¼·åˆ¶é‡ç¹ª (é˜²æ­¢ç ´åœ–çš„ä¿éšªçµ²)
        setTimeout(function() {
            map.invalidateSize();
        }, 500);
    }

    // å®šä½åŠŸèƒ½
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;

                // å¦‚æœå·²ç¶“æœ‰å°è—é»ï¼Œå…ˆç§»é™¤èˆŠçš„
                if (userMarker) map.removeLayer(userMarker);

                // ç•«ä¸Šæ–°çš„å°è—é»
                userMarker = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: "#2196f3", // äº®è—è‰²
                    color: "#ffffff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // é£›éå»
                map.flyTo([lat, lng], 16);
                
                // è·³å€‹æç¤º (å¯é¸)
                // alert("æŠ“åˆ°ä½ äº†ï¼"); 

            }, err => {
                alert("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ");
            });
        } else {
            alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        }
    }
</script>
{% endblock %}
