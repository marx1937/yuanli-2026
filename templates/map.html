{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - éˆæ„Ÿé›·é”{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; background-color: #fdfcf0; }
        
        /* å»Ÿå®‡ç´…åŒ¾é¡æ¨™é¡Œ */
        .map-header { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 900; width: 90%; max-width: 400px; text-align: center; }
        .header-badge {
            background: #d32f2f; color: #fff; padding: 10px 25px; border-radius: 50px; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3); display: inline-flex; align-items: center; border: 2px solid #fff8e1;
        }

        /* å°å¹«æ‰‹é®ç½© */
        #guideOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 64, 55, 0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .guide-card {
            background: #fff; width: 85%; max-width: 320px; border-radius: 30px; padding: 30px 25px; 
            text-align: center; border: 4px solid #fff8e1; box-shadow: 0 15px 40px rgba(0,0,0,0.3); animation: popUp 0.4s ease-out;
        }
        .guide-mascot { display: block; margin: 0 auto 20px auto; width: 150px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .guide-btn {
            background: linear-gradient(135deg, #f0932b 0%, #e67e22 100%); color: white; border: none; padding: 12px 0; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; width: 100%; box-shadow: 0 8px 20px rgba(230, 126, 34, 0.3);
        }

        /* å½ˆå‡ºè¦–çª—åœ“æ½¤åŒ– */
        .leaflet-popup-content-wrapper { border-radius: 20px; overflow: hidden; padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; width: 250px !important; }
        .popup-img { width: 100%; height: 160px; object-fit: cover; background: #f5f5f5; }
        .popup-info { padding: 15px; color: #5d4037; }
        .popup-btn {
            background: #d32f2f; color: white !important; border-radius: 50px; 
            padding: 10px 0; display: block; text-align: center; font-weight: bold; margin-top: 10px;
        }

        /* å®šä½æŒ‰éˆ• */
        .btn-locate {
            position: absolute; bottom: 110px; right: 20px; z-index: 900;
            width: 55px; height: 55px; border-radius: 50%; background: white; color: #d32f2f; font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .simple-pin { font-size: 32px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.3)); cursor: pointer; }
    </style>
{% endblock %}

{% block content %}
    <div id="guideOverlay">
        <div class="guide-card">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/guide_couple.png" class="guide-mascot" alt="å°å¹«æ‰‹">
            <h3 style="color:#d32f2f; font-weight:bold;">è‹‘è£¡å°‹ç¥æŒ‡å—</h3>
            <p style="color:#8d6e63; margin-bottom:20px;">é»æ“Šåœ°åœ–ä¸Šçš„åœ–é‡˜<br>çœ‹çœ‹ç¥éšŠå‹èº²åœ¨å“ªè£¡ï¼</p>
            <button class="guide-btn" onclick="closeGuide()">æ”¶åˆ°ï¼Œå‡ºç™¼ï¼</button>
        </div>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-badge"><i class="fas fa-map-marked-alt mr-2"></i> å°‹ç¥é›·é”åœ°åœ–</div>
    </div>

    <div id="map"></div>
    <div class="btn-locate" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 14;
        const POPUP_CACHE = {}; // æ‡¶äººå¿«å–

        function closeGuide() { $('#guideOverlay').fadeOut(); }

        /* åˆå§‹åŒ–åœ°åœ– - é–‹å•Ÿ Canvas æ•ˆèƒ½æ¨¡å¼ */
        var map = L.map('map', {
            zoomControl: false,
            preferCanvas: true, // ğŸš€ ä»–ç‰Œå»ºè­°ï¼šå¤§é‡é»ä½å¿…å‚™ï¼Œæ•ˆèƒ½æå‡ 10 å€
            tap: false
        }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OSM'
        }).addTo(map);

        /* è¨­å®š MarkerCluster - å¤§é‡è³‡æ–™åˆ†æ‰¹è™•ç† */
        var markers = L.markerClusterGroup({
            chunkedLoading: true, // ğŸš€ ä»–ç‰Œå»ºè­°ï¼šåˆ†æ‰¹è™•ç†ä¸å‡çµç•«é¢
            maxClusterRadius: 60,
            showCoverageOnHover: false
        });

        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='simple-pin'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30]
        });

        /* æ ¸å¿ƒè¼‰å…¥é‚è¼¯ */
        function loadLocations() {
            $.getJSON('/api/locations', function(data) {
                if(!data) return;
                markers.clearLayers();
                data.forEach(function(item) {
                    var marker = L.marker([item.lat, item.lng], { icon: simpleIcon });
                    
                    // ğŸš€ ä»–ç‰Œå»ºè­°ï¼šé»æ“Šæ‰ç”Ÿæˆè©³æƒ…ï¼Œçœè¨˜æ†¶é«”èˆ‡æµé‡
                    marker.on('click', function() {
                        if (!POPUP_CACHE[item.id]) {
                            POPUP_CACHE[item.id] = `
                                <img src="${item.image_url}" class="popup-img" loading="lazy">
                                <div class="popup-info">
                                    <b>ğŸ‘¤ ${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
                                    <p style="margin:5px 0; font-size:0.9rem;">${item.description || 'ç™¼ç¾ç¥è¹Ÿï¼'}</p>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                        <i class="fas fa-location-arrow"></i> å°èˆªå»æ‹œæ‹œ
                                    </a>
                                </div>`;
                        }
                        marker.bindPopup(POPUP_CACHE[item.id]).openPopup();
                    });
                    markers.addLayer(marker);
                });
                map.addLayer(markers);
            });
        }

        function resetMapView() { map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM); }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
                    L.circleMarker([pos.coords.latitude, pos.coords.longitude], { radius: 8, color: '#d32f2f' }).addTo(map);
                });
            }
        }

        $(document).ready(function() {
            loadLocations();
            setTimeout(() => map.invalidateSize(), 500);
        });
    </script>
{% endblock %}
