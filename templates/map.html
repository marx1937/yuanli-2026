<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°‹ç¥åœ°åœ– - è‹‘è£¡é®</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* 1. åŸºç¤è¨­å®š */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #fdfcf0; font-family: "Microsoft JhengHei", sans-serif; }

        /* åœ°åœ–å…¨è¢å¹• */
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* 2. ğŸ”¥ğŸ”¥ UX ä¿®æ­£ï¼šå½ˆçª—é˜²èª¤è§¸ + å»Ÿå…¬é¢¨ç¾åŒ– ğŸ”¥ğŸ”¥ */
        .swal2-container {
            z-index: 3000 !important;
            padding-bottom: 20px !important;
        }
        .swal2-popup {
            margin-bottom: 150px !important; /* é˜²èª¤è§¸ï¼šå¾€ä¸Šæ¨ */
            border-radius: 20px !important;
            border: 3px solid #8d6e63 !important; /* æ”¹æˆæœ¨ç´‹è¤è‰²çš„é‚Šæ¡†ï¼Œåƒå‘Šç¤ºç‰Œ */
            background: #fffbf0 url('https://www.transparenttextures.com/patterns/cream-paper.png') !important; /* å®£ç´™è³ªæ„Ÿ */
            max-width: 90% !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
        }
        .swal2-title { color: #5d4037 !important; font-weight: 900 !important; }
        .swal2-html-container { color: #5d4037 !important; font-weight: 500; }
        .swal2-close { 
            color: #c62828 !important; /* ç´…è‰²é—œé–‰éˆ• */
            border: 2px solid #c62828 !important;
            border-radius: 50% !important;
            font-size: 1.2rem !important;
            margin: 5px !important;
        }
        .swal2-close:focus { box-shadow: none !important; }

        /* 3. èšåˆå™¨æ¨£å¼ */
        .marker-cluster-custom {
            background: radial-gradient(circle at 30% 30%, #fff9c4, #fbc02d);
            border: 3px solid #c62828;
            border-radius: 50%;
            color: #fff; text-align: center; font-weight: 900; font-family: Arial, sans-serif;
            box-shadow: inset 0 -3px 5px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.3);
            display: flex !important; align-items: center; justify-content: center;
            text-shadow: -1px -1px 0 #b71c1c, 1px -1px 0 #b71c1c, -1px 1px 0 #b71c1c, 1px 1px 0 #b71c1c;
        }
        .marker-cluster-custom span { line-height: 1; font-size: 1.1rem; }

        /* 4. é ‚éƒ¨ç¯©é¸åˆ— */
        .map-filter-container {
            position: fixed; top: 15px; left: 0; right: 0; z-index: 1000;
            padding: 10px 15px; white-space: nowrap; overflow-x: auto;
            display: flex; gap: 8px; -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .map-filter-container::-webkit-scrollbar { display: none; }

        .filter-chip {
            display: inline-flex; align-items: center; gap: 5px;
            background: rgba(255, 255, 255, 0.95); color: #555; 
            padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15); border: 1px solid #fff; 
            cursor: pointer; transition: 0.2s;
        }
        .filter-chip span { background: #eee; color: #888; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; min-width: 15px; text-align: center; }
        .filter-chip.active { background: #d32f2f; color: white; transform: scale(1.05); }
        .filter-chip.active span { background: #fff; color: #d32f2f; }

        /* 5. å³å´å·¥å…·åˆ— */
        .right-toolbar {
            position: fixed; right: 15px; top: 45%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 12px; z-index: 1000;
        }
        .tool-btn {
            width: 45px; height: 45px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
            color: #555; font-size: 1.2rem; transition: 0.2s;
        }
        .tool-btn:active { transform: scale(0.9); background: #f5f5f5; }

        /* 6. åº•éƒ¨æ»‘å‡ºå¡ç‰‡ */
        #info-card {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; z-index: 1100;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            transition: bottom 0.3s ease-out;
            padding-bottom: 110px; 
        }
        #info-card.show { bottom: 0; }
        
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { font-size: 1.3rem; font-weight: 800; color: #333; }
        .card-badge { background: #ffebee; color: #d32f2f; padding: 3px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .card-content { display: flex; gap: 15px; }
        .card-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; background: #eee; }
        .card-details { flex: 1; font-size: 0.9rem; color: #666; }
        .detail-row { margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .btn-nav {
            display: block; width: 100%; margin-top: 15px;
            background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white;
            text-align: center; padding: 12px; border-radius: 50px; text-decoration: none; font-weight: bold;
        }
        .btn-nav:hover { color: white; text-decoration: none; filter: brightness(1.1); }

        /* 7. å½è£å°èˆªåˆ— (è¦–è¦ºä¿®æ­£ï¼šè®“éé¸ä¸­é …ç›®è®Šç°) */
        .fake-navbar {
            position: fixed; bottom: 0; width: 100%; 
            background: #fff; border-top: 1px solid #efebe9; 
            padding: 0 5px; height: 90px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 2000; box-shadow: 0 -5px 20px rgba(93, 64, 55, 0.05);
        }
        
        .nav-item { 
            text-align: center; color: #a1887f; text-decoration: none; 
            font-size: 0.75rem; flex: 1; display: flex; flex-direction: column; align-items: center; 
        }
        
        /* ğŸ”¥ é—œéµ CSSï¼šé è¨­è®Šç°ï¼Œé¸ä¸­è®Šå½© */
        .nav-icon { 
            height: 42px; width: auto; margin-bottom: 3px; 
            filter: grayscale(100%) sepia(20%) opacity(0.8); /* é è¨­ç°è‰²å¾©å¤æ„Ÿ */
            transition: all 0.3s; 
        }
        
        .nav-item.active .nav-icon { 
            transform: scale(1.1); 
            filter: none; /* é‚„åŸå½©è‰² */
            filter: drop-shadow(0 2px 2px rgba(211, 47, 47, 0.2)); 
        }
        .nav-item.active span { color: #d32f2f; font-weight: bold; }

        .nav-center-btn {
            width: 80px; height: 80px; background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            border-radius: 50%; border: 6px solid #f9f7f2; display: flex; align-items: center; justify-content: center;
            transform: translateY(-35px); box-shadow: 0 8px 15px rgba(198, 40, 40, 0.3); overflow: hidden; text-decoration: none;
        }
        .nav-center-icon { height: 55px; width: auto; display: block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); margin: 0; }

        /* ğŸŒŸ å»Ÿå…¬ç¶­ä¿®é¢¨ - å°ˆå±¬æŒ‰éˆ•æ¨£å¼ */
        .btn-jade {
            background: linear-gradient(135deg, #66bb6a, #2e7d32);
            color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-cinnabar {
            background: linear-gradient(135deg, #ef5350, #c62828);
            color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-jade:active, .btn-cinnabar:active { transform: scale(0.98); }

        /* å°å¹«æ‰‹æ¨£å¼ */
        .guide-row { display: flex; align-items: center; margin-bottom: 12px; text-align: left; }
        .guide-icon-box { width: 35px; flex-shrink: 0; text-align: center; font-size: 1.1rem; }
        .guide-text-box { flex: 1; color: #555; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="map-filter-container" id="filter-scroll"></div>
    
    <div id="map"></div>

    <div class="right-toolbar">
        <div class="tool-btn" onclick="map.zoomIn()"><i class="fas fa-plus"></i></div>
        <div class="tool-btn" onclick="map.zoomOut()"><i class="fas fa-minus"></i></div>
        <div class="tool-btn" onclick="locateUser()" id="btn-gps"><i class="fas fa-crosshairs"></i></div>
        <div class="tool-btn" onclick="showGuide()" style="color:#2e7d32;"><i class="fas fa-question"></i></div>
        <div class="tool-btn" onclick="openDebugMenu()" style="color:#d32f2f;"><i class="fas fa-cog"></i></div>
    </div>

    <div id="info-card">
        <div class="card-header-row">
            <div>
                <span class="card-badge" id="card-village">é‡Œåˆ¥</span>
                <div class="card-title" id="card-name">è¼‰å…¥ä¸­...</div>
            </div>
            <div style="font-size:1.5rem; color:#999;" onclick="closeCard()"><i class="fas fa-times"></i></div>
        </div>
        <div class="card-content">
            <img id="card-img" src="" onclick="window.location.href='/gallery'">
            <div class="card-details">
                <div class="detail-row"><i class="fas fa-user-circle"></i> <span id="card-user"></span></div>
                <div class="detail-row"><i class="fas fa-clock"></i> <span id="card-time"></span></div>
                <div class="detail-row"><i class="fas fa-sticky-note"></i> <span id="card-note"></span></div>
            </div>
        </div>
        <a href="#" id="btn-google-nav" target="_blank" class="btn-nav">
            <i class="fas fa-location-arrow"></i> Google å°èˆªå‡ºç™¼
        </a>
    </div>

    <div class="fake-navbar">
        <a href="/" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png" class="nav-icon"><span>é¦–é </span>
        </a>
        <a href="/map" class="nav-item active">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_map.png" class="nav-icon"><span>åœ°åœ–</span>
        </a>
        <a href="/upload" class="nav-center-btn">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="nav-center-icon">
        </a>
        <a href="/gallery" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" class="nav-icon"><span>åœ–åº«</span>
        </a>
        <a href="/leaderboard" class="nav-item">
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_leaderboard.png" class="nav-icon"><span>æ¦œå–®</span>
        </a>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <script>
        var map;
        var markersCluster;
        var allMarkers = [];
        var villageCounts = {};
        var userMarker = null;

        const ALL_VILLAGES = [
            "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "è‹‘æ¸¯é‡Œ", "è¥¿å¹³é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "æˆ¿è£¡é‡Œ", "å®¢åº„é‡Œ", "ä¸­æ­£é‡Œ", 
            "æ–°å¾©é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "èˆŠç¤¾é‡Œ", "å±±è…³é‡Œ", "ç¦ç”°é‡Œ", "æ³°ç”°é‡Œ", "ç‰ç”°é‡Œ", "å—å‹¢é‡Œ", 
            "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "ä¸Šé¤¨é‡Œ", "æ°´å¡é‡Œ", "è‹‘å‘é‡Œ", "å‡ºæ°´é‡Œ"
        ];

        $(document).ready(function() {
            initMap();
            loadData();
            if(!localStorage.getItem('map_guided_v3')) {
                showGuide();
                localStorage.setItem('map_guided_v3', 'true');
            }
        });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(map);

            markersCluster = L.markerClusterGroup({ 
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    var childCount = cluster.getChildCount();
                    var size = childCount > 50 ? 60 : (childCount > 10 ? 50 : 40);
                    return new L.DivIcon({ 
                        html: '<div><span>' + childCount + '</span></div>', 
                        className: 'marker-cluster-custom', 
                        iconSize: new L.Point(size, size) 
                    });
                }
            });
            map.addLayer(markersCluster);
            map.on('click', closeCard);
            setTimeout(() => map.invalidateSize(), 500);
        }

        function loadData() {
            let t = new Date().getTime();
            fetch('/api/locations?t=' + t).then(r => r.json()).then(data => {
                allMarkers = data;
                calculateCounts(data);
                renderFilterChips();
                renderMarkers(data);
            });
        }

        function renderMarkers(data) {
            markersCluster.clearLayers();
            var templeIcon = L.icon({
                iconUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1/marker_temple.png', 
                iconSize: [48, 48], iconAnchor: [24, 48], popupAnchor: [0, -45]
            });

            data.forEach(item => {
                if (item.lat && item.lng) {
                    let m = L.marker([item.lat, item.lng], { icon: templeIcon });
                    m.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        showCard(item);
                        map.flyTo([item.lat, item.lng], 16);
                    });
                    markersCluster.addLayer(m);
                }
            });
        }

        function locateUser() {
            $('#btn-gps').css('color', '#d32f2f');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    let lat = pos.coords.latitude, lng = pos.coords.longitude;
                    if (userMarker) map.removeLayer(userMarker);
                    var footprintIcon = L.icon({ iconUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1/marker_footprint.png', iconSize: [40, 40], iconAnchor: [20, 20] });
                    userMarker = L.marker([lat, lng], { icon: footprintIcon }).addTo(map);
                    map.flyTo([lat, lng], 17);
                });
            }
        }

        window.showGuide = function() {
            Swal.fire({
                imageUrl: 'https://res.cloudinary.com/diuoghid2/image/upload/v1768546635/guide_couple.png',
                imageWidth: 140, imageHeight: 'auto', imageAlt: 'å°‹ç¥å°å¹«æ‰‹',
                title: '<span style="color:#d32f2f; font-weight:900;">æ­¡è¿ä¾†åˆ°å°‹ç¥åœ°åœ–</span>',
                html: `
                    <div style="margin:10px 10px;">
                        <div class="guide-row"><div class="guide-icon-box"><i class="fas fa-map-marker-alt" style="color:#d32f2f;"></i></div><div class="guide-text-box"><span style="font-weight:bold; color:#333;">é»æ“Šåœ–é‡˜ï¼š</span>çœ‹ç…§ç‰‡èˆ‡å°èˆª</div></div>
                        <div class="guide-row"><div class="guide-icon-box"><i class="fas fa-crosshairs" style="color:#2e7d32;"></i></div><div class="guide-text-box"><span style="font-weight:bold; color:#333;">ç„æº–æŒ‰éˆ•ï¼š</span>å°‹æ‰¾ä½ çš„ä½ç½®</div></div>
                        <div class="guide-row"><div class="guide-icon-box"><i class="fas fa-camera" style="color:#e64a19;"></i></div><div class="guide-text-box"><span style="font-weight:bold; color:#333;">ä¸­é–“ç›¸æ©Ÿï¼š</span>ä¸Šå‚³ç¥éšŠå‹æƒ…å ±</div></div>
                        <div class="guide-row"><div class="guide-icon-box"><i class="fas fa-cog" style="color:#c62828;"></i></div><div class="guide-text-box"><span style="font-weight:bold; color:#333;">ç´…è‰²é½’è¼ªï¼š</span>åœ°åœ–è³‡æ–™æ›´æ–°</div></div>
                    </div>
                `,
                confirmButtonText: 'æ”¶åˆ°ï¼Œå‡ºç™¼å°‹ç¥ï¼', confirmButtonColor: '#e64a19', background: '#fffbf0', backdrop: `rgba(0,0,0,0.5)`,
                didOpen: () => { const img = Swal.getImage(); if(img) { img.style.filter = "drop-shadow(0 5px 10px rgba(0,0,0,0.1))"; img.style.animation = "float 3s ease-in-out infinite"; } }
            });
            if (!document.getElementById('float-style')) { const style = document.createElement('style'); style.id = 'float-style'; style.innerHTML = `@keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }`; document.head.appendChild(style); }
        }

        // ğŸŒŸ å»Ÿå…¬ç¶­ä¿®é¢¨ï¼šåµéŒ¯é¸å–® ğŸŒŸ
        window.openDebugMenu = function() { 
            Swal.fire({ 
                title: '<i class="fas fa-compass fa-spin"></i> å°‹ç¥ç¾…ç›¤ç¶­ä¿®', 
                html: `
                    <p style="font-size:0.95rem; color:#666; text-align:left; line-height:1.6;">
                        å“å‘€ï¼æ˜¯ä¸æ˜¯è¦ºå¾—ç¥æ˜éƒ½ä¸ç†ä½ ï¼Ÿå¯èƒ½æ˜¯ä½ çš„ã€å°‹ç¥ç¾…ç›¤ã€å¡åˆ°é™°... å•Šä¸æ˜¯ï¼Œæ˜¯è¨Šè™Ÿå¡ä½äº†å•¦ï¼<br>
                        <br>è«‹å˜—è©¦ä»¥ä¸‹æ–¹æ³•æ’é™¤ï¼š
                    </p>
                    <button class="btn-jade" onclick="forceReloadData()">
                        <i class="fas fa-sync-alt"></i> é‡æ–°æ„Ÿæ‡‰æ–¹ä½ (Reload)
                    </button>
                    <button class="btn-cinnabar" onclick="hardReset()">
                        <i class="fas fa-broom"></i> æ·¨åŒ–ç£å ´ (æ¸…é™¤å¿«å–)
                    </button>
                `, 
                showConfirmButton: false, 
                showCloseButton: true 
            }); 
        }

        window.forceReloadData = function() { map.invalidateSize(); loadData(); Swal.fire({icon: 'success', title: 'æ„Ÿæ‡‰å®Œæˆ', text: 'åœ°åœ–ç£å ´å·²æ›´æ–°ï¼', timer: 1500, showConfirmButton: false}); }
        window.hardReset = function() { 
            if ('caches' in window) { caches.keys().then((names) => { names.forEach(name => caches.delete(name)); }); } 
            localStorage.clear();
            window.location.reload(true); 
        }

        // ğŸ”¥ğŸ”¥ğŸ”¥ å®Œæ•´ä¿®å¾©å¾Œçš„å¡ç‰‡é¡¯ç¤ºå‡½å¼ ğŸ”¥ğŸ”¥ğŸ”¥
        function showCard(item) {
            let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
            let v = (item.nickname && item.nickname.includes("#")) ? item.nickname.split("#")[1] : (item.area || "å…¶ä»–");
            
            // Cloudinary åœ–ç‰‡å„ªåŒ–
            let img = item.image_url.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/');
            
            $('#card-village').text(v); 
            $('#card-name').text(name); 
            $('#card-user').text(name);
            
            // ğŸ”¥ ä¿®å¾© Aï¼šæ™‚é–“æ¬„ä½ä¿®æ­£ (ä½¿ç”¨ created_at)
            $('#card-time').text(item.created_at ? item.created_at.substring(0, 16) : 'æ™‚é–“æœªçŸ¥');
            
            // ğŸ”¥ ä¿®å¾© Bï¼šå‚™è¨»å¼·åŠ›æª¢æŸ¥ (æœ‰å­—æ‰é¡¯ç¤º)
            let noteText = (item.note && item.note.trim() !== "") ? item.note : "ç„¡å‚™è¨»";
            $('#card-note').text(noteText); 
            
            $('#card-img').attr('src', img);
            
            // ğŸ”¥ ä¿®å¾© Cï¼šGoogle å°èˆªé€£çµ (ä½¿ç”¨å®˜æ–¹ API æ ¼å¼)
            $('#btn-google-nav').attr('href', `https
