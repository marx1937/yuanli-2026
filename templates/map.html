{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}尋神地圖 - 苑裡鎮{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. 全螢幕地圖設定 */
    body { margin: 0; padding: 0; overflow: hidden; background: #fdfcf0; }
    #map { 
        width: 100%; 
        height: calc(100vh - 60px); /* 扣掉底部導航高度 */
        z-index: 1; 
    }

    /* 2. 頂部懸浮篩選列 (移植自影像庫) */
    .map-filter-container {
        position: absolute; top: 15px; left: 0; right: 0;
        z-index: 1000; padding: 0 10px;
        white-space: nowrap; overflow-x: auto;
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .map-filter-container::-webkit-scrollbar { display: none; }

    .filter-chip {
        display: inline-block; background: rgba(255, 255, 255, 0.95); 
        color: #5d4037; padding: 8px 16px; border-radius: 25px; 
        font-size: 0.9rem; font-weight: bold; margin-right: 8px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 1px solid #fff;
        cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; 
        transform: scale(1.05); box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
    }

    /* 3. 定位按鈕 */
    .btn-locate {
        position: absolute; bottom: 90px; right: 20px; z-index: 900;
        background: white; width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
        color: #555; font-size: 1.2rem; transition: 0.2s;
    }
    .btn-locate:active { background: #eee; transform: scale(0.95); }
    .btn-locate.active { color: #2980b9; }

    /* 4. 自訂 Popup (彈出視窗) 樣式 */
    .leaflet-popup-content-wrapper { border-radius: 15px; padding: 0; overflow: hidden; }
    .leaflet-popup-content { margin: 0; width: 200px !important; }
    
    .popup-cover { width: 100%; height: 120px; object-fit: cover; display: block; background: #eee; }
    .popup-info { padding: 12px; text-align: center; }
    .popup-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 5px; }
    .popup-village { color: #d32f2f; font-size: 0.9rem; background: #ffebee; padding: 2px 8px; border-radius: 10px; display: inline-block; margin-bottom: 8px;}
    .popup-btn {
        display: block; width: 100%; background: #4285f4; color: white; 
        text-align: center; padding: 8px 0; text-decoration: none; 
        border-radius: 50px; font-weight: bold; font-size: 0.9rem;
    }

    /* 5. 聚合圈圈樣式 */
    .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
    .marker-cluster-small div { background-color: rgba(110, 194, 66, 0.6); }
    .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
    .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
    .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
    .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
    .marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif; }
    .marker-cluster span { line-height: 30px; }
</style>
{% endblock %}

{% block content %}
    
    <div class="map-filter-container" id="filter-scroll">
        <div class="filter-chip active" onclick="filterMap('全部', this)">全覽</div>
    </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map;
    var markersCluster; // 聚合層
    var allMarkers = []; // 存原始資料用
    var userMarker = null;

    // 1. 初始化地圖
    function initMap() {
        // 預設中心點：苑裡火車站
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 13);
        
        // 使用 CartoDB 的文青風地圖底圖 (比預設的漂亮)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 初始化聚合層
        markersCluster = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        map.addLayer(markersCluster);

        loadGods();
        renderFilterChips();
    }

    // 2. 載入資料
    function loadGods() {
        fetch('/api/locations')
        .then(r => r.json())
        .then(data => {
            allMarkers = data;
            renderMarkers(data);
        });
    }

    // 3. 自訂圖標 (Q版廟宇)
    var godIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3710/3710266.png', // 這裡可以用你自己的 Q 版土地公圖
        iconSize: [38, 38], // 大小
        iconAnchor: [19, 38], // 定位點
        popupAnchor: [0, -35] // 彈窗位置
    });

    // 4. 繪製標記
    function renderMarkers(data) {
        markersCluster.clearLayers(); // 清空舊的

        data.forEach(item => {
            if (item.lat && item.lng) {
                // 解析里別 (從 area 或 nickname#里別 抓)
                let village = "苑裡鎮";
                if(item.nickname && item.nickname.includes("#")) {
                    village = item.nickname.split("#")[1];
                } else if (item.area) {
                    village = item.area;
                }

                var marker = L.marker([item.lat, item.lng], { icon: godIcon });
                
                // 綁定彈出視窗 (Popup)
                var popupContent = `
                    <div class="popup-box">
                        <img src="${item.image_url}" class="popup-cover" onclick="window.location.href='/gallery'">
                        <div class="popup-info">
                            <div class="popup-village">${village}</div>
                            <div class="popup-title">${item.nickname.split('#')[0]}</div>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                <i class="fas fa-location-arrow"></i> 導航出發
                            </a>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markersCluster.addLayer(marker); // 加入聚合層
            }
        });
    }

    // 5. 渲染篩選按鈕
    const ALL_VILLAGES = [
        "苑東里", "苑南里", "苑北里", "中正里", "客庄里", "房裡里", "新復里", "西勢里", "海岸里", "出水里", 
        "山東里", "苑坑里", "水坡里", "山柑里", "社苓里", "田心里", "玉田里", "泰田里", "上館里", "南勢里", 
        "山腳里", "舊社里", "石鎮里", "蕉埔里", "西平里"
    ];

    function renderFilterChips() {
        let container = document.getElementById('filter-scroll');
        let html = `<div class="filter-chip active" onclick="filterMap('全部', this)">全覽</div>`;
        ALL_VILLAGES.forEach(v => {
            html += `<div class="filter-chip" onclick="filterMap('${v}', this)">${v}</div>`;
        });
        container.innerHTML = html;
    }

    // 6. 篩選邏輯
    window.filterMap = function(village, btn) {
        // 樣式切換
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');

        // 資料過濾
        if (village === '全部') {
            renderMarkers(allMarkers);
            map.flyTo([24.4429, 120.6558], 13); // 回到全覽視角
        } else {
            let filtered = allMarkers.filter(item => {
                let v = item.area;
                if(item.nickname.includes("#")) v = item.nickname.split("#")[1];
                return v === village;
            });
            renderMarkers(filtered);
            
            // 如果有篩選出資料，自動縮放到該區域
            if (filtered.length > 0) {
                let group = new L.featureGroup(markersCluster.getLayers());
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }
    }

    // 7. 定位功能
    function locateUser() {
        if (navigator.geolocation) {
            document.querySelector('.btn-locate').style.color = "#d32f2f"; // 變色提示正在抓
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;

                // 清除舊的定位點
                if (userMarker) map.removeLayer(userMarker);

                // 加上藍色小圓點
                userMarker = L.circleMarker([lat, lng], {
                    radius: 8, fillColor: "#2196f3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
                }).addTo(map);

                map.flyTo([lat, lng], 16); // 飛過去
                document.querySelector('.btn-locate').classList.add('active');
            }, err => {
                alert("無法抓取您的位置，請開啟 GPS");
            });
        }
    }

    // 啟動
    initMap();

</script>
{% endblock %}
