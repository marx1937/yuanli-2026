<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map My God - æœå°‹é›·é”</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        body { 
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 70px;
        }
        .page-header {
            text-align: center; padding: 20px 0;
        }
        .page-title {
            font-family: 'Arial Black', sans-serif; color: #2d3436; text-transform: uppercase; letter-spacing: -1px;
        }
        #map { 
            height: 60vh; width: 95%; margin: 0 auto; 
            border-radius: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border: 4px solid white;
        }
        
        /* èšç„¦ç‡ˆé¸å–®æ¨£å¼ */
        .spotlight-control {
            width: 90%; max-width: 400px; margin: 10px auto;
            background: white; padding: 10px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
        }
        
        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 0; display: flex; justify-content: space-around; z-index: 999; }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 0.8rem; flex: 1; }
        .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

    <div class="page-header">
        <h4 class="page-title">Map <span style="color:#d32f2f;">My God</span></h4>
        <span style="background:white; padding:5px 15px; border-radius:20px; font-size:0.9rem; font-weight:bold; color:#555; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            ğŸ“¡ å…¨åŸŸæœå°‹é›·é”
        </span>
    </div>

    <div class="spotlight-control">
        <label for="district-select" style="margin:0; font-weight:bold; color:#555; font-size:0.9rem;">
            <i class="fas fa-search-location" style="color:#d32f2f;"></i> å¿«é€Ÿèšç„¦ï¼š
        </label>
        <select id="district-select" class="form-control form-control-sm" style="width: 65%; border-radius:20px;">
            <option value="all">å…¨è‹‘è£¡ (é¡¯ç¤ºå…¨éƒ¨)</option>
            <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option>
            <option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option>
            <option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
            <option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option>
            <option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
            <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option>
            <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option>
            <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option>
            <option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option>
            <option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
            <option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option>
            <option value="è‹‘å‘é‡Œ">è‹‘å‘é‡Œ</option>
            <option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
            <option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option>
            <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option>
            <option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
            <option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option>
            <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option>
            <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option>
            <option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
            <option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option>
            <option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option>
            <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option>
            <option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
            <option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
        </select>
    </div>

    <div id="map"></div>
    
    <div class="text-center mt-3">
        <a href="/upload" class="btn btn-danger" style="border-radius:30px; padding:10px 25px; box-shadow:0 4px 10px rgba(214, 48, 49, 0.3);">
            <i class="fas fa-plus"></i> é€™è£¡ä¹Ÿæœ‰ä¸€å°Šï¼
        </a>
    </div>

    <div class="bottom-nav">
        <a href="/" class="nav-item"><i class="fas fa-home"></i>é¦–é </a>
        <a href="/map" class="nav-item active"><i class="fas fa-map-marked-alt"></i>åœ°åœ–</a>
        <a href="/gallery" class="nav-item"><i class="fas fa-images"></i>åœ–åº«</a>
        <a href="/leaderboard" class="nav-item"><i class="fas fa-list-ol"></i>æ¦œå–®</a>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // è‹‘è£¡å„é‡Œçš„ã€Œé è¨­åº§æ¨™ã€ (ä¸­å¿ƒé»)
        // é€™è£¡å…ˆè¨­å®šå¹¾å€‹ç¯„ä¾‹ï¼Œä½ å¯ä»¥ä¹‹å¾Œè£œé½Šç²¾ç¢ºåº§æ¨™ï¼Œæˆ–è€…ä¾é è³‡æ–™è‡ªå‹•è¨ˆç®—
        const districts = {
            "è‹‘æ±é‡Œ": [24.443, 120.655],
            "è‹‘å—é‡Œ": [24.441, 120.652],
            "å±±è…³é‡Œ": [24.415, 120.685],
            // ...å…¶ä»–é‡Œçš„åº§æ¨™å¦‚æœæ²’æœ‰ï¼Œç¨‹å¼æœƒè‡ªå‹•æœå°‹è©²é‡Œçš„åœŸåœ°å…¬ä¾†å®šä½
        };

        var map = L.map('map').setView([24.44, 120.65], 13); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var markers = L.markerClusterGroup({
            // è¨­å®šï¼šç•¶ç¸®æ”¾åˆ°æœ€å¤§æ™‚ï¼Œä¸å†èšåˆï¼Œç›´æ¥é¡¯ç¤ºæ‰€æœ‰é»
            disableClusteringAtZoom: 16
        });

        // å„²å­˜æ‰€æœ‰çš„é»è³‡æ–™ï¼Œæ–¹ä¾¿ç¯©é¸
        var allLocations = [];

        $.getJSON('/api/locations', function(data) {
            allLocations = data; // å­˜èµ·ä¾†
            renderMarkers(allLocations); // åˆå§‹æ¸²æŸ“å…¨éƒ¨
        });

        function renderMarkers(data) {
            markers.clearLayers(); // æ¸…ç©ºåœ°åœ–
            
            if (data.length > 0) {
                var groupBounds = L.latLngBounds(); // ç”¨ä¾†è¨ˆç®—ç¯„åœ

                data.forEach(function(item) {
                    var popupContent = `
                        <div style="text-align:center;">
                            <b style="color:#d32f2f; font-size:1.1rem;">ğŸ‰ ç™¼ç¾ç¥éšŠå‹ï¼</b><br>
                            <span style="color:#666;">ä½ç½®ï¼š${item.description || 'æœªçŸ¥'}</span><br>
                            <img src="${item.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:10px; margin-top:5px; border:2px solid #eee;">
                        </div>
                    `;
                    var marker = L.marker([item.lat, item.lng]).bindPopup(popupContent);
                    markers.addLayer(marker);
                    groupBounds.extend([item.lat, item.lng]);
                });
                map.addLayer(markers);
                
                // è‡ªå‹•ç¸®æ”¾è¦–é‡
                if (!currentDistrictFilter || currentDistrictFilter === 'all') {
                     map.fitBounds(groupBounds);
                }
            }
        }

        // ç›£è½ä¸‹æ‹‰é¸å–®è®ŠåŒ–
        var currentDistrictFilter = 'all';
        
        $('#district-select').change(function() {
            var selectedDistrict = $(this).val();
            currentDistrictFilter = selectedDistrict;

            if (selectedDistrict === 'all') {
                // 1. é¡¯ç¤ºå…¨éƒ¨ï¼šé‡æ–°æ¸²æŸ“æ‰€æœ‰é»ï¼Œä¸¦ç¸®æ”¾è‡³å…¨è¦½
                renderMarkers(allLocations);
                if (allLocations.length > 0) {
                     map.fitBounds(markers.getBounds());
                }
            } else {
                // 2. èšç„¦æ¨¡å¼ï¼š
                // é€™è£¡çš„é‚è¼¯æ˜¯ï¼šé›–ç„¶æˆ‘å€‘é‚„æ˜¯é¡¯ç¤ºæ‰€æœ‰é»(æˆ–åªé¡¯ç¤ºè©²é‡Œ)ï¼Œ
                // ä½†æˆ‘å€‘è¦æŠŠé¡é ­ã€ŒZoom Inã€åˆ°é‚£å€‹é‡Œã€‚
                
                // ç°¡æ˜“ç‰ˆé‚è¼¯ï¼šå¦‚æœæœ‰å®šç¾©åº§æ¨™ï¼Œç›´æ¥é£›éå»ä¸¦æ”¾å¤§
                if (districts[selectedDistrict]) {
                    // é£›åˆ°è©²é‡Œä¸­å¿ƒï¼Œä¸¦æ”¾å¤§åˆ° Level 16 (é€™æ™‚å€™èšåˆåœˆåœˆæœƒç‚¸é–‹)
                    map.flyTo(districts[selectedDistrict], 16);
                } else {
                    // å¦‚æœæ²’æœ‰é è¨­åº§æ¨™ï¼Œæˆ‘å€‘å¯ä»¥è©¦è‘—ç¯©é¸å‡ºè©²é‡Œçš„åœŸåœ°å…¬ä¾†å®šä½
                    // (é€™éœ€è¦ä½ çš„è³‡æ–™åº«è£¡æœ‰ç´€éŒ„ 'é‡Œåˆ¥'ï¼Œç›®å‰å¯èƒ½åªèƒ½ç”¨å‚™è¨»ä¾†ç¯©)
                    // æš«æ™‚æ›¿ä»£æ–¹æ¡ˆï¼šæç¤ºç”¨æˆ¶
                    // alert("æ­£åœ¨å‰å¾€ " + selectedDistrict + "...");
                    // map.setZoom(14); // åªæ˜¯ç¤ºæ„
                }
            }
        });

        // å®šä½ä½¿ç”¨è€…
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                L.circleMarker([lat, lng], {
                    color: '#2980b9', fillColor: '#3498db', fillOpacity: 0.8, radius: 8
                }).addTo(map).bindPopup("ä½ ç›®å‰çš„ä½ç½®");
            });
        }
    </script>
</body>
</html>
