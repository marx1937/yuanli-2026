<script>
/* =========================
   åŸºæœ¬è¨­å®š
========================= */
const DEFAULT_LAT = 24.4418;
const DEFAULT_LNG = 120.6543;
const DEFAULT_ZOOM = 14;

function closeGuide() {
    $('#guideOverlay').fadeOut();
}

/* =========================
   åˆå§‹åŒ–åœ°åœ–ï¼ˆæ‰‹æ©Ÿå„ªåŒ–ï¼‰
========================= */
var map = L.map('map', {
    zoomControl: false,
    preferCanvas: true,
    inertia: true
}).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

/* =========================
   åº•åœ–ï¼ˆOSM ç©©å®šå¿«ï¼‰
========================= */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

/* =========================
   Marker Clusterï¼ˆæ•ˆèƒ½è¨­å®šï¼‰
========================= */
var markers = L.markerClusterGroup({
    chunkedLoading: true,
    chunkInterval: 200,
    chunkDelay: 50,
    removeOutsideVisibleBounds: true
});

map.addLayer(markers);

/* =========================
   Icon
========================= */
var simpleIcon = L.divIcon({
    className: 'custom-div-icon',
    html: "<div class='simple-pin'>ğŸ“</div>",
    iconSize: [30, 30],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
});

/* =========================
   åŠ å…¥ Markerï¼ˆåœ–ç‰‡ lazy loadï¼‰
========================= */
function addMarker(item) {
    var popupContent = `
        <div class="popup-img-box" data-img="${item.image_url}"></div>
        <div class="popup-info">
            <b>${item.nickname || 'ç†±å¿ƒé„‰è¦ª'}</b>
            <p>${item.description || 'ç™¼ç¾ç¥è¹Ÿï¼'}</p>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}"
               target="_blank" class="popup-btn">å°èˆªå»æ‹œæ‹œ</a>
        </div>
    `;

    var marker = L.marker([item.lat, item.lng], { icon: simpleIcon })
        .bindPopup(popupContent);

    marker.on('popupopen', function(e) {
        const box = e.popup._contentNode.querySelector('.popup-img-box');
        if (box && !box.innerHTML) {
            box.innerHTML = `<img src="${box.dataset.img}">`;
        }
    });

    markers.addLayer(marker);
}

/* =========================
   è¼‰å…¥è³‡æ–™ï¼ˆåªè¼‰ç•«é¢å…§ï¼‰
========================= */
function loadLocations() {
    const bounds = map.getBounds();

    $.getJSON('/api/locations', {
        north: bounds.getNorth(),
        south: bounds.getSouth(),
        east: bounds.getEast(),
        west: bounds.getWest()
    }, function(data) {
        markers.clearLayers();
        if (!data || !data.length) return;
        data.forEach(addMarker);
    });
}

/* =========================
   äº’å‹•åŠŸèƒ½
========================= */
function resetMapView() {
    map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
}

function locateUser() {
    if (!navigator.geolocation) {
        alert('ç„¡æ³•å®šä½');
        return;
    }
    navigator.geolocation.getCurrentPosition(function(pos) {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
    });
}

/* =========================
   åˆå§‹åŒ–æµç¨‹ï¼ˆé‡é»ï¼‰
========================= */
$(document).ready(function() {
    $('#guideOverlay').show();

    // â­ åœ°åœ–å…ˆé¡¯ç¤ºï¼Œå†å»¶é²è¼‰é»
    setTimeout(loadLocations, 300);

    // åœ°åœ–ç§»å‹•å¾Œæ‰é‡æ–°æŠ“è³‡æ–™
    map.on('moveend', loadLocations);
});
</script>
