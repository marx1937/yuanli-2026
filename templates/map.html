{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - è‹‘è£¡é®{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. å…¨è¢å¹•åœ°åœ– */
    #map { 
        position: fixed; top: 0; left: 0; bottom: 0; right: 0; 
        width: 100%; height: 100%; z-index: 0; 
        background: #e6e6e6; /* ğŸ”¥ é—œéµä¿®æ­£ï¼šçµ¦åœ°åœ–ä¸€å€‹å¯¦å¿ƒåº•è‰²ï¼Œé¿å…é€å‡ºèƒŒæ™¯é»é» */
    }

    /* 2. é ‚éƒ¨ç¯©é¸åˆ— */
    .map-filter-container {
        position: fixed; top: 15px; left: 0; right: 0; z-index: 1000;
        padding: 10px 15px; white-space: nowrap; overflow-x: auto;
        display: flex; gap: 8px;
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .map-filter-container::-webkit-scrollbar { display: none; }

    .filter-chip {
        display: inline-flex; align-items: center; gap: 5px;
        background: rgba(255, 255, 255, 0.95); color: #555; 
        padding: 8px 16px; border-radius: 50px; 
        font-size: 0.9rem; font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
        border: 1px solid #fff; cursor: pointer; transition: 0.2s;
    }
    .filter-chip span {
        background: #eee; color: #888; font-size: 0.75rem; 
        padding: 2px 6px; border-radius: 10px; min-width: 15px; text-align: center;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; border-color: #d32f2f;
        transform: scale(1.05); box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
    }
    .filter-chip.active span { background: #fff; color: #d32f2f; }

    /* 3. å³å´æ‡¸æµ®å·¥å…·åˆ— */
    .right-toolbar {
        position: fixed; right: 15px; top: 50%; transform: translateY(-50%);
        display: flex; flex-direction: column; gap: 15px; z-index: 900;
    }
    .tool-btn {
        width: 45px; height: 45px; background: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
        color: #555; font-size: 1.2rem; transition: 0.2s;
    }
    .tool-btn:active { transform: scale(0.9); background: #f5f5f5; }
    .tool-btn.active { color: #d32f2f; }

    /* 4. åº•éƒ¨è³‡è¨Šå¡ç‰‡ */
    #info-card {
        position: fixed; bottom: -100%; left: 0; right: 0;
        background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
        padding: 20px; z-index: 1100;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
        transition: bottom 0.3s ease-out;
        padding-bottom: 80px; 
    }
    #info-card.show { bottom: 0; }
    
    .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .card-title { font-size: 1.3rem; font-weight: 800; color: #333; }
    .card-badge { background: #ffebee; color: #d32f2f; padding: 3px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
    .card-close { font-size: 1.5rem; color: #999; cursor: pointer; padding: 5px; }
    
    .card-content { display: flex; gap: 15px; }
    .card-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; background: #eee; }
    .card-details { flex: 1; }
    .detail-row { font-size: 0.9rem; color: #666; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
    
    .btn-nav {
        display: block; width: 100%; margin-top: 15px;
        background: linear-gradient(135deg, #2e7d32, #1b5e20); 
        color: white; text-align: center; padding: 12px; border-radius: 50px;
        text-decoration: none; font-weight: bold; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
    }
</style>
{% endblock %}

{% block content %}
    
    <div class="map-filter-container" id="filter-scroll"></div>

    <div id="map"></div>

    <div class="right-toolbar">
        <div class="tool-btn" onclick="map.zoomIn()"><i class="fas fa-plus"></i></div>
        <div class="tool-btn" onclick="map.zoomOut()"><i class="fas fa-minus"></i></div>
        <div class="tool-btn" onclick="locateUser()" id="btn-gps"><i class="fas fa-crosshairs"></i></div>
        <div class="tool-btn" onclick="openDebugMenu()" style="color:#d32f2f;"><i class="fas fa-cog"></i></div>
    </div>

    <div id="info-card">
        <div class="card-header-row">
            <div>
                <span class="card-badge" id="card-village">é‡Œåˆ¥</span>
                <div class="card-title" id="card-name">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="card-close" onclick="closeCard()"><i class="fas fa-times"></i></div>
        </div>
        
        <div class="card-content">
            <img id="card-img" src="" onclick="window.location.href='/gallery'">
            <div class="card-details">
                <div class="detail-row"><i class="fas fa-user-circle"></i> <span id="card-user"></span></div>
                <div class="detail-row"><i class="fas fa-clock"></i> <span id="card-time"></span></div>
                <div class="detail-row"><i class="fas fa-sticky-note"></i> <span id="card-note"></span></div>
            </div>
        </div>
        
        <a href="#" id="btn-google-nav" target="_blank" class="btn-nav">
            <i class="fas fa-location-arrow"></i> Google å°èˆªå‡ºç™¼
        </a>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    var map;
    var markersCluster;
    var allMarkers = [];
    var villageCounts = {};
    var userMarker = null;

    // ğŸ”¥ ä¿®æ­£å¾Œçš„ 25 é‡Œåå–® (å·²ç§»é™¤å±±æ±é‡Œï¼ŒåŠ å…¥ç¦ç”°é‡Œ)
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "è‹‘æ¸¯é‡Œ", "è¥¿å¹³é‡Œ", 
        "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "æˆ¿è£¡é‡Œ", "å®¢åº„é‡Œ", "ä¸­æ­£é‡Œ", 
        "æ–°å¾©é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "èˆŠç¤¾é‡Œ", 
        "å±±è…³é‡Œ", "ç¦ç”°é‡Œ", "æ³°ç”°é‡Œ", "ç‰ç”°é‡Œ", "å—å‹¢é‡Œ", 
        "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "ä¸Šé¤¨é‡Œ", "æ°´å¡é‡Œ", "è‹‘å‘é‡Œ", "å‡ºæ°´é‡Œ"
    ];

    $(document).ready(function() {
        initMap();
        loadData();
    });

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 14);
        
        // ä½¿ç”¨ CartoDB Voyager åº•åœ– (ä¹¾æ·¨ã€é€Ÿåº¦å¿«ã€é©åˆä¸€èˆ¬åœ°åœ–)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
        }).addTo(map);

        markersCluster = L.markerClusterGroup({ showCoverageOnHover: false });
        map.addLayer(markersCluster);
        
        map.on('click', closeCard);
        
        // ğŸ”¥ é—œéµä¿®å¾©ï¼šç¢ºä¿åœ°åœ–è¼‰å…¥å¾Œé‡æ–°è¨ˆç®—å¤§å°ï¼Œè§£æ±ºç ´åœ–å•é¡Œ
        setTimeout(function() {
            map.invalidateSize();
        }, 500);
    }

    function loadData() {
        let timestamp = new Date().getTime(); 
        fetch('/api/locations?t=' + timestamp)
        .then(r => r.json())
        .then(data => {
            allMarkers = data;
            calculateCounts(data);
            renderFilterChips();
            renderMarkers(data);
        });
    }

    function renderMarkers(data) {
        markersCluster.clearLayers();
        
        var godIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3710/3710266.png', 
            iconSize: [40, 40], iconAnchor: [20, 40],
        });

        data.forEach(item => {
            if (item.lat && item.lng) {
                let marker = L.marker([item.lat, item.lng], { icon: godIcon });
                
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e); 
                    showCard(item);
                    map.flyTo([item.lat, item.lng], 16); 
                });

                markersCluster.addLayer(marker);
            }
        });
    }

    function showCard(item) {
        let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
        let village = getVillageName(item);
        let thumbUrl = item.image_url.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/');
        
        $('#card-village').text(village);
        $('#card-name').text(name);
        $('#card-user').text(name);
        $('#card-time').text(item.timestamp ? item.timestamp.substring(0,10) : 'æœªçŸ¥æ™‚é–“');
        $('#card-note').text(item.note || 'ç„¡å‚™è¨»');
        $('#card-img').attr('src', thumbUrl);
        // ä½¿ç”¨ Google Maps é€šç”¨é€£çµ
        $('#btn-google-nav').attr('href', `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`);
        
        $('#info-card').addClass('show');
    }

    function closeCard() {
        $('#info-card').removeClass('show');
    }

    // åµéŒ¯é¸å–®
    function openDebugMenu() {
        Swal.fire({
            title: 'ğŸ› ï¸ åµéŒ¯æ¨¡å¼',
            html: `
                <p style="font-size:0.9rem; color:#666;">å¦‚æœåœ°åœ–ä¸å®Œæ•´ï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†</p>
                <button class="btn btn-primary btn-block mb-2" onclick="forceReload()">
                    <i class="fas fa-sync"></i> é‡æ–°è¼‰å…¥åœ°åœ–
                </button>
                <button class="btn btn-danger btn-block" onclick="clearCacheAndReload()">
                    <i class="fas fa-trash"></i> æ¸…é™¤å¿«å–ä¸¦é‡æ•´
                </button>
            `,
            showConfirmButton: false,
            showCloseButton: true
        });
    }

    window.forceReload = function() {
        map.invalidateSize(); // å¼·åˆ¶é‡ç¹ªåœ°åœ–
        loadData();
        Swal.fire('å·²é‡ç¹ª', 'åœ°åœ–å°ºå¯¸å·²é‡æ–°è¨ˆç®—', 'success');
    }

    window.clearCacheAndReload = function() {
        if ('caches' in window) {
            caches.keys().then((names) => {
                names.forEach(name => caches.delete(name));
            });
        }
        window.location.reload(true);
    }

    function locateUser() {
        $('#btn-gps').css('color', '#d32f2f');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([lat, lng], { radius: 8, fillColor: "#2196f3", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                map.flyTo([lat, lng], 16);
            });
        }
    }

    function calculateCounts(data) {
        ALL_VILLAGES.forEach(v => villageCounts[v] = 0);
        data.forEach(item => {
            let v = getVillageName(item);
            if (villageCounts[v] !== undefined) villageCounts[v]++;
        });
    }

    function getVillageName(item) {
        if(item.nickname && item.nickname.includes("#")) return item.nickname.split("#")[1];
        if (item.area) return item.area;
        return "å…¶ä»–";
    }

    function renderFilterChips() {
        let container = document.getElementById('filter-scroll');
        let html = `<div class="filter-chip active" onclick="filterMap('å…¨éƒ¨', this)">å…¨è¦½ <span>${allMarkers.length}</span></div>`;
        ALL_VILLAGES.forEach(v => {
            html += `<div class="filter-chip" onclick="filterMap('${v}', this)">${v} <span>${villageCounts[v]||0}</span></div>`;
        });
        container.innerHTML = html;
    }

    window.filterMap = function(village, btn) {
        $('.filter-chip').removeClass('active');
        $(btn).addClass('active');
        closeCard();
        
        let filtered = (village === 'å…¨éƒ¨') ? allMarkers : allMarkers.filter(i => getVillageName(i) === village);
        renderMarkers(filtered);
        
        // ğŸ”¥ é—œéµä¿®æ­£ï¼šç¯©é¸å¾Œä¹Ÿé‡æ–°è¨ˆç®—åœ°åœ–å¤§å°ï¼Œç¢ºä¿ä¸ç ´åœ–
        map.invalidateSize();

        if (filtered.length > 0) {
            let group = L.featureGroup(filtered.map(i => L.marker([i.lat, i.lng])));
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }
</script>
{% endblock %}
