{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - è‹‘è£¡é®{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. å…¨è¢å¹•æ»¿ç‰ˆè¨­å®š */
    #map { 
        position: fixed; top: 0; left: 0; bottom: 0; right: 0; 
        width: 100%; height: 100%; z-index: 0; 
    }

    /* 2. æ‡¸æµ®ç¯©é¸åˆ— (å¸¶è¨ˆæ•¸åŠŸèƒ½) */
    .map-filter-container {
        position: fixed; top: 15px; left: 0; right: 0; z-index: 1000;
        padding: 10px 15px;
        white-space: nowrap; overflow-x: auto;
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
        display: flex; gap: 8px;
        background: linear-gradient(to bottom, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
    }
    .map-filter-container::-webkit-scrollbar { display: none; }

    /* ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
    .filter-chip {
        display: inline-flex; align-items: center; gap: 5px;
        background: rgba(255, 255, 255, 0.95); color: #5d4037; 
        padding: 8px 16px; border-radius: 50px; 
        font-size: 0.9rem; font-weight: bold;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
        border: 1px solid #fff; cursor: pointer; transition: all 0.2s;
    }
    .filter-chip span {
        background: #eee; color: #888; font-size: 0.75rem; 
        padding: 2px 6px; border-radius: 10px; min-width: 15px; text-align: center;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; border-color: #d32f2f;
        transform: scale(1.05); box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
    }
    .filter-chip.active span { background: #fff; color: #d32f2f; }

    /* 3. å®šä½æŒ‰éˆ• */
    .btn-locate {
        position: fixed; bottom: 100px; right: 20px; z-index: 900;
        background: white; width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        color: #444; font-size: 1.3rem; transition: 0.2s;
    }
    .btn-locate:active { transform: scale(0.9); background: #f5f5f5; }

    /* 4. å½ˆå‡ºè¦–çª— (Popup) ç¾åŒ– - ä¾ç…§éœ€æ±‚é¡¯ç¤ºè©³ç´°è³‡è¨Š */
    .leaflet-popup-content-wrapper { border-radius: 15px; overflow: hidden; padding: 0; }
    .leaflet-popup-content { margin: 0; width: 240px !important; }
    
    .popup-cover { width: 100%; height: 140px; object-fit: cover; display: block; background: #eee; cursor: pointer;}
    .popup-info { padding: 15px; text-align: left; font-size: 0.9rem; color: #555; }
    .popup-row { margin-bottom: 6px; display: flex; align-items: flex-start; }
    .popup-icon { color: #d32f2f; width: 20px; margin-right: 5px; text-align: center; margin-top: 2px;}
    .popup-label { font-weight: bold; color: #333; margin-right: 5px; }
    .popup-val { flex: 1; word-break: break-all; }
    
    .popup-btn {
        display: block; width: 100%; margin-top: 10px;
        background: linear-gradient(135deg, #4285f4, #1976d2); 
        color: white; text-align: center; padding: 10px 0; 
        text-decoration: none !important; 
        border-radius: 50px; font-weight: bold; font-size: 0.9rem;
        box-shadow: 0 3px 10px rgba(66, 133, 244, 0.3);
    }

    /* 5. èšåˆåœˆåœˆæ¨£å¼ */
    .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
    .marker-cluster-small div { background-color: rgba(110, 194, 66, 0.6); }
    .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
    .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
    .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
    .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
    .marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif; line-height: 30px; }
</style>
{% endblock %}

{% block content %}
    
    <div class="map-filter-container" id="filter-scroll">
        </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()" title="å›åˆ°æˆ‘çš„ä½ç½®">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map;
    var markersCluster;
    var allMarkers = [];
    var userMarker = null;
    var villageCounts = {}; // ç”¨ä¾†å­˜æ¯å€‹é‡Œçš„æ•¸é‡

    // 25 é‡Œæ¸…å–®
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    function initMap() {
        // é è¨­è¦–è§’ï¼šè‹‘è£¡é®
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 13);
        
        // åº•åœ–ï¼šCartoDB Voyager
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
        }).addTo(map);

        markersCluster = L.markerClusterGroup({ showCoverageOnHover: false });
        map.addLayer(markersCluster);

        loadGods();
    }

    function loadGods() {
        fetch('/api/locations')
        .then(r => r.json())
        .then(data => {
            allMarkers = data;
            calculateCounts(data); // 1. å…ˆç®—æ•¸é‡
            renderFilterChips();   // 2. å†ç•«æŒ‰éˆ•
            filterMap('å…¨éƒ¨', document.getElementById('btn-all')); // 3. é è¨­é¡¯ç¤ºå…¨éƒ¨
        });
    }

    // è¨ˆç®—æ¯å€‹é‡Œæœ‰å¹¾ç­†è³‡æ–™
    function calculateCounts(data) {
        // åˆå§‹åŒ–è¨ˆæ•¸å™¨
        ALL_VILLAGES.forEach(v => villageCounts[v] = 0);
        
        data.forEach(item => {
            let village = getVillageName(item);
            if (villageCounts[village] !== undefined) {
                villageCounts[village]++;
            }
        });
    }

    // è§£æé‡Œåå°å·¥å…·
    function getVillageName(item) {
        if(item.nickname && item.nickname.includes("#")) {
            return item.nickname.split("#")[1];
        } else if (item.area) {
            return item.area;
        }
        return "å…¶ä»–";
    }

    // æ¸²æŸ“ç¯©é¸æŒ‰éˆ• (å¸¶æ•¸å­—)
    function renderFilterChips() {
        let container = document.getElementById('filter-scroll');
        let totalCount = allMarkers.length;
        
        // å…¨éƒ¨æŒ‰éˆ•
        let html = `<div class="filter-chip active" id="btn-all" onclick="filterMap('å…¨éƒ¨', this)">
                        å…¨è¦½ <span>${totalCount}</span>
                    </div>`;
        
        // å„é‡ŒæŒ‰éˆ•
        ALL_VILLAGES.forEach(v => {
            let count = villageCounts[v] || 0;
            // åªæœ‰ç•¶æ•¸é‡ > 0 æ‰é¡¯ç¤ºï¼Œæˆ–è€…ä½ æƒ³å…¨éƒ¨é¡¯ç¤ºä¹Ÿå¯ä»¥
            // é€™è£¡è¨­å®šï¼šå…¨éƒ¨é¡¯ç¤ºï¼Œä½†æ²’è³‡æ–™çš„æœƒé¡¯å¾—å†·æ¸…ï¼Œæ¿€å‹µå¤§å®¶å»æ‹
            html += `<div class="filter-chip" onclick="filterMap('${v}', this)">
                        ${v} <span>${count}</span>
                    </div>`;
        });
        container.innerHTML = html;
    }

    // ç¯©é¸èˆ‡é–å®šå€åŸŸ
    window.filterMap = function(village, btn) {
        // 1. è™•ç†æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');

        // 2. ç¯©é¸è³‡æ–™
        let filteredData = [];
        if (village === 'å…¨éƒ¨') {
            filteredData = allMarkers;
        } else {
            filteredData = allMarkers.filter(item => getVillageName(item) === village);
        }

        // 3. é‡æ–°ç¹ªè£½åœ–é‡˜
        renderMarkers(filteredData);

        // 4. é–å®šå€åŸŸ (Auto Focus)
        if (filteredData.length > 0) {
            if (village === 'å…¨éƒ¨') {
                map.flyTo([24.4429, 120.6558], 13);
            } else {
                // åˆ©ç”¨ Leaflet çš„ getBounds è‡ªå‹•æŠ“å‡ºé€™äº›åœ–é‡˜çš„ç¯„åœ
                // å»ºç«‹ä¸€å€‹è‡¨æ™‚çš„ FeatureGroup ä¾†è¨ˆç®—ç¯„åœ
                let tempGroup = L.featureGroup();
                filteredData.forEach(item => {
                    if (item.lat && item.lng) {
                        tempGroup.addLayer(L.marker([item.lat, item.lng]));
                    }
                });
                // é£›éå»ä¸¦å‰›å¥½åŒ…ä½æ‰€æœ‰é» (padding è®“å‘¨åœç•™é»ç©ºéš™)
                map.fitBounds(tempGroup.getBounds().pad(0.2));
            }
        } else {
            if(village !== 'å…¨éƒ¨') alert(`ğŸ˜… ${village} ç›®å‰é‚„æ²’æœ‰è³‡æ–™ï¼Œå¿«å»ç•¶ç¬¬ä¸€å€‹ï¼`);
        }
    }

    var godIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3710/3710266.png', 
        iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -35],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41]
    });
    var defaultIcon = new L.Icon.Default();

    function renderMarkers(data) {
        markersCluster.clearLayers();

        data.forEach(item => {
            if (item.lat && item.lng) {
                let village = getVillageName(item);
                let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                let note = item.note || "ç„¡è£œå……èªªæ˜";
                
                var marker = L.marker([item.lat, item.lng], { 
                    icon: item.image_url ? godIcon : defaultIcon 
                });
                
                // Cloudinary åœ–ç‰‡å„ªåŒ–
                let thumbUrl = item.image_url || "";
                if(thumbUrl.includes('cloudinary.com')) {
                    thumbUrl = thumbUrl.replace('/upload/', '/upload/w_300,h_20
