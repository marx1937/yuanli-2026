{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}åœ°åœ–æ¸¬è©¦{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
    /* ğŸ”¥ æ ¸å½ˆç´š CSSï¼šå¼·åˆ¶æ¸…é™¤æ‰€æœ‰èƒŒæ™¯åœ–æ¡ˆ */
    html, body, .container, .main-content, div {
        background-image: none !important;
        background-color: #ffffff !important;
    }

    /* ç¢ºä¿åœ°åœ–å®¹å™¨æ²’æœ‰ä»»ä½•é‚Šè·ï¼Œä¸¦å¼·åˆ¶ç½®é ‚ */
    #map-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 999; /* å±¤ç´šè¨­è¶…é«˜ï¼Œå¼·å£“æ‰€æœ‰èƒŒæ™¯ */
        background: #eee; /* çµ¦å€‹ç°è‰²åº•ï¼Œè­‰æ˜ä»–åœ¨é€™ */
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* å®šä½æŒ‰éˆ• */
    .btn-gps {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 50px; height: 50px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: #333;
        z-index: 1000; /* æ¯”åœ°åœ–æ›´é«˜ */
        cursor: pointer;
        border: 2px solid #ccc;
    }
    .btn-gps:active { background: #ddd; }
</style>
{% endblock %}

{% block content %}
    
    <div id="map-container">
        <div id="map"></div>
    </div>

    <div class="btn-gps" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    var map;
    var userMarker = null;

    // åˆå§‹åŒ–åœ°åœ–
    document.addEventListener("DOMContentLoaded", function() {
        // ç¨å¾®å»¶é²ä¸€ä¸‹ï¼Œç¢ºä¿ç•«é¢é•·å¥½å†æ¸²æŸ“åœ°åœ–
        setTimeout(initMap, 100);
    });

    function initMap() {
        console.log("åˆå§‹åŒ–åœ°åœ–...");
        
        // 1. å»ºç«‹åœ°åœ–
        map = L.map('map', { 
            zoomControl: false, // éš±è—é è¨­ç¸®æ”¾éˆ•ï¼Œä¿æŒç•«é¢ä¹¾æ·¨
            attributionControl: false // éš±è—å³ä¸‹è§’ç‰ˆæ¬Šå®£å‘Šï¼Œä¿æŒä¹¾æ·¨
        }).setView([24.4429, 120.6558], 14);
        
        // 2. è¼‰å…¥ OSM åœ–å±¤ (æœ€å¿«ã€æœ€æ¨™æº–)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // 3. é—œéµï¼šé‡æ•´åœ°åœ–å°ºå¯¸ (è§£æ±ºç ´åœ–å•é¡Œ)
        map.invalidateSize();
    }

    // å®šä½åŠŸèƒ½
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;

                // ç§»é™¤èˆŠæ¨™è¨˜
                if (userMarker) map.removeLayer(userMarker);

                // ç•«ä¸Šè—è‰²å°åœ“é»
                userMarker = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: "#2196f3",
                    color: "white",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                // é£›éå»
                map.flyTo([lat, lng], 16);
                
            }, err => {
                alert("ç„¡æ³•æŠ“å–ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ");
            });
        } else {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        }
    }
</script>
{% endblock %}
