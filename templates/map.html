{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - è‹‘è£¡é®{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* 1. æš´åŠ›å…¨è¢å¹•è¨­å®š (æ‰“ç ´åŸæœ¬çš„æ¡†æ¶) */
    #map { 
        position: fixed; /* å¼·åˆ¶å›ºå®šä½ç½® */
        top: 0; left: 0; bottom: 0; right: 0; /* ä¸Šä¸‹å·¦å³å…¨æ»¿ */
        width: 100%; height: 100%; 
        z-index: 0; /* æ”¾åœ¨æœ€åº•å±¤ */
    }

    /* 2. é ‚éƒ¨æ‡¸æµ®ç¯©é¸åˆ— (æµ®åœ¨åœ°åœ–ä¸Š) */
    .map-filter-container {
        position: fixed; /* ä¹Ÿæ˜¯å›ºå®š */
        top: 15px; left: 0; right: 0;
        z-index: 1000; /* æµ®åœ¨æœ€ä¸Šå±¤ */
        padding: 10px 15px;
        white-space: nowrap; overflow-x: auto;
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
        display: flex; gap: 10px; /* æŒ‰éˆ•é–“è· */
        /* èƒŒæ™¯æ¼¸å±¤ï¼Œè®“å­—æ¯”è¼ƒæ¸…æ¥š */
        background: linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%);
    }
    .map-filter-container::-webkit-scrollbar { display: none; }

    /* ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
    .filter-chip {
        display: inline-block; 
        background: rgba(255, 255, 255, 0.95); 
        color: #5d4037; 
        padding: 8px 18px; 
        border-radius: 50px; 
        font-size: 0.95rem; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        border: 1px solid #fff;
        cursor: pointer; transition: all 0.2s;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; 
        transform: scale(1.05); 
        box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4);
        border: none;
    }

    /* 3. å®šä½æŒ‰éˆ• (æµ®åœ¨å³ä¸‹è§’) */
    .btn-locate {
        position: fixed; 
        bottom: 100px; /* é¿é–‹åº•éƒ¨å°èˆªåˆ— */
        right: 20px; 
        z-index: 900;
        background: white; width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        color: #444; font-size: 1.3rem; transition: 0.2s;
    }
    .btn-locate:active { transform: scale(0.9); background: #f5f5f5; }

    /* 4. å½ˆå‡ºè¦–çª—ç¾åŒ– */
    .leaflet-popup-content-wrapper { border-radius: 15px; overflow: hidden; padding: 0; }
    .leaflet-popup-content { margin: 0; width: 220px !important; }
    
    .popup-cover { width: 100%; height: 130px; object-fit: cover; display: block; background: #eee; }
    .popup-info { padding: 15px; text-align: center; }
    .popup-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 5px; }
    .popup-meta { color: #888; font-size: 0.85rem; margin-bottom: 10px; display: block;}
    
    .popup-btn {
        display: block; width: 100%; 
        background: linear-gradient(135deg, #4285f4, #1976d2); 
        color: white; text-align: center; padding: 10px 0; 
        text-decoration: none !important; 
        border-radius: 50px; font-weight: bold; font-size: 0.9rem;
        box-shadow: 0 3px 10px rgba(66, 133, 244, 0.3);
    }

    /* 5. èšåˆåœˆåœˆé¡è‰² */
    .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
    .marker-cluster-small div { background-color: rgba(110, 194, 66, 0.6); }
    .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
    .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
    .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
    .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
    .marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif; line-height: 30px; }
</style>
{% endblock %}

{% block content %}
    
    <div class="map-filter-container" id="filter-scroll">
        </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()" title="å›åˆ°æˆ‘çš„ä½ç½®">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map;
    var markersCluster;
    var allMarkers = [];
    var userMarker = null;

    // å®šç¾© 25 é‡Œæ¸…å–®
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    function initMap() {
        // é è¨­è¦–è§’ï¼šè‹‘è£¡é®ä¸­å¿ƒ
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 13);
        
        // ä½¿ç”¨ CartoDB Voyager åº•åœ– (ä¹¾æ·¨å¥½çœ‹ï¼Œé©åˆæˆ‘å€‘çš„é¢¨æ ¼)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
        }).addTo(map);

        markersCluster = L.markerClusterGroup({ showCoverageOnHover: false });
        map.addLayer(markersCluster);

        loadGods();
        renderFilterChips();
    }

    function loadGods() {
        fetch('/api/locations')
        .then(r => r.json())
        .then(data => {
            allMarkers = data;
            renderMarkers(data);
        });
    }

    // Qç‰ˆåœŸåœ°å…¬ Icon (ä½¿ç”¨é è¨­æˆ–ä½ çš„é‡‘èº«åœ–ç¸®å°ç‰ˆ)
    // é€™è£¡æˆ‘å…ˆç”¨ä¸€å€‹é€šç”¨çš„ Q ç‰ˆåœ–ç¤ºï¼Œå¦‚æœæœ‰å°ˆå±¬ icon å¯ä»¥æ›
    var godIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3710/3710266.png', 
        iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -35],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    // å‚™ç”¨ Icon (å¦‚æœä¸Šé¢é‚£å¼µåœ–æ›äº†)
    var defaultIcon = new L.Icon.Default();

    function renderMarkers(data) {
        markersCluster.clearLayers();

        data.forEach(item => {
            if (item.lat && item.lng) {
                // è™•ç†è³‡æ–™ï¼šå¾ "æš±ç¨±#é‡Œåˆ¥" æ‹†å‡ºé‡Œåˆ¥
                let village = "è‹‘è£¡é®";
                let name = item.nickname || "ç†±å¿ƒä¸²å‹";
                
                if(name.includes("#")) {
                    let parts = name.split("#");
                    name = parts[0];
                    village = parts[1];
                } else if (item.area) {
                    village = item.area;
                }

                // å»ºç«‹æ¨™è¨˜
                var marker = L.marker([item.lat, item.lng], { 
                    icon: godIcon 
                });
                
                // è™•ç†åœ–ç‰‡é€£çµ (Cloudinary å„ªåŒ– - ç¸®å°å°ºå¯¸åŠ å¿«è¼‰å…¥)
                let thumbUrl = item.image_url;
                if(thumbUrl.includes('cloudinary.com')) {
                    thumbUrl = thumbUrl.replace('/upload/', '/upload/w_300,h_200,c_fill,q_auto/');
                }

                // å½ˆå‡ºè¦–çª—å…§å®¹
                var popupContent = `
                    <div style="cursor:pointer;" onclick="window.location.href='/gallery'">
                        <img src="${thumbUrl}" class="popup-cover" onerror="this.src='https://placehold.co/300x200?text=No+Image'">
                        <div class="popup-info">
                            <span class="badge badge-danger" style="background:#ffebee; color:#d32f2f; padding:2px 8px; border-radius:10px; font-size:0.8rem;">${village}</span>
                            <div class="popup-title">${name}</div>
                            <div class="popup-meta">${item.created_at ? item.created_at.substring(0,10) : ''}</div>
                            
                            <a href="http://googleusercontent.com/maps.google.com/maps?daddr=${item.lat},${item.lng}" target="_blank" class="popup-btn">
                                <i class="fas fa-location-arrow"></i> å°èˆªå‡ºç™¼
                            </a>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markersCluster.addLayer(marker);
            }
        });
    }

    function renderFilterChips() {
        let container = document.getElementById('filter-scroll');
        let html = `<div class="filter-chip active" onclick="filterMap('å…¨éƒ¨', this)">å…¨è¦½</div>`;
        ALL_VILLAGES.forEach(v => {
            html += `<div class="filter-chip" onclick="filterMap('${v}', this)">${v}</div>`;
        });
        container.innerHTML = html;
    }

    window.filterMap = function(village, btn) {
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');

        if (village === 'å…¨éƒ¨') {
            renderMarkers(allMarkers);
            map.flyTo([24.4429, 120.6558], 13);
        } else {
            let filtered = allMarkers.filter(item => {
                let v = item.area || "";
                if(item.nickname && item.nickname.includes("#")) v = item.nickname.split("#")[1];
                return v === village;
            });
            renderMarkers(filtered);
            
            if (filtered.length > 0) {
                // è‡ªå‹•ç¸®æ”¾åˆ°è©²å€åŸŸçš„åœŸåœ°å…¬å€‘
                let group = new L.featureGroup(filtered.map(i => L.marker([i.lat, i.lng])));
                map.fitBounds(group.getBounds().pad(0.2));
            } else {
                // alert(`ğŸ˜… ${village} ç›®å‰é‚„æ²’æœ‰äººå›å ±å–”ï¼`); // æ€•å¤ªåµå…ˆé—œæ‰
            }
        }
    }

    function locateUser() {
        if (navigator.geolocation) {
            document.querySelector('.btn-locate').style.color = "#d32f2f";
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;

                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([lat, lng], {
                    radius: 8, fillColor: "#2196f3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
                }).addTo(map);

                map.flyTo([lat, lng], 16);
            }, err => {
                alert("ç„¡æ³•æŠ“å–æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ");
            });
        } else {
            alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
        }
    }

    initMap();

</script>
{% endblock %}
