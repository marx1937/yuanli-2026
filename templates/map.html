{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ–{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        /* --- é é¢ä½ˆå±€ --- */
        /* è¨­å®šåœ°åœ–åº•è‰²ï¼Œé¿å…è¼‰å…¥ç¬é–“çœ‹åˆ°é»‘åº• */
        #map { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh; 
            z-index: 1; 
            background-color: #fffbf0; /* Google Map çš„é è¨­æš–åº•è‰² */
        }
        
        /* --- 1. é ‚éƒ¨æ¨™é¡Œåˆ— (æ‡¸æµ®è† å›Š) --- */
        .map-header {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 900; width: 90%; max-width: 400px; text-align: center;
        }
        
        .header-capsule {
            background: rgba(255, 255, 255, 0.95); 
            padding: 10px 25px; 
            border-radius: 50px;
            font-weight: bold; color: #5d4037; 
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.15); 
            display: inline-flex; align-items: center; 
            border: 1px solid rgba(141, 110, 99, 0.2);
            cursor: pointer; transition: transform 0.2s, background 0.2s;
            backdrop-filter: blur(5px);
        }
        .header-capsule:active { transform: scale(0.95); background: #fff8e1; }

        /* --- 2. åœ°åœ–æ¨™è¨˜æ¨£å¼ --- */
        .custom-div-icon { background: transparent; border: none; }
        .simple-pin {
            font-size: 36px;
            line-height: 36px; text-align: center;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
            cursor: pointer; transition: transform 0.2s;
        }
        .simple-pin:active { transform: scale(1.2); }

        /* --- 3. å½ˆçª—ç¾å­¸ (åœ“è§’ + ç´…è‰²æŒ‰éˆ•) --- */
        .leaflet-popup-content-wrapper { 
            border-radius: 20px; 
            overflow: hidden; padding: 0; 
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.2);
        }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        
        .popup-img-box { 
            width: 100%; height: 160px; overflow: hidden; position: relative; 
            background: #f9f7f2; 
        }
        .popup-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .popup-info { padding: 15px 20px; text-align: left; background: #fff; }
        .popup-title { font-weight: bold; font-size: 1.15rem; color: #5d4037; margin-bottom: 5px; }
        .popup-desc { font-size: 0.9rem; color: #8d6e63; margin-bottom: 15px; line-height: 1.4; }
        
        .popup-btn {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); 
            color: white !important; 
            border-radius: 50px; padding: 10px 0; font-size: 0.95rem; font-weight: bold;
            text-decoration: none !important; display: block; text-align: center;
            box-shadow: 0 4px 10px rgba(183, 28, 28, 0.3);
            transition: opacity 0.2s;
        }
        .popup-btn:active { opacity: 0.9; transform: scale(0.98); }

        /* --- 4. å®šä½æŒ‰éˆ• --- */
        .btn-locate {
            position: absolute; bottom: 110px; right: 20px; z-index: 900;
            width: 55px; height: 55px; border-radius: 50%;
            background: white; color: #5d4037; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(141, 110, 99, 0.1);
            box-shadow: 0 5px 15px rgba(93, 64, 55, 0.2); 
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-locate:active { transform: scale(0.9); background: #fff8e1; }

        /* --- 5. å°å¹«æ‰‹å°è¦½é®ç½© (ä½ç½®ä¿®æ­£ç‰ˆ) --- */
        #guideOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 64, 55, 0.6); 
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .guide-card {
            background: #fff; 
            width: 85%; max-width: 320px;
            border-radius: 25px; 
            padding: 30px 25px 25px 25px; /* ä¸‹æ–¹ç•™å¤šä¸€é»é»ç©ºé–“ */
            text-align: center; position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center;
            border: 4px solid #fff8e1;
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .guide-mascot {
            /* ğŸ”¥ é—œéµä¿®æ­£ï¼šè®“é›™äººçµ„ç½®ä¸­ï¼Œä¸”ä¸Šä¸‹éƒ½æœ‰ç©ºé–“ */
            display: block;
            margin: 10px auto 15px auto; /* ä¸Š 10px, ä¸‹ 15px, å·¦å³è‡ªå‹•ç½®ä¸­ */
            width: 140px; 
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
            z-index: 10;
        }

        .guide-title { font-weight: bold; color: #d32f2f; font-size: 1.4rem; margin-bottom: 20px; letter-spacing: 1px; }
        .guide-list { text-align: left; margin-bottom: 10px; font-size: 0.95rem; color: #5d4037; width: 100%; padding-left: 10px; }
        .guide-list li { margin-bottom: 12px; list-style: none; display: flex; align-items: center; }
        
        .guide-list i { 
            color: #d32f2f; 
            width: 30px; text-align: center; margin-right: 10px; font-size: 1.2rem; 
            background: #fff8e1; border-radius: 50%; padding: 5px; height: 30px; width: 30px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .btn-guide-ok {
            background: linear-gradient(135deg, #f0932b 0%, #e67e22 100%); 
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; width: 100%;
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.3);
            position: relative; z-index: 1; 
        }
        .btn-guide-ok:active { transform: scale(0.95); }

    </style>
{% endblock %}

{% block content %}
    <div id="guideOverlay">
        <div class="guide-card">
            <h3 class="guide-title">æ­¡è¿ä¾†åˆ°å°‹ç¥åœ°åœ–</h3>
            <ul class="guide-list">
                <li><i class="fas fa-map-pin"></i> <div><b>é»æ“Šåœ–é‡˜</b>ï¼šæŸ¥çœ‹ç…§ç‰‡èˆ‡å°èˆª</div></li>
                <li><i class="fas fa-undo-alt"></i> <div><b>é»æ“Šæ¨™é¡Œ</b>ï¼šåœ°åœ–ä¸€éµæ­¸ä½</div></li>
                <li><i class="fas fa-crosshairs"></i> <div><b>ç„æº–æŒ‰éˆ•</b>ï¼šå°‹æ‰¾ä½ çš„ä½ç½®</div></li>
                <li><i class="fas fa-camera"></i> <div><b>ä¸­é–“ç›¸æ©Ÿ</b>ï¼šå»ä¸Šå‚³æ–°æƒ…å ±</div></li>
            </ul>
            <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/guide_couple.png" class="guide-mascot" alt="å°‹ç¥å°å¹«æ‰‹">
            <button class="btn btn-guide-ok" onclick="closeGuide()">æ”¶åˆ°ï¼Œå‡ºç™¼å°‹ç¥ï¼</button>
        </div>
    </div>

    <div class="map-header" onclick="resetMapView()">
        <div class="header-capsule">
            <i class="fas fa-map-marked-alt" style="color:#d32f2f; margin-right:8px;"></i> å°‹ç¥é›·é”åœ°åœ–
            <i class="fas fa-undo-alt" style="font-size: 0.8rem; color: #a1887f; margin-left: 8px;"></i>
        </div>
    </div>

    <div id="map"></div>

    <div class="btn-locate" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        function closeGuide() {
            $('#guideOverlay').fadeOut();
        }

        const DEFAULT_LAT = 24.4418;
        const DEFAULT_LNG = 120.6543;
        const DEFAULT_ZOOM = 13;

        var map = L.map('map', { zoomControl: false }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

        // ğŸ”¥ çµ‚æ¥µå¤§çµ•æ‹›ï¼šæ”¹ç”¨ Google Maps åœ–å±¤ (å°ç£æœ€ç©©)
        // ä½¿ç”¨ Google å®˜æ–¹ Tile Server (mt1)
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: 'Â© Google',
            maxZoom: 20
        }).addTo(map);

        var markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            spiderfyDistanceMultiplier: 1.5,
            maxClusterRadius: 60
        });

        var simpleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='simple-pin'>ğŸ“</div>",
            iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
        });

        // æŠ“å–è³‡æ–™
        $.getJSON('/api/locations', function(data) {
            if(data && data.length > 0) {
                data.forEach(function(item) {
                    var lat = item.lat; var lng = item.lng;
                    var img = item.image_url;
                    var nickname = item.nickname || 'ç†±å¿ƒé„‰è¦ª';
                    var desc = item.description || 'ç™¼ç¾ç¥éšŠå‹ï¼';
                    
                    if(!desc || desc === "") desc = "åœ¨è‹‘è£¡ç™¼ç¾çš„ç¥è¹Ÿï¼";

                    var popupContent = `
                        <div class="popup-img-box"><img src="${img}" loading="lazy"></div>
                        <div class="popup-info">
                            <div class="popup-title">ğŸ‘¤ ${nickname}</div>
                            <div class="popup-desc">${desc}</div>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn">
                                <i class="fas fa-location-arrow"></i> å°èˆªå»æ‹œæ‹œ
                            </a>
                        </div>
                    `;
                    var marker = L.marker([lat, lng], { icon: simpleIcon }).bindPopup(popupContent);
                    markers.addLayer(marker);
                });
                map.addLayer(markers);
            }
        });

        function resetMapView() {
            map.flyTo([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);
            map.closePopup();
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    map.flyTo([lat, lng], 16);
                    L.circleMarker([lat, lng], {
                        radius: 8, fillColor: "#0984e3", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
                    }).addTo(map).bindPopup("ğŸ“ ä½ åœ¨é€™è£¡").openPopup();
                }, function() { alert("ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªå·²æˆæ¬Šã€‚"); });
            } else {
                alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½å–”ï¼");
            }
        }

        $(document).ready(function() {
            $('#guideOverlay').css('display', 'flex');
        });
    </script>
{% endblock %}
