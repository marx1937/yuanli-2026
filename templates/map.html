{% extends "base.html" %}
{% set active_page = "map" %}

{% block title %}å°‹ç¥åœ°åœ– - è¶Šç„ç‰ˆ{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
    /* 1. æŠŠæ‰€æœ‰å¯èƒ½æ“‹ä½åœ°åœ–çš„èƒŒæ™¯éƒ½è®Šé€æ˜ */
    html, body, .container, .main-content, .wrapper {
        background: transparent !important;
        background-color: rgba(255,255,255,0) !important;
    }

    /* 2. åœ°åœ–æœ¬é«”ï¼šå…¨è¢å¹•ã€å›ºå®šåœ¨æœ€åº•å±¤ */
    #map { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100vw; 
        height: 100vh; 
        z-index: -1; /* è¨­ç‚º -1ï¼Œè®“å®ƒä¹–ä¹–ç•¶æ¡Œå¸ƒï¼Œä¸è¦æ“‹åˆ°æŒ‰éˆ• */
        display: block;
    }

    /* 3. å®šä½æŒ‰éˆ•ï¼šæµ®åœ¨å³ä¸‹è§’ */
    .btn-gps {
        position: fixed;
        bottom: 120px; /* é¿é–‹åº•éƒ¨å°èˆªåˆ— */
        right: 20px;
        width: 50px; height: 50px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: #d32f2f;
        z-index: 1000; /* ç¢ºä¿æŒ‰éˆ•æŒ‰å¾—åˆ° */
        cursor: pointer;
        border: 2px solid #fff;
    }
    .btn-gps:active { transform: scale(0.9); }
    
    /* ç‚ºäº†ç¢ºä¿åº•éƒ¨å°èˆªåˆ—çœ‹å¾—è¦‹ï¼Œçµ¦å®ƒä¸€é»èƒŒæ™¯è‰² (å¦‚æœåŸæœ¬æ²’æœ‰çš„è©±) */
    nav, .bottom-nav {
        background: rgba(255,255,255,0.9) !important;
        backdrop-filter: blur(5px);
    }
</style>
{% endblock %}

{% block content %}
    
    <div id="map"></div>

    <div class="btn-gps" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    var map;
    var userMarker = null;

    // ğŸ”¥ è¶Šç„è¡Œå‹•é–‹å§‹
    document.addEventListener("DOMContentLoaded", function() {
        // 1. æ‰¾åˆ°åœ°åœ–å…ƒç´ 
        var mapElement = document.getElementById('map');
        
        // 2. æŠŠå®ƒå¾ç¾åœ¨çš„ä½ç½®ã€Œæ‹”å‡ºä¾†ã€ï¼Œç›´æ¥æ’å…¥åˆ° body çš„æœ€å‰é¢
        // é€™æ¨£å®ƒå°±æœƒè„«é›¢æ‰€æœ‰çš„ paddingã€margin é™åˆ¶
        document.body.prepend(mapElement);

        // 3. å•Ÿå‹•åœ°åœ–
        initMap();
    });

    function initMap() {
        // å»ºç«‹åœ°åœ–
        map = L.map('map', { zoomControl: false }).setView([24.4429, 120.6558], 14);
        
        // è¼‰å…¥ OSM åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // ğŸ”¥ é—œéµï¼šå‘Šè¨´åœ°åœ–ã€Œä½ çš„å¤§å°æ”¹è®Šäº†ã€ï¼Œè«‹é‡æ–°ç¹ªè£½
        // å»¶é² 500ms ç¢ºä¿æ¬å®¶å®Œæˆå¾Œå†ç•«
        setTimeout(function() {
            map.invalidateSize();
        }, 500);
    }

    // å®šä½åŠŸèƒ½
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                
                userMarker = L.circleMarker([lat, lng], {
                    radius: 10, fillColor: "#2196f3", color: "white", weight: 3, fillOpacity: 0.9
                }).addTo(map);

                map.flyTo([lat, lng], 16);
            }, err => { alert("å®šä½å¤±æ•—"); });
        }
    }
</script>
{% endblock %}
