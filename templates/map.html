<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Map My God - æœå°‹é›·é”</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        body { 
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: "Microsoft JhengHei", sans-serif;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        
        #map { 
            height: 72vh; 
            width: 95%; margin: 0 auto; 
            border-radius: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border: 4px solid white;
            z-index: 1;
        }
        
        /* ğŸ”¦ èšç„¦ç‡ˆæ§åˆ¶å€ */
        .spotlight-control {
            position: relative;
            width: 90%; max-width: 450px; 
            margin: 80px auto 20px auto; 
            background: white; padding: 10px 15px; border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 20;
        }
        
        /* ğŸ§ å°å¹«æ‰‹å…¬ä»” */
        .helper-mascot {
            position: absolute;
            top: -65px;  
            right: 5px;  
            height: 85px; width: auto; 
            cursor: pointer;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2));
            transition: transform 0.2s;
            animation: float-mascot 3s ease-in-out infinite;
            z-index: 22;
        }
        .helper-mascot:active { transform: scale(0.9) rotate(-5deg); }

        @keyframes float-mascot {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        /* ğŸ’¬ å°å¹«æ‰‹æ°£æ³¡æ¡† */
        .helper-bubble {
            position: absolute;
            top: -70px;   
            right: 75px;  
            background: #2d3436;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 21;
            pointer-events: none;
            opacity: 0.95;
            animation: bounce-bubble 2s infinite;
        }
        @keyframes bounce-bubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* ğŸ”´ æ‡¸æµ®æ–‡å­—æŒ‰éˆ• */
        .btn-floating-text {
            position: fixed; bottom: 95px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: #d63031; border: 2px solid #ff7675; 
            border-radius: 30px; padding: 8px 25px;
            font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 900; display: flex; align-items: center; justify-content: center;
            white-space: nowrap; animation: pulse-text 2s infinite;
        }
        @keyframes pulse-text {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; 
            background: white; border-top: 1px solid #eee; 
            padding: 0 10px; height: 70px;
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 999; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .nav-item { text-align: center; color: #b2bec3; text-decoration: none; font-size: 0.7rem; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: #d32f2f; font-weight: bold; }
        
        .nav-center-btn {
            width: 65px; height: 65px;
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            border-radius: 50%; border: 5px solid #f8f9fa; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 -5px 15px rgba(214, 48, 49, 0.3);
            transform: translateY(-25px); position: relative; z-index: 1000;
        }
        .nav-center-btn:hover { color: white; transform: translateY(-30px); }
    </style>
</head>
<body>

    <div class="spotlight-control">
        <div style="flex-grow: 1; display:flex; align-items:center;">
            <i class="fas fa-compass" style="color:#d32f2f; margin-right:8px; font-size:1.4rem;"></i>
            
            <select id="district-select" class="form-control form-control-sm" style="border-radius:20px; border:1px solid #eee; background:#f9f9f9; height: 35px;">
                <option value="all">é¡¯ç¤ºå…¨è‹‘è£¡ (é è¨­)</option>
                <option value="è‹‘æ±é‡Œ">è‹‘æ±é‡Œ</option>
                <option value="è‹‘å—é‡Œ">è‹‘å—é‡Œ</option>
                <option value="è‹‘åŒ—é‡Œ">è‹‘åŒ—é‡Œ</option>
                <option value="è¥¿å¹³é‡Œ">è¥¿å¹³é‡Œ</option>
                <option value="æµ·å²¸é‡Œ">æµ·å²¸é‡Œ</option>
                <option value="è‹‘æ¸¯é‡Œ">è‹‘æ¸¯é‡Œ</option>
                <option value="è¥¿å‹¢é‡Œ">è¥¿å‹¢é‡Œ</option>
                <option value="æˆ¿è£¡é‡Œ">æˆ¿è£¡é‡Œ</option>
                <option value="æ–°å¾©é‡Œ">æ–°å¾©é‡Œ</option>
                <option value="å®¢åº„é‡Œ">å®¢åº„é‡Œ</option>
                <option value="ä¸­æ­£é‡Œ">ä¸­æ­£é‡Œ</option>
                <option value="è‹‘å‘é‡Œ">è‹‘å‘é‡Œ</option>
                <option value="æ°´å¡é‡Œ">æ°´å¡é‡Œ</option>
                <option value="å±±è…³é‡Œ">å±±è…³é‡Œ</option>
                <option value="èˆŠç¤¾é‡Œ">èˆŠç¤¾é‡Œ</option>
                <option value="ç¦ç”°é‡Œ">ç¦ç”°é‡Œ</option>
                <option value="çŸ³é®é‡Œ">çŸ³é®é‡Œ</option>
                <option value="å—å‹¢é‡Œ">å—å‹¢é‡Œ</option>
                <option value="æ³°ç”°é‡Œ">æ³°ç”°é‡Œ</option>
                <option value="ä¸Šé¤¨é‡Œ">ä¸Šé¤¨é‡Œ</option>
                <option value="ç‰ç”°é‡Œ">ç‰ç”°é‡Œ</option>
                <option value="ç¤¾è‹“é‡Œ">ç¤¾è‹“é‡Œ</option>
                <option value="å±±æŸ‘é‡Œ">å±±æŸ‘é‡Œ</option>
                <option value="è•‰åŸ”é‡Œ">è•‰åŸ”é‡Œ</option>
                <option value="ç”°å¿ƒé‡Œ">ç”°å¿ƒé‡Œ</option>
            </select>
        </div>
        
        <div class="helper-bubble">æˆ‘æ˜¯å°å¹«æ‰‹ ğŸ‘‹</div>
        <img src="/static/maps.png" class="helper-mascot" alt="å°å¹«æ‰‹" data-toggle="modal" data-target="#mapHelperModal">
    </div>

    <div id="map"></div>
    
    <a href="/upload" class="btn-floating-text">
        <i class="fas fa-camera-retro" style="margin-right:5px; font-size:1.1rem;"></i> ç™¼ç¾ç¥éšŠå‹ï¼Ÿå¿«å¹«ç¥‚æ‹ç…§ï¼
    </a>

    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: transparent; border: none;">
                <div class="modal-body text-center" style="position: relative;">
                    <button type="button" class="close" data-dismiss="modal" style="position: absolute; right: 0; top: -30px; color: white; opacity: 1; font-size: 2rem;">Ã—</button>
                    <h5 id="modalHunterName" style="color: white; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.5);"></h5>
                    <img id="modalImage" src="" style="width: 100%; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); margin-bottom: 20px;">
                    <a id="navBtn" href="#" target="_blank" class="btn btn-primary btn-block" style="border-radius: 30px; font-weight: bold; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <i class="fas fa-location-arrow"></i> Google Maps å¸¶æˆ‘å»
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mapHelperModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px;">
                <div class="modal-header" style="border-bottom:none;">
                    <h5 class="modal-title" style="font-weight:bold; color:#2d3436;">ğŸ—ºï¸ åœ°åœ–æ€éº¼çœ‹ï¼Ÿ</h5>
                    <button type="button" class="close" data-dismiss="modal">Ã—</button>
                </div>
                <div class="modal-body" style="padding:0 20px 20px 20px;">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center">
                            <div style="width:30px; height:30px; background-color:#6ecc39; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; margin-right:15px; font-weight:bold;">10</div>
                            <span><b>å½©è‰²åœ“åœˆ (èšåˆ)</b><br><small class="text-muted">é€™å€æœ‰ 10 å°Šï¼Œé»æ“Šçœ‹ç´°ç¯€ï¼</small></span>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="fas fa-map-marker-alt" style="color:#2980b9; font-size:1.5rem; margin-right:18px; margin-left:5px;"></i>
                            <span><b>è—è‰²åœ–é‡˜</b><br><small class="text-muted">é€™è£¡æœ‰ä¸€å°ŠåœŸåœ°å…¬ï¼</small></span>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer" style="border-top:none;">
                    <button type="button" class="btn btn-primary btn-block" data-dismiss="modal" style="border-radius:30px;">æ‡‚äº†ï¼Œé–‹å§‹å°‹å¯¶ï¼</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/" class="nav-item">
            <i class="fas fa-archway"></i> <span>é¦–é </span> </a>
        <a href="/map" class="nav-item active">
            <i class="fas fa-map-signs"></i> <span>åœ°åœ–</span> </a>
        
        <a href="/upload" class="nav-center-btn">
            <i class="fas fa-camera-retro"></i> </a>

        <a href="/gallery" class="nav-item">
            <i class="fas fa-images"></i> <span>åœ–åº«</span>
        </a>
        <a href="/leaderboard" class="nav-item">
            <i class="fas fa-scroll"></i> <span>æ¦œå–®</span> </a>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const districts = {
            "è‹‘æ±é‡Œ": [24.443, 120.655], "è‹‘å—é‡Œ": [24.441, 120.652], "è‹‘åŒ—é‡Œ": [24.445, 120.653],
            "è¥¿å¹³é‡Œ": [24.442, 120.648], "æµ·å²¸é‡Œ": [24.450, 120.635], "è‹‘æ¸¯é‡Œ": [24.455, 120.640],
            "è¥¿å‹¢é‡Œ": [24.438, 120.645], "æˆ¿è£¡é‡Œ": [24.430, 120.640], "æ–°å¾©é‡Œ": [24.425, 120.635],
            "å®¢åº„é‡Œ": [24.435, 120.655], "ä¸­æ­£é‡Œ": [24.438, 120.660], "è‹‘å‘é‡Œ": [24.450, 120.665],
            "æ°´å¡é‡Œ": [24.455, 120.670], "å±±è…³é‡Œ": [24.415, 120.685], "èˆŠç¤¾é‡Œ": [24.410, 120.690],
            "ç¦ç”°é‡Œ": [24.405, 120.680], "çŸ³é®é‡Œ": [24.395, 120.700], "å—å‹¢é‡Œ": [24.390, 120.690],
            "æ³°ç”°é‡Œ": [24.420, 120.670], "ä¸Šé¤¨é‡Œ": [24.425, 120.675], "ç‰ç”°é‡Œ": [24.430, 120.670],
            "ç¤¾è‹“é‡Œ": [24.435, 120.680], "å±±æŸ‘é‡Œ": [24.440, 120.685], "è•‰åŸ”é‡Œ": [24.400, 120.720],
            "ç”°å¿ƒé‡Œ": [24.415, 120.665]
        };

        var map = L.map('map').setView([24.44, 120.65], 13); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        var markers = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
        var allLocations = [];

        $.getJSON('/api/locations', function(data) {
            allLocations = data;
            renderMarkers(allLocations);
        });

        window.showLargeImage = function(imgUrl, hunterName, lat, lng) {
            $('#modalImage').attr('src', imgUrl);
            var displayName = hunterName ? ('ğŸ† ç†±å¿ƒä¸²å‹ï¼š' + hunterName) : 'ğŸ† ç†±å¿ƒä¸²å‹';
            $('#modalHunterName').text(displayName);
            $('#navBtn').attr('href', `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
            $('#imageModal').modal('show');
        };

        function renderMarkers(data) {
            markers.clearLayers();
            if (data.length > 0) {
                var groupBounds = L.latLngBounds();
                data.forEach(function(item) {
                    var rawName = item.nickname;
                    var displayHtml = '';
                    if (rawName && rawName.trim() !== '') {
                        displayHtml = `<span style="color:#d35400; font-weight:bold; font-size:1rem;">ğŸ† ç†±å¿ƒä¸²å‹ï¼š${rawName}</span><br>`;
                    } else {
                        displayHtml = `<span style="color:#d35400; font-weight:bold; font-size:1rem;">ğŸ† ç†±å¿ƒä¸²å‹</span><br>`;
                    }

                    var locText = item.description;
                    if(!locText || locText === 'æœªçŸ¥') {
                        locText = `åº§æ¨™: ${item.lat.toFixed(4)}, ${item.lng.toFixed(4)}`;
                    }

                    var popupContent = `
                        <div style="text-align:center;">
                            <b style="color:#d32f2f; font-size:1.1rem;">ğŸ‰ ç™¼ç¾ç¥éšŠå‹ï¼</b><br>
                            ${displayHtml}
                            <span style="color:#666; font-size:0.9rem;">ğŸ“ ä½ç½®ï¼š${locText}</span><br>
                            <img src="${item.image_url}" onclick="showLargeImage('${item.image_url}', '${rawName || ''}', ${item.lat}, ${item.lng})"
                                 style="width:120px; height:120px; object-fit:cover; border-radius:10px; margin-top:8px; border:2px solid #eee; cursor:pointer;" title="é»æ“Šæ”¾å¤§">
                            <br>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}" target="_blank" style="display:inline-block; margin-top:5px; font-size:0.8rem; color:#2980b9;">
                                <i class="fas fa-location-arrow"></i> å°èˆªå»
                            </a>
                        </div>
                    `;
                    var marker = L.marker([item.lat, item.lng]).bindPopup(popupContent);
                    markers.addLayer(marker);
                    groupBounds.extend([item.lat, item.lng]);
                });
                map.addLayer(markers);
                if (!currentDistrictFilter || currentDistrictFilter === 'all') { map.fitBounds(groupBounds); }
            }
        }
        
        var currentDistrictFilter = 'all';
        $('#district-select').change(function() {
            var selectedDistrict = $(this).val();
            currentDistrictFilter = selectedDistrict;
            if (selectedDistrict === 'all') { renderMarkers(allLocations); if (allLocations.length > 0) map.fitBounds(markers.getBounds()); } 
            else { if (districts[selectedDistrict]) map.flyTo(districts[selectedDistrict], 16); }
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude; lng = position.coords.longitude;
                L.circleMarker([lat, lng], { color: '#2980b9', fillColor: '#3498db', fillOpacity: 0.8, radius: 8 }).addTo(map).bindPopup("ä½ ç›®å‰çš„ä½ç½®");
            });
        }
    </script>
</body>
</html>
