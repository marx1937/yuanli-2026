{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block title %}å°‹ç¥è¶³è·¡ - å½±åƒç´€éŒ„{% endblock %}

{% block styles %}
<style>
    /* 1. åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. çœ‹æ¿å€ */
    .gallery-header {
        text-align: center; padding: 20px 0 10px 0;
        position: relative; margin-bottom: 5px;
    }
    
    .gallery-banner-img {
        width: 92%; max-width: 380px; height: auto;
        min-height: 120px;
        filter: drop-shadow(0 10px 15px rgba(93, 64, 55, 0.2));
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* ğŸ”¥ æ–°å¢ï¼šæ©«å‘æ²å‹•å¿«ç¯©åˆ— (Chips) */
    .filter-scroll-container {
        width: 100%; overflow-x: auto; white-space: nowrap;
        padding: 5px 15px 15px 15px; /* ä¸‹æ–¹ç•™é»ç©ºé–“çµ¦é™°å½± */
        -webkit-overflow-scrolling: touch; /* è®“ iOS æ»‘å‹•é †æš¢ */
        scrollbar-width: none; /* éš±è—æ²è»¸ (Firefox) */
    }
    .filter-scroll-container::-webkit-scrollbar { display: none; /* éš±è—æ²è»¸ (Chrome/Safari) */ }

    .filter-chip {
        display: inline-block;
        background: white; color: #8d6e63;
        padding: 6px 16px; border-radius: 20px;
        font-size: 0.9rem; font-weight: bold;
        margin-right: 8px; cursor: pointer;
        border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    
    /* é¸ä¸­ç‹€æ…‹ */
    .filter-chip.active {
        background: #d32f2f; color: white;
        box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        border-color: #d32f2f; transform: scale(1.05);
    }

    /* 3. ç€‘å¸ƒæµä½ˆå±€ */
    .gallery-container {
        column-count: 2; column-gap: 12px;
        width: 94%; max-width: 600px; margin: 0 auto;
    }

    .gallery-item {
        break-inside: avoid; background: white; border-radius: 15px;
        margin-bottom: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        overflow: hidden; transition: transform 0.2s;
        cursor: pointer; position: relative;
    }
    .gallery-item:active { transform: scale(0.98); }

    .photo-thumb {
        width: 100%; display: block;
        background-color: #eee; min-height: 100px; object-fit: cover;
    }

    .photo-info { padding: 8px 10px; }
    
    .photo-title {
        font-size: 0.9rem; font-weight: bold; color: #5d4037;
        margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    .photo-meta {
        display: flex; justify-content: space-between; align-items: center;
        font-size: 0.75rem; color: #999;
    }

    /* è¼‰å…¥ä¸­ */
    #loading-box { text-align: center; padding: 50px; color: #aaa; width: 100%; }
    
    /* Modal */
    #photo-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 10000;
        display: none; justify-content: center; align-items: center;
        flex-direction: column; opacity: 0; transition: opacity 0.3s;
    }
    #modal-img { max-width: 95%; max-height: 70vh; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #modal-desc { color: white; margin-top: 15px; text-align: center; padding: 0 20px; font-size: 1rem; line-height: 1.5; max-width: 90%; }
    #modal-close {
        position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;
        background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }
</style>
{% endblock %}

{% block content %}

    <div class="gallery-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/f_auto,q_auto/gallery_top.png" 
             class="gallery-banner-img" 
             alt="å°‹ç¥è¶³è·¡"
             onerror="this.src='https://placehold.co/380x120?text=Check+Image+Name'"> 
    </div>

    <div class="filter-scroll-container" id="filter-bar">
        </div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¼‰å…¥è¶³è·¡...
    </div>

    <div class="gallery-container" id="gallery-grid"></div>

    <div id="photo-modal" onclick="closeModal()">
        <div id="modal-close">&times;</div>
        <img id="modal-img" src="" alt="Zoomed Photo" onclick="event.stopPropagation()">
        <div id="modal-desc"></div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    let allPhotos = []; // å„²å­˜æ‰€æœ‰ç…§ç‰‡è³‡æ–™ï¼Œæ–¹ä¾¿éæ¿¾

    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        // 1. åˆå§‹åŒ–è³‡æ–™
        allPhotos = data.filter(item => item.image_url && item.image_url.startsWith('http'));
        allPhotos.reverse();

        // 2. è™•ç†æ¯ä¸€å¼µç…§ç‰‡çš„è³‡æ–™ (è§£ç¢¼é‡Œåˆ¥)
        allPhotos.forEach(item => {
            let rawName = item.nickname || item.name || 'å–„å¿ƒäººå£«';
            item.displayName = rawName;
            item.villageName = 'è‹‘è£¡é®'; // é è¨­

            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                item.displayName = parts[0];
                item.villageName = parts[1];
            } else {
                let soup = (item.area || "") + (item.address || "") + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let v = matches.find(term => ALL_VILLAGES.includes(term));
                    if (v) item.villageName = v;
                }
            }
        });

        // 3. å»ºç«‹å¿«ç¯©æŒ‰éˆ•
        renderFilterChips();

        // 4. é¡¯ç¤ºæ‰€æœ‰ç…§ç‰‡
        renderGallery('å…¨éƒ¨');

        $('#loading-box').hide();
    })
    .catch(e => {
        $('#loading-box').html('âŒ ç…§ç‰‡è®€å–å¤±æ•—');
        console.error(e);
    });

    // å»ºç«‹å¿«ç¯©æŒ‰éˆ•
    function renderFilterChips() {
        let container = $('#filter-bar');
        let html = `<div class="filter-chip active" onclick="filterGallery(this, 'å…¨éƒ¨')">å…¨éƒ¨</div>`;
        
        ALL_VILLAGES.forEach(v => {
            // åªæœ‰ç•¶è©²é‡Œæœ‰ç…§ç‰‡æ™‚ï¼Œæ‰é¡¯ç¤ºæŒ‰éˆ• (é¿å…ç©ºæŒ‰éˆ•)
            let hasPhoto = allPhotos.some(p => p.villageName === v);
            if (hasPhoto) {
                html += `<div class="filter-chip" onclick="filterGallery(this, '${v}')">${v}</div>`;
            }
        });
        container.html(html);
    }

    // éæ¿¾åŠŸèƒ½
    window.filterGallery = function(btn, village) {
        // è®Šæ›´æŒ‰éˆ•æ¨£å¼
        $('.filter-chip').removeClass('active');
        $(btn).addClass('active');

        // é‡æ–°æ¸²æŸ“ç€‘å¸ƒæµ
        renderGallery(village);
    }

    // æ¸²æŸ“ç€‘å¸ƒæµ
    function renderGallery(filterVillage) {
        let grid = document.getElementById('gallery-grid');
        let html = '';
        
        let displayData = allPhotos;
        if (filterVillage !== 'å…¨éƒ¨') {
            displayData = allPhotos.filter(p => p.villageName === filterVillage);
        }

        displayData.forEach(item => {
            let desc = item.description || 'æ²’æœ‰æè¿°';
            let thumbUrl = item.image_url;
            if(thumbUrl.includes('cloudinary.com')) {
                thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,f_auto,q_auto/');
            }

            html += `
                <div class="gallery-item" onclick="openModal('${item.image_url}', '${item.displayName}', '${item.villageName}', '${desc.replace(/'/g, "\\'")}')">
                    <img src="${thumbUrl}" class="photo-thumb" loading="lazy">
                    <div class="photo-info">
                        <div class="photo-title">${item.displayName}</div>
                        <div class="photo-meta">
                            <span>${item.villageName}</span>
                            <span style="font-size:0.7rem">${new Date(item.created_at || Date.now()).toLocaleDateString().slice(5)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        if (displayData.length === 0) {
            html = '<div style="text-align:center; width:100%; color:#999; margin-top:20px;">ğŸ˜… é€™å€‹é‡Œé‚„æ²’æœ‰ç…§ç‰‡ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</div>';
        }

        grid.innerHTML = html;
    }

    function openModal(url, name, village, desc) {
        $('#modal-img').attr('src', url);
        $('#modal-desc').html(`<strong style="font-size:1.2rem; display:block; margin-bottom:8px; color:#ffd700;">${name} @ ${village}</strong><span style="opacity:0.9;">${desc}</span>`);
        $('#photo-modal').css('display', 'flex').animate({ opacity: 1 }, 200);
    }

    function closeModal() {
        $('#photo-modal').animate({ opacity: 0 }, 200, function(){ $(this).hide(); });
    }
</script>
{% endblock %}
