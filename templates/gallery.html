{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block title %}å°‹ç¥è¶³è·¡ - å½±åƒç´€éŒ„{% endblock %}

{% block styles %}
<style>
    /* 1. åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. çœ‹æ¿å€ */
    .gallery-header {
        text-align: center; padding: 20px 0 10px 0;
        position: relative; margin-bottom: 5px;
    }
    
    .gallery-banner-img {
        width: 92%; max-width: 380px; height: auto;
        min-height: 120px;
        filter: drop-shadow(0 10px 15px rgba(93, 64, 55, 0.2));
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* 3. æ©«å‘æ²å‹•å¿«ç¯©åˆ— */
    .filter-scroll-container {
        width: 100%; overflow-x: auto; white-space: nowrap;
        padding: 5px 15px 15px 15px; 
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .filter-scroll-container::-webkit-scrollbar { display: none; }

    .filter-chip {
        display: inline-block; background: white; color: #8d6e63;
        padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        margin-right: 8px; cursor: pointer; border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        border-color: #d32f2f; transform: scale(1.05);
    }

    /* 4. ç€‘å¸ƒæµä½ˆå±€ */
    .gallery-container {
        column-count: 2; column-gap: 12px;
        width: 94%; max-width: 600px; margin: 0 auto;
    }
    .gallery-item {
        break-inside: avoid; background: white; border-radius: 15px;
        margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        overflow: hidden; transition: transform 0.2s; cursor: pointer; position: relative;
    }
    .gallery-item:active { transform: scale(0.98); }
    .photo-thumb { width: 100%; display: block; background-color: #eee; min-height: 100px; object-fit: cover; }
    .photo-info { padding: 8px 10px; }
    .photo-title { font-size: 0.9rem; font-weight: bold; color: #5d4037; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .photo-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999; }

    /* 5. ğŸ”¥ æ²ˆæµ¸å¼ Modal (ç¥è·¡æª”æ¡ˆå¡é¢¨æ ¼) */
    #photo-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(45, 20, 20, 0.96); /* æ·±é…’ç´…èƒŒæ™¯ */
        z-index: 10000;
        display: none; justify-content: center; align-items: center;
        flex-direction: column; opacity: 0; transition: opacity 0.3s;
    }
    
    #modal-img { 
        max-width: 90%; max-height: 50vh; 
        border-radius: 12px; 
        border: 4px solid #fff8e1; /* ç±³ç™½é‚Šæ¡† */
        box-shadow: 0 0 25px rgba(255, 215, 0, 0.2);
    }
    
    #modal-desc { 
        margin-top: 20px; text-align: center; padding: 0 20px;
        max-width: 90%;
    }
    
    /* ğŸ”¥ è³‡è¨Šå€æ¨£å¼å‡ç´š */
    .location-text {
        font-size: 1.5rem; display: block; margin-bottom: 5px;
        color: #ffca28; /* äº®é»ƒè‰² - ç¥è·¡ä½ç½® */
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        font-weight: 800; letter-spacing: 1px;
    }
    .provider-text {
        font-size: 0.95rem; display: block; margin-bottom: 15px;
        color: rgba(255,255,255,0.7); /* æ·¡ç™½è‰² - æä¾›è€… */
        font-weight: normal;
    }
    .modal-desc-text {
        color: rgba(255,255,255,0.9); font-size: 1rem; line-height: 1.6;
        font-style: italic; border-top: 1px solid rgba(255,255,255,0.2);
        padding-top: 10px; display: inline-block;
    }
    
    .modal-actions { display: flex; gap: 12px; margin-top: 25px; width: 90%; justify-content: center; }
    
    .action-btn {
        flex: 1; max-width: 110px; padding: 12px 0; border-radius: 50px;
        text-align: center; color: white; font-weight: bold; text-decoration: none;
        display: flex; align-items: center; justify-content: center; gap: 5px;
        font-size: 0.9rem; transition: transform 0.2s; cursor: pointer; border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .action-btn:active { transform: scale(0.95); }

    .btn-nav { background: linear-gradient(135deg, #ff5722, #d84315); } 
    .btn-line { background: linear-gradient(135deg, #fbc02d, #f57f17); color: #4e342e; } 
    .btn-fb { background: #1877f2; } 

    #modal-close {
        position: absolute; top: 20px; right: 20px; color: rgba(255,255,255,0.6); 
        font-size: 2rem; cursor: pointer;
        background: rgba(0,0,0,0.3); width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    #modal-close:hover { color: white; background: #d32f2f; }
    
    #loading-box { text-align: center; padding: 50px; color: #aaa; width: 100%; }
</style>
{% endblock %}

{% block content %}

    <div class="gallery-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/f_auto,q_auto/gallery_top.png?v=2" 
             class="gallery-banner-img" 
             alt="å°‹ç¥è¶³è·¡"
             onerror="this.src='https://placehold.co/380x120?text=Gallery+Banner'"> 
    </div>

    <div class="filter-scroll-container" id="filter-bar"></div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¼‰å…¥è¶³è·¡...
    </div>

    <div class="gallery-container" id="gallery-grid"></div>

    <div id="photo-modal" onclick="closeModal()">
        <div id="modal-close">Ã—</div>
        <img id="modal-img" src="" alt="Zoomed Photo" onclick="event.stopPropagation()">
        
        <div id="modal-desc">
            </div>

        <div class="modal-actions" onclick="event.stopPropagation()">
            <a href="#" id="btn-nav" target="_blank" class="action-btn btn-nav"><i class="fas fa-location-arrow"></i> å°èˆª</a>
            <a href="#" id="btn-line" target="_blank" class="action-btn btn-line"><i class="fas fa-share-alt"></i> åˆ†äº«</a>
            <a href="#" id="btn-fb" target="_blank" class="action-btn btn-fb"><i class="fab fa-facebook-f"></i> FB</a>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    let allPhotos = [];

    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        allPhotos = data.filter(item => item.image_url && item.image_url.startsWith('http'));
        allPhotos.reverse();

        allPhotos.forEach(item => {
            let rawName = item.nickname || item.name || 'å–„å¿ƒäººå£«';
            item.displayName = rawName;
            item.villageName = 'è‹‘è£¡é®';

            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                item.displayName = parts[0];
                item.villageName = parts[1];
            } else {
                let soup = (item.area || "") + (item.address || "") + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let v = matches.find(term => ALL_VILLAGES.includes(term));
                    if (v) item.villageName = v;
                }
            }
        });

        renderFilterChips();
        renderGallery('å…¨éƒ¨');
        $('#loading-box').hide();
    })
    .catch(e => {
        $('#loading-box').html('âŒ ç…§ç‰‡è®€å–å¤±æ•—');
        console.error(e);
    });

    function renderFilterChips() {
        let container = $('#filter-bar');
        let html = `<div class="filter-chip active" onclick="filterGallery(this, 'å…¨éƒ¨')">å…¨éƒ¨</div>`;
        ALL_VILLAGES.forEach(v => {
            if (allPhotos.some(p => p.villageName === v)) {
                html += `<div class="filter-chip" onclick="filterGallery(this, '${v}')">${v}</div>`;
            }
        });
        container.html(html);
    }

    window.filterGallery = function(btn, village) {
        $('.filter-chip').removeClass('active');
        $(btn).addClass('active');
        renderGallery(village);
    }

    function renderGallery(filterVillage) {
        let grid = document.getElementById('gallery-grid');
        let html = '';
        let displayData = filterVillage !== 'å…¨éƒ¨' ? allPhotos.filter(p => p.villageName === filterVillage) : allPhotos;

        displayData.forEach(item => {
            let desc = item.description || 'æ²’æœ‰æè¿°';
            let thumbUrl = item.image_url;
            if(thumbUrl.includes('cloudinary.com')) {
                thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,f_auto,q_auto/');
            }
            
            let lat = item.lat || item.latitude || '';
            let lng = item.lng || item.longitude || '';

            html += `
                <div class="gallery-item" onclick="openModal('${item.image_url}', '${item.displayName}', '${item.villageName}', '${desc.replace(/'/g, "\\'")}', '${lat}', '${lng}')">
                    <img src="${thumbUrl}" class="photo-thumb" loading="lazy">
                    <div class="photo-info">
                        <div class="photo-title">${item.displayName}</div>
                        <div class="photo-meta">
                            <span>${item.villageName}</span>
                            <span style="font-size:0.7rem">${new Date(item.created_at || Date.now()).toLocaleDateString().slice(5)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        if (displayData.length === 0) {
            html = '<div style="text-align:center; width:100%; color:#999; margin-top:20px;">ğŸ˜… é€™å€‹é‡Œé‚„æ²’æœ‰ç…§ç‰‡ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</div>';
        }
        grid.innerHTML = html;
    }

    function openModal(url, name, village, desc, lat, lng) {
        $('#modal-img').attr('src', url);
        
        // ğŸ”¥ é€™è£¡æ”¹æˆäº†ã€Œä¸Šä¸‹åˆ†è¡Œã€çš„æ˜ç¢ºæ¨™ç¤ºè¨­è¨ˆ
        $('#modal-desc').html(`
            <span class="location-text">
                <i class="fas fa-map-marker-alt"></i> ${village}
            </span>
            <span class="provider-text">
                <i class="fas fa-camera" style="margin-right:3px;"></i> å½±åƒæä¾›ï¼š${name}
            </span>
            <div class="modal-desc-text">
                <i class="fas fa-quote-left" style="color:#bdbdbd; font-size:0.8rem; margin-right:5px;"></i>
                ${desc}
            </div>
        `);
        
        let navBtn = $('#btn-nav');
        if (lat && lng) {
            navBtn.attr('href', `http://googleusercontent.com/maps.google.com/maps?daddr=${lat},${lng}`);
            navBtn.show();
        } else {
            navBtn.hide();
        }

        let shareText = encodeURIComponent(`ğŸ”¥ æˆ‘åœ¨ã€å°‹ç¥æƒ…å ±ç«™ã€‘ç™¼ç¾ ${name} åœ¨ ${village} æ‹çš„åœŸåœ°å…¬ï¼\nå¿«ä¾†çœ‹çœ‹ï¼š`);
        let shareUrl = encodeURIComponent(url); 
        $('#btn-line').attr('href', `https://line.me/R/msg/text/?${shareText}%20${shareUrl}`);

        let siteUrl = encodeURIComponent(window.location.origin); 
        $('#btn-fb').attr('href', `https://www.facebook.com/sharer/sharer.php?u=${siteUrl}`);

        $('#photo-modal').css('display', 'flex').animate({ opacity: 1 }, 200);
    }

    function closeModal() {
        $('#photo-modal').animate({ opacity: 0 }, 200, function(){ $(this).hide(); });
    }
</script>
{% endblock %}
