{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block styles %}
<style>
    /* 瀑布流版面設定 */
    .gallery-container {
        padding: 15px 10px;
        padding-bottom: 120px; /* 避開底部導航 */
        column-count: 2; /* 手機版兩欄 */
        column-gap: 10px;
    }
    
    @media (min-width: 768px) {
        .gallery-container { column-count: 3; } /* 電腦版三欄 */
    }

    /* 照片卡片 */
    .photo-card {
        break-inside: avoid; /* 防止卡片被切斷 */
        background: white;
        border-radius: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid #f0f0f0;
    }
    .photo-card:active { transform: scale(0.98); }

    .photo-img {
        width: 100%;
        height: auto;
        display: block;
        background: #eee;
        min-height: 100px; /* 預佔位 */
    }

    .photo-info { padding: 10px; }
    .photo-area { 
        font-size: 0.8rem; color: #d32f2f; font-weight: bold; 
        background: #ffebee; padding: 2px 8px; border-radius: 8px;
        display: inline-block; margin-bottom: 5px;
    }
    .photo-nickname { font-size: 0.9rem; font-weight: bold; color: #333; display: block;}
    .photo-note { 
        font-size: 0.85rem; color: #666; 
        margin-top: 5px; 
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* 最多顯示兩行 */
    }

    /* 頂部標題 */
    .page-header { text-align: center; padding: 20px 0 10px 0; }
    .header-title { 
        font-size: 1.4rem; font-weight: 900; color: #5d4037; 
        background: #fff; padding: 8px 20px; border-radius: 50px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: inline-block;
        border: 1px solid rgba(255,255,255,0.8);
    }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <div class="header-title">
            <i class="fas fa-images" style="color:#d32f2f;"></i> 眾神圖庫
        </div>
    </div>

    <div class="gallery-container" id="gallery-list">
        <div style="text-align:center; padding:50px; color:#999; width:100%;">
            <i class="fas fa-circle-notch fa-spin"></i> 載入神明中...
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        loadGallery();
    });

    function loadGallery() {
        // 加個隨機數避免快取
        let t = new Date().getTime();
        $.getJSON('/api/locations?t=' + t, function(data) {
            let html = '';
            
            // 如果沒資料
            if (data.length === 0) {
                $('#gallery-list').html('<div style="text-align:center; width:100%; padding:50px; color:#888;">目前還沒有神明入住喔！<br>快去當第一個上傳的人！</div>');
                return;
            }

            // 新的照片排前面 (反轉陣列)
            data.reverse().forEach(item => {
                // 資料處理
                let name = item.nickname ? item.nickname.split("#")[0] : "熱心串友";
                let area = (item.nickname && item.nickname.includes("#")) ? item.nickname.split("#")[1] : (item.area || "苑裡");
                let note = (item.note && item.note.trim() !== "") ? item.note : "無備註";
                
                // 圖片優化
                let thumb = item.image_url.replace('/upload/', '/upload/w_400,c_scale,q_auto/');

                html += `
                    <div class="photo-card" onclick='showDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                        <img class="photo-img" src="${thumb}" loading="lazy">
                        <div class="photo-info">
                            <span class="photo-area">${area}</span>
                            <span class="photo-nickname">${name}</span>
                            <div class="photo-note">${note}</div>
                        </div>
                    </div>
                `;
            });

            $('#gallery-list').html(html);
        });
    }

    // 點擊照片顯示詳細大圖 (比照地圖頁的規格)
    window.showDetail = function(item) {
        let name = item.nickname ? item.nickname.split("#")[0] : "熱心串友";
        let area = (item.nickname && item.nickname.includes("#")) ? item.nickname.split("#")[1] : (item.area || "苑裡");
        let note = (item.note && item.note.trim() !== "") ? item.note : "無備註";
        let time = item.created_at ? item.created_at.substring(0, 16) : "未知時間";
        
        // Google 導航連結 (官方格式)
        let navLink = `http://googleusercontent.com/maps.google.com/maps?daddr=${item.lat},${item.lng}`;

        Swal.fire({
            title: '',
            html: `
                <div style="text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="background:#ffebee; color:#d32f2f; padding:3px 10px; border-radius:10px; font-weight:bold;">${area}</span>
                        <span style="color:#999; font-size:0.85rem;"><i class="far fa-clock"></i> ${time}</span>
                    </div>
                    
                    <img src="${item.image_url}" style="width:100%; border-radius:10px; margin-bottom:15px; border:1px solid #ddd;">
                    
                    <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;">
                        <div style="font-weight:bold; color:#333; margin-bottom:5px;">
                            <i class="fas fa-user-circle" style="color:#8d6e63;"></i> ${name}
                        </div>
                        <div style="color:#555; line-height:1.5;">
                            <i class="fas fa-pen" style="color:#8d6e63; font-size:0.9rem;"></i> ${note}
                        </div>
                    </div>

                    <a href="${navLink}" target="_blank" 
                       style="display:block; width:100%; background:#2e7d32; color:white; padding:12px; border-radius:50px; text-decoration:none; font-weight:bold; text-align:center;">
                       <i class="fas fa-location-arrow"></i> Google 導航出發
                    </a>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            background: '#fffbf0',
            width: '90%',
            padding: '15px'
        });
    }
</script>
{% endblock %}
