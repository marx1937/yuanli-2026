{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block styles %}
<style>
    /* 1. é‚„åŸç¶“å…¸ç¶²æ ¼æ’åˆ— (å…©æ¬„å¼) */
    .gallery-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -5px;
    }
    .gallery-col {
        flex: 0 0 50%; /* ä¸€æ’å…©å¼µ */
        max-width: 50%;
        padding: 5px;
        margin-bottom: 10px;
    }
    @media (min-width: 768px) {
        .gallery-col { flex: 0 0 33.33%; max-width: 33.33%; } /* é›»è…¦ç‰ˆä¸€æ’ä¸‰å¼µ */
    }

    /* 2. ç…§ç‰‡å¡ç‰‡æ¨£å¼ */
    .photo-card {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 100%;
        cursor: pointer;
        position: relative;
    }
    .photo-img-container {
        width: 100%;
        padding-top: 100%; /* 1:1 æ­£æ–¹å½¢è£åˆ‡ */
        position: relative;
        background: #eee;
    }
    .photo-img {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: cover;
    }
    .photo-info-overlay {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        padding: 20px 10px 5px 10px;
        color: white;
    }
    .photo-badge {
        background: #d32f2f; color: white;
        font-size: 0.75rem; padding: 2px 6px;
        border-radius: 4px; position: absolute; top: 10px; left: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* 3. é ‚éƒ¨æ¨™é¡Œå€ (æ›ä¸ŠåŒ¾é¡åœ–ç‰‡) */
    .page-header { 
        text-align: center; 
        padding: 20px 0 10px 0; 
        width: 100%; 
        position: relative; 
    }

    /* 4. æ·±è‰²å½ˆçª—æ¨£å¼ */
    .custom-swal-popup {
        background: #2c2c2c !important;
        border: 1px solid #444 !important;
        border-radius: 15px !important;
    }
    .custom-swal-title { color: #fbc02d !important; text-align: left !important; font-size: 1.3rem !important; margin-bottom: 0 !important; }
    .custom-swal-content { color: #eee !important; text-align: left !important; font-size: 0.95rem !important; }
    
    /* æŒ‰éˆ•ç¾¤çµ„ */
    .btn-group-custom { display: flex; gap: 8px; margin-top: 15px; }
    .btn-action { flex: 1; border-radius: 50px; font-weight: bold; padding: 10px 0; border: none; color: white; font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-nav { background: #2e7d32; }
    .btn-line { background: #ff9800; }
    .btn-fb { background: #1877f2; }
</style>
{% endblock %}

{% block content %}

    <div class="page-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1768691402/title_signboard.png" 
             alt="å°‹ç¥æƒ…å ±ç«™"
             style="width: 95%; max-width: 600px; height: auto; object-fit: contain; filter: drop-shadow(0 5px 8px rgba(0,0,0,0.2)); margin-bottom: 5px;">
    </div>

    <div class="container-fluid" style="padding-bottom: 100px;">
        <div class="gallery-row" id="gallery-list">
            <div style="text-align:center; width:100%; padding:40px; color:#999;">
                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥ç¥æ˜...
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        loadGallery();
    });

    function loadGallery() {
        let t = new Date().getTime();
        $.getJSON('/api/locations?t=' + t, function(data) {
            let html = '';
            
            if (data.length === 0) {
                $('#gallery-list').html('<div style="text-align:center; width:100%; margin-top:50px; color:#888;">é‚„æ²’æœ‰è³‡æ–™å–”ï¼</div>');
                return;
            }

            data.reverse().forEach(item => {
                let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                let area = (item.nickname && item.nickname.includes("#")) ? item.nickname.split("#")[1] : (item.area || "è‹‘è£¡");
                let thumb = item.image_url.replace('/upload/', '/upload/w_300,h_300,c_fill,q_auto/');

                html += `
                    <div class="gallery-col">
                        <div class="photo-card" onclick='showDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                            <span class="photo-badge">${area}</span>
                            <div class="photo-img-container">
                                <img class="photo-img" src="${thumb}" loading="lazy">
                                <div class="photo-info-overlay">
                                    <i class="fas fa-user-circle"></i> ${name}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#gallery-list').html(html);
        });
    }

    window.showDetail = function(item) {
        let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
        let area = (item.nickname && item.nickname.includes("#")) ? item.nickname.split("#")[1] : (item.area || "è‹‘è£¡");
        let note = (item.note && item.note.trim() !== "") ? item.note : "ç„¡å‚™è¨»";
        let time = item.created_at ? item.created_at.substring(0, 16) : "æœªçŸ¥æ™‚é–“";
        let navLink = `http://googleusercontent.com/maps.google.com/maps?daddr=${item.lat},${item.lng}`;
        let shareUrl = window.location.href; 

        // ğŸ”¥ éš¨æ©Ÿåˆ†äº«æ–‡æ¡ˆ
        const shareMessages = [
            `æˆ‘åœ¨å°‹ç¥åœ°åœ–ç™¼ç¾äº† ${area} çš„ç¥éšŠå‹ï¼å¿«ä¾†çœ‹ï¼`,
            `å°‹ç¥æƒ…å ±ï¼š${area} é€™è£¡æœ‰ä¸€å°Šå¾ˆéˆé©—çš„åœŸåœ°å…¬å–”ï¼`,
            `æœ‰æ‹œæœ‰ä¿åº‡ï¼æˆ‘åœ¨ ${area} å¹«å¤§å®¶ç¥ˆç¦å›‰ï½ğŸ™`,
            `ç™¼ç¾é‡ç”Ÿç¥æ˜ï¼ğŸ“åœ°é»åœ¨ ${area}ï¼Œé»æˆ‘å°èˆªï¼`,
            `è‹‘è£¡å°‹ç¥åœ°åœ–ï¼š${area} é€™è£¡é¢¨æ™¯ä¸éŒ¯ï¼Œé‚„æœ‰ç¥æ˜ä¿ä½‘ï¼`
        ];
        let shareText = shareMessages[Math.floor(Math.random() * shareMessages.length)];

        Swal.fire({
            background: '#2c2c2c',
            html: `
                <div style="padding:0px;">
                    <img src="${item.image_url}" style="width:100%; border-radius:10px; border:2px solid #fff; margin-bottom:15px;">
                    
                    <div style="text-align:left; color:#fff;">
                        <div style="font-size:1.4rem; font-weight:bold; color:#fbc02d; margin-bottom:5px;">
                            <i class="fas fa-map-marker-alt"></i> ${area}
                        </div>
                        <div style="font-size:0.95rem; color:#ccc; margin-bottom:10px;">
                            <i class="fas fa-camera"></i> å½±åƒæä¾›ï¼š${name}
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; margin-bottom:5px;">
                            <i class="fas fa-quote-left" style="color:#aaa;"></i>
                            <span style="color:#fff; font-size:1rem; margin-left:5px;">${note}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#777; text-align:right; margin-bottom:15px;">
                           ${time}
                        </div>
                    </div>

                    <div class="btn-group-custom">
                        <a href="${navLink}" target="_blank" class="btn-action btn-nav">
                            <i class="fas fa-location-arrow"></i> å°èˆª
                        </a>
                        <a href="https://line.me/R/msg/text/?${shareText} ${shareUrl}" target="_blank" class="btn-action btn-line">
                            <i class="fab fa-line"></i> LINE
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}" target="_blank" class="btn-action btn-fb">
                            <i class="fab fa-facebook-f"></i> FB
                        </a>
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: { popup: 'custom-swal-popup' }
        });
    }
</script>
{% endblock %}
