<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°‹ç¥è¶³è·¡ - å½±åƒç´€éŒ„</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* 2. åŸºç¤è¨­å®š */
        body {
            background-color: #fdfcf0;
            background-image: 
                linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            padding-bottom: 110px; /* é¿é–‹åº•éƒ¨å°èˆª */
            margin: 0;
            font-family: "Microsoft JhengHei", sans-serif;
        }

        /* 3. çœ‹æ¿å€ */
        .gallery-header {
            text-align: center; padding: 20px 0 10px 0;
            position: relative; margin-bottom: 5px;
        }
        .gallery-banner-img {
            width: 90%; max-width: 320px; height: auto;
            filter: drop-shadow(0 8px 10px rgba(93, 64, 55, 0.15));
            animation: float-title 3s ease-in-out infinite;
        }
        @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* 4. ğŸ”¥ æ–°å¢ï¼šé ‚éƒ¨ç¯©é¸åˆ— (è·Ÿåœ°åœ–é ä¸€æ¨£) */
        .gallery-filter-container {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(253, 252, 240, 0.95);
            padding: 10px 15px; white-space: nowrap; overflow-x: auto;
            display: flex; gap: 8px; 
            border-bottom: 1px solid #efebe9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .gallery-filter-container::-webkit-scrollbar { display: none; }

        .filter-chip {
            display: inline-flex; align-items: center; gap: 5px;
            background: #fff; color: #555; 
            padding: 6px 14px; border-radius: 50px; font-size: 0.85rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #efebe9; 
            cursor: pointer; transition: 0.2s;
        }
        .filter-chip.active { background: #d32f2f; color: white; transform: scale(1.05); border-color: #b71c1c; }

        /* 5. ç…§ç‰‡ç¶²æ ¼å€ */
        .gallery-grid {
            padding: 15px;
            column-count: 2; column-gap: 15px; /* ç€‘å¸ƒæµä½ˆå±€ */
        }
        .gallery-item {
            break-inside: avoid; margin-bottom: 15px;
            background: #fff; border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border: 1px solid #fff; position: relative;
            cursor: pointer; transition: transform 0.2s;
        }
        .gallery-item:active { transform: scale(0.98); }
        .gallery-img { width: 100%; display: block; }
        .gallery-info { padding: 8px 10px; }
        .gallery-location { font-size: 0.8rem; color: #d32f2f; font-weight: bold; margin-bottom: 2px; }
        .gallery-user { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 4px; }

        /* 6. åº•éƒ¨å°èˆª (æ‰‹å‹•ç‰ˆ) */
        .fake-navbar { 
            position: fixed; bottom: 0; width: 100%; 
            background: #fff; border-top: 1px solid #efebe9; 
            padding: 0 5px; height: 90px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 2000; box-shadow: 0 -5px 20px rgba(93, 64, 55, 0.05);
        }
        .nav-item { text-align: center; color: #a1887f; text-decoration: none !important; font-size: 0.75rem; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .nav-icon { height: 42px; width: auto; margin-bottom: 3px; filter: grayscale(100%) sepia(20%) opacity(0.8); transition: 0.3s; }
        .nav-item.active .nav-icon { transform: scale(1.1); filter: none; filter: drop-shadow(0 2px 2px rgba(211, 47, 47, 0.2)); }
        .nav-item.active span { color: #d32f2f; font-weight: bold; }
        .nav-center-btn {
            width: 80px; height: 80px; background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            border-radius: 50%; border: 6px solid #fdfcf0; display: flex; align-items: center; justify-content: center;
            transform: translateY(-35px); box-shadow: 0 8px 15px rgba(198, 40, 40, 0.3);
        }
        .nav-center-icon { height: 55px; width: auto; display: block; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }

        /* Modal æ¨£å¼å„ªåŒ– */
        .modal-content { border-radius: 20px; border: none; overflow: hidden; }
        .modal-body { padding: 0; position: relative; }
        .modal-img-full { width: 100%; display: block; }
        .modal-details { padding: 20px; background: #fff; }
        .location-text { color: #d32f2f; font-weight: 900; font-size: 1.2rem; display: block; margin-bottom: 5px; }
        .provider-text { color: #888; font-size: 0.9rem; margin-bottom: 15px; display: block; }
        .modal-desc-text { 
            background: #fff8e1; padding: 12px; border-radius: 10px; 
            color: #5d4037; font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;
        }
        .btn-modal-action {
            width: 100%; padding: 12px; border-radius: 50px; font-weight: bold; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
        }
        .btn-nav-go { background: linear-gradient(135deg, #2e7d32, #1b5e20); color: white; }
        .btn-line-share { background: #06c755; color: white; }
    </style>
</head>
<body>

    <div class="gallery-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" style="width:50px; margin-bottom:5px;">
        <h4 style="font-weight:900; color:#5d4037; margin:0;">å°‹ç¥è¶³è·¡å½±åƒåº«</h4>
    </div>

    <div class="gallery-filter-container" id="filter-scroll">
        </div>

    <div class="gallery-grid" id="gallery-container">
        <div style="text-align:center; width:100%; color:#999; margin-top:50px;">
            <i class="fas fa-spinner fa-spin fa-2x"></i><br>è¼‰å…¥å½±åƒä¸­...
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" style="position:absolute; right:15px; top:15px; z-index:10; color:white; text-shadow:0 0 5px rgba(0,0,0,0.5); opacity:1;">&times;</button>
                    <img id="modal-img" src="" class="modal-img-full">
                    <div class="modal-details">
                        <div id="modal-desc"></div>
                        <a href="#" id="btn-nav" target="_blank" class="btn-modal-action btn-nav-go">
                            <i class="fas fa-location-arrow"></i> Google å°èˆª
                        </a>
                        <a href="#" id="btn-line" target="_blank" class="btn-modal-action btn-line-share">
                            <i class="fab fa-line"></i> åˆ†äº«åˆ° LINE
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fake-navbar">
        <a href="/" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_home.png" class="nav-icon"><span>é¦–é </span></a>
        <a href="/map" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_map.png" class="nav-icon"><span>åœ°åœ–</span></a>
        <a href="/upload" class="nav-center-btn"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_upload.png" class="nav-center-icon"></a>
        <a href="/gallery" class="nav-item active"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_gallery.png" class="nav-icon"><span>åœ–åº«</span></a>
        <a href="/leaderboard" class="nav-item"><img src="https://res.cloudinary.com/diuoghid2/image/upload/v1/nav_leaderboard.png" class="nav-icon"><span>æ¦œå–®</span></a>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        const ALL_VILLAGES = [
            "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "è‹‘æ¸¯é‡Œ", "è¥¿å¹³é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "æˆ¿è£¡é‡Œ", "å®¢åº„é‡Œ", "ä¸­æ­£é‡Œ", 
            "æ–°å¾©é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "èˆŠç¤¾é‡Œ", "å±±è…³é‡Œ", "ç¦ç”°é‡Œ", "æ³°ç”°é‡Œ", "ç‰ç”°é‡Œ", "å—å‹¢é‡Œ", 
            "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "ä¸Šé¤¨é‡Œ", "æ°´å¡é‡Œ", "è‹‘å‘é‡Œ", "å‡ºæ°´é‡Œ"
        ];

        let allData = [];

        // è¼‰å…¥è³‡æ–™
        fetch('/api/locations').then(r => r.json()).then(data => {
            allData = data.reverse(); // æœ€æ–°çš„åœ¨ä¸Šé¢
            renderFilters();
            renderGallery(allData);
        });

        // 1. æ¸²æŸ“ç¯©é¸å™¨
        function renderFilters() {
            let html = `<div class="filter-chip active" onclick="filterGallery('å…¨éƒ¨', this)">å…¨éƒ¨</div>`;
            ALL_VILLAGES.forEach(v => {
                html += `<div class="filter-chip" onclick="filterGallery('${v}', this)">${v}</div>`;
            });
            $('#filter-scroll').html(html);
        }

        // 2. ç¯©é¸é‚è¼¯
        function filterGallery(village, btn) {
            $('.filter-chip').removeClass('active');
            $(btn).addClass('active');

            if (village === 'å…¨éƒ¨') {
                renderGallery(allData);
            } else {
                let filtered = allData.filter(i => {
                    let v = "å…¶ä»–";
                    if (i['é‡Œåˆ¥'] && i['é‡Œåˆ¥'] !== "nan") v = i['é‡Œåˆ¥'];
                    else if (i.nickname && i.nickname.includes("#")) v = i.nickname.split("#")[1];
                    else if (i.area) v = i.area;
                    return v === village;
                });
                renderGallery(filtered);
            }
        }

        // 3. æ¸²æŸ“ç…§ç‰‡ç‰†
        function renderGallery(data) {
            let container = $('#gallery-container');
            container.empty();

            if(data.length === 0) {
                container.html('<div style="text-align:center; width:100%; color:#999; margin-top:30px;">é€™è£¡é‚„æ²’æœ‰ç¥éšŠå‹å–”ï¼<br>å¿«å»ç•¶ç¬¬ä¸€å€‹ï¼</div>');
                return;
            }

            data.forEach(item => {
                let imgUrl = item.image_url.replace('/upload/', '/upload/w_300,c_fill,q_auto/'); // å„ªåŒ–ç¸®åœ–
                let name = item.nickname ? item.nickname.split("#")[0] : "ç†±å¿ƒä¸²å‹";
                let v = "å…¶ä»–";
                if (item['é‡Œåˆ¥'] && item['é‡Œåˆ¥'] !== "nan") v = item['é‡Œåˆ¥'];
                else if (item.nickname && item.nickname.includes("#")) v = item.nickname.split("#")[1];
                else if (item.area) v = item.area;

                let card = `
                    <div class="gallery-item" onclick="openModal('${item.image_url}', '${name}', '${v}', '${item.note || ""}', ${item.lat}, ${item.lng})">
                        <img src="${imgUrl}" class="gallery-img" loading="lazy">
                        <div class="gallery-info">
                            <div class="gallery-location"><i class="fas fa-map-marker-alt"></i> ${v}</div>
                            <div class="gallery-user"><i class="fas fa-user-circle"></i> ${name}</div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        }

        // 4. é–‹å•Ÿå¤§åœ– Modal
        window.openModal = function(url, name, village, desc, lat, lng) {
            $('#modal-img').attr('src', url);
            
            let descHtml = `
                <span class="location-text">
                    <i class="fas fa-map-marker-alt"></i> ${village}
                </span>
                <span class="provider-text">
                    <i class="fas fa-camera" style="margin-right:3px;"></i> å½±åƒæä¾›ï¼š${name}
                </span>
            `;
            if(desc) {
                descHtml += `
                    <div class="modal-desc-text">
                        <i class="fas fa-quote-left" style="color:#bdbdbd; font-size:0.8rem; margin-right:5px;"></i>
                        ${desc}
                    </div>
                `;
            }
            $('#modal-desc').html(descHtml);

            // å°èˆªæŒ‰éˆ•
            let navBtn = $('#btn-nav');
            if (lat && lng) {
                navBtn.attr('href', `http://googleusercontent.com/maps.google.com/maps?daddr=${lat},${lng}`);
                navBtn.show();
            } else {
                navBtn.hide();
            }

            // LINE åˆ†äº«æŒ‰éˆ•
            let shareText = encodeURIComponent(`ğŸ”¥ æˆ‘åœ¨ã€å°‹ç¥æƒ…å ±ç«™ã€‘ç™¼ç¾ ${name} åœ¨ ${village} æ‹çš„åœŸåœ°å…¬ï¼\nå¿«ä¾†çœ‹çœ‹ï¼š`);
            let shareUrl = encodeURIComponent(url); 
            $('#btn-line').attr('href', `https://line.me/R/msg/text/?${shareText}%20${shareUrl}`);

            $('#imageModal').modal('show');
        }
    </script>
</body>
</html>
