{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block title %}å°‹ç¥è¶³è·¡ - å½±åƒç´€éŒ„{% endblock %}

{% block styles %}
<style>
    /* 1. åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. çœ‹æ¿å€ */
    .gallery-header {
        text-align: center; padding: 25px 0 15px 0;
        position: relative; margin-bottom: 10px;
    }
    
    .gallery-banner-img {
        width: 92%; max-width: 380px; height: auto;
        /* é ç•™é«˜åº¦é¿å…é–ƒçˆ */
        min-height: 120px;
        /* æŸ”å’ŒæŠ•å½± */
        filter: drop-shadow(0 10px 15px rgba(93, 64, 55, 0.2));
        /* å‘¼å¸å‹•ç•« */
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* 3. ç€‘å¸ƒæµä½ˆå±€ (Masonry) */
    .gallery-container {
        column-count: 2; /* æ‰‹æ©Ÿç‰ˆå…©æ¬„ */
        column-gap: 12px;
        width: 94%; max-width: 600px; margin: 0 auto;
    }

    .gallery-item {
        break-inside: avoid; /* é˜²æ­¢å¡ç‰‡è¢«åˆ‡æ–· */
        background: white; border-radius: 15px;
        margin-bottom: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: transform 0.2s;
        cursor: pointer;
        position: relative;
    }
    .gallery-item:active { transform: scale(0.98); }

    .photo-thumb {
        width: 100%; display: block;
        background-color: #eee; min-height: 100px;
        object-fit: cover;
    }

    .photo-info {
        padding: 8px 10px;
    }
    
    .photo-title {
        font-size: 0.9rem; font-weight: bold; color: #5d4037;
        margin-bottom: 4px;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    .photo-meta {
        display: flex; justify-content: space-between; align-items: center;
        font-size: 0.75rem; color: #999;
    }
    
    .village-tag {
        background: #fff3e0; color: #ef6c00; padding: 2px 6px;
        border-radius: 6px; font-weight: bold; font-size: 0.7rem;
    }

    /* è¼‰å…¥ä¸­ */
    #loading-box { text-align: center; padding: 50px; color: #aaa; width: 100%; }
    
    /* é»æ“Šæ”¾å¤§çš„ Modal */
    #photo-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 10000;
        display: none; justify-content: center; align-items: center;
        flex-direction: column; opacity: 0; transition: opacity 0.3s;
    }
    #modal-img {
        max-width: 95%; max-height: 70vh; 
        border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #modal-desc {
        color: white; margin-top: 15px; text-align: center; padding: 0 20px;
        font-size: 1rem; line-height: 1.5; max-width: 90%;
    }
    #modal-close {
        position: absolute; top: 20px; right: 20px;
        color: white; font-size: 2rem; cursor: pointer;
        background: rgba(255,255,255,0.2); width: 40px; height: 40px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }
</style>
{% endblock %}

{% block content %}

    <div class="gallery-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/f_auto,q_auto/gallery_top.png" 
             class="gallery-banner-img" 
             alt="å°‹ç¥è¶³è·¡"
             onerror="this.src='https://placehold.co/380x120?text=Gallery+Banner'"> 
    </div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¼‰å…¥è¶³è·¡...
    </div>

    <div class="gallery-container" id="gallery-grid">
        </div>

    <div id="photo-modal" onclick="closeModal()">
        <div id="modal-close">&times;</div>
        <img id="modal-img" src="" alt="Zoomed Photo" onclick="event.stopPropagation()">
        <div id="modal-desc"></div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        let grid = document.getElementById('gallery-grid');
        
        // 1. éæ¿¾æ‰æ²’æœ‰åœ–ç‰‡çš„è³‡æ–™
        let validData = data.filter(item => item.image_url && item.image_url.startsWith('http'));
        
        // 2. å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
        validData.reverse();

        let html = '';
        validData.forEach(item => {
            // è§£ç¢¼é‚è¼¯ (æœ¨é¦¬æˆ°è¡“è§£ç¢¼)
            let rawName = item.nickname || item.name || 'å–„å¿ƒäººå£«';
            let displayName = rawName;
            let villageName = 'è‹‘è£¡é®';

            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                displayName = parts[0];
                villageName = parts[1];
            } else {
                // èˆŠè³‡æ–™å˜—è©¦å¾åœ°å€æˆ–æè¿°æ‰¾é‡Œå
                let soup = (item.area || "") + (item.address || "") + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let v = matches.find(term => ALL_VILLAGES.includes(term));
                    if (v) villageName = v;
                }
            }

            // è™•ç†æè¿°æ–‡å­— (å¦‚æœå¤ªé•·æˆªæ–·)
            let desc = item.description || 'æ²’æœ‰æè¿°';
            
            // åœ–ç‰‡å„ªåŒ–ï¼šåˆ—è¡¨åœ–ä¹ŸåŠ ä¸Šç¸®åœ–åƒæ•¸ (w_400)ï¼Œè®“åˆ—è¡¨è¼‰å…¥æ›´å¿«
            // æ³¨æ„ï¼šåªæœ‰ Cloudinary çš„åœ–å¯ä»¥ç”¨é€™æ‹›ï¼Œå¦‚æœæ˜¯å…¶ä»–åœ–åºŠå‰‡ç”¨åŸåœ–
            let thumbUrl = item.image_url;
            if(thumbUrl.includes('cloudinary.com')) {
                // åœ¨ /upload/ å¾Œé¢æ’å…¥ w_400,f_auto,q_auto
                thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,f_auto,q_auto/');
            }

            html += `
                <div class="gallery-item" onclick="openModal('${item.image_url}', '${displayName}', '${villageName}', '${desc.replace(/'/g, "\\'")}')">
                    <img src="${thumbUrl}" class="photo-thumb" loading="lazy">
                    <div class="photo-info">
                        <div class="photo-title">${displayName}</div>
                        <div class="photo-meta">
                            <span>${villageName}</span>
                            <span style="font-size:0.7rem">${new Date(item.created_at || Date.now()).toLocaleDateString().slice(5)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        if (validData.length === 0) {
            html = '<div style="text-align:center; width:100%; color:#999; margin-top:20px;">ğŸ“¸ ç›®å‰é‚„æ²’æœ‰ç…§ç‰‡ï¼Œå¿«å»ä¸Šå‚³ç¬¬ä¸€å¼µï¼</div>';
        }

        $('#loading-box').hide();
        grid.innerHTML = html;
    })
    .catch(e => {
        $('#loading-box').html('âŒ ç…§ç‰‡è®€å–å¤±æ•—');
        console.error(e);
    });

    // Modal åŠŸèƒ½
    function openModal(url, name, village, desc) {
        $('#modal-img').attr('src', url);
        $('#modal-desc').html(`
            <strong style="font-size:1.2rem; display:block; margin-bottom:8px; color:#ffd700;">${name} @ ${village}</strong>
            <span style="opacity:0.9;">${desc}</span>
        `);
        $('#photo-modal').css('display', 'flex').animate({ opacity: 1 }, 200);
    }

    function closeModal() {
        $('#photo-modal').animate({ opacity: 0 }, 200, function(){
            $(this).hide();
        });
    }
</script>
{% endblock %}
