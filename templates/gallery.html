{% extends "base.html" %}
{% set active_page = "gallery" %}

{% block title %}å°‹ç¥è¶³è·¡ - å½±åƒç´€éŒ„{% endblock %}

{% block styles %}
<style>
    /* 1. åŸºç¤è¨­å®š */
    body {
        background-color: #fdfcf0;
        background-image: 
            linear-gradient(to right, rgba(215, 204, 200, 0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(215, 204, 200, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 80px;
    }

    /* 2. çœ‹æ¿å€ */
    .gallery-header {
        text-align: center; padding: 20px 0 10px 0;
        position: relative; margin-bottom: 5px;
    }
    
    .gallery-banner-img {
        width: 92%; max-width: 380px; height: auto;
        min-height: 120px;
        filter: drop-shadow(0 10px 15px rgba(93, 64, 55, 0.2));
        animation: float-title 3s ease-in-out infinite;
    }
    @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    /* 3. æ©«å‘æ²å‹•å¿«ç¯©åˆ— (Chips) */
    .filter-scroll-container {
        width: 100%; overflow-x: auto; white-space: nowrap;
        padding: 5px 15px 15px 15px; 
        -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .filter-scroll-container::-webkit-scrollbar { display: none; }

    .filter-chip {
        display: inline-block; background: white; color: #8d6e63;
        padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        margin-right: 8px; cursor: pointer; border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s;
    }
    .filter-chip.active {
        background: #d32f2f; color: white; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        border-color: #d32f2f; transform: scale(1.05);
    }

    /* 4. ç€‘å¸ƒæµä½ˆå±€ */
    .gallery-container {
        column-count: 2; column-gap: 12px;
        width: 94%; max-width: 600px; margin: 0 auto;
    }

    .gallery-item {
        break-inside: avoid; background: white; border-radius: 15px;
        margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        overflow: hidden; transition: transform 0.2s; cursor: pointer; position: relative;
    }
    .gallery-item:active { transform: scale(0.98); }

    .photo-thumb { width: 100%; display: block; background-color: #eee; min-height: 100px; object-fit: cover; }
    .photo-info { padding: 8px 10px; }
    .photo-title { font-size: 0.9rem; font-weight: bold; color: #5d4037; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .photo-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #999; }

    /* 5. Modal èˆ‡ åŠŸèƒ½æŒ‰éˆ•å€ */
    #photo-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 10000;
        display: none; justify-content: center; align-items: center;
        flex-direction: column; opacity: 0; transition: opacity 0.3s;
    }
    #modal-img { max-width: 95%; max-height: 60vh; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #modal-desc { color: white; margin-top: 15px; text-align: center; padding: 0 20px; font-size: 1rem; line-height: 1.5; max-width: 90%; }
    
    /* ğŸ”¥ æ–°å¢ï¼šæŒ‰éˆ•å€æ¨£å¼ */
    .modal-actions {
        display: flex; gap: 15px; margin-top: 20px; width: 90%; justify-content: center;
    }
    .action-btn {
        flex: 1; max-width: 120px; padding: 10px 0; border-radius: 30px;
        text-align: center; color: white; font-weight: bold; text-decoration: none;
        display: flex; align-items: center; justify-content: center; gap: 5px;
        font-size: 0.9rem; transition: transform 0.2s; cursor: pointer; border: none;
    }
    .action-btn:active { transform: scale(0.95); }
    
    /* é¡è‰²å®šç¾© */
    .btn-nav { background: linear-gradient(135deg, #ff9800, #f57c00); box-shadow: 0 4px 10px rgba(245, 124, 0, 0.4); }
    .btn-line { background: #06c755; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.4); }
    .btn-fb { background: #1877f2; box-shadow: 0 4px 10px rgba(24, 119, 242, 0.4); }

    #modal-close {
        position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;
        background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }
    
    #loading-box { text-align: center; padding: 50px; color: #aaa; width: 100%; }
</style>
{% endblock %}

{% block content %}

    <div class="gallery-header">
        <img src="https://res.cloudinary.com/diuoghid2/image/upload/f_auto,q_auto/gallery_top.png?v=2" 
             class="gallery-banner-img" 
             alt="å°‹ç¥è¶³è·¡"
             onerror="this.src='https://placehold.co/380x120?text=Gallery+Banner'"> 
    </div>

    <div class="filter-scroll-container" id="filter-bar"></div>

    <div id="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨è¼‰å…¥è¶³è·¡...
    </div>

    <div class="gallery-container" id="gallery-grid"></div>

    <div id="photo-modal" onclick="closeModal()">
        <div id="modal-close">&times;</div>
        <img id="modal-img" src="" alt="Zoomed Photo" onclick="event.stopPropagation()">
        
        <div id="modal-desc"></div>

        <div class="modal-actions" onclick="event.stopPropagation()">
            <a href="#" id="btn-nav" target="_blank" class="action-btn btn-nav">
                <i class="fas fa-location-arrow"></i> å°èˆª
            </a>
            <a href="#" id="btn-line" target="_blank" class="action-btn btn-line">
                <i class="fab fa-line"></i> åˆ†äº«
            </a>
            <a href="#" id="btn-fb" target="_blank" class="action-btn btn-fb">
                <i class="fab fa-facebook-f"></i> FB
            </a>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const ALL_VILLAGES = [
        "è‹‘æ±é‡Œ", "è‹‘å—é‡Œ", "è‹‘åŒ—é‡Œ", "ä¸­æ­£é‡Œ", "å®¢åº„é‡Œ", "æˆ¿è£¡é‡Œ", "æ–°å¾©é‡Œ", "è¥¿å‹¢é‡Œ", "æµ·å²¸é‡Œ", "å‡ºæ°´é‡Œ", 
        "å±±æ±é‡Œ", "è‹‘å‘é‡Œ", "æ°´å¡é‡Œ", "å±±æŸ‘é‡Œ", "ç¤¾è‹“é‡Œ", "ç”°å¿ƒé‡Œ", "ç‰ç”°é‡Œ", "æ³°ç”°é‡Œ", "ä¸Šé¤¨é‡Œ", "å—å‹¢é‡Œ", 
        "å±±è…³é‡Œ", "èˆŠç¤¾é‡Œ", "çŸ³é®é‡Œ", "è•‰åŸ”é‡Œ", "è¥¿å¹³é‡Œ"
    ];

    let allPhotos = [];

    fetch('/api/locations?t=' + new Date().getTime())
    .then(r => r.json())
    .then(data => {
        allPhotos = data.filter(item => item.image_url && item.image_url.startsWith('http'));
        allPhotos.reverse();

        allPhotos.forEach(item => {
            let rawName = item.nickname || item.name || 'å–„å¿ƒäººå£«';
            item.displayName = rawName;
            item.villageName = 'è‹‘è£¡é®';

            if (rawName.indexOf('#') > -1) {
                let parts = rawName.split('#');
                item.displayName = parts[0];
                item.villageName = parts[1];
            } else {
                let soup = (item.area || "") + (item.address || "") + (item.description || "");
                let matches = soup.match(/[\u4e00-\u9fa5]{2,3}é‡Œ/g);
                if (matches) {
                    let v = matches.find(term => ALL_VILLAGES.includes(term));
                    if (v) item.villageName = v;
                }
            }
        });

        renderFilterChips();
        renderGallery('å…¨éƒ¨');
        $('#loading-box').hide();
    })
    .catch(e => {
        $('#loading-box').html('âŒ ç…§ç‰‡è®€å–å¤±æ•—');
        console.error(e);
    });

    function renderFilterChips() {
        let container = $('#filter-bar');
        let html = `<div class="filter-chip active" onclick="filterGallery(this, 'å…¨éƒ¨')">å…¨éƒ¨</div>`;
        ALL_VILLAGES.forEach(v => {
            if (allPhotos.some(p => p.villageName === v)) {
                html += `<div class="filter-chip" onclick="filterGallery(this, '${v}')">${v}</div>`;
            }
        });
        container.html(html);
    }

    window.filterGallery = function(btn, village) {
        $('.filter-chip').removeClass('active');
        $(btn).addClass('active');
        renderGallery(village);
    }

    function renderGallery(filterVillage) {
        let grid = document.getElementById('gallery-grid');
        let html = '';
        let displayData = filterVillage !== 'å…¨éƒ¨' ? allPhotos.filter(p => p.villageName === filterVillage) : allPhotos;

        displayData.forEach(item => {
            let desc = item.description || 'æ²’æœ‰æè¿°';
            let thumbUrl = item.image_url;
            if(thumbUrl.includes('cloudinary.com')) {
                thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,f_auto,q_auto/');
            }
            
            // ğŸ”¥ é—œéµï¼šé€™è£¡è¦æŠŠ lat, lng å‚³é€² openModal
            // å¦‚æœ item æ²’æœ‰ lat/lngï¼Œæˆ‘å€‘å°±å‚³ç©ºå€¼
            let lat = item.lat || item.latitude || '';
            let lng = item.lng || item.longitude || '';

            html += `
                <div class="gallery-item" onclick="openModal('${item.image_url}', '${item.displayName}', '${item.villageName}', '${desc.replace(/'/g, "\\'")}', '${lat}', '${lng}')">
                    <img src="${thumbUrl}" class="photo-thumb" loading="lazy">
                    <div class="photo-info">
                        <div class="photo-title">${item.displayName}</div>
                        <div class="photo-meta">
                            <span>${item.villageName}</span>
                            <span style="font-size:0.7rem">${new Date(item.created_at || Date.now()).toLocaleDateString().slice(5)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        if (displayData.length === 0) {
            html = '<div style="text-align:center; width:100%; color:#999; margin-top:20px;">ğŸ˜… é€™å€‹é‡Œé‚„æ²’æœ‰ç…§ç‰‡ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼</div>';
        }
        grid.innerHTML = html;
    }

    // ğŸ”¥ Modal é–‹å•Ÿé‚è¼¯ (å«æŒ‰éˆ•è¨­å®š)
    function openModal(url, name, village, desc, lat, lng) {
        $('#modal-img').attr('src', url);
        $('#modal-desc').html(`<strong style="font-size:1.2rem; display:block; margin-bottom:8px; color:#ffd700;">${name} @ ${village}</strong><span style="opacity:0.9;">${desc}</span>`);
        
        // 1. è¨­å®šå°èˆªé€£çµ
        let navBtn = $('#btn-nav');
        if (lat && lng) {
            navBtn.attr('href', `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
            navBtn.show(); // æœ‰åº§æ¨™æ‰é¡¯ç¤º
        } else {
            navBtn.hide(); // æ²’åº§æ¨™å°±éš±è—
        }

        // 2. è¨­å®š Line åˆ†äº« (æ–‡å­— + åœ–ç‰‡é€£çµ)
        let shareText = encodeURIComponent(`ğŸ”¥ æˆ‘åœ¨ã€å°‹ç¥æƒ…å ±ç«™ã€‘ç™¼ç¾ ${name} åœ¨ ${village} æ‹çš„åœŸåœ°å…¬ï¼\nå¿«ä¾†çœ‹çœ‹ï¼š`);
        let shareUrl = encodeURIComponent(url); // é€™è£¡åˆ†äº«ç›´æ¥çš„åœ–ç‰‡é€£çµï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹æˆåˆ†äº«ç¶²ç«™é¦–é 
        $('#btn-line').attr('href', `https://line.me/R/msg/text/?${shareText}%20${shareUrl}`);

        // 3. è¨­å®š FB åˆ†äº« (åˆ†äº«ç¶²ç«™é¦–é æ¯”è¼ƒå¥½ï¼Œå› ç‚º FB æŠ“å¤§åœ–)
        // å¦‚æœè¦åˆ†äº«å–®åœ–ï¼ŒFB çˆ¬èŸ²éœ€è¦ meta tag æ”¯æ´ï¼Œé€™æ¯”è¼ƒè¤‡é›œã€‚
        // é€™è£¡æˆ‘å€‘å…ˆè¨­å®šåˆ†äº«ä¸»ç¶²ç«™ï¼Œè®“å¤§å®¶çŸ¥é“é€™å€‹å¹³å°ã€‚
        let siteUrl = encodeURIComponent(window.location.origin); 
        $('#btn-fb').attr('href', `https://www.facebook.com/sharer/sharer.php?u=${siteUrl}`);

        $('#photo-modal').css('display', 'flex').animate({ opacity: 1 }, 200);
    }

    function closeModal() {
        $('#photo-modal').animate({ opacity: 0 }, 200, function(){ $(this).hide(); });
    }
</script>
{% endblock %}
