<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœŸåœ°å…¬åœ–åº«ç‰†</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { background-color: #fafafa; font-family: -apple-system, sans-serif; padding-bottom: 60px; }
        .app-header { background: white; border-bottom: 1px solid #dbdbdb; padding: 10px 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        .header-title { font-weight: bold; font-size: 1.1rem; color: #262626; }
        .header-btn { color: #262626; font-size: 1.2rem; text-decoration: none; }
        
        /* ç¯©é¸åˆ— */
        .filter-bar { background: #fff; padding: 10px; border-bottom: 1px solid #eee; position: sticky; top: 50px; z-index: 99; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; }
        .custom-select { border-radius: 20px; font-size: 0.9rem; height: auto; border: 1px solid #ddd; background-color: #f8f9fa; }

        /* ç…§ç‰‡ç¶²æ ¼ */
        .gallery-grid { display: flex; flex-wrap: wrap; margin-right: -1px; margin-left: -1px; }
        .gallery-item { position: relative; flex: 0 0 33.333%; max-width: 33.333%; padding: 1px; cursor: pointer; }
        .square-box { position: relative; width: 100%; padding-bottom: 100%; background-color: #eee; overflow: hidden; }
        .square-box img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .gallery-item:active img { opacity: 0.8; }

        /* Modal ç¾åŒ– */
        .modal-content { border: none; border-radius: 15px; overflow: hidden; }
        .modal-body { padding: 0; }
        .full-img { width: 100%; }
        .img-info { padding: 20px; background: white; text-align: left; }
        
        /* å°èˆªèˆ‡åˆ†äº«æŒ‰éˆ• */
        .action-btns { display: flex; gap: 10px; margin-top: 15px; }
        .btn-nav { flex: 1; background-color: #4285F4; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: bold; }
        .btn-share { flex: 1; background-color: #06C755; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: bold; } /* Line ç¶ è‰² */
    </style>
</head>
<body>

    <div class="app-header">
        <a href="/" class="header-btn"><i class="fas fa-chevron-left"></i></a>
        <div class="header-title">åœŸåœ°å…¬åœ–åº«ç‰†</div>
        <a href="/upload" class="header-btn"><i class="far fa-plus-square"></i></a>
    </div>

    <div class="filter-bar">
        <select class="custom-select" id="area-filter"><option value="all">ğŸ“ å…¨éƒ¨åœ°å€</option></select>
        <select class="custom-select" id="user-filter"><option value="all">ğŸ‘¤ å…¨éƒ¨è²¢ç»è€…</option></select>
    </div>

    <div class="container-fluid p-0">
        <div id="ig-grid" class="gallery-grid">
            <div style="padding:50px; width:100%; text-align:center;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
        </div>
        <div id="no-result" style="display:none; text-align:center; padding:40px; color:#999;">æ‰¾ä¸åˆ°ç¬¦åˆçš„ç…§ç‰‡</div>
    </div>

    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <img src="" id="modal-img" class="full-img">
                    <div class="img-info">
                        <h5 id="modal-area" style="font-weight:bold; margin-bottom:5px;"></h5>
                        <p id="modal-user" style="color:#666; font-size:0.9rem; margin-bottom:10px;"></p>
                        <div style="background:#f5f5f5; padding:10px; border-radius:8px; font-size:0.95rem; color:#333;">
                            ğŸ“ <span id="modal-note"></span>
                        </div>
                        
                        <div class="action-btns">
                            <a id="nav-link" href="#" target="_blank" class="btn btn-nav text-center">
                                <i class="fas fa-location-arrow"></i> å°èˆªå»
                            </a>
                            <button onclick="shareLine()" class="btn btn-share">
                                <i class="fab fa-line"></i> åˆ†äº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    
    <script>
        var allData = [];

        $(document).ready(function() {
            $.getJSON('/api/locations', function(data) {
                allData = data.reverse();
                initFilters(allData);
                renderGallery(allData);
            });

            $('#area-filter, #user-filter').on('change', function() {
                var selectedArea = $('#area-filter').val();
                var selectedUser = $('#user-filter').val();
                var filtered = allData.filter(function(item) {
                    var matchArea = (selectedArea === 'all') || (item.area === selectedArea);
                    var matchUser = (selectedUser === 'all') || (item.nickname === selectedUser);
                    return matchArea && matchUser;
                });
                renderGallery(filtered);
            });
        });

        function initFilters(data) {
            var areas = new Set();
            var users = new Set();
            data.forEach(function(item) {
                if(item.area) areas.add(item.area);
                if(item.nickname) users.add(item.nickname);
            });
            areas.forEach(a => $('#area-filter').append(`<option value="${a}">${a}</option>`));
            users.forEach(u => $('#user-filter').append(`<option value="${u}">${u}</option>`));
        }

        function renderGallery(data) {
            var container = $('#ig-grid');
            var noResult = $('#no-result');
            container.empty();

            if (data.length === 0) { noResult.show(); return; } else { noResult.hide(); }

            data.forEach(function(item) {
                var imgUrl = item.image_url || 'https://via.placeholder.com/300';
                // æ³¨æ„ï¼šé€™è£¡å‚³å…¥ lat, lng ä¾›å°èˆªä½¿ç”¨
                var html = `
                    <div class="gallery-item" onclick="showPhoto('${imgUrl}', '${item.area}', '${item.nickname}', '${item.note || ""}', ${item.lat}, ${item.lng})">
                        <div class="square-box"><img src="${imgUrl}" loading="lazy"></div>
                    </div>
                `;
                container.append(html);
            });
        }

        // é¡¯ç¤ºè©³æƒ… (æ–°å¢æ¥æ”¶ lat, lng)
        function showPhoto(url, area, user, note, lat, lng) {
            $('#modal-img').attr('src', url);
            $('#modal-area').html('<i class="fas fa-map-marker-alt"></i> ' + area);
            $('#modal-user').text('ä¸Šå‚³è€…ï¼š' + (user || 'åŒ¿å'));
            $('#modal-note').text(note ? note : 'æ²’æœ‰å‚™è¨»');
            
            // è¨­å®š Google Maps å°èˆªé€£çµ
            // api=1&destination=ç·¯åº¦,ç¶“åº¦
            var navUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            $('#nav-link').attr('href', navUrl);

            $('#photoModal').modal('show');
        }

        // Line åˆ†äº«åŠŸèƒ½
        function shareLine() {
            var url = window.location.href; // åˆ†äº«ç›®å‰ç¶²ç«™ç¶²å€
            var text = "å¿«ä¾†çœ‹çœ‹æˆ‘åœ¨è‹‘è£¡ç™¼ç¾çš„é€™åº§åœŸåœ°å…¬å»Ÿï¼";
            window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}`, '_blank');
        }
    </script>
</body>
</html>
