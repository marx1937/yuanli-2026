<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœŸåœ°å…¬å¾Œå°ç®¡ç†</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .table img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        /* é‡è¤‡è³‡æ–™çš„è­¦å‘Šè‰² (ç´…è‰²) */
        .duplicate-row { background-color: #ffe6e6 !important; border-left: 5px solid #dc3545; }
        .warning-tag { color: #dc3545; font-weight: bold; font-size: 0.85rem; display: block; margin-top: 5px; }
        .coord-info { font-size: 0.75rem; color: #666; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>ğŸ›°ï¸ åœŸåœ°å…¬å¯©æ ¸ç¸½éƒ¨ (GPSç‰ˆ)</h3>
            <a href="/" class="btn btn-outline-secondary">å›åœ°åœ–é¦–é </a>
        </div>
        
        <div class="alert alert-warning">
            <i class="fas fa-satellite-dish"></i> 
            ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—è·é›¢ã€‚å¦‚æœå…©å¼µç…§ç‰‡è·é›¢ <b>å°æ–¼ 20 å…¬å°º</b>ï¼Œæœƒæ¨™ç¤ºç‚º <span style="background:#ffe6e6; padding:0 5px; color:#dc3545;">ç´…è‰²</span>ï¼Œä»£è¡¨å¯èƒ½æ˜¯é‡è¤‡å›å ±ã€‚
        </div>

        <div class="table-responsive">
            <table class="table table-bordered bg-white shadow-sm">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 5%">ID</th>
                        <th style="width: 15%">ç…§ç‰‡</th>
                        <th style="width: 15%">åœ°å€</th>
                        <th style="width: 25%">åº§æ¨™ / è·é›¢åˆ†æ</th>
                        <th style="width: 15%">ä¸Šå‚³è€…</th>
                        <th style="width: 15%">å‚™è¨»</th>
                        <th style="width: 10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="data-list">
                    <tr><td colspan="7" class="text-center p-5">æ­£åœ¨é€²è¡Œ GPS æ¯”å°åˆ†æ...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
    
    <script>
        $(document).ready(function() {
            loadData();
        });

        function loadData() {
            $.getJSON('/api/admin/all_data', function(data) {
                var html = '';
                
                // 1. é€²è¡Œ GPS äº¤å‰æ¯”å°ï¼Œæ‰¾å‡ºé‡è¤‡çš„é …ç›®
                // å…ˆæŠŠè³‡æ–™æŒ‰ ID å€’åºæ’åˆ— (æ–°çš„åœ¨ä¸Šé¢)
                data.sort((a, b) => b.id - a.id);

                // ç‚ºæ¯å€‹é …ç›®åŠ ä¸Š isDuplicate æ¨™è¨˜
                for(let i = 0; i < data.length; i++) {
                    data[i].isDuplicate = false;
                    data[i].nearbyIds = []; // ç´€éŒ„è·Ÿèª°å¤ªè¿‘
                    
                    for(let j = 0; j < data.length; j++) {
                        if(i === j) continue; // ä¸è·Ÿè‡ªå·±æ¯”

                        // è¨ˆç®—è·é›¢ (å–®ä½ï¼šå…¬é‡Œ)
                        let dist = getDistanceFromLatLonInKm(
                            data[i].lat, data[i].lng,
                            data[j].lat, data[j].lng
                        );

                        // å¦‚æœè·é›¢å°æ–¼ 0.02 å…¬é‡Œ (ä¹Ÿå°±æ˜¯ 20 å…¬å°º)
                        if(dist < 0.02) {
                            data[i].isDuplicate = true;
                            data[i].nearbyIds.push(data[j].id);
                        }
                    }
                }

                // 2. ç”¢ç”Ÿè¡¨æ ¼
                data.forEach(function(item) {
                    var rowClass = item.isDuplicate ? 'duplicate-row' : '';
                    
                    var warningMsg = '';
                    if (item.isDuplicate) {
                        warningMsg = `<span class="warning-tag">
                            <i class="fas fa-exclamation-circle"></i> ä½ç½®é‡è¤‡è­¦ç¤º!<br>
                            (èˆ‡ ID: ${item.nearbyIds.join(', ')} å¤ªè¿‘)
                        </span>`;
                    }

                    html += `
                        <tr class="${rowClass}">
                            <td class="align-middle font-weight-bold">${item.id}</td>
                            <td class="align-middle">
                                <a href="${item.image_url}" target="_blank">
                                    <img src="${item.image_url}">
                                </a>
                            </td>
                            <td class="align-middle">
                                <span style="font-size:1.1rem; font-weight:bold;">${item.area}</span>
                            </td>
                            <td class="align-middle">
                                <div class="coord-info">Lat: ${item.lat}</div>
                                <div class="coord-info">Lng: ${item.lng}</div>
                                ${warningMsg}
                            </td>
                            <td class="align-middle">${item.nickname}</td>
                            <td class="align-middle text-muted small">${item.note || ''}</td>
                            <td class="align-middle">
                                <button class="btn btn-danger btn-block btn-sm" onclick="deleteItem(${item.id})">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                $('#data-list').html(html);
            });
        }

        // --- æ•¸å­¸å·¥å…·ï¼šè¨ˆç®—å…©é» GPS è·é›¢ (Haversine å…¬å¼) ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // åœ°çƒåŠå¾‘ (km)
            var dLat = deg2rad(lat2-lat1);
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // è·é›¢ (km)
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        // åˆªé™¤åŠŸèƒ½
        function deleteItem(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ(ID: ' + id + ')')) {
                $.post('/api/delete', { id: id }, function(response) {
                    if(response.success) {
                        loadData(); // é‡æ–°æ•´ç†
                    } else {
                        alert('åˆªé™¤å¤±æ•—ï¼š' + response.message);
                    }
                });
            }
        }
    </script>
</body>
</html>
