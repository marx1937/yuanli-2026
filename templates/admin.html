<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœŸåœ°å…¬å¾Œå°ç®¡ç†</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .table img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .duplicate-row { background-color: #ffe6e6 !important; border-left: 5px solid #dc3545; }
        .warning-tag { color: #dc3545; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>ğŸ‘®â€â™‚ï¸ åœŸåœ°å…¬å¯©æ ¸ç¸½éƒ¨</h3>
            <a href="/" class="btn btn-outline-secondary">å›åœ°åœ–é¦–é </a>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            ç´…è‰²èƒŒæ™¯ä»£è¡¨ <b>åŒä¸€å€‹é‡Œæœ‰é‡è¤‡ç…§ç‰‡</b>ã€‚è«‹ä¿ç•™ä¸€å¼µæœ€å¥½çš„ï¼Œåˆªé™¤å…¶ä»–çš„ï¼ˆé€™å°±æ˜¯ã€Œå¯©æ ¸ã€ï¼‰ã€‚
        </div>

        <div class="table-responsive">
            <table class="table table-bordered bg-white shadow-sm">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 5%">ID</th>
                        <th style="width: 15%">ç…§ç‰‡</th>
                        <th style="width: 15%">åœ°å€ (é‡Œ)</th>
                        <th style="width: 15%">ä¸Šå‚³è€…</th>
                        <th style="width: 20%">å‚™è¨»</th>
                        <th style="width: 10%">å¯©æ ¸æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="data-list">
                    <tr><td colspan="6" class="text-center p-5">è¼‰å…¥è³‡æ–™ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
    
    <script>
        $(document).ready(function() {
            loadData();
        });

        function loadData() {
            $.getJSON('/api/admin/all_data', function(data) {
                var html = '';
                
                // 1. å…ˆè¨ˆç®—æ¯å€‹é‡Œå‡ºç¾å¹¾æ¬¡
                var areaCounts = {};
                data.forEach(item => {
                    var area = item.area || "æœªçŸ¥";
                    areaCounts[area] = (areaCounts[area] || 0) + 1;
                });

                // 2. ç”¢ç”Ÿè¡¨æ ¼
                // æˆ‘å€‘æŒ‰ç…§ã€Œåœ°å€ã€æ’åºï¼Œé€™æ¨£é‡è¤‡çš„æœƒæ’åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿ä½ çœ‹
                data.sort((a, b) => (a.area > b.area) ? 1 : -1);

                data.forEach(function(item) {
                    var area = item.area || "æœªçŸ¥";
                    var isDuplicate = areaCounts[area] > 1; // å¦‚æœå‡ºç¾è¶…é1æ¬¡ï¼Œå°±æ˜¯é‡è¤‡
                    var rowClass = isDuplicate ? 'duplicate-row' : '';
                    var warning = isDuplicate ? '<br><span class="warning-tag"><i class="fas fa-exclamation-triangle"></i> é‡è¤‡å›å ±</span>' : '';

                    html += `
                        <tr class="${rowClass}">
                            <td class="align-middle">${item.id}</td>
                            <td class="align-middle">
                                <a href="${item.image_url}" target="_blank">
                                    <img src="${item.image_url}">
                                </a>
                            </td>
                            <td class="align-middle" style="font-size:1.1rem; font-weight:bold;">
                                ${area}
                                ${warning}
                            </td>
                            <td class="align-middle">${item.nickname}</td>
                            <td class="align-middle text-muted">${item.note || ''}</td>
                            <td class="align-middle">
                                <button class="btn btn-danger btn-block" onclick="deleteItem(${item.id})">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                $('#data-list').html(html);
            });
        }

        function deleteItem(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ(ID: ' + id + ')')) {
                $.post('/api/delete', { id: id }, function(response) {
                    if(response.success) {
                        // alert('åˆªé™¤æˆåŠŸ');
                        loadData(); // é‡æ–°æ•´ç†
                    } else {
                        alert('åˆªé™¤å¤±æ•—ï¼š' + response.message);
                    }
                });
            }
        }
    </script>
</body>
</html>
